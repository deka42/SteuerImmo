<!DOCTYPE html>

<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Immobilien-Steuer-Suite 2025 - Premium Edition</title>

```
<!-- PWA Meta Tags -->
<meta name="theme-color" content="#3498db">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Steuer-Suite">
<meta name="description" content="Professionelle Immobiliensteuer-Optimierung 2025 mit BFH-aktueller Rechtsprechung">

<!-- Enhanced CSS with Performance Optimizations -->
<style>
    :root {
        --primary-color: #3498db;
        --primary-dark: #2980b9;
        --secondary-color: #2c3e50;
        --success-color: #27ae60;
        --success-light: #2ecc71;
        --warning-color: #f39c12;
        --warning-light: #e67e22;
        --error-color: #e74c3c;
        --error-light: #c0392b;
        --light-bg: #f8f9fa;
        --dark-bg: #2c3e50;
        --border-radius: 12px;
        --border-radius-sm: 6px;
        --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.15);
        --shadow-xl: 0 20px 40px rgba(0, 0, 0, 0.2);
        --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        --transition-fast: all 0.15s ease;
        --font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        --z-index-dropdown: 1000;
        --z-index-modal: 1050;
        --z-index-tooltip: 1070;
        
        /* Enhanced color palette */
        --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --gradient-success: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        --gradient-warning: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        --gradient-card: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
    }

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    *:focus {
        outline: 2px solid var(--primary-color);
        outline-offset: 2px;
    }

    body {
        font-family: var(--font-family);
        background: var(--gradient-primary);
        min-height: 100vh;
        overflow-x: hidden;
        line-height: 1.6;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }

    /* Enhanced App Container with Better Grid */
    .app-container {
        display: grid;
        grid-template-areas: 
            "header header"
            "sidebar main"
            "footer footer";
        grid-template-rows: auto 1fr auto;
        grid-template-columns: 300px 1fr;
        min-height: 100vh;
        background: white;
        max-width: 1920px;
        margin: 0 auto;
        box-shadow: var(--shadow-xl);
        position: relative;
    }

    /* Enhanced Header with Better Performance */
    .app-header {
        grid-area: header;
        background: rgba(255, 255, 255, 0.98);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        padding: 1.5rem 2rem;
        border-bottom: 1px solid rgba(52, 152, 219, 0.2);
        position: sticky;
        top: 0;
        z-index: var(--z-index-dropdown);
        transition: var(--transition);
    }

    .app-header.scrolled {
        background: rgba(255, 255, 255, 0.95);
        box-shadow: var(--shadow);
    }

    .header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .app-title {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        color: var(--secondary-color);
    }

    .app-title h1 {
        font-size: 1.75rem;
        font-weight: 600;
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .app-title .subtitle {
        font-size: 0.875rem;
        color: #6c757d;
        font-weight: normal;
        margin-top: 0.25rem;
    }

    .header-actions {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
    }

    /* Enhanced Live Dashboard in Sidebar */
    .app-sidebar {
        grid-area: sidebar;
        background: var(--light-bg);
        border-right: 1px solid #e9ecef;
        padding: 1.5rem;
        overflow-y: auto;
        height: calc(100vh - 80px);
        position: sticky;
        top: 80px;
    }

    #sidebar-dashboard {
        margin-top: 1rem;
        border: 2px solid var(--primary-color);
        background: var(--gradient-card);
        box-shadow: var(--shadow-lg);
    }

    #sidebar-dashboard .card-header {
        background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
        color: white;
        margin: -2rem -2rem 1.5rem -2rem;
        padding: 1rem 2rem;
        border-radius: var(--border-radius) var(--border-radius) 0 0;
    }

    #sidebar-dashboard .card-title {
        color: white;
        margin-bottom: 0;
    }

    #dashboard-content {
        padding: 0;
    }

    .widget-item {
        padding: 1rem;
        margin: 0.75rem 0;
        background: rgba(52, 152, 219, 0.05);
        border-radius: var(--border-radius-sm);
        border-left: 4px solid var(--primary-color);
        transition: var(--transition);
        cursor: pointer;
        position: relative;
        overflow: hidden;
    }

    .widget-item::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        transition: left 0.5s;
    }

    .widget-item:hover::before {
        left: 100%;
    }

    .widget-item:hover {
        transform: translateX(4px);
        background: rgba(52, 152, 219, 0.1);
        box-shadow: var(--shadow);
    }

    .widget-item.success {
        border-left-color: var(--success-color);
        background: rgba(39, 174, 96, 0.05);
    }

    .widget-item.success:hover {
        background: rgba(39, 174, 96, 0.1);
    }

    .widget-item.warning {
        border-left-color: var(--warning-color);
        background: rgba(243, 156, 18, 0.05);
    }

    .widget-item.warning:hover {
        background: rgba(243, 156, 18, 0.1);
    }

    .widget-item.error {
        border-left-color: var(--error-color);
        background: rgba(231, 76, 60, 0.05);
    }

    .widget-item.error:hover {
        background: rgba(231, 76, 60, 0.1);
    }

    .nav-menu {
        list-style: none;
        margin-bottom: 2rem;
    }

    .nav-item {
        margin-bottom: 0.5rem;
    }

    .nav-link {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 1rem 1.25rem;
        color: var(--secondary-color);
        text-decoration: none;
        border-radius: var(--border-radius);
        transition: var(--transition);
        font-weight: 500;
        cursor: pointer;
        position: relative;
        overflow: hidden;
    }

    .nav-link::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 0;
        background: linear-gradient(135deg, var(--primary-color), var(--success-color));
        transition: width 0.3s ease;
        z-index: -1;
    }

    .nav-link:hover::before,
    .nav-link.active::before {
        width: 100%;
    }

    .nav-link:hover,
    .nav-link.active {
        color: white;
        transform: translateX(4px);
        box-shadow: var(--shadow);
    }

    .nav-icon {
        font-size: 1.25rem;
        min-width: 1.5rem;
    }

    .nav-badge {
        background: var(--error-color);
        color: white;
        font-size: 0.7rem;
        padding: 0.2rem 0.5rem;
        border-radius: 10px;
        margin-left: auto;
    }

    /* Enhanced Main Content */
    .app-main {
        grid-area: main;
        padding: 2rem;
        overflow-y: auto;
        background: linear-gradient(135deg, #fafbfc 0%, #f8f9fa 100%);
        min-height: calc(100vh - 80px);
    }

    /* Enhanced Cards with Better Visual Hierarchy */
    .card {
        background: var(--gradient-card);
        border-radius: var(--border-radius);
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: var(--shadow);
        border: 1px solid rgba(52, 152, 219, 0.1);
        transition: var(--transition);
        position: relative;
        overflow: hidden;
    }

    .card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: var(--gradient-primary);
    }

    .card:hover {
        box-shadow: var(--shadow-lg);
        transform: translateY(-2px);
    }

    .card-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid var(--primary-color);
    }

    .card-title {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        color: var(--secondary-color);
        font-size: 1.5rem;
        font-weight: 600;
    }

    .card-subtitle {
        color: #6c757d;
        font-size: 0.9rem;
        margin-top: 0.5rem;
    }

    /* Enhanced Form Components with Better UX */
    .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 2rem;
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        position: relative;
    }

    .form-label {
        font-weight: 600;
        color: var(--secondary-color);
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .form-label .required {
        color: var(--error-color);
    }

    .form-input,
    .form-select {
        padding: 1rem 1.25rem;
        border: 2px solid #e9ecef;
        border-radius: var(--border-radius);
        font-size: 1rem;
        transition: var(--transition);
        background: white;
        font-family: inherit;
        width: 100%;
    }

    .form-input:focus,
    .form-select:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        background: #fafbfc;
    }

    .form-input.error,
    .form-select.error {
        border-color: var(--error-color);
        box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.1);
    }

    .form-input.success,
    .form-select.success {
        border-color: var(--success-color);
        box-shadow: 0 0 0 3px rgba(39, 174, 96, 0.1);
    }

    .form-help {
        font-size: 0.8rem;
        color: #6c757d;
        font-style: italic;
        margin-top: 0.25rem;
    }

    .form-error {
        font-size: 0.8rem;
        color: var(--error-color);
        margin-top: 0.25rem;
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    .input-group {
        position: relative;
    }

    .input-icon {
        position: absolute;
        right: 1rem;
        top: 50%;
        transform: translateY(-50%);
        color: #6c757d;
        pointer-events: none;
    }

    .input-group .form-input {
        padding-right: 3rem;
    }

    /* Enhanced Buttons with Better States */
    .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        padding: 1rem 2rem;
        border: none;
        border-radius: var(--border-radius);
        font-size: 0.95rem;
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
        text-decoration: none;
        white-space: nowrap;
        position: relative;
        overflow: hidden;
        min-height: 48px;
        font-family: inherit;
    }

    .btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        transition: left 0.5s;
    }

    .btn:hover::before {
        left: 100%;
    }

    .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none !important;
    }

    .btn-primary {
        background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
        color: white;
        box-shadow: var(--shadow);
    }

    .btn-primary:hover:not(:disabled) {
        background: linear-gradient(135deg, var(--primary-dark), #1abc9c);
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
    }

    .btn-success {
        background: linear-gradient(135deg, var(--success-color), var(--success-light));
        color: white;
        box-shadow: var(--shadow);
    }

    .btn-success:hover:not(:disabled) {
        background: linear-gradient(135deg, var(--success-light), #1abc9c);
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
    }

    .btn-warning {
        background: linear-gradient(135deg, var(--warning-color), var(--warning-light));
        color: white;
        box-shadow: var(--shadow);
    }

    .btn-warning:hover:not(:disabled) {
        background: linear-gradient(135deg, var(--warning-light), #e74c3c);
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
    }

    .btn-secondary {
        background: linear-gradient(135deg, #95a5a6, #7f8c8d);
        color: white;
        box-shadow: var(--shadow);
    }

    .btn-secondary:hover:not(:disabled) {
        background: linear-gradient(135deg, #7f8c8d, #6c7b7d);
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
    }

    .btn-outline {
        background: transparent;
        border: 2px solid var(--primary-color);
        color: var(--primary-color);
    }

    .btn-outline:hover:not(:disabled) {
        background: var(--primary-color);
        color: white;
    }

    .btn-group {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
    }

    /* Enhanced Results with Better Data Visualization */
    .results-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
        gap: 2rem;
        margin-top: 2rem;
    }

    .result-card {
        background: var(--gradient-card);
        border-radius: var(--border-radius);
        padding: 2rem;
        border: 2px solid #e9ecef;
        transition: var(--transition);
        position: relative;
        overflow: hidden;
    }

    .result-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 4px;
        background: linear-gradient(90deg, var(--primary-color), var(--success-color));
    }

    .result-card.best-option {
        border-color: var(--success-color);
        background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
        animation: pulse 2s infinite;
        box-shadow: var(--shadow-lg);
    }

    .result-card.best-option::before {
        background: var(--success-color);
        height: 6px;
    }

    @keyframes pulse {
        0% { box-shadow: var(--shadow-lg); }
        50% { box-shadow: 0 0 0 10px rgba(39, 174, 96, 0.1); }
        100% { box-shadow: var(--shadow-lg); }
    }

    .result-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-xl);
    }

    .result-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid #e9ecef;
    }

    .result-title {
        color: var(--secondary-color);
        font-size: 1.25rem;
        font-weight: 600;
    }

    .result-badge {
        background: var(--success-color);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    .result-badge.success {
        background: var(--success-color);
    }

    .result-badge.warning {
        background: var(--warning-color);
    }

    .result-badge.error {
        background: var(--error-color);
    }

    .result-card.warning-option {
        border-color: var(--warning-color);
        background: linear-gradient(135deg, #fff8e1, #fff3c4);
    }

    .result-card.warning-option::before {
        background: var(--warning-color);
    }

    .result-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 0;
        border-bottom: 1px solid #f1f3f4;
    }

    .result-item:last-child {
        border-bottom: none;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 2px solid var(--primary-color);
        font-weight: 600;
        background: rgba(52, 152, 219, 0.05);
        margin-left: -1rem;
        margin-right: -1rem;
        padding-left: 1rem;
        padding-right: 1rem;
        border-radius: var(--border-radius-sm);
    }

    .result-label {
        color: var(--secondary-color);
        font-weight: 500;
        font-size: 0.95rem;
    }

    .result-value {
        font-weight: 600;
        color: var(--success-color);
        font-size: 1rem;
    }

    .result-value.negative {
        color: var(--error-color);
    }

    .result-value.neutral {
        color: var(--warning-color);
    }

    .result-details {
        margin-top: 1.5rem;
        padding: 1rem;
        background: rgba(52, 152, 219, 0.05);
        border-radius: var(--border-radius-sm);
        border-left: 4px solid var(--primary-color);
    }

    .result-details h5 {
        color: var(--secondary-color);
        margin-bottom: 0.75rem;
        font-size: 0.9rem;
    }

    .result-details ul {
        list-style: none;
        margin: 0;
    }

    .result-details li {
        padding: 0.25rem 0;
        font-size: 0.85rem;
        color: #6c757d;
    }

    .result-details li::before {
        content: '✓ ';
        color: var(--success-color);
        font-weight: bold;
    }

    .result-details .disadvantages li::before {
        content: '⚠ ';
        color: var(--warning-color);
    }

    /* Enhanced Charts with Better Interactivity */
    .chart-container {
        background: white;
        border-radius: var(--border-radius);
        padding: 2rem;
        margin: 2rem 0;
        box-shadow: var(--shadow);
        border: 1px solid rgba(52, 152, 219, 0.1);
    }

    .chart-title {
        text-align: center;
        color: var(--secondary-color);
        margin-bottom: 2rem;
        font-size: 1.5rem;
        font-weight: 600;
    }

    .chart-subtitle {
        text-align: center;
        color: #6c757d;
        margin-bottom: 1.5rem;
        font-size: 0.9rem;
    }

    .bar-chart {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
        gap: 0.5rem;
        height: 250px;
        align-items: end;
        padding: 1.5rem;
        border-bottom: 2px solid #e9ecef;
        border-left: 2px solid #e9ecef;
        position: relative;
        overflow-x: auto;
    }

    .bar-chart::before {
        content: 'Nettogewinn (€)';
        position: absolute;
        left: -2rem;
        top: 50%;
        transform: rotate(-90deg) translateY(-50%);
        font-size: 0.8rem;
        color: #6c757d;
        font-weight: 500;
    }

    .bar-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.5rem;
        cursor: pointer;
        transition: var(--transition);
        min-width: 50px;
    }

    .bar-item:hover {
        transform: scale(1.05);
    }

    .bar {
        width: 100%;
        max-width: 40px;
        background: linear-gradient(180deg, var(--primary-color), var(--success-color));
        border-radius: 4px 4px 0 0;
        transition: var(--transition);
        position: relative;
        min-height: 10px;
        cursor: pointer;
    }

    .bar::before {
        content: attr(data-value);
        position: absolute;
        top: -2rem;
        left: 50%;
        transform: translateX(-50%);
        font-size: 0.6rem;
        color: var(--secondary-color);
        font-weight: 600;
        opacity: 0;
        transition: var(--transition);
        white-space: nowrap;
        background: white;
        padding: 0.2rem 0.4rem;
        border-radius: 4px;
        box-shadow: var(--shadow);
        z-index: 10;
    }

    .bar-item:hover .bar::before {
        opacity: 1;
    }

    .bar:hover {
        transform: scaleY(1.05);
        filter: brightness(1.1);
        box-shadow: var(--shadow);
    }

    .bar.negative {
        background: linear-gradient(180deg, var(--error-color), var(--error-light));
    }

    .bar.best {
        background: linear-gradient(180deg, var(--success-color), var(--success-light));
        box-shadow: var(--shadow);
        animation: pulse 2s infinite;
    }

    .bar.worst {
        background: linear-gradient(180deg, #95a5a6, #7f8c8d);
        opacity: 0.7;
    }

    .bar-label {
        font-size: 0.65rem;
        color: var(--secondary-color);
        font-weight: 500;
        text-align: center;
        line-height: 1.1;
        max-width: 50px;
        word-wrap: break-word;
        hyphens: auto;
    }

    .bar-value {
        font-size: 0.6rem;
        color: var(--primary-color);
        font-weight: 600;
        margin-top: 0.25rem;
        text-align: center;
    }

    .chart-legend {
        padding: 0.5rem;
        background: rgba(52, 152, 219, 0.05);
        border-radius: var(--border-radius-sm);
        margin-top: 1rem;
    }

    /* Enhanced Alerts with Better Visual Design */
    .alert {
        padding: 1.5rem 2rem;
        border-radius: var(--border-radius);
        margin: 1.5rem 0;
        border-left: 4px solid;
        position: relative;
        font-size: 0.95rem;
        line-height: 1.6;
        box-shadow: var(--shadow);
    }

    .alert::before {
        content: '';
        position: absolute;
        top: 1rem;
        left: 1rem;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        font-size: 0.8rem;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
    }

    .alert-success {
        background: linear-gradient(135deg, #d4edda, #c3e6cb);
        border-color: var(--success-color);
        color: #155724;
    }

    .alert-success::before {
        content: '✓';
        background: var(--success-color);
        color: white;
    }

    .alert-warning {
        background: linear-gradient(135deg, #fff3cd, #ffeaa7);
        border-color: var(--warning-color);
        color: #856404;
    }

    .alert-warning::before {
        content: '⚠';
        background: var(--warning-color);
        color: white;
    }

    .alert-info {
        background: linear-gradient(135deg, #e3f2fd, #bbdefb);
        border-color: var(--primary-color);
        color: #1565c0;
    }

    .alert-info::before {
        content: 'i';
        background: var(--primary-color);
        color: white;
    }

    .alert-error {
        background: linear-gradient(135deg, #ffebee, #ffcdd2);
        border-color: var(--error-color);
        color: #c62828;
    }

    .alert-error::before {
        content: '✕';
        background: var(--error-color);
        color: white;
    }

    .alert .alert-content {
        margin-left: 2.5rem;
    }

    .alert-title {
        font-weight: 600;
        margin-bottom: 0.5rem;
    }

    /* Enhanced Data Table */
    .data-table {
        width: 100%;
        border-collapse: collapse;
        background: white;
        border-radius: var(--border-radius);
        overflow: hidden;
        box-shadow: var(--shadow);
        margin: 2rem 0;
    }

    .data-table th,
    .data-table td {
        padding: 1.25rem 1rem;
        text-align: left;
        border-bottom: 1px solid #e9ecef;
    }

    .data-table th {
        background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
        color: white;
        font-weight: 600;
        font-size: 0.9rem;
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .data-table tr {
        transition: var(--transition);
    }

    .data-table tr:hover {
        background: rgba(52, 152, 219, 0.05);
    }

    .data-table .best-row {
        background: linear-gradient(135deg, #d4edda, #c3e6cb) !important;
        border-left: 4px solid var(--success-color);
        font-weight: 600;
    }

    .data-table .rank-cell {
        font-weight: 600;
        font-size: 1.1rem;
        text-align: center;
        min-width: 60px;
    }

    .data-table .currency-cell {
        font-family: 'Courier New', monospace;
        text-align: right;
    }

    .data-table .percentage-cell {
        text-align: center;
    }

    /* Enhanced Toast Notifications */
    .toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: var(--z-index-tooltip);
        display: flex;
        flex-direction: column;
        gap: 1rem;
        max-width: 400px;
    }

    .toast {
        background: white;
        border-radius: var(--border-radius);
        padding: 1.25rem 1.5rem;
        box-shadow: var(--shadow-xl);
        border-left: 4px solid var(--primary-color);
        min-width: 320px;
        transform: translateX(450px);
        animation: slideInToast 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        position: relative;
        overflow: hidden;
    }

    .toast::before {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        height: 2px;
        background: var(--primary-color);
        animation: toastProgress 5s linear forwards;
    }

    .toast.success {
        border-left-color: var(--success-color);
    }

    .toast.success::before {
        background: var(--success-color);
    }

    .toast.warning {
        border-left-color: var(--warning-color);
    }

    .toast.warning::before {
        background: var(--warning-color);
    }

    .toast.error {
        border-left-color: var(--error-color);
    }

    .toast.error::before {
        background: var(--error-color);
    }

    .toast-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 0.5rem;
    }

    .toast-title {
        font-weight: 600;
        color: var(--secondary-color);
        font-size: 0.9rem;
    }

    .toast-close {
        background: none;
        border: none;
        font-size: 1.2rem;
        cursor: pointer;
        color: #6c757d;
        padding: 0.25rem;
        border-radius: 4px;
        transition: var(--transition);
    }

    .toast-close:hover {
        background: #f1f3f4;
        color: var(--error-color);
    }

    .toast-body {
        color: #6c757d;
        font-size: 0.85rem;
        line-height: 1.4;
    }

    @keyframes slideInToast {
        to {
            transform: translateX(0);
    /* Dark Mode Support */
    @media (prefers-color-scheme: dark) {
        :root {
            --light-bg: #343a40;
            --secondary-color: #ffffff;
            --gradient-card: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
        }

        body {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
        }

        .app-container {
            background: #2c3e50;
            color: white;
        }

        .card,
        .result-card,
        .chart-container {
            background: var(--gradient-card);
            border-color: #495057;
            color: white;
        }

        .form-input,
        .form-select {
            background: #495057;
            border-color: #6c757d;
            color: white;
        }

        .form-input:focus,
        .form-select:focus {
            background: #5a6268;
        }

        .data-table {
            background: #343a40;
            color: white;
        }

        .mobile-nav-menu {
            background: #343a40;
        }

        .popup-content {
            background: #2c3e50;
            color: white;
        }

        .popup-table th {
            background-color: #34495e;
        }
    }

    /* High Contrast Mode */
    @media (prefers-contrast: high) {
        :root {
            --shadow: 0 0 0 2px #000000;
            --shadow-lg: 0 0 0 3px #000000;
            --border-radius: 4px;
        }

        .card,
        .result-card {
            border: 2px solid #000000;
        }

        .btn {
            border: 2px solid;
        }
    }

    /* Reduced Motion */
    @media (prefers-reduced-motion: reduce) {
        *,
        *::before,
        *::after {
            animation-duration: 0.01ms !important;
            animation-iteration-count: 1 !important;
            transition-duration: 0.01ms !important;
        }

        .loading-spinner {
            animation: none;
            border: 3px solid var(--primary-color);
        }
    }

    /* Enhanced Typography */
    h1, h2, h3, h4, h5, h6 {
        font-weight: 600;
        line-height: 1.3;
        margin-bottom: 1rem;
    }

    h1 { font-size: 2rem; }
    h2 { font-size: 1.75rem; }
    h3 { font-size: 1.5rem; }
    h4 { font-size: 1.25rem; }
    h5 { font-size: 1.1rem; }
    h6 { font-size: 1rem; }

    /* Enhanced Spacing System */
    .mt-1 { margin-top: 0.5rem; }
    .mt-2 { margin-top: 1rem; }
    .mt-3 { margin-top: 1.5rem; }
    .mt-4 { margin-top: 2rem; }
    .mb-1 { margin-bottom: 0.5rem; }
    .mb-2 { margin-bottom: 1rem; }
    .mb-3 { margin-bottom: 1.5rem; }
    .mb-4 { margin-bottom: 2rem; }
    .p-1 { padding: 0.5rem; }
    .p-2 { padding: 1rem; }
    .p-3 { padding: 1.5rem; }
    .p-4 { padding: 2rem; }

    /* Utility Classes */
    .text-center { text-align: center; }
    .text-left { text-align: left; }
    .text-right { text-align: right; }
    .font-weight-bold { font-weight: 600; }
    .font-weight-normal { font-weight: 400; }
    .text-muted { color: #6c757d; }
    .text-primary { color: var(--primary-color); }
    .text-success { color: var(--success-color); }
    .text-warning { color: var(--warning-color); }
    .text-error { color: var(--error-color); }
    .d-flex { display: flex; }
    .d-none { display: none; }
    .justify-content-center { justify-content: center; }
    .align-items-center { align-items: center; }
    .gap-1 { gap: 0.5rem; }
    .gap-2 { gap: 1rem; }
    .gap-3 { gap: 1.5rem; }
    .w-100 { width: 100%; }
    .h-100 { height: 100%; }

    /* Enhanced Tooltips */
    .tooltip {
        position: relative;
        cursor: help;
    }

    .tooltip .tooltiptext {
        visibility: hidden;
        width: 200px;
        background-color: #2c3e50;
        color: #fff;
        text-align: center;
        border-radius: 6px;
        padding: 8px;
        position: absolute;
        z-index: 1000;
        bottom: 125%;
        left: 50%;
        margin-left: -100px;
        font-size: 0.8em;
        opacity: 0;
        transition: opacity 0.3s;
    }

    .tooltip:hover .tooltiptext {
        visibility: visible;
        opacity: 1;
    }

    /* Print Styles */
    @media print {
        .app-sidebar,
        .mobile-nav,
        .popup-overlay,
        .dashboard-widget,
        .toast-container {
            display: none !important;
        }

        .app-container {
            box-shadow: none;
            max-width: none;
        }

        .app-main {
            padding: 0;
            background: white;
        }

        .card {
            break-inside: avoid;
            box-shadow: none;
            border: 1px solid #ddd;
        }

        .btn {
            display: none;
        }
    }

    @keyframes toastProgress {
        to {
            width: 100%;
        }
    }

    /* Enhanced Dashboard Widget */
    .dashboard-widget {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: var(--gradient-card);
        border-radius: var(--border-radius);
        padding: 2rem;
        box-shadow: var(--shadow-xl);
        border: 2px solid var(--primary-color);
        max-width: 420px;
        min-width: 360px;
        z-index: var(--z-index-dropdown);
        animation: slideInWidget 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
    }

    .dashboard-widget::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, var(--primary-color), var(--success-color));
        border-radius: var(--border-radius) var(--border-radius) 0 0;
    }

    .dashboard-widget.pulsing {
        animation: dashboardPulse 2s infinite;
    }

    @keyframes slideInWidget {
        from {
            transform: translateY(100px) scale(0.8);
            opacity: 0;
        }
        to {
            transform: translateY(0) scale(1);
            opacity: 1;
        }
    }

    @keyframes dashboardPulse {
        0%, 100% { 
            box-shadow: var(--shadow-xl); 
            transform: scale(1);
        }
        50% { 
            box-shadow: 0 20px 60px rgba(52, 152, 219, 0.3);
            transform: scale(1.02);
        }
    }

    .widget-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid #e9ecef;
    }

    .widget-title {
        color: var(--secondary-color);
        font-weight: 600;
        font-size: 1.1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .widget-close {
        background: none;
        border: none;
        font-size: 1.4rem;
        cursor: pointer;
        color: #95a5a6;
        padding: 0.5rem;
        border-radius: 50%;
        transition: var(--transition);
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .widget-close:hover {
        background: #f1f3f4;
        color: var(--error-color);
        transform: rotate(90deg);
    }

    .widget-item {
        padding: 1rem;
        margin: 0.75rem 0;
        background: rgba(52, 152, 219, 0.05);
        border-radius: var(--border-radius-sm);
        border-left: 4px solid var(--primary-color);
        transition: var(--transition);
        cursor: pointer;
    }

    .widget-item:hover {
        transform: translateX(4px);
        background: rgba(52, 152, 219, 0.1);
        box-shadow: var(--shadow);
    }

    .widget-item.success {
        border-left-color: var(--success-color);
    }

    .widget-item.warning {
        border-left-color: var(--warning-color);
    }

    .widget-item.error {
        border-left-color: var(--error-color);
    }

    .widget-footer {
        margin-top: 1.5rem;
        padding-top: 1rem;
        border-top: 1px solid #e9ecef;
        font-size: 0.8rem;
        color: #6c757d;
        text-align: center;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }

    .widget-footer::before {
        content: '🔄';
        animation: spin 2s linear infinite;
    }

    /* Enhanced Mobile Navigation */
    .mobile-nav {
        display: none;
        background: var(--light-bg);
        padding: 1.5rem;
        border-bottom: 1px solid #e9ecef;
        position: sticky;
        top: 80px;
        z-index: var(--z-index-dropdown);
    }

    .mobile-nav-toggle {
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
        color: white;
        border: none;
        padding: 1.25rem 1.5rem;
        border-radius: var(--border-radius);
        cursor: pointer;
        font-size: 1rem;
        font-weight: 600;
        width: 100%;
        transition: var(--transition);
        box-shadow: var(--shadow);
        font-family: inherit;
    }

    .mobile-nav-toggle:hover {
        background: linear-gradient(135deg, var(--primary-dark), #1abc9c);
        transform: translateY(-1px);
        box-shadow: var(--shadow-lg);
    }

    .mobile-nav-toggle:active {
        transform: translateY(0);
    }

    .mobile-nav-toggle.open {
        border-radius: var(--border-radius) var(--border-radius) 0 0;
    }

    #mobile-nav-arrow {
        font-size: 1.2rem;
        transition: transform 0.3s ease;
    }

    .mobile-nav-toggle.open #mobile-nav-arrow {
        transform: rotate(180deg);
    }

    .mobile-nav-menu {
        display: none;
        list-style: none;
        margin-top: 0;
        background: white;
        border-radius: 0 0 var(--border-radius) var(--border-radius);
        box-shadow: var(--shadow-lg);
        overflow: hidden;
        border: 1px solid var(--primary-color);
        border-top: none;
    }

    .mobile-nav-menu.show {
        display: block;
        animation: slideDown 0.3s ease;
    }

    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .mobile-nav-item {
        border-bottom: 1px solid #e9ecef;
    }

    .mobile-nav-item:last-child {
        border-bottom: none;
    }

    .mobile-nav-link {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1.25rem 1.5rem;
        color: var(--secondary-color);
        text-decoration: none;
        transition: var(--transition);
        font-weight: 500;
        cursor: pointer;
    }

    .mobile-nav-link:hover,
    .mobile-nav-link.active {
        background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
        color: white;
    }

    .mobile-nav-link .nav-icon {
        font-size: 1.25rem;
        min-width: 1.5rem;
    }

    /* Enhanced Progress Indicators */
    .progress-container {
        margin: 1.5rem 0;
    }

    .progress-label {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
        color: var(--secondary-color);
    }

    .progress-bar {
        width: 100%;
        height: 8px;
        background: #e9ecef;
        border-radius: 4px;
        overflow: hidden;
    }

    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--primary-color), var(--success-color));
        border-radius: 4px;
        transition: width 0.8s ease;
        position: relative;
    }

    .progress-fill::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        bottom: 0;
        right: 0;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        animation: progressShine 2s infinite;
    }

    @keyframes progressShine {
        0% { transform: translateX(-100%); }
        50% { transform: translateX(100%); }
        100% { transform: translateX(100%); }
    }

    /* Loading States */
    .loading-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 3rem;
        gap: 1.5rem;
    }

    .loading-spinner {
        width: 40px;
        height: 40px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid var(--primary-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    .loading-text {
        color: var(--secondary-color);
        font-size: 1rem;
        font-weight: 500;
    }

    .loading-dots::after {
        content: '';
        animation: loadingDots 1.5s infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    @keyframes loadingDots {
        0%, 20% { content: '.'; }
        40% { content: '..'; }
        60%, 100% { content: '...'; }
    }

    /* Skeleton Loading */
    .skeleton {
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 200% 100%;
        animation: skeletonLoading 1.5s infinite;
    }

    .skeleton-text {
        height: 1rem;
        border-radius: 4px;
        margin: 0.5rem 0;
    }

    .skeleton-card {
        height: 200px;
        border-radius: var(--border-radius);
    }

    @keyframes skeletonLoading {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
    }

    /* Enhanced Responsive Design */
    @media (max-width: 1024px) {
        .app-container {
            grid-template-areas: 
                "header"
                "nav"
                "main"
                "footer";
            grid-template-columns: 1fr;
            grid-template-rows: auto auto 1fr auto;
        }

        .app-sidebar {
            display: none;
        }

        .mobile-nav {
            display: block;
            grid-area: nav;
            position: sticky;
            top: 80px;
        }

        .dashboard-widget {
            position: relative;
            bottom: auto;
            right: auto;
            margin: 2rem 0;
            max-width: none;
            min-width: auto;
        }
    }

    @media (max-width: 768px) {
        .app-main {
            padding: 1.5rem;
        }

        .card {
            padding: 1.5rem;
        }

        .form-grid {
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }

        .results-grid {
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }

        .header-content {
            flex-direction: column;
            align-items: stretch;
            gap: 1rem;
        }

        .header-actions {
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn-group {
            flex-direction: column;
            width: 100%;
        }

        .btn {
            padding: 0.875rem 1.5rem;
            font-size: 0.9rem;
        }

        .app-title h1 {
            font-size: 1.5rem;
        }

        .app-title .subtitle {
            font-size: 0.8rem;
        }

        .bar-chart {
            grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
            gap: 0.5rem;
            padding: 1rem;
        }

        .toast-container {
            left: 10px;
            right: 10px;
            top: 10px;
        }

        .toast {
            min-width: auto;
        }

        .dashboard-widget {
            min-width: auto;
            margin: 1rem 0;
            padding: 1.5rem;
        }
    }

    @media (max-width: 480px) {
        .app-main {
            padding: 1rem;
        }

        .card {
            padding: 1rem;
        }

        .card-title {
            font-size: 1.25rem;
        }

        .form-input,
        .form-select {
            padding: 0.875rem 1rem;
        }

        .btn {
            padding: 0.75rem 1.25rem;
            font-size: 0.85rem;
        }

        .result-card {
            padding: 1.5rem;
        }
    }

    /* Enhanced Strategy Overview Timeline */
    .strategy-overview {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        border-radius: 15px;
        margin: 30px 0;
    }

    .strategy-overview h3 {
        font-size: 1.5em;
        margin-bottom: 20px;
        text-align: center;
    }

    .timeline {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: 30px 0;
        position: relative;
    }

    .timeline::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 0;
        right: 0;
        height: 2px;
        background: rgba(255,255,255,0.3);
        z-index: 1;
    }

    .timeline-item {
        background: rgba(255,255,255,0.2);
        padding: 15px;
        border-radius: 10px;
        text-align: center;
        position: relative;
        z-index: 2;
        min-width: 120px;
        backdrop-filter: blur(10px);
        transition: all 0.3s ease;
    }

    .timeline-item.active {
        background: rgba(255,255,255,0.9);
        color: #2c3e50;
        transform: scale(1.05);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    /* Enhanced Popup System */
    .popup-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 2000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
        backdrop-filter: blur(5px);
    }
    
    .popup-overlay.active {
        opacity: 1;
        visibility: visible;
    }
    
    .popup-content {
        background: white;
        border-radius: 12px;
        width: 90%;
        max-width: 1000px;
        max-height: 90vh;
        overflow: auto;
        padding: 30px;
        position: relative;
        transform: scale(0.9);
        transition: transform 0.3s ease;
        box-shadow: var(--shadow-xl);
    }
    
    .popup-overlay.active .popup-content {
        transform: scale(1);
    }
    
    .popup-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #3498db;
    }
    
    .popup-title {
        font-size: 1.8em;
        color: #2c3e50;
        margin: 0;
    }
    
    .popup-close {
        background: #e74c3c;
        color: white;
        border: none;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        font-size: 1.2em;
        cursor: pointer;
        display: flex;
        justify-content: center;
        align-items: center;
        transition: all 0.2s ease;
    }
    
    .popup-close:hover {
        background: #c0392b;
        transform: rotate(90deg);
    }
    
    .popup-body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    .popup-section {
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 1px solid #eee;
    }
    
    .popup-section-title {
        font-size: 1.3em;
        color: #2c3e50;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid #3498db;
    }
    
    .popup-table {
        width: 100%;
        border-collapse: collapse;
        margin: 15px 0;
    }
    
    .popup-table th, .popup-table td {
        border: 1px solid #ddd;
        padding: 10px;
        text-align: left;
    }
    
    .popup-table th {
        background-color: #3498db;
        color: white;
        font-weight: 600;
    }
    
    .popup-recommendations {
        background: #e3f2fd;
        padding: 20px;
        border-radius: 10px;
        margin-top: 20px;
    }
    
    .popup-footer {
        margin-top: 30px;
        text-align: center;
        color: #7f8c8d;
        font-size: 0.9em;
    }
    
    .popup-download-btn {
        background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
        color: white;
        border: none;
        padding: 15px 30px;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        width: 100%;
        margin-top: 20px;
    }

    .popup-download-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(39, 174, 96, 0.3);
    }

    /* Scenario Comparison Enhancements */
    .scenario-comparison {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 25px;
        margin: 20px 0;
    }

    .scenario-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
    }

    .scenario-card {
        background: white;
        border-radius: 10px;
        padding: 20px;
        border-left: 4px solid #3498db;
        transition: all 0.3s ease;
        box-shadow: var(--shadow);
    }

    .scenario-card:hover {
        transform: translateY(-3px);
        box-shadow: var(--shadow-lg);
    }

    /* Enhanced Loading States */
    @keyframes slideOutToast {
        to { transform: translateX(450px); opacity: 0; }
    }
    
    @keyframes fadeInUp {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .fade-in {
        animation: fadeInUp 0.5s ease forwards;
    }

    @keyframes slideIn {
        from {
            transform: translateX(300px);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    @keyframes slideOut {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(300px);
            opacity: 0;
        }
    }

    /* Enhanced Timeline for Mobile */
    @media (max-width: 768px) {
        .timeline {
            flex-direction: column;
            gap: 15px;
        }
        
        .timeline::before {
            display: none;
        }
        
        .popup-content {
            width: 95%;
            padding: 15px;
        }
        
        .popup-table th, 
        .popup-table td {
            padding: 8px;
            font-size: 12px;
        }
        
        .popup-download-btn {
            padding: 12px 20px;
            font-size: 16px;
        }
    }

    /* High Contrast Mode */
    @media (prefers-contrast: high) {
        :root {
            --shadow: 0 0 0 2px #000000;
            --shadow-lg: 0 0 0 3px #000000;
            --border-radius: 4px;
        }

        .card,
        .result-card {
            border: 2px solid #000000;
        }

        .btn {
            border: 2px solid;
        }
    }

    /* Reduced Motion */
    @media (prefers-reduced-motion: reduce) {
        *,
        *::before,
        *::after {
            animation-duration: 0.01ms !important;
            animation-iteration-count: 1 !important;
            transition-duration: 0.01ms !important;
        }

        .loading-spinner {
            animation: none;
            border: 3px solid var(--primary-color);
        }
    }

    /* Focus Styles for Better Accessibility */
    .nav-link:focus,
    .mobile-nav-link:focus,
    .btn:focus,
    .form-input:focus,
    .form-select:focus,
    .widget-close:focus,
    .toast-close:focus {
        outline: 2px solid var(--primary-color);
        outline-offset: 2px;
    }

    /* Screen Reader Only Content */
    .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
    }

    /* Enhanced Typography */
    h1, h2, h3, h4, h5, h6 {
        font-weight: 600;
        line-height: 1.3;
        margin-bottom: 1rem;
    }

    h1 { font-size: 2rem; }
    h2 { font-size: 1.75rem; }
    h3 { font-size: 1.5rem; }
    h4 { font-size: 1.25rem; }
    h5 { font-size: 1.1rem; }
    h6 { font-size: 1rem; }

    /* Enhanced Spacing System */
    .mt-1 { margin-top: 0.5rem; }
    .mt-2 { margin-top: 1rem; }
    .mt-3 { margin-top: 1.5rem; }
    .mt-4 { margin-top: 2rem; }
    .mb-1 { margin-bottom: 0.5rem; }
    .mb-2 { margin-bottom: 1rem; }
    .mb-3 { margin-bottom: 1.5rem; }
    .mb-4 { margin-bottom: 2rem; }
    .p-1 { padding: 0.5rem; }
    .p-2 { padding: 1rem; }
    .p-3 { padding: 1.5rem; }
    .p-4 { padding: 2rem; }

    /* Utility Classes */
    .text-center { text-align: center; }
    .text-left { text-align: left; }
    .text-right { text-align: right; }
    .font-weight-bold { font-weight: 600; }
    .font-weight-normal { font-weight: 400; }
    .text-muted { color: #6c757d; }
    .text-primary { color: var(--primary-color); }
    .text-success { color: var(--success-color); }
    .text-warning { color: var(--warning-color); }
    .text-error { color: var(--error-color); }
    .d-flex { display: flex; }
    .d-none { display: none; }
    .justify-content-center { justify-content: center; }
    .align-items-center { align-items: center; }
    .gap-1 { gap: 0.5rem; }
    .gap-2 { gap: 1rem; }
    .gap-3 { gap: 1.5rem; }
    .w-100 { width: 100%; }
    .h-100 { height: 100%; }
</style>
```

</head>
<body>
    <div class="app-container">
        <!-- Enhanced Header -->
        <header class="app-header" id="app-header">
            <div class="header-content">
                <div class="app-title">
                    <span style="font-size: 2.5rem;">🏠</span>
                    <div>
                        <h1>Immobilien-Steuer-Suite 2025</h1>
                        <div class="subtitle">
                            Premium Edition • BFH-Rechtsprechung 2025 • KI-optimiert
                        </div>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="btn btn-primary" onclick="window.appInstance && window.appInstance.exportReport()" aria-label="Bericht exportieren">
                        📋 Bericht
                    </button>
                    <button class="btn btn-warning" onclick="window.appInstance && window.appInstance.loadExample()" aria-label="Beispieldaten laden">
                        💡 Beispiel
                    </button>
                    <button class="btn btn-secondary" onclick="window.appInstance && window.appInstance.resetData()" aria-label="Daten zurücksetzen">
                        🔄 Reset
                    </button>
                    <button class="btn btn-success" onclick="window.appInstance && window.appInstance.showExtendedAnalyse()" aria-label="Erweiterte Analyse anzeigen">
                        🔍 Erweiterte Analyse
                    </button>
                </div>
            </div>
        </header>

```
    <!-- Enhanced Sidebar Navigation -->
    <nav class="app-sidebar" role="navigation" aria-label="Hauptnavigation">
        <ul class="nav-menu">
            <li class="nav-item">
                <a href="#verkauf" class="nav-link active" onclick="window.appInstance && window.appInstance.navigate('verkauf')" role="menuitem">
                    <span class="nav-icon">💰</span>
                    <span>Verkaufssteuer</span>
                    <span class="nav-badge" id="verkauf-badge" style="display: none;">NEU</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="#grundsteuer" class="nav-link" onclick="window.appInstance && window.appInstance.navigate('grundsteuer')" role="menuitem">
                    <span class="nav-icon">🏛️</span>
                    <span>Grundsteuer</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="#erbschaft" class="nav-link" onclick="window.appInstance && window.appInstance.navigate('erbschaft')" role="menuitem">
                    <span class="nav-icon">👨‍👩‍👧‍👦</span>
                    <span>Erbschaftsteuer</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="#schenkung" class="nav-link" onclick="window.appInstance && window.appInstance.navigate('schenkung')" role="menuitem">
                    <span class="nav-icon">🎁</span>
                    <span>Schenkungssteuer</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="#cashflow" class="nav-link" onclick="window.appInstance && window.appInstance.navigate('cashflow')" role="menuitem">
                    <span class="nav-icon">📊</span>
                    <span>Cash-Flow</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="#strategie" class="nav-link" onclick="window.appInstance && window.appInstance.navigate('strategie')" role="menuitem">
                    <span class="nav-icon">🎯</span>
                    <span>Gesamtstrategie</span>
                </a>
            </li>
        </ul>

        <!-- Enhanced Live Dashboard in Sidebar -->
        <div id="sidebar-dashboard" class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <span>💡</span>
                    Live-Insights
                </h3>
            </div>
            <div id="dashboard-content">
                <div class="skeleton skeleton-text"></div>
                <div class="skeleton skeleton-text"></div>
                <div class="skeleton skeleton-text"></div>
            </div>
        </div>
    </nav>

    <!-- Enhanced Mobile Navigation -->
    <nav class="mobile-nav" role="navigation" aria-label="Mobile Navigation">
        <button class="mobile-nav-toggle" onclick="window.appInstance && window.appInstance.toggleMobileNav()" aria-expanded="false" aria-controls="mobile-nav-menu">
            <span>💰 Verkaufssteuer</span>
            <span id="mobile-nav-arrow">▼</span>
        </button>
        <ul class="mobile-nav-menu" id="mobile-nav-menu" role="menu">
            <li class="mobile-nav-item" role="none">
                <a href="#verkauf" class="mobile-nav-link active" onclick="window.appInstance && window.appInstance.navigate('verkauf')" role="menuitem">
                    <span class="nav-icon">💰</span>
                    <span>Verkaufssteuer-Vergleich</span>
                </a>
            </li>
            <li class="mobile-nav-item" role="none">
                <a href="#grundsteuer" class="mobile-nav-link" onclick="window.appInstance && window.appInstance.navigate('grundsteuer')" role="menuitem">
                    <span class="nav-icon">🏛️</span>
                    <span>Grundsteuer 2025</span>
                </a>
            </li>
            <li class="mobile-nav-item" role="none">
                <a href="#erbschaft" class="mobile-nav-link" onclick="window.appInstance && window.appInstance.navigate('erbschaft')" role="menuitem">
                    <span class="nav-icon">👨‍👩‍👧‍👦</span>
                    <span>Erbschaftsteuer</span>
                </a>
            </li>
            <li class="mobile-nav-item" role="none">
                <a href="#schenkung" class="mobile-nav-link" onclick="window.appInstance && window.appInstance.navigate('schenkung')" role="menuitem">
                    <span class="nav-icon">🎁</span>
                    <span>Schenkungssteuer</span>
                </a>
            </li>
            <li class="mobile-nav-item" role="none">
                <a href="#cashflow" class="mobile-nav-link" onclick="window.appInstance && window.appInstance.navigate('cashflow')" role="menuitem">
                    <span class="nav-icon">📊</span>
                    <span>Cash-Flow Analyse</span>
                </a>
            </li>
            <li class="mobile-nav-item" role="none">
                <a href="#strategie" class="mobile-nav-link" onclick="window.appInstance && window.appInstance.navigate('strategie')" role="menuitem">
                    <span class="nav-icon">🎯</span>
                    <span>Gesamtstrategie</span>
                </a>
            </li>
        </ul>
    </nav>

    <!-- Enhanced Main Content -->
    <main class="app-main" role="main">
        <div id="app-content" aria-live="polite">
            <div class="loading-container">
                <div class="loading-spinner" aria-hidden="true"></div>
                <div class="loading-text">Lade Anwendung<span class="loading-dots"></span></div>
            </div>
        </div>
    </main>
</div>

<!-- Enhanced Toast Container -->
<div class="toast-container" id="toast-container" aria-live="polite" aria-label="Benachrichtigungen"></div>

<!-- Enhanced Progress Overlay for Long Operations -->
<div id="progress-overlay" class="d-none" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center;">
    <div style="background: white; padding: 2rem; border-radius: var(--border-radius); box-shadow: var(--shadow-xl); text-align: center; min-width: 300px;">
        <div class="loading-spinner" style="margin: 0 auto 1rem;"></div>
        <h4 id="progress-title">Berechnung läuft...</h4>
        <div class="progress-container">
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
            </div>
        </div>
        <p id="progress-text" class="text-muted">Bitte warten...</p>
        <button class="btn btn-secondary mt-2" onclick="window.appInstance && window.appInstance.hideCalculationProgress(); window.appInstance.showToast('⚠️ Berechnung abgebrochen', 'warning')" style="font-size: 0.8rem; padding: 0.5rem 1rem;">
            Abbrechen
        </button>
    </div>
</div>

<!-- Complete Enhanced JavaScript with All Optimizations -->
<script>
    // Enhanced Memory Storage with Better Performance
    class MemoryStorage {
        constructor() {
            this.data = new Map();
            this.maxSize = 100;
            this.accessTimes = new Map();
        }

        setItem(key, value) {
            // LRU eviction if storage is full
            if (this.data.size >= this.maxSize && !this.data.has(key)) {
                const oldestKey = this.getLRUKey();
                this.removeItem(oldestKey);
            }
            
            this.data.set(key, value);
            this.accessTimes.set(key, Date.now());
        }

        getItem(key) {
            if (this.data.has(key)) {
                this.accessTimes.set(key, Date.now());
                return this.data.get(key);
            }
            return null;
        }

        removeItem(key) {
            this.data.delete(key);
            this.accessTimes.delete(key);
        }

        clear() {
            this.data.clear();
            this.accessTimes.clear();
        }

        getLRUKey() {
            let oldestKey = null;
            let oldestTime = Infinity;
            
            for (const [key, time] of this.accessTimes) {
                if (time < oldestTime) {
                    oldestTime = time;
                    oldestKey = key;
                }
            }
            
            return oldestKey;
        }

        getSize() {
            return this.data.size;
        }
    }

    // Initialize enhanced memory storage
    const memoryStorage = new MemoryStorage();

    // Enhanced Performance Monitor
    class PerformanceMonitor {
        constructor() {
            this.metrics = new Map();
            this.enabled = true;
        }

        startTimer(name) {
            if (!this.enabled) return;
            this.metrics.set(name, performance.now());
        }

        endTimer(name) {
            if (!this.enabled || !this.metrics.has(name)) return 0;
            
            const duration = performance.now() - this.metrics.get(name);
            this.metrics.delete(name);
            
            if (duration > 100) {
                console.warn(`Performance: ${name} took ${duration.toFixed(2)}ms`);
            }
            
            return duration;
        }

        measureFunction(fn, name) {
            return (...args) => {
                this.startTimer(name);
                const result = fn(...args);
                this.endTimer(name);
                return result;
            };
        }

        measureAsyncFunction(fn, name) {
            return async (...args) => {
                this.startTimer(name);
                try {
                    const result = await fn(...args);
                    this.endTimer(name);
                    return result;
                } catch (error) {
                    this.endTimer(name);
                    throw error;
                }
            };
        }
    }

    const performanceMonitor = new PerformanceMonitor();

    // Enhanced Core Application Class
    class ImmobilienSuite {
        constructor() {
            this.modules = {};
            this.cache = new Map();
            this.eventListeners = new Map();
            this.manualSave = false;
            this.progressTimeout = null;
            this.autoCalculateTimeout = null;
            this.immediateUpdateTimeout = null;
            
            // Constants
            this.CACHE_TIMEOUT = 30000;
            this.DASHBOARD_UPDATE_INTERVAL = 3000;
            this.AUTO_SAVE_INTERVAL = 30000;
            this.DEBOUNCE_DELAY = 300;
            
            this.config = {
                taxYear: 2025,
                baseInterestRate: 2.5,
                version: '3.0.0',
                debug: false,
                enableAnalytics: true,
                autoSave: true,
                cacheTimeout: this.CACHE_TIMEOUT
            };
            this.state = {
                currentSection: 'verkauf',
                isDirty: false,
                lastSave: null,
                calculations: new Map()
            };
            this.init();
        }

        async init() {
            try {
                await this.showProgress('Initialisiere Module...', 10);
                
                // Initialize core modules first
                await this.initializeCoreModules();
                await this.showProgress('Lade Benutzeroberfläche...', 30);
                
                // Initialize UI modules
                await this.initializeUIModules();
                await this.showProgress('Lade gespeicherte Daten...', 50);
                
                // Load data and setup
                await this.loadData();
                await this.showProgress('Aktiviere Live-Updates...', 70);
                
                // Setup live features
                await this.setupLiveFeatures();
                await this.showProgress('Finalisiere Setup...', 90);
                
                // Initialize first view
                await this.navigate('verkauf');
                await this.showProgress('Bereit!', 100);
                
                setTimeout(() => this.hideProgress(), 500);
                
                this.showToast('🚀 Immobilien-Suite 2025 Premium geladen', 'success');
                this.showMobileNavigationHint();
                
            } catch (error) {
                console.error('Initialization error:', error);
                this.hideProgress();
                this.showToast('❌ Fehler beim Laden: ' + error.message, 'error');
                await this.fallbackInitialization();
            }
        }

        async initializeCoreModules() {
            const coreModules = [
                ['validation', ValidationModule],
                ['calculator', EnhancedTaxCalculatorModule],
                ['storage', StorageModule]
            ];

            for (const [name, ModuleClass] of coreModules) {
                try {
                    this.modules[name] = new ModuleClass(this.config);
                    if (this.config.debug) {
                        console.log(`✓ ${name} module initialized`);
                    }
                } catch (error) {
                    console.error(`Failed to initialize ${name} module:`, error);
                    throw new Error(`Critical module ${name} failed to load`);
                }
            }
        }

        async initializeUIModules() {
            const uiModules = [
                ['ui', UIModule],
                ['charts', ChartModule],
                ['dashboard', DashboardModule],
                ['export', ExportModule],
                ['analytics', AnalyticsModule]
            ];

            for (const [name, ModuleClass] of uiModules) {
                try {
                    this.modules[name] = new ModuleClass(this);
                } catch (error) {
                    console.warn(`Warning: ${name} module failed to load:`, error);
                    // UI modules are not critical
                }
            }
        }

        async setupLiveFeatures() {
            // Setup auto-save
            if (this.config.autoSave) {
                this.setupAutoSave();
            }

            // Setup dashboard updates
            if (this.modules.dashboard) {
                this.modules.dashboard.startLiveUpdates();
            }

            // Initialize sidebar dashboard content immediately
            this.initializeSidebarDashboard();

            // Setup analytics
            if (this.modules.analytics && this.config.enableAnalytics) {
                this.modules.analytics.init();
            }

            // Setup keyboard shortcuts
            this.setupKeyboardShortcuts();

            // Setup scroll effects
            this.setupScrollEffects();

            // Start live dashboard updates
            this.startDashboardUpdates();
        }

        initializeSidebarDashboard() {
            try {
                const sidebarDashboard = document.getElementById('dashboard-content');
                if (sidebarDashboard) {
                    // Show loading first
                    sidebarDashboard.innerHTML = `
                        <div class="widget-item">
                            <div style="font-weight: 600; color: #3498db; margin-bottom: 5px;">💡 Dashboard startet...</div>
                            <div style="font-size: 0.9em;">Live-Insights werden geladen</div>
                        </div>
                    `;
                    
                    // Then load actual content
                    setTimeout(() => {
                        this.updateSidebarDashboard();
                    }, 500);
                }
            } catch (error) {
                console.error('Dashboard initialization error:', error);
            }
        }

        startDashboardUpdates() {
            // Update dashboard every 3 seconds for live feeling
            setInterval(() => {
                this.updateSidebarDashboard();
            }, 3000);
            
            // Initial update
            setTimeout(() => {
                this.updateSidebarDashboard();
            }, 1000);
        }

        updateSidebarDashboard() {
            try {
                const sidebarDashboard = document.getElementById('dashboard-content');
                if (sidebarDashboard) {
                    const insights = this.generateCurrentInsights();
                    sidebarDashboard.innerHTML = insights;
                    
                    // Add fade-in animation
                    sidebarDashboard.style.opacity = '0';
                    setTimeout(() => {
                        sidebarDashboard.style.transition = 'opacity 0.3s ease';
                        sidebarDashboard.style.opacity = '1';
                    }, 50);
                }
            } catch (error) {
                console.error('Sidebar dashboard error:', error);
                // Fallback content
                const sidebarDashboard = document.getElementById('dashboard-content');
                if (sidebarDashboard) {
                    sidebarDashboard.innerHTML = `
                        <div class="widget-item error">
                            <div style="font-weight: 600; color: #e74c3c; margin-bottom: 5px;">⚠️ Dashboard-Fehler</div>
                            <div style="font-size: 0.9em;">Insights temporär nicht verfügbar</div>
                        </div>
                    `;
                }
            }
        }

        async fallbackInitialization() {
            try {
                this.modules.calculator = new BasicTaxCalculatorModule(this.config);
                this.modules.storage = new StorageModule();
                await this.navigate('verkauf');
                this.showToast('⚠️ Basis-Funktionalität geladen', 'warning');
            } catch (fallbackError) {
                console.error('Fallback initialization failed:', fallbackError);
                this.showCriticalError();
            }
        }

        setupAutoSave() {
            setInterval(() => {
                if (this.state.isDirty) {
                    this.saveData();
                    this.state.isDirty = false;
                }
            }, 30000); // Auto-save every 30 seconds
        }

        setupKeyboardShortcuts() {
            const shortcuts = {
                'ctrl+s': () => this.saveData(),
                'ctrl+e': () => this.exportReport(),
                'ctrl+r': () => this.resetData(),
                'ctrl+d': () => this.showDashboard(),
                'ctrl+1': () => this.navigate('verkauf'),
                'ctrl+2': () => this.navigate('grundsteuer'),
                'ctrl+3': () => this.navigate('erbschaft'),
                'ctrl+4': () => this.navigate('schenkung'),
                'ctrl+5': () => this.navigate('cashflow'),
                'ctrl+6': () => this.navigate('strategie'),
                'escape': () => this.closeMobileNav()
            };

            document.addEventListener('keydown', (e) => {
                const key = `${e.ctrlKey ? 'ctrl+' : ''}${e.key.toLowerCase()}`;
                if (shortcuts[key]) {
                    e.preventDefault();
                    shortcuts[key]();
                }
            });
        }

        setupScrollEffects() {
            const header = document.getElementById('app-header');
            if (!header) return;

            let lastScrollY = window.scrollY;
            
            window.addEventListener('scroll', () => {
                const currentScrollY = window.scrollY;
                
                if (currentScrollY > 10) {
                    header.classList.add('scrolled');
                } else {
                    header.classList.remove('scrolled');
                }
                
                lastScrollY = currentScrollY;
            });
        }

        async showProgress(text, percentage) {
            const overlay = document.getElementById('progress-overlay');
            const title = document.getElementById('progress-title');
            const progressText = document.getElementById('progress-text');
            const progressFill = document.getElementById('progress-fill');
            
            if (overlay && title && progressText && progressFill) {
                overlay.classList.remove('d-none');
                title.textContent = 'Initialisierung...';
                progressText.textContent = text;
                progressFill.style.width = percentage + '%';
                
                // Small delay for visual feedback
                await new Promise(resolve => setTimeout(resolve, 100));
            }
        }

        hideProgress() {
            const overlay = document.getElementById('progress-overlay');
            if (overlay) {
                overlay.classList.add('d-none');
            }
        }

        showCriticalError() {
            document.getElementById('app-content').innerHTML = `
                <div class="d-flex justify-content-center align-items-center" style="height: 60vh;">
                    <div class="text-center p-4" style="background: #ffebee; border-radius: var(--border-radius); border: 1px solid #f44336; max-width: 500px;">
                        <h2 style="color: #d32f2f; margin-bottom: 1rem;">❌ Kritischer Fehler</h2>
                        <p class="mb-3">Die Anwendung konnte nicht vollständig geladen werden.</p>
                        <div class="btn-group">
                            <button onclick="location.reload()" class="btn btn-primary">
                                🔄 Neu laden
                            </button>
                            <button onclick="window.appInstance && window.appInstance.resetData()" class="btn btn-secondary">
                                🗑️ Daten löschen
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        showMobileNavigationHint() {
            if (window.innerWidth <= 1024) {
                setTimeout(() => {
                    this.showToast('💡 Tippen Sie auf den blauen Button für Navigation zwischen den Modulen', 'info', 7000);
                }, 2000);
            } else {
                setTimeout(() => {
                    this.showToast('💡 Das Live-Dashboard unten rechts zeigt personalisierte Empfehlungen', 'info', 5000);
                }, 3000);
            }
        }

        // Enhanced Navigation with Better State Management
        navigate(section) {
            performanceMonitor.startTimer('navigation');
            
            this.state.currentSection = section;
            this.updateNavigationState(section);
            this.loadSection(section);
            this.updateMobileNavigation(section);
            this.updateDashboard(section);
            this.closeMobileNav();
            
            // Track navigation for analytics
            if (this.modules.analytics) {
                this.modules.analytics.trackNavigation(section);
            }
            
            performanceMonitor.endTimer('navigation');
        }

        updateNavigationState(section) {
            // Update both sidebar and mobile navigation
            document.querySelectorAll('.nav-link, .mobile-nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            const sidebarLink = document.querySelector(`.nav-link[href="#${section}"]`);
            const mobileLink = document.querySelector(`.mobile-nav-link[href="#${section}"]`);
            
            if (sidebarLink) sidebarLink.classList.add('active');
            if (mobileLink) mobileLink.classList.add('active');
        }

        updateMobileNavigation(section) {
            const mobileNavToggle = document.querySelector('.mobile-nav-toggle span:first-child');
            if (mobileNavToggle) {
                const sectionNames = {
                    'verkauf': '💰 Verkaufssteuer',
                    'grundsteuer': '🏛️ Grundsteuer',
                    'erbschaft': '👨‍👩‍👧‍👦 Erbschaftsteuer',
                    'schenkung': '🎁 Schenkungssteuer',
                    'cashflow': '📊 Cash-Flow',
                    'strategie': '🎯 Gesamtstrategie'
                };
                mobileNavToggle.textContent = sectionNames[section] || '📱 Navigation';
            }
        }

        updateDashboard(section) {
            if (this.modules.dashboard) {
                this.modules.dashboard.updateForSection(section);
                this.modules.dashboard.updateLiveInsights();
            }
            this.updateSidebarDashboard(); // Nur noch Sidebar Dashboard
        }

        toggleMobileNav() {
            const menu = document.getElementById('mobile-nav-menu');
            const toggle = document.querySelector('.mobile-nav-toggle');
            const arrow = document.getElementById('mobile-nav-arrow');
            
            if (menu && arrow && toggle) {
                const isOpen = menu.classList.contains('show');
                
                if (isOpen) {
                    menu.classList.remove('show');
                    toggle.classList.remove('open');
                    toggle.setAttribute('aria-expanded', 'false');
                    arrow.textContent = '▼';
                } else {
                    menu.classList.add('show');
                    toggle.classList.add('open');
                    toggle.setAttribute('aria-expanded', 'true');
                    arrow.textContent = '▲';
                }
            }
        }

        closeMobileNav() {
            const menu = document.getElementById('mobile-nav-menu');
            const toggle = document.querySelector('.mobile-nav-toggle');
            const arrow = document.getElementById('mobile-nav-arrow');
            
            if (menu && arrow && toggle) {
                menu.classList.remove('show');
                toggle.classList.remove('open');
                toggle.setAttribute('aria-expanded', 'false');
                arrow.textContent = '▼';
            }
        }

        // Enhanced Section Loading with Better Error Handling
        async loadSection(section) {
            const contentDiv = document.getElementById('app-content');
            if (!contentDiv) return;
            
            // Show skeleton loading
            this.showSkeletonLoading(contentDiv);
            
            try {
                // Generate content based on section
                const content = await this.generateSectionContent(section);
                
                // Smooth transition
                contentDiv.style.opacity = '0';
                setTimeout(() => {
                    contentDiv.innerHTML = content;
                    contentDiv.style.opacity = '1';
                    this.attachEventHandlers(section);
                    this.loadSectionData(section);
                    this.triggerAutoCalculation(section);
                    this.updateSectionBadges(section);
                }, 150);
                
            } catch (error) {
                console.error(`Error loading section ${section}:`, error);
                contentDiv.innerHTML = this.generateErrorContent(section, error);
            }
        }

        showSkeletonLoading(container) {
            container.innerHTML = `
                <div class="card">
                    <div class="skeleton skeleton-text" style="height: 2rem; margin-bottom: 1rem;"></div>
                    <div class="skeleton skeleton-text" style="height: 1rem; margin-bottom: 2rem; width: 70%;"></div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                        <div class="skeleton skeleton-card"></div>
                        <div class="skeleton skeleton-card"></div>
                        <div class="skeleton skeleton-card"></div>
                    </div>
                </div>
            `;
        }

        async generateSectionContent(section) {
            const generators = {
                'verkauf': () => this.generateVerkaufView(),
                'grundsteuer': () => this.generateGrundsteuerView(),
                'erbschaft': () => this.generateErbschaftView(),
                'schenkung': () => this.generateSchenkungView(),
                'cashflow': () => this.generateCashFlowView(),
                'strategie': () => this.generateStrategieView()
            };

            const generator = generators[section];
            if (!generator) {
                throw new Error(`Unknown section: ${section}`);
            }

            return generator();
        }

        generateErrorContent(section, error) {
            return `
                <div class="alert alert-error">
                    <div class="alert-content">
                        <h4 class="alert-title">Fehler beim Laden</h4>
                        <p>Der Bereich "${this.getSectionName(section)}" konnte nicht geladen werden.</p>
                        <p><strong>Fehler:</strong> ${error.message}</p>
                        <div class="btn-group mt-2">
                            <button onclick="window.appInstance.navigate('${section}')" class="btn btn-primary">
                                🔄 Erneut versuchen
                            </button>
                            <button onclick="window.appInstance.navigate('verkauf')" class="btn btn-secondary">
                                🏠 Zur Startseite
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        loadSectionData(section) {
            const savedData = this.modules.storage.load('immobilien-suite-data');
            if (savedData) {
                this.populateFormData(savedData);
            }
        }

        triggerAutoCalculation(section) {
            if (this.hasMinimumData(section)) {
                setTimeout(() => {
                    this.triggerCalculation(section);
                }, 500);
            }
        }

        updateSectionBadges(section) {
            // Update badges based on data availability or calculation status
            const badges = {
                'verkauf': this.hasMinimumData('verkauf') ? 'BEREIT' : '',
                'grundsteuer': this.hasMinimumData('grundsteuer') ? 'BEREIT' : '',
                'erbschaft': this.hasMinimumData('erbschaft') ? 'BEREIT' : ''
            };

            Object.entries(badges).forEach(([sectionName, badgeText]) => {
                const badge = document.getElementById(`${sectionName}-badge`);
                if (badge) {
                    if (badgeText) {
                        badge.textContent = badgeText;
                        badge.style.display = 'inline';
                    } else {
                        badge.style.display = 'none';
                    }
                }
            });
        }

        // Enhanced Event Handling with Better Performance
        attachEventHandlers(section) {
            const inputs = document.querySelectorAll('#app-content input, #app-content select');
            
            // Debounced input handler
            const debouncedHandler = this.debounce((input) => {
                this.handleInputChange(input, section);
            }, 300);

            inputs.forEach(input => {
                // Remove existing listeners to prevent duplicates
                input.removeEventListener('input', debouncedHandler);
                input.removeEventListener('change', debouncedHandler);
                
                // Add new listeners
                input.addEventListener('input', () => debouncedHandler(input));
                input.addEventListener('change', () => debouncedHandler(input));
                
                // Add validation on blur
                input.addEventListener('blur', () => this.validateInput(input));
            });

            // Add form validation indicators
            this.setupFormValidation();
        }

        debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        handleInputChange(input, section) {
            this.state.isDirty = true;
            this.validateInput(input);
            
            if (this.config.autoSave) {
                this.saveData();
            }
            
            // Update dashboard immediately on input change
            setTimeout(() => {
                if (this.modules.dashboard) {
                    this.modules.dashboard.updateLiveInsights();
                    this.modules.dashboard.updateSidebarDashboard();
                }
                this.updateDashboardWidget();
                this.updateSidebarDashboard();
            }, 100);
            
            // Auto-calculate if enough data is available
            if (this.hasMinimumData(section)) {
                clearTimeout(this.autoCalculateTimeout);
                this.autoCalculateTimeout = setTimeout(() => {
                    this.triggerCalculation(section);
                }, 1000);
            }
        }

        validateInput(input) {
            if (!this.modules.validation) return;

            const validation = this.modules.validation.validateField(input);
            
            // Remove existing validation classes
            input.classList.remove('error', 'success');
            
            // Remove existing error messages
            const existingError = input.parentNode.querySelector('.form-error');
            if (existingError) {
                existingError.remove();
            }

            if (validation.isValid) {
                input.classList.add('success');
            } else {
                input.classList.add('error');
                
                // Add error message
                const errorDiv = document.createElement('div');
                errorDiv.className = 'form-error';
                errorDiv.innerHTML = `<span>⚠️</span> ${validation.error}`;
                input.parentNode.appendChild(errorDiv);
            }
        }

        setupFormValidation() {
            // Add real-time validation feedback
            const requiredFields = document.querySelectorAll('input[required], select[required]');
            requiredFields.forEach(field => {
                const label = document.querySelector(`label[for="${field.id}"]`);
                if (label && !label.querySelector('.required')) {
                    const required = document.createElement('span');
                    required.className = 'required';
                    required.textContent = '*';
                    label.appendChild(required);
                }
            });
        }

        showExtendedAnalyse() {
            try {
                const formData = this.collectAllFormData();
                const kaufpreis = this.parseNumber(formData.kaufpreis);
                const verkaufspreis = this.parseNumber(formData.verkaufspreis);
                const gewinn = verkaufspreis - kaufpreis;
                const haltedauer = this.parseNumber(formData.haltedauer);
                
                // Strategieempfehlung basierend auf Gewinn und Haltedauer
                let empfehlung = '';
                let timelineAktiv = [];
                
                if (gewinn > 500000) {
                    empfehlung = '🏆 Cross-Border DE-LU/CH Struktur mit EU-Holding';
                    timelineAktiv = ['optimierung', 'exit'];
                } else if (gewinn > 200000) {
                    empfehlung = '🏢 VV GmbH & Co. KG mit Share Deal (40% steuerfrei)';
                    timelineAktiv = haltedauer < 8 ? ['kauf', 'optimierung'] : ['optimierung'];
                } else {
                    empfehlung = '🏠 VV GbR oder Familienpool für einfache Strukturen';
                    timelineAktiv = haltedauer >= 10 ? ['exit'] : ['haltung'];
                }

                const analyseHTML = `
                    <div class="alert alert-success">
                        <div class="alert-content">
                            <div class="alert-title">🔍 Erweiterte Immobilien-Analyse - BFH 2025</div>
                            <div style="margin-top: 15px;">
                                <strong>📈 Portfolio-Bewertung:</strong><br>
                                • Aktueller Verkaufsgewinn: ${this.formatCurrency(gewinn)}<br>
                                • Optimale Rechtsform: ${empfehlung}<br>
                                • Maximales Steueroptimierungspotential: ${this.formatCurrency(gewinn * 0.18)}<br>
                                • Empfohlener Umsetzungszeitraum: ${haltedauer < 8 ? '6-12 Monate' : '3-6 Monate'}
                            </div>
                            
                            <div style="margin-top: 15px;">
                                <strong>⚖️ Rechtliche Rahmenbedingungen 2025:</strong><br>
                                • <strong>BFH-Urteil:</strong> VV GmbH & Co. KG gewerbesteuerfrei bei reiner Vermietung<br>
                                • <strong>Share Deal:</strong> 40% des Gewinns steuerfrei nach §8b KStG<br>
                                • <strong>Zinswende:</strong> Nießbrauchswerte um 20-30% gesunken = Schenkungschancen<br>
                                • <strong>Cross-Border:</strong> EU-Strukturen ab 500k€ Portfolio hochattraktiv
                            </div>
                            
                            <div style="margin-top: 15px;">
                                <strong>💡 Sofort-Optimierungen:</strong><br>
                                1. <strong>Struktur-Check:</strong> Aktuelle Rechtsform binnen 30 Tagen prüfen<br>
                                2. <strong>Timing:</strong> ${haltedauer < 10 ? `Noch ${(10-haltedauer).toFixed(1)} Jahre bis steuerfrei` : 'Verkauf jetzt steuerfrei möglich'}<br>
                                3. <strong>Nachfolge:</strong> ${gewinn > 200000 ? 'Schenkungsstrategie entwickeln' : 'Einfache Übertragung planen'}<br>
                                4. <strong>Portfolio:</strong> Weitere Immobilien in gleicher Struktur bündeln
                            </div>
                        </div>
                    </div>
                    
                    <div class="card mt-4">
                        <div class="card-header">
                            <h3 class="card-title">📝 Konkreter Maßnahmenplan</h3>
                        </div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Priorität</th>
                                    <th>Maßnahme</th>
                                    <th>Zeitrahmen</th>
                                    <th>Kosten</th>
                                    <th>Ersparnis</th>
                                    <th>ROI</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="best-row">
                                    <td>🔥 HOCH</td>
                                    <td><strong>Strukturwechsel VV GmbH & Co. KG</strong></td>
                                    <td>3-6 Monate</td>
                                    <td>${this.formatCurrency(3500)}</td>
                                    <td>${this.formatCurrency(gewinn * 0.15)}</td>
                                    <td>${Math.round((gewinn * 0.15) / 3500)}x</td>
                                </tr>
                                <tr>
                                    <td>⚡ MITTEL</td>
                                    <td>Steuerliches Gutachten Immobilienwert</td>
                                    <td>1-2 Monate</td>
                                    <td>${this.formatCurrency(2000)}</td>
                                    <td>${this.formatCurrency(gewinn * 0.08)}</td>
                                    <td>${Math.round((gewinn * 0.08) / 2000)}x</td>
                                </tr>
                                <tr>
                                    <td>📋 LANG</td>
                                    <td>Nachfolgeplanung & Schenkungsstrategie</td>
                                    <td>6-18 Monate</td>
                                    <td>${this.formatCurrency(4500)}</td>
                                    <td>${this.formatCurrency(gewinn * 0.25)}</td>
                                    <td>${Math.round((gewinn * 0.25) / 4500)}x</td>
                                </tr>
                                ${gewinn > 500000 ? `
                                <tr>
                                    <td>🌍 EXPERT</td>
                                    <td>Cross-Border Struktur (DE-LU/CH)</td>
                                    <td>6-12 Monate</td>
                                    <td>${this.formatCurrency(15000)}</td>
                                    <td>${this.formatCurrency(gewinn * 0.18)}</td>
                                    <td>${Math.round((gewinn * 0.18) / 15000)}x</td>
                                </tr>
                                ` : ''}
                            </tbody>
                        </table>
                    </div>

                    <div class="alert alert-warning mt-3">
                        <div class="alert-content">
                            <div class="alert-title">⚠️ Wichtige Fristen & Deadlines</div>
                            <p><strong>3-Objekte-Regel:</strong> Max. 3 Verkäufe in 5 Jahren für Vermögensverwaltung<br>
                            <strong>10-Jahres-Frist:</strong> ${haltedauer >= 10 ? '✅ Erreicht - steuerfrei!' : `⏰ Noch ${(10-haltedauer).toFixed(1)} Jahre`}<br>
                            <strong>Schenkung-Freibeträge:</strong> Alle 10 Jahre neu nutzbar<br>
                            <strong>BFH-Rechtsprechung:</strong> Aktuell gültig, aber Gesetzesänderungen möglich</p>
                        </div>
                    </div>
                `;

                // Zur Strategie-Sektion wechseln und Analyse anzeigen
                this.navigate('strategie');
                setTimeout(() => {
                    const container = document.getElementById('strategie-results');
                    if (container) {
                        container.innerHTML = analyseHTML;
                    }
                }, 300);
                
                this.showToast('🔍 Erweiterte Analyse wurde erstellt', 'success');
                
            } catch (error) {
                console.error('Extended analysis error:', error);
                this.showToast('❌ Fehler bei der erweiterten Analyse', 'error');
            }
        }

        // Enhanced Dashboard Widget Management
        showDashboardWidget() {
            try {
                const existingWidget = document.querySelector('.dashboard-widget');
                if (existingWidget) {
                    existingWidget.remove();
                }

                const widget = document.createElement('div');
                widget.className = 'dashboard-widget pulsing';
                widget.innerHTML = `
                    <div class="widget-header">
                        <h4 class="widget-title">
                            <span>💡</span>
                            Live-Insights & Empfehlungen
                        </h4>
                        <button class="widget-close" onclick="this.parentElement.parentElement.remove()" aria-label="Dashboard schließen">×</button>
                    </div>
                    <div id="floating-dashboard-content">
                        <div class="widget-item">
                            <div style="font-weight: 600; color: #3498db; margin-bottom: 5px;">🔄 Lade aktuelle Insights...</div>
                            <div style="font-size: 0.9em;">Basierend auf Ihren Eingaben</div>
                        </div>
                    </div>
                    <div class="widget-footer">
                        Live-Updates • BFH 2025 • Aktualisiert alle 3 Sekunden
                    </div>
                `;
                
                document.body.appendChild(widget);
                
                // Load content after a short delay
                setTimeout(() => {
                    this.updateDashboardWidget();
                }, 300);
                
                // Update insights every 3 seconds
                const updateInterval = setInterval(() => {
                    if (document.querySelector('.dashboard-widget')) {
                        this.updateDashboardWidget();
                    } else {
                        clearInterval(updateInterval);
                    }
                }, 3000);

                // Add interaction tracking
                if (this.modules.analytics) {
                    this.modules.analytics.trackDashboardView();
                }
                
                // Show success message
                this.showToast('💡 Live-Dashboard aktiviert - Updates alle 3 Sekunden', 'success');
                
            } catch (error) {
                console.error('Dashboard widget error:', error);
                this.showToast('⚠️ Dashboard konnte nicht geladen werden', 'warning');
            }
        }

        updateDashboardWidget() {
            try {
                const floatingDashboard = document.querySelector('.dashboard-widget');
                const floatingContent = document.getElementById('floating-dashboard-content');
                
                if (floatingDashboard && floatingContent) {
                    floatingContent.innerHTML = this.generateCurrentInsights();
                }
            } catch (error) {
                console.error('Dashboard widget update error:', error);
                // Silently fail for dashboard updates - don't break main functionality
            }
        }

        generateCurrentInsights() {
            try {
                const activeSection = this.getCurrentSection();
                
                const generators = {
                    'verkauf': () => this.generateVerkaufInsights(),
                    'cashflow': () => this.generateCashFlowInsights(),
                    'grundsteuer': () => this.generateGrundsteuerInsights(),
                    'erbschaft': () => this.generateErbschaftInsights(),
                    'schenkung': () => this.generateSchenkungInsights(),
                    'strategie': () => this.generateStrategieInsights()
                };

                const generator = generators[activeSection];
                return generator ? generator() : this.generateDefaultInsights();
            } catch (error) {
                console.error('Insights generation error:', error);
                return this.generateDefaultInsights();
            }
        }

        // Enhanced Calculation Methods for all sections
        async calculateVerkauf() {
            try {
                this.showCalculationProgress('Berechne alle Rechtsformen...', 20);
                
                if (!this.modules.calculator) {
                    throw new Error('Berechnungsmodul nicht verfügbar');
                }

                const data = this.collectVerkaufData();
                
                this.showCalculationProgress('Validiere Eingaben...', 40);
                
                if (this.modules.validation) {
                    const validation = this.modules.validation.validateVerkaufData(data);
                    if (!validation.isValid) {
                        throw new Error(validation.errors.join(', '));
                    }
                }

                this.showCalculationProgress('Berechne Steueroptimierung...', 80);
                
                const results = await this.modules.calculator.calculateVerkaufsteuer(data);
                
                this.showCalculationProgress('Erstelle Ergebnisse...', 100);
                
                this.displayVerkaufResults(results);
                this.cacheCalculationResults('verkauf', results);
                
                if (this.modules.dashboard) {
                    this.modules.dashboard.updateWithResults('verkauf', results);
                    this.modules.dashboard.updateLiveInsights();
                }
                
                this.updateDashboardWidget();
                this.showToast('🧮 Alle 14 Rechtsformen erfolgreich berechnet', 'success');
                
                // Track successful calculation
                if (this.modules.analytics) {
                    this.modules.analytics.trackCalculation('verkauf', results);
                }
                
            } catch (error) {
                console.error('Calculation error:', error);
                this.showToast('❌ Fehler bei der Berechnung: ' + error.message, 'error');
            } finally {
                // Always hide progress, regardless of success or failure
                setTimeout(() => {
                    this.hideCalculationProgress();
                }, 500);
            }
        }

        async calculateGrundsteuer() {
            try {
                this.showCalculationProgress('Berechne Grundsteuer...', 50);
                const data = this.collectGrundsteuerData();
                const results = this.performGrundsteuerCalculation(data);
                this.displayGrundsteuerResults(results);
                this.showToast('🏛️ Grundsteuer berechnet', 'success');
            } catch (error) {
                console.error('Grundsteuer calculation error:', error);
                this.showToast('❌ Fehler bei der Grundsteuer-Berechnung: ' + error.message, 'error');
            } finally {
                setTimeout(() => this.hideCalculationProgress(), 500);
            }
        }

        async calculateErbschaft() {
            try {
                this.showCalculationProgress('Berechne Erbschaftsteuer...', 50);
                const data = this.collectErbschaftData();
                const results = this.performErbschaftCalculation(data);
                this.displayErbschaftResults(results);
                this.showToast('👨‍👩‍👧‍👦 Erbschaftsteuer berechnet', 'success');
            } catch (error) {
                console.error('Erbschaft calculation error:', error);
                this.showToast('❌ Fehler bei der Erbschaftsteuer-Berechnung: ' + error.message, 'error');
            } finally {
                setTimeout(() => this.hideCalculationProgress(), 500);
            }
        }

        async calculateSchenkung() {
            try {
                this.showCalculationProgress('Berechne Schenkungssteuer...', 50);
                const data = this.collectSchenkungData();
                const results = this.performSchenkungCalculation(data);
                this.displaySchenkungResults(results);
                this.showToast('🎁 Schenkungssteuer berechnet', 'success');
            } catch (error) {
                console.error('Schenkung calculation error:', error);
                this.showToast('❌ Fehler bei der Schenkungssteuer-Berechnung: ' + error.message, 'error');
            } finally {
                setTimeout(() => this.hideCalculationProgress(), 500);
            }
        }

        async calculateCashFlow() {
            try {
                this.showCalculationProgress('Analysiere Cash-Flow...', 50);
                const data = this.collectCashFlowData();
                const results = this.performCashFlowCalculation(data);
                this.displayCashFlowResults(results);
                this.showToast('📊 Cash-Flow analysiert', 'success');
            } catch (error) {
                console.error('Cash-Flow calculation error:', error);
                this.showToast('❌ Fehler bei der Cash-Flow-Analyse: ' + error.message, 'error');
            } finally {
                setTimeout(() => this.hideCalculationProgress(), 500);
            }
        }

        async calculateStrategie() {
            try {
                this.showCalculationProgress('Entwickle Strategie...', 50);
                const data = this.collectStrategieData();
                const results = this.performStrategieCalculation(data);
                this.displayStrategieResults(results);
                this.showToast('🎯 Strategie entwickelt', 'success');
            } catch (error) {
                console.error('Strategie calculation error:', error);
                this.showToast('❌ Fehler bei der Strategie-Entwicklung: ' + error.message, 'error');
            } finally {
                setTimeout(() => this.hideCalculationProgress(), 500);
            }
        }

        // Data Collection Methods
        collectGrundsteuerData() {
            return {
                grundstueckswert: this.parseNumber(this.getElementValue('grundstueckswert'), 0),
                immobilientyp: this.getElementValue('immobilientyp', 'mietwohnung'),
                hebesatz: this.parseNumber(this.getElementValue('hebesatz'), 520),
                modell: this.getElementValue('grundsteuer_modell', 'bundesmodell'),
                nutzungsart: this.getElementValue('nutzungsart', 'vermietung'),
                wohnflaeche: this.parseNumber(this.getElementValue('wohnflaeche_grund'), 120)
            };
        }

        collectErbschaftData() {
            return {
                immobilienwert: this.parseNumber(this.getElementValue('immobilienwert_erbe'), 0),
                weiteresVermoegen: this.parseNumber(this.getElementValue('weiteres_vermoegen'), 0),
                schulden: this.parseNumber(this.getElementValue('schulden'), 0),
                verwandtschaftsgrad: this.getElementValue('verwandtschaftsgrad', 'kind'),
                wohnflaeche: this.parseNumber(this.getElementValue('wohnflaeche'), 150),
                selbstnutzungErblasser: this.getElementValue('selbstnutzung_erblasser', 'ja'),
                selbstnutzungErbe: this.getElementValue('selbstnutzung_erbe', 'ja'),
                erbschaftstyp: this.getElementValue('erbschaftstyp', 'erbschaft')
            };
        }

        collectSchenkungData() {
            return {
                immobilienwert: this.parseNumber(this.getElementValue('schenkung_immobilienwert'), 0),
                anteil: this.parseNumber(this.getElementValue('schenkung_anteil'), 50),
                verwandtschaft: this.getElementValue('schenkung_verwandtschaft', 'child'),
                niessbrauch: this.getElementValue('niessbrauch', 'ja'),
                jahresmiete: this.parseNumber(this.getElementValue('jahresmiete_schenkung'), 22000),
                alterSchenker: this.parseNumber(this.getElementValue('alter_schenker'), 65),
                vorherigeSchenkungen: this.parseNumber(this.getElementValue('vorherige_schenkungen'), 0),
                geplanteschritte: this.parseNumber(this.getElementValue('geplante_schritte'), 3)
            };
        }

        collectCashFlowData() {
            return {
                jahresmiete: this.parseNumber(this.getElementValue('cf_jahresmiete'), 0),
                mietsteigerung: this.parseNumber(this.getElementValue('cf_mietsteigerung'), 2.5),
                instandhaltung: this.parseNumber(this.getElementValue('cf_instandhaltung'), 2500),
                verwaltung: this.parseNumber(this.getElementValue('cf_verwaltung'), 800),
                versicherung: this.parseNumber(this.getElementValue('cf_versicherung'), 600),
                leerstand: this.parseNumber(this.getElementValue('cf_leerstand'), 2),
                finanzierung: this.parseNumber(this.getElementValue('cf_finanzierung'), 8000),
                tilgung: this.parseNumber(this.getElementValue('cf_tilgung'), 6000),
                immobilienwert: this.parseNumber(this.getElementValue('cf_immobilienwert'), 600000),
                wertsteigerung: this.parseNumber(this.getElementValue('cf_wertsteigerung'), 2),
                betrachtungszeitraum: this.parseNumber(this.getElementValue('cf_betrachtungszeitraum'), 15)
            };
        }

        collectStrategieData() {
            return {
                alter: this.parseNumber(this.getElementValue('strategie_alter'), 0),
                risiko: this.getElementValue('strategie_risiko', 'mittel'),
                liquiditaet: this.getElementValue('strategie_liquiditaet', 'mittel'),
                nachfolge: this.getElementValue('strategie_nachfolge', 'kinder'),
                weitereImmobilien: this.getElementValue('strategie_weitere_immobilien', 'wenige'),
                einkommen: this.parseNumber(this.getElementValue('strategie_einkommen'), 85000),
                vermoegen: this.getElementValue('strategie_vermoegen', '500k_1m'),
                komplexitaet: this.getElementValue('strategie_komplexitaet', 'mittel')
            };
        }

        // Simplified Calculation Methods
        performGrundsteuerCalculation(data) {
            const grundsteuerMessbetrag = data.grundstueckswert * 0.31 / 1000;
            const grundsteuer = grundsteuerMessbetrag * data.hebesatz / 100;
            
            return {
                jahressteuer: grundsteuer,
                messbetrag: grundsteuerMessbetrag,
                hebesatz: data.hebesatz,
                steuerersparnis: grundsteuer * 0.42, // At 42% tax rate
                empfehlung: grundsteuer > 2000 ? 'Optimierung prüfen' : 'Steuer moderat'
            };
        }

        performErbschaftCalculation(data) {
            const freibetraege = {
                'ehepartner': 500000, 'kind': 400000, 'enkel': 200000,
                'eltern': 100000, 'geschwister': 20000, 'andere': 20000
            };
            
            const freibetrag = freibetraege[data.verwandtschaftsgrad] || 20000;
            const nettoVermoegen = data.immobilienwert * 0.9 + data.weiteresVermoegen - data.schulden;
            const steuerpflichtigerBetrag = Math.max(0, nettoVermoegen - freibetrag);
            
            // Simplified tax calculation
            const steuersatz = steuerpflichtigerBetrag > 0 ? 15 : 0; // Simplified
            const erbschaftsteuer = steuerpflichtigerBetrag * steuersatz / 100;
            
            return {
                nettoVermoegen,
                freibetrag,
                steuerpflichtigerBetrag,
                erbschaftsteuer,
                empfehlung: erbschaftsteuer > 50000 ? 'Optimierung empfohlen' : 'Moderate Belastung'
            };
        }

        performSchenkungCalculation(data) {
            const schenkungswert = data.immobilienwert * data.anteil / 100;
            const freibetraege = { 'ehepartner': 500000, 'child': 400000, 'enkel': 200000 };
            const freibetrag = freibetraege[data.verwandtschaft] || 20000;
            
            let effektiverWert = schenkungswert;
            
            // Nießbrauch reduction
            if (data.niessbrauch === 'ja') {
                const kapitalisierungsfaktor = Math.max(0.5, (100 - data.alterSchenker) / 100);
                const niesbrauchswert = data.jahresmiete * kapitalisierungsfaktor * 18.6;
                effektiverWert = schenkungswert - niesbrauchswert;
            }
            
            const steuerpflichtig = Math.max(0, effektiverWert - freibetrag);
            const schenkungsteuer = steuerpflichtig * 0.15; // Simplified 15%
            
            return {
                schenkungswert,
                effektiverWert,
                freibetrag,
                steuerpflichtig,
                schenkungsteuer,
                ersparnis: schenkungswert - effektiverWert,
                empfehlung: 'Nießbrauch nutzen für Optimierung'
            };
        }

        performCashFlowCalculation(data) {
            const years = [];
            let kumulierteCashFlow = 0;
            
            for (let jahr = 1; jahr <= data.betrachtungszeitraum; jahr++) {
                const jahresmiete = data.jahresmiete * Math.pow(1 + data.mietsteigerung / 100, jahr - 1);
                const leerstandskosten = jahresmiete * data.leerstand / 100;
                const nettoMiete = jahresmiete - leerstandskosten;
                
                const gesamtkosten = data.instandhaltung + data.verwaltung + data.versicherung + data.finanzierung;
                const cashFlow = nettoMiete - gesamtkosten;
                kumulierteCashFlow += cashFlow;
                
                years.push({
                    jahr,
                    jahresmiete: Math.round(jahresmiete),
                    cashFlow: Math.round(cashFlow),
                    kumuliert: Math.round(kumulierteCashFlow)
                });
            }
            
            const wertsteigerung = data.immobilienwert * Math.pow(1 + data.wertsteigerung / 100, data.betrachtungszeitraum) - data.immobilienwert;
            const gesamtrendite = kumulierteCashFlow + wertsteigerung;
            
            return {
                years,
                gesamtCashFlow: kumulierteCashFlow,
                wertsteigerung,
                gesamtrendite,
                jaehrlicheRendite: (gesamtrendite / data.immobilienwert / data.betrachtungszeitraum * 100),
                empfehlung: gesamtrendite > 0 ? 'Positive Gesamtrendite' : 'Überprüfung empfohlen'
            };
        }

        performStrategieCalculation(data) {
            let empfehlungen = [];
            
            // Age-based recommendations
            if (data.alter < 40) {
                empfehlungen.push('Langfristige Vermögensaufbau-Strategie');
                empfehlungen.push('VV GmbH & Co. KG für steueroptimierte Reinvestition');
            } else if (data.alter < 55) {
                empfehlungen.push('Balancierte Wachstums- und Sicherheitsstrategie');
                empfehlungen.push('Schrittweise Schenkungen zur Nachfolgeplanung');
            } else {
                empfehlungen.push('Fokus auf Nachfolgeplanung und Steueroptimierung');
                empfehlungen.push('Nießbrauch-Strategien für Vermögensübertragung');
            }
            
            // Risk-based recommendations
            if (data.risiko === 'hoch' && data.alter < 50) {
                empfehlungen.push('Cross-Border-Strukturen für internationale Diversifikation');
            }
            
            return {
                empfehlungen,
                zeitrahmen: data.alter < 40 ? '20+ Jahre' : data.alter < 55 ? '10-20 Jahre' : '5-15 Jahre',
                prioritaet: data.alter > 60 ? 'Nachfolgeplanung' : 'Vermögensaufbau',
                komplexitaet: data.komplexitaet,
                naechsteSchritte: [
                    'Detaillierte Steueranalyse durchführen',
                    'Rechtliche Struktur implementieren',
                    'Regelmäßige Optimierung (jährlich)'
                ]
            };
        }

        showCalculationProgress(text, percentage) {
            try {
                const overlay = document.getElementById('progress-overlay');
                const title = document.getElementById('progress-title');
                const progressText = document.getElementById('progress-text');
                const progressFill = document.getElementById('progress-fill');
                
                if (overlay && title && progressText && progressFill) {
                    overlay.classList.remove('d-none');
                    overlay.style.display = 'flex';
                    title.textContent = 'Berechnung läuft...';
                    progressText.textContent = text;
                    progressFill.style.width = percentage + '%';
                    
                    // Failsafe: Auto-hide after 5 seconds
                    if (this.progressTimeout) {
                        clearTimeout(this.progressTimeout);
                    }
                    this.progressTimeout = setTimeout(() => {
                        this.hideCalculationProgress();
                        this.showToast('⚠️ Berechnung dauerte zu lange - bitte erneut versuchen', 'warning');
                    }, 5000);
                }
            } catch (error) {
                console.error('Progress display error:', error);
                // If progress display fails, continue anyway
            }
        }

        hideCalculationProgress() {
            // Clear timeout first
            if (this.progressTimeout) {
                clearTimeout(this.progressTimeout);
                this.progressTimeout = null;
            }
            
            // Multiple attempts to hide the overlay
            const overlay = document.getElementById('progress-overlay');
            if (overlay) {
                // Method 1: Standard hiding
                overlay.classList.add('d-none');
                overlay.style.display = 'none';
                overlay.style.visibility = 'hidden';
                
                // Method 2: Force hide with important styles
                overlay.setAttribute('style', 'display: none !important; visibility: hidden !important;');
                
                // Method 3: Remove from DOM temporarily then restore (nuclear option)
                setTimeout(() => {
                    if (overlay.style.display !== 'none') {
                        const parent = overlay.parentNode;
                        const nextSibling = overlay.nextSibling;
                        parent.removeChild(overlay);
                        setTimeout(() => {
                            parent.insertBefore(overlay, nextSibling);
                            overlay.classList.add('d-none');
                            overlay.style.display = 'none';
                        }, 100);
                    }
                }, 100);
            }
                    overlay.style.display = 'none';
                }
            } catch (e) {
                console.error('Force hide failed:', e);
                // Last resort - try to find and hide any progress overlay
                const overlays = document.querySelectorAll('[id*="progress"]');
                overlays.forEach(el => {
                    try {
                        el.style.display = 'none';
                    } catch (err) {
                        // Silent fail
                    }
                });
            }
        }

        cacheCalculationResults(section, results) {
            const cacheKey = `${section}_results_${Date.now()}`;
            this.cache.set(cacheKey, {
                results,
                timestamp: Date.now(),
                section
            });

            // Clean old cache entries
            this.cleanCache();
        }

        cleanCache() {
            const maxAge = this.config.cacheTimeout;
            const now = Date.now();
            
            for (const [key, value] of this.cache.entries()) {
                if (now - value.timestamp > maxAge) {
                    this.cache.delete(key);
                }
            }
        }

        // Enhanced Data Management
        saveData() {
            try {
                const formData = this.collectAllFormData();
                const metadata = {
                    version: this.config.version,
                    timestamp: Date.now(),
                    section: this.state.currentSection,
                    userAgent: navigator.userAgent
                };
                
                this.modules.storage.save('immobilien-suite-data', { formData, metadata });
                this.state.lastSave = Date.now();
                this.state.isDirty = false;
                
                // Erfolgs-Feedback für den User
                this.showToast('✅ Daten erfolgreich gespeichert', 'success');
                
                if (this.config.debug) {
                    console.log('Data saved successfully');
                }
                
            } catch (error) {
                console.error('Error saving data:', error);
                this.showToast('⚠️ Daten konnten nicht gespeichert werden', 'warning');
            }
        }

        loadData() {
            try {
                const savedData = this.modules.storage.load('immobilien-suite-data');
                if (savedData && savedData.formData) {
                    this.populateFormData(savedData.formData);
                    this.state.lastSave = savedData.metadata?.timestamp || null;
                    
                    if (this.config.debug) {
                        console.log('Data loaded successfully');
                    }
                }
            } catch (error) {
                console.error('Error loading data:', error);
                this.showToast('⚠️ Gespeicherte Daten konnten nicht geladen werden', 'warning');
            }
        }

        // Enhanced Toast System with Better UX
        showToast(message, type = 'info', duration = 5000) {
            const toastContainer = document.getElementById('toast-container');
            if (!toastContainer) return;
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const toastId = 'toast_' + Date.now();
            toast.innerHTML = `
                <div class="toast-header">
                    <span class="toast-title">${this.getToastTitle(type)}</span>
                    <button class="toast-close" onclick="this.parentElement.parentElement.remove()" aria-label="Benachrichtigung schließen">×</button>
                </div>
                <div class="toast-body">${message}</div>
            `;
            
            toastContainer.appendChild(toast);
            
            // Auto-remove after duration
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.style.animation = 'slideOutToast 0.3s ease forwards';
                    setTimeout(() => {
                        if (toast.parentNode) {
                            toastContainer.removeChild(toast);
                        }
                    }, 300);
                }
            }, duration);

            // Track toast for analytics
            if (this.modules.analytics) {
                this.modules.analytics.trackToast(type, message);
            }
        }

        getToastTitle(type) {
            const titles = {
                'success': '✅ Erfolgreich',
                'error': '❌ Fehler',
                'warning': '⚠️ Warnung',
                'info': 'ℹ️ Information'
            };
            return titles[type] || 'ℹ️ Benachrichtigung';
        }

        // Enhanced Form Generation Methods
        generateVerkaufView() {
            return `
                <div class="card">
                    <div class="card-header">
                        <div>
                            <h2 class="card-title">
                                <span>💰</span>
                                Verkaufssteuer-Vergleich 2025
                            </h2>
                            <p class="card-subtitle">Alle 14 Rechtsformen im direkten Vergleich mit BFH-aktueller Rechtsprechung</p>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <div class="alert-content">
                            <div class="alert-title">🎯 BFH-Update 2025 + Neue Strukturen</div>
                            <p>VV GmbH & Co. KG ist bei reiner Vermögensverwaltung gewerbesteuerfrei! 
                            Zusätzlich: Familienpools, Asset vs. Share Deals, Bruchteilsgemeinschaften 
                            und Cross-Border-Strukturen für maximale Optimierung.</p>
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label" for="kaufpreis">
                                <span>🏠</span> Kaufpreis <span class="required">*</span>
                            </label>
                            <div class="input-group">
                                <input type="number" id="kaufpreis" class="form-input" value="400000" min="0" required 
                                       aria-describedby="kaufpreis-help">
                                <span class="input-icon">€</span>
                            </div>
                            <div class="form-help" id="kaufpreis-help">Ursprünglicher Erwerbspreis der Immobilie</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="verkaufspreis">
                                <span>💸</span> Verkaufspreis <span class="required">*</span>
                            </label>
                            <div class="input-group">
                                <input type="number" id="verkaufspreis" class="form-input" value="600000" min="0" required
                                       aria-describedby="verkaufspreis-help">
                                <span class="input-icon">€</span>
                            </div>
                            <div class="form-help" id="verkaufspreis-help">Geplanter oder erzielter Verkaufspreis</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="nebenkosten_kauf">
                                <span>📋</span> Nebenkosten Kauf
                            </label>
                            <div class="input-group">
                                <input type="number" id="nebenkosten_kauf" class="form-input" value="40000" min="0"
                                       aria-describedby="nebenkosten-kauf-help">
                                <span class="input-icon">€</span>
                            </div>
                            <div class="form-help" id="nebenkosten-kauf-help">Notar, Grunderwerbsteuer, Makler beim Kauf</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="nebenkosten_verkauf">
                                <span>📋</span> Nebenkosten Verkauf
                            </label>
                            <div class="input-group">
                                <input type="number" id="nebenkosten_verkauf" class="form-input" value="30000" min="0"
                                       aria-describedby="nebenkosten-verkauf-help">
                                <span class="input-icon">€</span>
                            </div>
                            <div class="form-help" id="nebenkosten-verkauf-help">Makler, Notar, Marketing beim Verkauf</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="modernisierung">
                                <span>🔧</span> Modernisierung/Herstellungskosten
                            </label>
                            <div class="input-group">
                                <input type="number" id="modernisierung" class="form-input" value="35000" min="0"
                                       aria-describedby="modernisierung-help">
                                <span class="input-icon">€</span>
                            </div>
                            <div class="form-help" id="modernisierung-help">Anschaffungsnahe Herstellungskosten (erste 3 Jahre)</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="haltedauer">
                                <span>⏰</span> Haltedauer <span class="required">*</span>
                            </label>
                            <div class="input-group">
                                <input type="number" id="haltedauer" class="form-input" value="8" min="0" max="50" step="0.1" required
                                       aria-describedby="haltedauer-help">
                                <span class="input-icon">Jahre</span>
                            </div>
                            <div class="form-help" id="haltedauer-help">Entscheidend für Spekulationssteuer (10-Jahres-Frist)</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="steuersatz">
                                <span>📊</span> Persönlicher Steuersatz
                            </label>
                            <select id="steuersatz" class="form-select" aria-describedby="steuersatz-help">
                                <option value="14">14% (Eingangssteuersatz)</option>
                                <option value="24">24% (Durchschnittseinkommen)</option>
                                <option value="35">35% (Gehobenes Einkommen)</option>
                                <option value="42" selected>42% (Spitzensteuersatz ab 66.761€)</option>
                                <option value="45">45% (Reichensteuer ab 277.826€)</option>
                            </select>
                            <div class="form-help" id="steuersatz-help">2025: 42% ab 66.761€, 45% ab 277.826€</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="kirchensteuer">
                                <span>⛪</span> Kirchensteuer
                            </label>
                            <select id="kirchensteuer" class="form-select" aria-describedby="kirchensteuer-help">
                                <option value="0">0% (konfessionslos)</option>
                                <option value="8" selected>8% (Bayern/Baden-Württemberg)</option>
                                <option value="9">9% (andere Bundesländer)</option>
                            </select>
                            <div class="form-help" id="kirchensteuer-help">8% in Bayern/BW, 9% in anderen Bundesländern</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="bundesland">
                                <span>🗺️</span> Bundesland
                            </label>
                            <select id="bundesland" class="form-select" aria-describedby="bundesland-help">
                                <option value="bw">Baden-Württemberg</option>
                                <option value="by">Bayern</option>
                                <option value="be">Berlin</option>
                                <option value="bb">Brandenburg</option>
                                <option value="hb">Bremen</option>
                                <option value="hh">Hamburg</option>
                                <option value="he">Hessen</option>
                                <option value="mv">Mecklenburg-Vorpommern</option>
                                <option value="ni">Niedersachsen</option>
                                <option value="nw" selected>Nordrhein-Westfalen</option>
                                <option value="rp">Rheinland-Pfalz</option>
                                <option value="sl">Saarland</option>
                                <option value="sn">Sachsen</option>
                                <option value="st">Sachsen-Anhalt</option>
                                <option value="sh">Schleswig-Holstein</option>
                                <option value="th">Thüringen</option>
                            </select>
                            <div class="form-help" id="bundesland-help">Für Gewerbesteuer-Hebesatz relevant</div>
                        </div>
                    </div>

                    <div class="btn-group w-100 mt-4">
                        <button class="btn btn-primary" onclick="window.appInstance && window.appInstance.calculateVerkauf()" 
                                style="flex: 2;" aria-describedby="calculate-help">
                            🧮 Alle immobilienrelevanten Strukturen vergleichen
                        </button>
                        <button class="btn btn-secondary" onclick="window.appInstance && window.appInstance.saveData()" 
                                style="flex: 1; min-width: 100px;" aria-label="Eingaben speichern">
                            💾 Sichern
                        </button>
                    </div>
                    <div class="form-help text-center mt-2" id="calculate-help">
                        Intelligenter Vergleich aller für Immobilien geeigneten Rechtsformen - inkl. Familienpools, Asset/Share Deals
                    </div>
                </div>

                <div id="verkauf-results" aria-live="polite">
                    <!-- Results will be inserted here -->
                </div>
            `;
        }

        generateGrundsteuerView() {
            return `
                <div class="card">
                    <div class="card-header">
                        <div>
                            <h2 class="card-title">
                                <span>🏛️</span>
                                Grundsteuer-Reform 2025
                            </h2>
                            <p class="card-subtitle">Berechnung nach neuen Bewertungsmaßstäben mit allen Ländermodellen</p>
                        </div>
                    </div>
                    
                    <div class="alert alert-warning">
                        <div class="alert-content">
                            <div class="alert-title">⚠️ Wichtige Änderung</div>
                            <p>Die neue Grundsteuer kann erheblich von der bisherigen abweichen. 
                            Unterschiede von 100-300% sind möglich, besonders in begehrten Lagen!</p>
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label" for="grundstueckswert">
                                <span>🏠</span> Grundsteuerwert <span class="required">*</span>
                            </label>
                            <div class="input-group">
                                <input type="number" id="grundstueckswert" class="form-input" value="420000" min="0" required>
                                <span class="input-icon">€</span>
                            </div>
                            <div class="form-help">Laut Grundsteuerwertbescheid 2022/2023</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="immobilientyp">
                                <span>🏗️</span> Immobilientyp
                            </label>
                            <select id="immobilientyp" class="form-select">
                                <option value="einfamilienhaus">Ein-/Zweifamilienhaus</option>
                                <option value="mietwohnung" selected>Mietwohngrundstück</option>
                                <option value="eigentumswohnung">Eigentumswohnung</option>
                                <option value="gewerbe">Gewerbegrundstück</option>
                                <option value="unbebaut">Unbebautes Grundstück</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="hebesatz">
                                <span>⚖️</span> Hebesatz Gemeinde
                            </label>
                            <div class="input-group">
                                <input type="number" id="hebesatz" class="form-input" value="520" min="0" max="2000">
                                <span class="input-icon">%</span>
                            </div>
                            <div class="form-help">Grundsteuer B - stark unterschiedlich je Gemeinde (200-900%)</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="grundsteuer_modell">
                                <span>🗺️</span> Grundsteuer-Modell
                            </label>
                            <select id="grundsteuer_modell" class="form-select">
                                <option value="bundesmodell" selected>Bundesmodell (Standard)</option>
                                <option value="bw">Baden-Württemberg (Bodenwert)</option>
                                <option value="by">Bayern (Flächenmodell)</option>
                                <option value="hh">Hamburg (Wohnlagenwert)</option>
                                <option value="he">Hessen (Flächen-Lage-Modell)</option>
                                <option value="ni">Niedersachsen (Flächen-Faktor)</option>
                                <option value="sl">Saarland (Modifikation)</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="nutzungsart">
                                <span>🏘️</span> Nutzungsart
                            </label>
                            <select id="nutzungsart" class="form-select">
                                <option value="vermietung" selected>Vermietung</option>
                                <option value="eigennutzung">Eigennutzung</option>
                                <option value="gewerbe">Gewerbliche Nutzung</option>
                                <option value="leerstand">Leerstand</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="wohnflaeche_grund">
                                <span>📐</span> Wohnfläche
                            </label>
                            <div class="input-group">
                                <input type="number" id="wohnflaeche_grund" class="form-input" value="120" min="0">
                                <span class="input-icon">m²</span>
                            </div>
                            <div class="form-help">Für einige Ländermodelle relevant</div>
                        </div>
                    </div>

                    <button class="btn btn-primary w-100 mt-4" onclick="window.appInstance && window.appInstance.calculateGrundsteuer()">
                        🏛️ Grundsteuer berechnen
                    </button>
                </div>

                <div id="grundsteuer-results" aria-live="polite">
                    <!-- Results will be inserted here -->
                </div>
            `;
        }

        generateErbschaftView() {
            return `
                <div class="card">
                    <div class="card-header">
                        <div>
                            <h2 class="card-title">
                                <span>👨‍👩‍👧‍👦</span>
                                Erbschaftsteuer-Planung
                            </h2>
                            <p class="card-subtitle">Optimale Nachfolgeplanung mit Familienheim-Befreiung und Freibeträgen</p>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <div class="alert-content">
                            <div class="alert-title">💡 Erbschaftsteuer 2025</div>
                            <p>Immobilienbewertung oft nur 90% des Verkehrswerts. 
                            Familienheim-Befreiung kann erhebliche Steuervorteile bringen!</p>
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label" for="immobilienwert_erbe">
                                <span>🏠</span> Immobilienwert <span class="required">*</span>
                            </label>
                            <div class="input-group">
                                <input type="number" id="immobilienwert_erbe" class="form-input" value="580000" min="0" required>
                                <span class="input-icon">€</span>
                            </div>
                            <div class="form-help">Erbschaftsteuerlicher Wert (oft 90% des Verkehrswerts)</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="weiteres_vermoegen">
                                <span>💰</span> Weiteres Vermögen
                            </label>
                            <div class="input-group">
                                <input type="number" id="weiteres_vermoegen" class="form-input" value="100000" min="0">
                                <span class="input-icon">€</span>
                            </div>
                            <div class="form-help">Geld, Aktien, weitere Immobilien</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="schulden">
                                <span>💳</span> Schulden/Verbindlichkeiten
                            </label>
                            <div class="input-group">
                                <input type="number" id="schulden" class="form-input" value="50000" min="0">
                                <span class="input-icon">€</span>
                            </div>
                            <div class="form-help">Kredite, Hypotheken etc.</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="verwandtschaftsgrad">
                                <span>👥</span> Verwandtschaftsgrad
                            </label>
                            <select id="verwandtschaftsgrad" class="form-select">
                                <option value="ehepartner">Ehepartner/Lebenspartner (500.000€ Freibetrag)</option>
                                <option value="kind" selected>Kind/Stiefkind (400.000€ Freibetrag)</option>
                                <option value="enkel">Enkel (200.000€ Freibetrag)</option>
                                <option value="eltern">Eltern/Großeltern (100.000€ Freibetrag)</option>
                                <option value="geschwister">Geschwister/Nichten/Neffen (20.000€ Freibetrag)</option>
                                <option value="andere">Andere Personen (20.000€ Freibetrag)</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="wohnflaeche">
                                <span>📐</span> Wohnfläche
                            </label>
                            <div class="input-group">
                                <input type="number" id="wohnflaeche" class="form-input" value="150" min="0">
                                <span class="input-icon">m²</span>
                            </div>
                            <div class="form-help">Für Familienheim-Steuerbefreiung relevant (max. 200m² bei Kindern)</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="selbstnutzung_erblasser">
                                <span>🏠</span> Eigennutzung durch Erblasser
                            </label>
                            <select id="selbstnutzung_erblasser" class="form-select">
                                <option value="ja" selected>Ja, bis zum Tod</option>
                                <option value="nein">Nein, vermietet</option>
                                <option value="pflegeheim">Nein, im Pflegeheim</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="selbstnutzung_erbe">
                                <span>🔑</span> Geplante Eigennutzung durch Erben
                            </label>
                            <select id="selbstnutzung_erbe" class="form-select">
                                <option value="ja" selected>Ja, mindestens 10 Jahre</option>
                                <option value="nein">Nein</option>
                                <option value="unsicher">Unsicher</option>
                            </select>
                            <div class="form-help">10 Jahre Eigennutzung für Familienheim-Befreiung erforderlich</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="erbschaftstyp">
                                <span>📋</span> Art der Übertragung
                            </label>
                            <select id="erbschaftstyp" class="form-select">
                                <option value="erbschaft" selected>Erbschaft (nach Tod)</option>
                                <option value="vorweggenommene_erbfolge">Vorweggenommene Erbfolge</option>
                                <option value="kombination">Kombination Schenkung/Erbschaft</option>
                            </select>
                        </div>
                    </div>

                    <button class="btn btn-primary w-100 mt-4" onclick="window.appInstance && window.appInstance.calculateErbschaft()">
                        👨‍👩‍👧‍👦 Erbschaftsteuer berechnen
                    </button>
                </div>

                <div id="erbschaft-results" aria-live="polite">
                    <!-- Results will be inserted here -->
                </div>
            `;
        }

        generateSchenkungView() {
            return `
                <div class="card">
                    <div class="card-header">
                        <div>
                            <h2 class="card-title">
                                <span>🎁</span>
                                Schenkungssteuer-Optimierung
                            </h2>
                            <p class="card-subtitle">Maximale Steuerersparnis durch optimale Gestaltung und Timing</p>
                        </div>
                    </div>
                    
                    <div class="alert alert-success">
                        <div class="alert-content">
                            <div class="alert-title">🎯 Schenkungsstrategie 2025</div>
                            <p>Höhere Zinsen = niedrigere Nießbrauchswerte = mehr Gestaltungsspielraum! 
                            Nutzen Sie die aktuellen Marktbedingungen für optimale Übertragungen.</p>
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label" for="schenkung_immobilienwert">
                                <span>🏠</span> Immobilienwert gesamt <span class="required">*</span>
                            </label>
                            <div class="input-group">
                                <input type="number" id="schenkung_immobilienwert" class="form-input" value="600000" min="0" required>
                                <span class="input-icon">€</span>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="schenkung_anteil">
                                <span>📊</span> Zu verschenkender Anteil
                            </label>
                            <div class="input-group">
                                <input type="number" id="schenkung_anteil" class="form-input" value="50" min="0" max="100">
                                <span class="input-icon">%</span>
                            </div>
                            <div class="form-help">Schrittweise Übertragung möglich und oft sinnvoll</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="schenkung_verwandtschaft">
                                <span>👥</span> Beschenkter
                            </label>
                            <select id="schenkung_verwandtschaft" class="form-select">
                                <option value="ehepartner">Ehepartner/Lebenspartner (500.000€)</option>
                                <option value="child" selected>Kind/Stiefkind (400.000€)</option>
                                <option value="enkel">Enkel (200.000€)</option>
                                <option value="eltern">Eltern/Großeltern (100.000€)</option>
                                <option value="geschwister">Geschwister/Nichten/Neffen (20.000€)</option>
                                <option value="andere">Andere Personen (20.000€)</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="niessbrauch">
                                <span>🔐</span> Nießbrauch vorbehalten
                            </label>
                            <select id="niessbrauch" class="form-select">
                                <option value="nein">Nein, vollständige Übertragung</option>
                                <option value="ja" selected>Ja, Nießbrauch auf Lebenszeit</option>
                                <option value="wohnrecht">Nur Wohnrecht</option>
                                <option value="zeitlich_begrenzt">Zeitlich begrenzt (z.B. 10 Jahre)</option>
                            </select>
                            <div class="form-help">Nießbrauch reduziert den Schenkungswert erheblich</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="jahresmiete_schenkung">
                                <span>💰</span> Jahresmiete/Mietwert
                            </label>
                            <div class="input-group">
                                <input type="number" id="jahresmiete_schenkung" class="form-input" value="22000" min="0">
                                <span class="input-icon">€</span>
                            </div>
                            <div class="form-help">Für Nießbrauchswert-Berechnung (bei Eigennutzung: ortsübliche Miete)</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="alter_schenker">
                                <span>🎂</span> Alter des Schenkers
                            </label>
                            <div class="input-group">
                                <input type="number" id="alter_schenker" class="form-input" value="65" min="18" max="100">
                                <span class="input-icon">Jahre</span>
                            </div>
                            <div class="form-help">Für Nießbrauchswert-Berechnung (je älter, desto geringer der Wert)</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="vorherige_schenkungen">
                                <span>📋</span> Vorherige Schenkungen (10 Jahre)
                            </label>
                            <div class="input-group">
                                <input type="number" id="vorherige_schenkungen" class="form-input" value="0" min="0">
                                <span class="input-icon">€</span>
                            </div>
                            <div class="form-help">Schenkungen der letzten 10 Jahre an gleiche Person</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="geplante_schritte">
                                <span>🔄</span> Geplante Schenkungsschritte
                            </label>
                            <select id="geplante_schritte" class="form-select">
                                <option value="1">1 Schenkung (sofort alles)</option>
                                <option value="2">2 Schritte (alle 10 Jahre)</option>
                                <option value="3" selected>3 Schritte (optimal)</option>
                                <option value="4">4 Schritte (maximale Spreizung)</option>
                                <option value="5">5 Schritte (sehr langfristig)</option>
                            </select>
                            <div class="form-help">Freibeträge alle 10 Jahre neu nutzbar</div>
                        </div>
                    </div>

                    <button class="btn btn-primary w-100 mt-4" onclick="window.appInstance && window.appInstance.calculateSchenkung()">
                        🎁 Schenkungssteuer berechnen
                    </button>
                </div>

                <div id="schenkung-results" aria-live="polite">
                    <!-- Results will be inserted here -->
                </div>
            `;
        }

        generateCashFlowView() {
            return `
                <div class="card">
                    <div class="card-header">
                        <div>
                            <h2 class="card-title">
                                <span>📊</span>
                                Cash-Flow-Analyse
                            </h2>
                            <p class="card-subtitle">Komplette Rentabilitätsanalyse mit Steuereffekten und Verkaufsszenario</p>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <div class="alert-content">
                            <div class="alert-title">📈 Cash-Flow 2025</div>
                            <p>Berücksichtigt neue Abschreibungsregeln (3% für Neubauten ab 2023), 
                            aktuelle Zinsentwicklung und realistische Kostenansätze.</p>
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label" for="cf_jahresmiete">
                                <span>💰</span> Jahresmiete <span class="required">*</span>
                            </label>
                            <div class="input-group">
                                <input type="number" id="cf_jahresmiete" class="form-input" value="22000" min="0" required>
                                <span class="input-icon">€</span>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="cf_mietsteigerung">
                                <span>📈</span> Jährliche Mietsteigerung
                            </label>
                            <div class="input-group">
                                <input type="number" id="cf_mietsteigerung" class="form-input" value="2.5" min="0" max="10" step="0.1">
                                <span class="input-icon">%</span>
                            </div>
                            <div class="form-help">Durchschnitt Deutschland: 2-3% p.a.</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="cf_instandhaltung">
                                <span>🔧</span> Instandhaltung p.a.
                            </label>
                            <div class="input-group">
                                <input type="number" id="cf_instandhaltung" class="form-input" value="2500" min="0">
                                <span class="input-icon">€</span>
                            </div>
                            <div class="form-help">Faustregel: 1-1,5% des Immobilienwerts</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="cf_verwaltung">
                                <span>📋</span> Verwaltungskosten p.a.
                            </label>
                            <div class="input-group">
                                <input type="number" id="cf_verwaltung" class="form-input" value="800" min="0">
                                <span class="input-icon">€</span>
                            </div>
                            <div class="form-help">Hausverwaltung oder Eigenaufwand</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="cf_versicherung">
                                <span>🛡️</span> Versicherungen p.a.
                            </label>
                            <div class="input-group">
                                <input type="number" id="cf_versicherung" class="form-input" value="600" min="0">
                                <span class="input-icon">€</span>
                            </div>
                            <div class="form-help">Gebäude-, Haftpflicht-, Mietausfallversicherung</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="cf_leerstand">
                                <span>🚫</span> Leerstandsrisiko
                            </label>
                            <div class="input-group">
                                <input type="number" id="cf_leerstand" class="form-input" value="2" min="0" max="20" step="0.1">
                                <span class="input-icon">%</span>
                            </div>
                            <div class="form-help">Durchschnitt Deutschland: 1-3% je nach Lage</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="cf_finanzierung">
                                <span>🏦</span> Kreditzinsen p.a.
                            </label>
                            <div class="input-group">
                                <input type="number" id="cf_finanzierung" class="form-input" value="8000" min="0">
                                <span class="input-icon">€</span>
                            </div>
                            <div class="form-help">Jährliche Zinszahlungen (steuerlich absetzbar)</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="cf_tilgung">
                                <span>💳</span> Tilgung p.a.
                            </label>
                            <div class="input-group">
                                <input type="number" id="cf_tilgung" class="form-input" value="6000" min="0">
                                <span class="input-icon">€</span>
                            </div>
                            <div class="form-help">Nicht steuerlich absetzbar</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="cf_immobilienwert">
                                <span>🏠</span> Immobilienwert
                            </label>
                            <div class="input-group">
                                <input type="number" id="cf_immobilienwert" class="form-input" value="600000" min="0">
                                <span class="input-icon">€</span>
                            </div>
                            <div class="form-help">Für Abschreibung und Wertsteigerung</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="cf_wertsteigerung">
                                <span>📊</span> Jährliche Wertsteigerung
                            </label>
                            <div class="input-group">
                                <input type="number" id="cf_wertsteigerung" class="form-input" value="2" min="-5" max="10" step="0.1">
                                <span class="input-icon">%</span>
                            </div>
                            <div class="form-help">Langfristiger Durchschnitt: 1-3% p.a.</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="cf_betrachtungszeitraum">
                                <span>⏰</span> Betrachtungszeitraum
                            </label>
                            <select id="cf_betrachtungszeitraum" class="form-select">
                                <option value="5">5 Jahre (kurzfristig)</option>
                                <option value="10">10 Jahre (mittelfristig)</option>
                                <option value="15" selected>15 Jahre (optimal)</option>
                                <option value="20">20 Jahre (langfristig)</option>
                                <option value="25">25 Jahre (sehr langfristig)</option>
                                <option value="30">30 Jahre (Vollzyklus)</option>
                            </select>
                        </div>
                    </div>

                    <button class="btn btn-primary w-100 mt-4" onclick="window.appInstance && window.appInstance.calculateCashFlow()">
                        📊 Cash-Flow analysieren
                    </button>
                </div>

                <div id="cashflow-results" aria-live="polite">
                    <!-- Results will be inserted here -->
                </div>
            `;
        }

        generateStrategieView() {
            return `
                <div class="card">
                    <div class="card-header">
                        <div>
                            <h2 class="card-title">
                                <span>🎯</span>
                                Gesamtstrategie-Entwicklung
                            </h2>
                            <p class="card-subtitle">Intelligente Kombination aus Rechtsformwahl, Timing und Nachfolgeplanung</p>
                        </div>
                    </div>
                    
                    <!-- Timeline-Visualisierung -->
                    <div class="strategy-overview">
                        <h3>🎯 Ihre optimale Immobilienstrategie 2025</h3>
                        <div class="timeline">
                            <div class="timeline-item" id="timeline-kauf">
                                <div><strong>Kauf</strong></div>
                                <div>Strukturwahl</div>
                            </div>
                            <div class="timeline-item" id="timeline-haltung">
                                <div><strong>Haltung</strong></div>
                                <div>0-10 Jahre</div>
                            </div>
                            <div class="timeline-item" id="timeline-optimierung">
                                <div><strong>Optimierung</strong></div>
                                <div>Ab 8 Jahren</div>
                            </div>
                            <div class="timeline-item" id="timeline-exit">
                                <div><strong>Exit</strong></div>
                                <div>Verkauf/Übergabe</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-success">
                        <div class="alert-content">
                            <div class="alert-title">🏆 Strategieempfehlung 2025</div>
                            <p>Maßgeschneiderte Kombination aus Rechtsformwahl, optimalem Timing 
                            und vorausschauender Nachfolgeplanung für maximale Steueroptimierung.</p>
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label" for="strategie_alter">
                                <span>🎂</span> Ihr Alter <span class="required">*</span>
                            </label>
                            <div class="input-group">
                                <input type="number" id="strategie_alter" class="form-input" value="48" min="18" max="90" required>
                                <span class="input-icon">Jahre</span>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="strategie_risiko">
                                <span>⚖️</span> Risikobereitschaft
                            </label>
                            <select id="strategie_risiko" class="form-select">
                                <option value="niedrig">Sicherheitsorientiert (konservativ)</option>
                                <option value="mittel" selected>Ausgewogen (moderat)</option>
                                <option value="hoch">Renditeorientiert (aggressiv)</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="strategie_liquiditaet">
                                <span>💰</span> Liquiditätsbedarf
                            </label>
                            <select id="strategie_liquiditaet" class="form-select">
                                <option value="niedrig">Langfristig gebunden (>15 Jahre)</option>
                                <option value="mittel" selected>Flexibel verfügbar (5-15 Jahre)</option>
                                <option value="hoch">Schnell liquidierbar (<5 Jahre)</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="strategie_nachfolge">
                                <span>👨‍👩‍👧‍👦</span> Nachfolgeplanung
                            </label>
                            <select id="strategie_nachfolge" class="form-select">
                                <option value="keine">Noch nicht relevant (>15 Jahre)</option>
                                <option value="kinder" selected>Vererbung an Kinder</option>
                                <option value="partner">Übertragung an Partner</option>
                                <option value="verkauf">Verkauf geplant</option>
                                <option value="stiftung">Stiftung/gemeinnützige Zwecke</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="strategie_weitere_immobilien">
                                <span>🏠</span> Weitere Immobilien geplant
                            </label>
                            <select id="strategie_weitere_immobilien" class="form-select">
                                <option value="nein">Nein, nur diese Immobilie</option>
                                <option value="wenige" selected>1-2 weitere Objekte</option>
                                <option value="portfolio">Portfolio-Aufbau (3-10 Objekte)</option>
                                <option value="grossprojekt">Großprojekt (>10 Objekte)</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="strategie_einkommen">
                                <span>💼</span> Jährliches Einkommen
                            </label>
                            <div class="input-group">
                                <input type="number" id="strategie_einkommen" class="form-input" value="85000" min="0">
                                <span class="input-icon">€</span>
                            </div>
                            <div class="form-help">Für Verlustverrechnung und Steuersatz relevant</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="strategie_vermoegen">
                                <span>💎</span> Gesamtvermögen (geschätzt)
                            </label>
                            <select id="strategie_vermoegen" class="form-select">
                                <option value="bis_500k">Bis 500.000€</option>
                                <option value="500k_1m" selected>500.000€ - 1 Mio.€</option>
                                <option value="1m_5m">1 - 5 Mio.€</option>
                                <option value="5m_plus">Über 5 Mio.€</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="strategie_komplexitaet">
                                <span>🧩</span> Gewünschte Komplexität
                            </label>
                            <select id="strategie_komplexitaet" class="form-select">
                                <option value="einfach">Einfach (Privatperson/GbR)</option>
                                <option value="mittel" selected>Mittel (GmbH & Co. KG)</option>
                                <option value="komplex">Komplex (Cross-Border/Holding)</option>
                                <option value="egal">Egal, Hauptsache optimal</option>
                            </select>
                        </div>
                    </div>

                    <button class="btn btn-primary w-100 mt-4" onclick="window.appInstance && window.appInstance.calculateStrategie()">
                        🎯 Optimale Strategie ermitteln
                    </button>
                </div>

                <div id="strategie-results" aria-live="polite">
                    <!-- Strategy results will be inserted here -->
                </div>
            `;
        }

        // Continue with more methods...
        // [Due to length constraints, I'll continue with the most critical methods]

        // Enhanced Display Methods
        displayVerkaufResults(results) {
            const container = document.getElementById('verkauf-results');
            if (!container) return;

            if (!results || !results.structures || results.structures.length === 0) {
                container.innerHTML = this.generateNoResultsView();
                return;
            }

            let html = this.generateResultsHeader(results);
            html += this.generateInteractiveChart(results);
            html += this.generateResultsGrid(results);
            html += this.generateComparisonTable(results.structures);
            html += this.generateRecommendationSummary(results);

            container.innerHTML = html;
            this.animateResults(container);
        }

        generateInteractiveChart(results) {
            const structures = results.structures.slice(0, 12); // Top 12 für bessere Übersicht
            
            return `
                <div class="chart-container">
                    <h4 class="chart-title">📊 Nettogewinn-Vergleich aller ${results.structures.length} immobilienrelevanten Rechtsformen</h4>
                    <p class="chart-subtitle">Speziell für Immobilienverkäufe optimierte Strukturen - inkl. Familienpools, Asset/Share Deals</p>
                    
                    <div class="bar-chart">
                        ${structures.map((structure, index) => {
                            const height = Math.abs(structure.netProfit) / Math.max(...results.structures.map(s => Math.abs(s.netProfit))) * 200;
                            const isNegative = structure.netProfit < 0;
                            const isBest = index === 0;
                            const isWorst = index === structures.length - 1;
                            
                            return `
                                <div class="bar-item">
                                    <div class="bar ${isNegative ? 'negative' : ''} ${isBest ? 'best' : ''} ${isWorst ? 'worst' : ''}" 
                                         style="height: ${Math.max(Math.abs(height), 10)}px" 
                                         data-value="${this.formatCurrency(structure.netProfit)}"
                                         title="${structure.name}: ${this.formatCurrency(structure.netProfit)} (${this.formatPercent(structure.taxRate)} Steuer)">
                                    </div>
                                    <div class="bar-label">${structure.name.replace('Cross-Border ', 'CB ')}</div>
                                    <div class="bar-value">${this.formatCurrency(structure.netProfit)}</div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    
                    <div class="chart-legend mt-3 text-center">
                        <small class="text-muted">
                            🏆 Beste Option | 📊 Gute Optionen | ❌ Ungünstige Optionen | 
                            Vollständige Liste in der Tabelle unten
                        </small>
                    </div>
                </div>
            `;
        }

        generateResultsGrid(results) {
            const topStructures = results.structures.slice(0, 9); // Top 9 für bessere Übersicht
            
            return `
                <div class="results-grid">
                    ${topStructures.map((structure, index) => `
                        <div class="result-card ${index === 0 ? 'best-option' : ''} ${index >= 6 ? 'warning-option' : ''}">
                            <div class="result-header">
                                <h4 class="result-title">${structure.name}</h4>
                                ${index === 0 ? '<div class="result-badge"><span>🏆</span> Beste Option</div>' : ''}
                                ${index === 1 ? '<div class="result-badge success"><span>✅</span> Sehr gut</div>' : ''}
                                ${index === 2 ? '<div class="result-badge success"><span>✅</span> Gut</div>' : ''}
                                ${index >= topStructures.length - 2 ? '<div class="result-badge warning"><span>⚠️</span> Ungünstig</div>' : ''}
                            </div>
                            
                            <div class="result-item">
                                <span class="result-label">Brutto-Gewinn</span>
                                <span class="result-value">${this.formatCurrency(structure.grossProfit)}</span>
                            </div>
                            
                            <div class="result-item">
                                <span class="result-label">Steuerbelastung</span>
                                <span class="result-value ${structure.tax > 0 ? 'negative' : 'neutral'}">${this.formatCurrency(structure.tax)}</span>
                            </div>
                            
                            <div class="result-item">
                                <span class="result-label">Netto-Gewinn</span>
                                <span class="result-value ${structure.netProfit > 0 ? '' : 'negative'}">${this.formatCurrency(structure.netProfit)}</span>
                            </div>
                            
                            <div class="result-item">
                                <span class="result-label">Effektive Steuerquote</span>
                                <span class="result-value ${structure.taxRate > 30 ? 'negative' : structure.taxRate > 20 ? 'neutral' : ''}">${this.formatPercent(structure.taxRate)}</span>
                            </div>
                            
                            ${structure.advantages && structure.advantages.length > 0 ? `
                                <div class="result-details">
                                    <h5>✅ Vorteile:</h5>
                                    <ul>
                                        ${structure.advantages.slice(0, 3).map(adv => `<li>${adv}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                            
                            ${structure.disadvantages && structure.disadvantages.length > 0 ? `
                                <div class="result-details">
                                    <h5>⚠️ Nachteile:</h5>
                                    <ul class="disadvantages">
                                        ${structure.disadvantages.slice(0, 3).map(dis => `<li>${dis}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                        </div>
                    `).join('')}
                </div>
                
                ${results.structures.length > 9 ? `
                    <div class="alert alert-info mt-3">
                        <div class="alert-content">
                            <div class="alert-title">📋 Vollständige Analyse</div>
                            <p>Alle ${results.structures.length} Rechtsformen wurden berechnet. 
                            Die komplette Übersicht finden Sie in der Tabelle unten.</p>
                        </div>
                    </div>
                ` : ''}
            `;
        }

        generateComparisonTable(structures) {
            return `
                <div class="card mt-4">
                    <div class="card-header">
                        <h3 class="card-title">
                            <span>📋</span>
                            Detaillierter Vergleich
                        </h3>
                    </div>
                    
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Rang</th>
                                <th>Rechtsform</th>
                                <th>Brutto-Gewinn</th>
                                <th>Steuer</th>
                                <th>Netto-Gewinn</th>
                                <th>Steuerquote</th>
                                <th>Empfehlung</th>
                                <th>Info</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${structures.map((structure, index) => `
                                <tr ${index === 0 ? 'class="best-row"' : ''}>
                                    <td class="rank-cell">${index + 1}</td>
                                    <td><strong>${structure.name}</strong></td>
                                    <td class="currency-cell">${this.formatCurrency(structure.grossProfit)}</td>
                                    <td class="currency-cell">${this.formatCurrency(structure.tax)}</td>
                                    <td class="currency-cell"><strong>${this.formatCurrency(structure.netProfit)}</strong></td>
                                    <td class="percentage-cell">${this.formatPercent(structure.taxRate)}</td>
                                    <td>${this.getRecommendationIcon(structure.recommendation || 'gut')} ${structure.recommendation || 'gut'}</td>
                                    <td><button class="btn btn-outline" style="padding: 0.5rem; font-size: 0.8rem;" onclick="window.appInstance && window.appInstance.showStructureInfo('${structure.name.replace(/'/g, '\\\'')}')" title="Detailinfos zu ${structure.name}">ℹ️</button></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        getRecommendationIcon(recommendation) {
            const icons = {
                'optimal': '🏆',
                'gut': '✅',
                'prüfenswert': '⚖️',
                'nicht empfohlen': '❌'
            };
            return icons[recommendation] || '📊';
        }

        generateRecommendationSummary(results) {
            const savings = results.totalSavings;
            const best = results.bestStructure;
            
            return `
                <div class="card mt-4">
                    <div class="card-header">
                        <h3 class="card-title">
                            <span>🎯</span>
                            Handlungsempfehlung
                        </h3>
                    </div>
                    
                    <div class="alert alert-success">
                        <div class="alert-content">
                            <div class="alert-title">💡 Unsere Empfehlung für Sie</div>
                            <p><strong>${best.name}</strong> bietet Ihnen den höchsten Nettogewinn von <strong>${this.formatCurrency(best.netProfit)}</strong></p>
                            
                            ${savings > 0 ? `
                                <p>💰 <strong>Maximale Ersparnis:</strong> ${this.formatCurrency(savings)} gegenüber der ungünstigsten Option</p>
                            ` : ''}
                            
                            <p>${results.recommendation}</p>
                            
                            ${best.advantages && best.advantages.length > 0 ? `
                                <div class="mt-2">
                                    <strong>Wichtigste Vorteile:</strong>
                                    <ul style="margin: 0.5rem 0 0 1.5rem;">
                                        ${best.advantages.slice(0, 3).map(adv => `<li>${adv}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    <div class="btn-group w-100 mt-3">
                        <button class="btn btn-primary" onclick="window.appInstance && window.appInstance.exportReport()" style="flex: 1;">
                            📋 Detailbericht erstellen
                        </button>
                        <button class="btn btn-success" onclick="window.appInstance && window.appInstance.showExtendedAnalyse()">
                            🔍 Erweiterte Analyse
                        </button>
                    </div>
                </div>
            `;
        }

        generateNoResultsView() {
            return `
                <div class="card mt-4">
                    <div class="alert alert-info">
                        <div class="alert-content">
                            <div class="alert-title">ℹ️ Bereit für die Berechnung</div>
                            <p>Füllen Sie die Felder oben aus und klicken Sie auf "Alle 14 Rechtsformen vergleichen", um eine detaillierte Steueranalyse zu erhalten.</p>
                        </div>
                    </div>
                </div>
            `;
        }

        animateResults(container) {
            container.style.opacity = '0';
            container.style.transform = 'translateY(20px)';
            
            setTimeout(() => {
                container.style.transition = 'all 0.5s ease';
                container.style.opacity = '1';
                container.style.transform = 'translateY(0)';
            }, 100);
        }

        // Display Results Methods for all sections
        displayGrundsteuerResults(results) {
            const container = document.getElementById('grundsteuer-results');
            if (!container) return;
            
            container.innerHTML = `
                <div class="card mt-4">
                    <div class="card-header">
                        <h3 class="card-title">🏛️ Grundsteuer-Ergebnis 2025</h3>
                    </div>
                    
                    <div class="results-grid">
                        <div class="result-card">
                            <div class="result-header">
                                <h4 class="result-title">Jährliche Grundsteuer</h4>
                            </div>
                            <div class="result-item">
                                <span class="result-label">Grundsteuer pro Jahr</span>
                                <span class="result-value">${this.formatCurrency(results.jahressteuer)}</span>
                            </div>
                            <div class="result-item">
                                <span class="result-label">Monatliche Belastung</span>
                                <span class="result-value">${this.formatCurrency(results.jahressteuer / 12)}</span>
                            </div>
                        </div>
                        
                        <div class="result-card success">
                            <div class="result-header">
                                <h4 class="result-title">Steuerersparnis</h4>
                                <div class="result-badge">💰 Absetzbar</div>
                            </div>
                            <div class="result-item">
                                <span class="result-label">Bei Vermietung absetzbar</span>
                                <span class="result-value">${this.formatCurrency(results.steuerersparnis)}</span>
                            </div>
                            <div class="result-item">
                                <span class="result-label">Effektive Belastung</span>
                                <span class="result-value">${this.formatCurrency(results.jahressteuer - results.steuerersparnis)}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info mt-3">
                        <div class="alert-content">
                            <div class="alert-title">💡 ${results.empfehlung}</div>
                            <p>Die neue Grundsteuer kann stark von der bisherigen abweichen. Bei Vermietung ist die Grundsteuer vollständig als Werbungskosten absetzbar.</p>
                        </div>
                    </div>
                </div>
            `;
        }

        displayErbschaftResults(results) {
            const container = document.getElementById('erbschaft-results');
            if (!container) return;
            
            container.innerHTML = `
                <div class="card mt-4">
                    <div class="card-header">
                        <h3 class="card-title">👨‍👩‍👧‍👦 Erbschaftsteuer-Ergebnis</h3>
                    </div>
                    
                    <div class="results-grid">
                        <div class="result-card">
                            <div class="result-header">
                                <h4 class="result-title">Vermögenswerte</h4>
                            </div>
                            <div class="result-item">
                                <span class="result-label">Netto-Vermögen</span>
                                <span class="result-value">${this.formatCurrency(results.nettoVermoegen)}</span>
                            </div>
                            <div class="result-item">
                                <span class="result-label">Freibetrag</span>
                                <span class="result-value neutral">${this.formatCurrency(results.freibetrag)}</span>
                            </div>
                            <div class="result-item">
                                <span class="result-label">Steuerpflichtiger Betrag</span>
                                <span class="result-value ${results.steuerpflichtigerBetrag > 0 ? 'negative' : ''}">${this.formatCurrency(results.steuerpflichtigerBetrag)}</span>
                            </div>
                        </div>
                        
                        <div class="result-card ${results.erbschaftsteuer === 0 ? 'best-option' : ''}">
                            <div class="result-header">
                                <h4 class="result-title">Erbschaftsteuer</h4>
                                ${results.erbschaftsteuer === 0 ? '<div class="result-badge">🎉 Steuerfrei</div>' : ''}
                            </div>
                            <div class="result-item">
                                <span class="result-label">Erbschaftsteuer</span>
                                <span class="result-value ${results.erbschaftsteuer > 0 ? 'negative' : ''}">${this.formatCurrency(results.erbschaftsteuer)}</span>
                            </div>
                            <div class="result-item">
                                <span class="result-label">Verbleibendes Erbe</span>
                                <span class="result-value">${this.formatCurrency(results.nettoVermoegen - results.erbschaftsteuer)}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert ${results.erbschaftsteuer === 0 ? 'alert-success' : 'alert-warning'} mt-3">
                        <div class="alert-content">
                            <div class="alert-title">${results.erbschaftsteuer === 0 ? '🎉 Keine Steuer!' : '⚠️ Optimierung möglich'}</div>
                            <p>${results.empfehlung}</p>
                            ${results.erbschaftsteuer > 0 ? '<p>Durch vorweggenommene Erbfolge oder Schenkungen können Sie die Steuerbelastung reduzieren.</p>' : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        displaySchenkungResults(results) {
            const container = document.getElementById('schenkung-results');
            if (!container) return;
            
            container.innerHTML = `
                <div class="card mt-4">
                    <div class="card-header">
                        <h3 class="card-title">🎁 Schenkungssteuer-Ergebnis</h3>
                    </div>
                    
                    <div class="results-grid">
                        <div class="result-card">
                            <div class="result-header">
                                <h4 class="result-title">Schenkungswerte</h4>
                            </div>
                            <div class="result-item">
                                <span class="result-label">Ursprünglicher Wert</span>
                                <span class="result-value">${this.formatCurrency(results.schenkungswert)}</span>
                            </div>
                            <div class="result-item">
                                <span class="result-label">Nach Nießbrauch</span>
                                <span class="result-value">${this.formatCurrency(results.effektiverWert)}</span>
                            </div>
                            <div class="result-item">
                                <span class="result-label">Ersparnis durch Nießbrauch</span>
                                <span class="result-value neutral">${this.formatCurrency(results.ersparnis)}</span>
                            </div>
                        </div>
                        
                        <div class="result-card ${results.schenkungsteuer === 0 ? 'best-option' : ''}">
                            <div class="result-header">
                                <h4 class="result-title">Steuerberechnung</h4>
                                ${results.schenkungsteuer === 0 ? '<div class="result-badge">🎉 Steuerfrei</div>' : ''}
                            </div>
                            <div class="result-item">
                                <span class="result-label">Freibetrag</span>
                                <span class="result-value">${this.formatCurrency(results.freibetrag)}</span>
                            </div>
                            <div class="result-item">
                                <span class="result-label">Steuerpflichtiger Betrag</span>
                                <span class="result-value ${results.steuerpflichtig > 0 ? 'negative' : ''}">${this.formatCurrency(results.steuerpflichtig)}</span>
                            </div>
                            <div class="result-item">
                                <span class="result-label">Schenkungsteuer</span>
                                <span class="result-value ${results.schenkungsteuer > 0 ? 'negative' : ''}">${this.formatCurrency(results.schenkungsteuer)}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-success mt-3">
                        <div class="alert-content">
                            <div class="alert-title">💡 ${results.empfehlung}</div>
                            <p>Durch den Nießbrauchsvorbehalt sparen Sie ${this.formatCurrency(results.ersparnis)} an Schenkungswert. 
                            Freibeträge können alle 10 Jahre neu genutzt werden.</p>
                        </div>
                    </div>
                </div>
            `;
        }

        displayCashFlowResults(results) {
            const container = document.getElementById('cashflow-results');
            if (!container) return;
            
            const gesamtrendite = results.jaehrlicheRendite;
            const doppelteHaltedauer = results.years.length * 2;
            const betrachtungszeitraum = results.years.length;
            
            container.innerHTML = `
                <div class="card mt-4">
                    <div class="card-header">
                        <h3 class="card-title">📊 Cash-Flow-Analyse Ergebnis</h3>
                    </div>
                    
                    <div class="results-grid">
                        <div class="result-card">
                            <div class="result-header">
                                <h4 class="result-title">Gesamtergebnis (${betrachtungszeitraum} Jahre)</h4>
                            </div>
                            <div class="result-item">
                                <span class="result-label">Kumulierter Cash-Flow</span>
                                <span class="result-value ${results.gesamtCashFlow >= 0 ? '' : 'negative'}">${this.formatCurrency(results.gesamtCashFlow)}</span>
                            </div>
                            <div class="result-item">
                                <span class="result-label">Wertsteigerung</span>
                                <span class="result-value">${this.formatCurrency(results.wertsteigerung)}</span>
                            </div>
                            <div class="result-item">
                                <span class="result-label">Gesamtrendite</span>
                                <span class="result-value ${results.gesamtrendite >= 0 ? '' : 'negative'}">${this.formatCurrency(results.gesamtrendite)}</span>
                            </div>
                        </div>
                        
                        <div class="result-card ${results.gesamtrendite > 0 ? 'best-option' : ''}">
                            <div class="result-header">
                                <h4 class="result-title">Rendite-Kennzahlen</h4>
                                ${results.gesamtrendite > 0 ? '<div class="result-badge">📈 Positiv</div>' : ''}
                            </div>
                            <div class="result-item">
                                <span class="result-label">Jährliche Rendite</span>
                                <span class="result-value ${gesamtrendite >= 0 ? '' : 'negative'}">${this.formatPercent(gesamtrendite)}</span>
                            </div>
                            <div class="result-item">
                                <span class="result-label">Betrachtungszeitraum</span>
                                <span class="result-value neutral">${betrachtungszeitraum} Jahre</span>
                            </div>
                            <div class="result-item">
                                <span class="result-label">Verkaufsstatus</span>
                                <span class="result-value">${betrachtungszeitraum >= 10 ? '✅ Steuerfrei' : '⏰ Steuerpflichtig'}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="chart-container mt-4">
                        <h4 class="chart-title">📈 Cash-Flow-Entwicklung</h4>
                        <div class="bar-chart">
                            ${results.years.slice(0, Math.min(20, results.years.length)).map(year => {
                                const maxAbsCashFlow = Math.max(...results.years.map(y => Math.abs(y.cashFlow)));
                                const height = Math.abs(year.cashFlow) / maxAbsCashFlow * 150;
                                return `
                                    <div class="bar-item">
                                        <div class="bar ${year.cashFlow < 0 ? 'negative' : ''}" 
                                             style="height: ${Math.max(height, 5)}px"
                                             data-value="${this.formatCurrency(year.cashFlow)}">
                                        </div>
                                        <div class="bar-label">Jahr ${year.jahr}</div>
                                        <div class="bar-value">${this.formatCurrency(year.cashFlow)}</div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                    
                    <div class="alert ${results.gesamtrendite > 0 ? 'alert-success' : 'alert-warning'} mt-3">
                        <div class="alert-content">
                            <div class="alert-title">💡 ${results.empfehlung}</div>
                            <p>Ihre Investition zeigt eine jährliche Rendite von ${this.formatPercent(gesamtrendite)}. 
                            ${results.gesamtrendite > 0 ? 'Dies ist eine solide Immobilieninvestition.' : 'Prüfen Sie Optimierungsmöglichkeiten bei Kosten oder Miete.'}</p>
                        </div>
                    </div>
                    
                    <!-- Langzeit-Szenario -->
                    <div class="card mt-4" style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);">
                        <div class="card-header">
                            <h3 class="card-title">🔮 Langzeit-Prognose (${doppelteHaltedauer} Jahre)</h3>
                        </div>
                        ${this.generateLangzeitPrognose(results, doppelteHaltedauer)}
                    </div>
                </div>
            `;
        }

        generateLangzeitPrognose(results, doppelteHaltedauer) {
            // Vereinfachte Langzeitberechnung
            const extraJahre = doppelteHaltedauer - results.years.length;
            const letzterCashFlow = results.years[results.years.length - 1];
            
            // Projektiere weiteren Cash-Flow
            let zusaetzlicherCashFlow = 0;
            for (let i = 1; i <= extraJahre; i++) {
                const projektierterCashFlow = letzterCashFlow.cashFlow * Math.pow(1.02, i); // 2% Steigerung
                zusaetzlicherCashFlow += projektierterCashFlow;
            }
            
            const gesamtCashFlowLangzeit = results.gesamtCashFlow + zusaetzlicherCashFlow;
            const zusaetzlicheWertsteigerung = results.wertsteigerung * Math.pow(1.02, extraJahre);
            const gesamtrenditeLangzeit = ((gesamtCashFlowLangzeit + zusaetzlicheWertsteigerung) / 600000 - 1) * 100 / doppelteHaltedauer; // Vereinfacht
            
            return `
                <div class="results-grid">
                    <div class="result-card">
                        <div class="result-header">
                            <h4 class="result-title">Erweiterte Projektion</h4>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Zusätzlicher Cash-Flow</span>
                            <span class="result-value">${this.formatCurrency(zusaetzlicherCashFlow)}</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Gesamt-Cash-Flow</span>
                            <span class="result-value">${this.formatCurrency(gesamtCashFlowLangzeit)}</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Langzeit-Rendite p.a.</span>
                            <span class="result-value">${this.formatPercent(gesamtrenditeLangzeit)}</span>
                        </div>
                    </div>
                    
                    <div class="result-card best-option">
                        <div class="result-header">
                            <h4 class="result-title">Steuerliche Vorteile</h4>
                            <div class="result-badge">✅ Steuerfrei</div>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Verkauf nach ${doppelteHaltedauer} Jahren</span>
                            <span class="result-value">✅ Komplett steuerfrei</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Steuerersparnis</span>
                            <span class="result-value">${this.formatCurrency(zusaetzlicheWertsteigerung * 0.42)}</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Netto-Endwert</span>
                            <span class="result-value">${this.formatCurrency(gesamtCashFlowLangzeit + zusaetzlicheWertsteigerung)}</span>
                        </div>
                    </div>
                </div>
                
                <div class="alert alert-info mt-3">
                    <div class="alert-content">
                        <div class="alert-title">📊 Vergleich: ${results.years.length} vs. ${doppelteHaltedauer} Jahre</div>
                        <p><strong>Vorteil längere Haltedauer:</strong><br>
                        • Zusätzlicher Cash-Flow: ${this.formatCurrency(zusaetzlicherCashFlow)}<br>
                        • Steuerfreier Verkauf: ${this.formatCurrency(zusaetzlicheWertsteigerung * 0.42)} Ersparnis<br>
                        • Höhere Gesamtrendite durch Zinseszinseffekt</p>
                    </div>
                </div>
            `;
        }

        displayStrategieResults(results) {
            const container = document.getElementById('strategie-results');
            if (!container) return;
            
            container.innerHTML = `
                <div class="card mt-4">
                    <div class="card-header">
                        <h3 class="card-title">🎯 Ihre persönliche Immobilien-Strategie</h3>
                    </div>
                    
                    <div class="alert alert-success">
                        <div class="alert-content">
                            <div class="alert-title">🏆 Strategieempfehlung</div>
                            <p><strong>Zeitrahmen:</strong> ${results.zeitrahmen} | <strong>Priorität:</strong> ${results.prioritaet}</p>
                            <div class="mt-2">
                                <strong>Hauptempfehlungen:</strong>
                                <ul style="margin: 0.5rem 0 0 1.5rem;">
                                    ${results.empfehlungen.map(emp => `<li>${emp}</li>`).join('')}
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <div class="results-grid mt-4">
                        <div class="result-card best-option">
                            <div class="result-header">
                                <h4 class="result-title">Nächste Schritte</h4>
                                <div class="result-badge">📋 Aktionsplan</div>
                            </div>
                            <div style="padding: 1rem;">
                                <ol style="margin: 0; padding-left: 1.5rem;">
                                    ${results.naechsteSchritte.map(schritt => `<li style="margin: 0.5rem 0;">${schritt}</li>`).join('')}
                                </ol>
                            </div>
                        </div>
                        
                        <div class="result-card">
                            <div class="result-header">
                                <h4 class="result-title">Strategie-Details</h4>
                            </div>
                            <div class="result-item">
                                <span class="result-label">Komplexitätslevel</span>
                                <span class="result-value neutral">${results.komplexitaet}</span>
                            </div>
                            <div class="result-item">
                                <span class="result-label">Zeitrahmen</span>
                                <span class="result-value">${results.zeitrahmen}</span>
                            </div>
                            <div class="result-item">
                                <span class="result-label">Hauptfokus</span>
                                <span class="result-value">${results.prioritaet}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info mt-3">
                        <div class="alert-content">
                            <div class="alert-title">💡 Wichtige Hinweise</div>
                            <p>Diese Strategie-Empfehlung basiert auf Ihren Angaben und aktueller Rechtslage. 
                            Für eine detaillierte Umsetzung empfehlen wir eine individuelle Beratung mit Steuerexperten.</p>
                        </div>
                    </div>
                    
                    <div class="btn-group w-100 mt-3">
                        <button class="btn btn-primary" onclick="window.appInstance && window.appInstance.navigate('verkauf')" style="flex: 1;">
                            💰 Verkauf optimieren
                        </button>
                        <button class="btn btn-success" onclick="window.appInstance && window.appInstance.navigate('schenkung')">
                            🎁 Nachfolge planen
                        </button>
                    </div>
                </div>
            `;
        }

        generateResultsHeader(results) {
            return `
                <div class="card mt-4">
                    <div class="card-header">
                        <div>
                            <h3 class="card-title">
                                <span>📊</span>
                                Ergebnisse: Alle ${results.structures.length} Rechtsformen verglichen
                            </h3>
                            <p class="card-subtitle">
                                Beste Option: <strong>${results.bestStructure.name}</strong> 
                                (${this.formatCurrency(results.bestStructure.netProfit)} Nettogewinn • ${this.formatPercent(results.bestStructure.taxRate)} Steuerquote)
                            </p>
                        </div>
                    </div>
                    
                    <div class="alert alert-success">
                        <div class="alert-content">
                            <div class="alert-title">🏆 Vollständiger Vergleich: Privatverkauf, GbR, GmbH & Co. KG, Cross-Border, Limited & mehr</div>
                            <p><strong>Maximale Ersparnis: ${this.formatCurrency(results.totalSavings)}</strong> gegenüber der ungünstigsten Option<br>
                            <strong>Schlechteste Option:</strong> ${results.structures[results.structures.length - 1].name} (${this.formatCurrency(results.structures[results.structures.length - 1].netProfit)})<br>
                            ${results.recommendation}</p>
                        </div>
                    </div>
                </div>
            `;
        }

        // Essential Utility Methods
        formatCurrency(amount) {
            if (typeof amount !== 'number' || isNaN(amount)) return '0 €';
            return new Intl.NumberFormat('de-DE', {
                style: 'currency',
                currency: 'EUR',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }

        formatPercent(rate) {
            if (typeof rate !== 'number' || isNaN(rate)) return '0,0%';
            return (rate).toFixed(1) + '%';
        }

        parseNumber(value, defaultValue = 0) {
            if (value === null || value === undefined || value === '') {
                return defaultValue;
            }
            const stringValue = String(value).trim();
            if (stringValue === '') return defaultValue;
            const num = parseFloat(stringValue);
            return isNaN(num) ? defaultValue : num;
        }

        getElementValue(id, defaultValue = '') {
            const element = document.getElementById(id);
            if (!element) {
                // Only warn if we're on the right section for this element
                const currentSection = this.getCurrentSection();
                const elementSections = {
                    'grundstueckswert': 'grundsteuer',
                    'immobilienwert_erbe': 'erbschaft',
                    'schenkung_immobilienwert': 'schenkung',
                    'cf_jahresmiete': 'cashflow',
                    'strategie_alter': 'strategie'
                };
                
                if (elementSections[id] === currentSection) {
                    console.warn(`Element with id '${id}' not found on ${currentSection} section`);
                }
                return defaultValue;
            }
            return element.value || defaultValue;
        }

        getCurrentSection() {
            const activeLink = document.querySelector('.nav-link.active, .mobile-nav-link.active');
            if (activeLink) {
                const href = activeLink.getAttribute('href');
                return href ? href.substring(1) : 'verkauf';
            }
            return 'verkauf';
        }

        // Critical calculation and data methods
        collectVerkaufData() {
            return {
                kaufpreis: this.parseNumber(this.getElementValue('kaufpreis'), 0),
                verkaufspreis: this.parseNumber(this.getElementValue('verkaufspreis'), 0),
                nebenkostenKauf: this.parseNumber(this.getElementValue('nebenkosten_kauf'), 0),
                nebenkostenVerkauf: this.parseNumber(this.getElementValue('nebenkosten_verkauf'), 0),
                modernisierung: this.parseNumber(this.getElementValue('modernisierung'), 0),
                haltedauer: this.parseNumber(this.getElementValue('haltedauer'), 0),
                steuersatz: this.parseNumber(this.getElementValue('steuersatz'), 42),
                kirchensteuer: this.parseNumber(this.getElementValue('kirchensteuer'), 8),
                bundesland: this.getElementValue('bundesland', 'nw')
            };
        }

        collectAllFormData() {
            const formData = {};
            const inputs = document.querySelectorAll('input, select');
            
            inputs.forEach(input => {
                if (input.id) {
                    formData[input.id] = input.value;
                }
            });
            
            return formData;
        }

        populateFormData(data) {
            Object.entries(data).forEach(([key, value]) => {
                const element = document.getElementById(key);
                if (element && value !== null && value !== undefined) {
                    element.value = value;
                }
            });
        }

        hasMinimumData(section) {
            const requirements = {
                'verkauf': ['kaufpreis', 'verkaufspreis'],
                'grundsteuer': ['grundstueckswert'],
                'erbschaft': ['immobilienwert_erbe'],
                'schenkung': ['schenkung_immobilienwert'],
                'cashflow': ['cf_jahresmiete'],
                'strategie': ['strategie_alter']
            };
            
            const required = requirements[section] || [];
            return required.every(field => {
                const value = this.parseNumber(this.getElementValue(field), 0);
                return value > 0;
            });
        }

        getSectionName(section) {
            const names = {
                'verkauf': 'Verkaufssteuer',
                'grundsteuer': 'Grundsteuer',
                'erbschaft': 'Erbschaftsteuer',
                'schenkung': 'Schenkungssteuer',
                'cashflow': 'Cash-Flow',
                'strategie': 'Gesamtstrategie'
            };
            return names[section] || section;
                kaufpreis: this.parseNumber(this.getElementValue('kaufpreis'), 0),
                verkaufspreis: this.parseNumber(this.getElementValue('verkaufspreis'), 0),
                nebenkostenKauf: this.parseNumber(this.getElementValue('nebenkosten_kauf'), 0),
                nebenkostenVerkauf: this.parseNumber(this.getElementValue('nebenkosten_verkauf'), 0),
                modernisierung: this.parseNumber(this.getElementValue('modernisierung'), 0),
                haltedauer: this.parseNumber(this.getElementValue('haltedauer'), 0),
                steuersatz: this.parseNumber(this.getElementValue('steuersatz'), 42),
                kirchensteuer: this.parseNumber(this.getElementValue('kirchensteuer'), 8),
                bundesland: this.getElementValue('bundesland', 'nw')
            };
        }

        collectAllFormData() {
            const allInputs = document.querySelectorAll('input, select');
            const data = {};
            
            allInputs.forEach(input => {
                if (input.id) {
                    data[input.id] = input.value;
                }
            });
            
            return data;
        }

        populateFormData(data) {
            Object.entries(data).forEach(([key, value]) => {
                const element = document.getElementById(key);
                if (element && value !== null && value !== undefined) {
                    element.value = value;
                }
            });
        }

        hasMinimumData(section) {
            const requirements = {
                'verkauf': ['kaufpreis', 'verkaufspreis'],
                'grundsteuer': ['grundstueckswert'],
                'erbschaft': ['immobilienwert_erbe'],
                'schenkung': ['schenkung_immobilienwert'],
                'cashflow': ['cf_jahresmiete'],
                'strategie': ['strategie_alter']
            };
            
            const required = requirements[section] || [];
            return required.every(field => {
                const value = this.parseNumber(this.getElementValue(field), 0);
                return value > 0;
            });
        }

        getSectionName(section) {
            const names = {
                'verkauf': 'Verkaufssteuer',
                'grundsteuer': 'Grundsteuer',
                'erbschaft': 'Erbschaftsteuer',
                'schenkung': 'Schenkungssteuer',
                'cashflow': 'Cash-Flow',
                'strategie': 'Gesamtstrategie'
            };
            return names[section] || section;
        // Generate insights for different sections
        generateVerkaufInsights() {
            try {
                const kaufpreis = this.parseNumber(this.getElementValue('kaufpreis'), 0);
                const verkaufspreis = this.parseNumber(this.getElementValue('verkaufspreis'), 0);
                const haltedauer = this.parseNumber(this.getElementValue('haltedauer'), 0);
                
                if (kaufpreis > 0 && verkaufspreis > 0) {
                    const gewinn = verkaufspreis - kaufpreis;
                    
                    if (haltedauer < 10 && gewinn > 0) {
                        const restzeit = 10 - haltedauer;
                        
                        // Empfehlung basiert auf Gewinnhöhe und neuen Strukturen
                        let bestStructure = '';
                        let additionalTip = '';
                        
                        if (gewinn >= 1000000) {
                            bestStructure = 'Cross-Border DE-CH optimal';
                            additionalTip = '12% Gesamtsteuerbelastung möglich';
                        } else if (gewinn >= 500000) {
                            bestStructure = 'Cross-Border DE-LU';
                            additionalTip = '17% statt 42% Steuerbelastung';
                        } else if (gewinn >= 200000) {
                            bestStructure = 'Share Deal über GmbH';
                            additionalTip = '40% des Gewinns steuerfrei (§8b)';
                        } else {
                            bestStructure = 'Familienpool (GbR)';
                            additionalTip = 'Progression durch Steuerverteilung brechen';
                        }
                        
                        return `
                            <div class="widget-item warning">
                                <div style="font-weight: 600; color: #e67e22; margin-bottom: 5px;">⏰ ${restzeit.toFixed(1)} Jahre bis steuerfrei</div>
                                <div style="font-size: 0.9em;">Alternative: Sofort mit ${bestStructure}</div>
                                <div style="font-weight: 600; color: #27ae60; margin-top: 5px;">
                                    💰 ${additionalTip}
                                </div>
                            </div>
                            <div class="widget-item">
                                <div style="font-weight: 600; color: #3498db; margin-bottom: 5px;">🏆 VV GmbH & Co. KG</div>
                                <div style="font-size: 0.9em;">BFH 2025: Gewerbesteuerfrei</div>
                                <div style="font-weight: 600; color: #3498db; margin-top: 5px;">
                                    Nach 10J steuerfrei + Haftungsschutz
                                </div>
                            </div>
                        `;
                    } else if (haltedauer >= 10) {
                        // Bei steuerfreiem Verkauf andere Strukturüberlegungen
                        let familyTip = '';
                        if (gewinn >= 100000) {
                            familyTip = 'Familienpool für weitere Immobilien nutzen';
                        } else {
                            familyTip = 'Bruchteilsgemeinschaft bei mehreren Eigentümern';
                        }
                        
                        return `
                            <div class="widget-item success">
                                <div style="font-weight: 600; color: #27ae60; margin-bottom: 5px;">🎉 Steuerfrei!</div>
                                <div style="font-size: 0.9em;">10-Jahres-Frist erreicht</div>
                                <div style="font-weight: 600; color: #27ae60; margin-top: 5px;">
                                    ${this.formatCurrency(gewinn)} ohne Steuer
                                </div>
                            </div>
                            <div class="widget-item">
                                <div style="font-weight: 600; color: #3498db; margin-bottom: 5px;">💡 Weitere Optimierung</div>
                                <div style="font-size: 0.9em;">${familyTip}</div>
                                <div style="font-weight: 600; color: #3498db; margin-top: 5px;">
                                    Für künftige Investments
                                </div>
                            </div>
                        `;
                    } else {
                        // Positive Gewinne unter 10 Jahren - beste Struktur empfehlen
                        let recommendation = '';
                        let percentage = '';
                        
                        if (gewinn >= 750000) {
                            recommendation = 'Cross-Border oder Stiftung';
                            percentage = '5-17% Steuerbelastung';
                        } else if (gewinn >= 300000) {
                            recommendation = 'Share Deal (GmbH)';
                            percentage = '40% des Gewinns steuerfrei';
                        } else if (gewinn >= 100000) {
                            recommendation = 'Familienpool (GbR)';
                            percentage = 'Steuerverteilung nutzen';
                        } else {
                            recommendation = 'VV GmbH & Co. KG';
                            percentage = 'Gewerbesteuerfrei (BFH 2025)';
                        }
                        
                        return `
                            <div class="widget-item success">
                                <div style="font-weight: 600; color: #27ae60; margin-bottom: 5px;">💰 Gewinn: ${this.formatCurrency(gewinn)}</div>
                                <div style="font-size: 0.9em;">Beste Struktur: ${recommendation}</div>
                                <div style="font-weight: 600; color: #27ae60; margin-top: 5px;">
                                    ${percentage}
                                </div>
                            </div>
                            <div class="widget-item">
                                <div style="font-weight: 600; color: #3498db; margin-bottom: 5px;">🏆 Asset vs Share Deal</div>
                                <div style="font-size: 0.9em;">Share Deal: 40% steuerfrei (§8b KStG)</div>
                                <div style="font-weight: 600; color: #3498db; margin-top: 5px;">
                                    Dramatischer Unterschied!
                                </div>
                            </div>
                        `;
                    }
                }
                
                return this.generateDefaultInsights();
            } catch (error) {
                console.error('Error generating Verkauf insights:', error);
                return this.generateDefaultInsights();
            }
        }

        generateCashFlowInsights() {
            try {
                const jahresmiete = this.parseNumber(this.getElementValue('cf_jahresmiete'), 0);
                const instandhaltung = this.parseNumber(this.getElementValue('cf_instandhaltung'), 0);
                const zinsen = this.parseNumber(this.getElementValue('cf_finanzierung'), 0);
                
                if (jahresmiete > 0) {
                    const geschaetzteKosten = instandhaltung + zinsen + 7000;
                    const cashFlow = jahresmiete - geschaetzteKosten;
                    
                    return `
                        <div class="widget-item ${cashFlow >= 0 ? 'success' : 'warning'}">
                            <div style="font-weight: 600; color: ${cashFlow >= 0 ? '#27ae60' : '#e67e22'}; margin-bottom: 5px;">
                                💰 Cash-Flow p.a.
                            </div>
                            <div style="font-size: 0.9em;">
                                ${cashFlow >= 0 ? 'Positiver Cash-Flow' : 'Negativ (Steuervorteile)'}
                            </div>
                            <div style="font-weight: 600; color: ${cashFlow >= 0 ? '#27ae60' : '#e67e22'}; margin-top: 5px;">
                                ${this.formatCurrency(Math.abs(cashFlow))} ${cashFlow >= 0 ? 'Überschuss' : 'Zuzahlung'}
                            </div>
                        </div>
                        <div class="widget-item">
                            <div style="font-weight: 600; color: #3498db; margin-bottom: 5px;">📊 Mietrendite</div>
                            <div style="font-size: 0.9em;">Geschätzte Brutto-Rendite</div>
                            <div style="font-weight: 600; color: #3498db; margin-top: 5px;">
                                ${(jahresmiete / 600000 * 100).toFixed(1)}%
                            </div>
                        </div>
                    `;
                }
                
                return `
                    <div class="widget-item">
                        <div style="font-weight: 600; color: #6c757d; margin-bottom: 5px;">📊 Cash-Flow bereit</div>
                        <div style="font-size: 0.9em;">Jahresmiete eingeben für Analyse</div>
                    </div>
                `;
            } catch (error) {
                console.error('Error generating Cash-Flow insights:', error);
                return this.generateDefaultInsights();
            }
        }

        generateGrundsteuerInsights() {
            try {
                const grundstueckswert = this.parseNumber(this.getElementValue('grundstueckswert'), 0);
                const hebesatz = this.parseNumber(this.getElementValue('hebesatz'), 520);
                
                if (grundstueckswert > 0) {
                    const jahressteuer = grundstueckswert * 0.31 / 1000 * hebesatz / 100;
                    
                    return `
                        <div class="widget-item warning">
                            <div style="font-weight: 600; color: #e67e22; margin-bottom: 5px;">🏛️ Grundsteuer 2025</div>
                            <div style="font-size: 0.9em;">Neue Bewertung</div>
                            <div style="font-weight: 600; color: #e67e22; margin-top: 5px;">
                                ${this.formatCurrency(jahressteuer)} p.a.
                            </div>
                        </div>
                        <div class="widget-item">
                            <div style="font-weight: 600; color: #27ae60; margin-bottom: 5px;">💰 Steuerersparnis</div>
                            <div style="font-size: 0.9em;">Bei Vermietung absetzbar</div>
                            <div style="font-weight: 600; color: #27ae60; margin-top: 5px;">
                                ${this.formatCurrency(jahressteuer * 0.42)} p.a.
                            </div>
                        </div>
                    `;
                }
                
                return `
                    <div class="widget-item">
                        <div style="font-weight: 600; color: #6c757d; margin-bottom: 5px;">🏛️ Grundsteuer bereit</div>
                        <div style="font-size: 0.9em;">Grundsteuerwert eingeben</div>
                    </div>
                `;
            } catch (error) {
                console.error('Error generating Grundsteuer insights:', error);
                return this.generateDefaultInsights();
            }
        }

        generateErbschaftInsights() {
            try {
                const immobilienwert = this.parseNumber(this.getElementValue('immobilienwert_erbe'), 0);
                const verwandtschaftsgrad = this.getElementValue('verwandtschaftsgrad', 'kind');
                
                if (immobilienwert > 0) {
                    const freibetraege = { 'ehepartner': 500000, 'kind': 400000, 'enkel': 200000, 'eltern': 100000, 'geschwister': 20000, 'andere': 20000 };
                    const freibetrag = freibetraege[verwandtschaftsgrad] || 20000;
                    const ueberschreitung = Math.max(0, immobilienwert * 0.9 - freibetrag);
                    
                    return `
                        <div class="widget-item">
                            <div style="font-weight: 600; color: #3498db; margin-bottom: 5px;">👨‍👩‍👧‍👦 Freibetrag</div>
                            <div style="font-size: 0.9em;">Für ${verwandtschaftsgrad}</div>
                            <div style="font-weight: 600; color: #3498db; margin-top: 5px;">
                                ${this.formatCurrency(freibetrag)}
                            </div>
                        </div>
                        <div class="widget-item ${ueberschreitung > 0 ? 'warning' : 'success'}">
                            <div style="font-weight: 600; color: ${ueberschreitung > 0 ? '#e67e22' : '#27ae60'}; margin-bottom: 5px;">
                                ${ueberschreitung > 0 ? '💸 Steuerpflichtig' : '🎉 Steuerfrei'}
                            </div>
                            <div style="font-size: 0.9em;">
                                ${ueberschreitung > 0 ? 'Freibetrag überschritten' : 'Innerhalb Freibetrag'}
                            </div>
                            <div style="font-weight: 600; color: ${ueberschreitung > 0 ? '#e67e22' : '#27ae60'}; margin-top: 5px;">
                                ${ueberschreitung > 0 ? this.formatCurrency(ueberschreitung) : 'Keine Steuer'}
                            </div>
                        </div>
                    `;
                }
                
                return `
                    <div class="widget-item">
                        <div style="font-weight: 600; color: #6c757d; margin-bottom: 5px;">👨‍👩‍👧‍👦 Erbschaft bereit</div>
                        <div style="font-size: 0.9em;">Immobilienwert eingeben</div>
                    </div>
                `;
            } catch (error) {
                console.error('Error generating Erbschaft insights:', error);
                return this.generateDefaultInsights();
            }
        }

        generateSchenkungInsights() {
            try {
                const immobilienwert = this.parseNumber(this.getElementValue('schenkung_immobilienwert'), 0);
                const anteil = this.parseNumber(this.getElementValue('schenkung_anteil'), 50);
                const verwandtschaft = this.getElementValue('schenkung_verwandtschaft', 'child');
                
                if (immobilienwert > 0) {
                    const schenkungswert = immobilienwert * anteil / 100;
                    
                    // Strukturempfehlung basierend auf Wert
                    let strukturTipp = '';
                    let optimierung = '';
                    
                    if (schenkungswert >= 500000) {
                        strukturTipp = 'Cross-Border + Familienpool';
                        optimierung = 'Internationale Optimierung';
                    } else if (schenkungswert >= 200000) {
                        strukturTipp = 'Share Deal über GmbH';
                        optimierung = '40% steuerfreier Gewinn';
                    } else {
                        strukturTipp = 'Bruchteilsgemeinschaft';
                        optimierung = 'Einfache Familienstruktur';
                    }
                    
                    return `
                        <div class="widget-item success">
                            <div style="font-weight: 600; color: #27ae60; margin-bottom: 5px;">🎁 Schenkungswert</div>
                            <div style="font-size: 0.9em;">${anteil}% = ${this.formatCurrency(schenkungswert)}</div>
                            <div style="font-weight: 600; color: #27ae60; margin-top: 5px;">
                                Empfohlen: ${strukturTipp}
                            </div>
                        </div>
                        <div class="widget-item">
                            <div style="font-weight: 600; color: #3498db; margin-bottom: 5px;">💡 ${optimierung}</div>
                            <div style="font-size: 0.9em;">Freibeträge alle 10 Jahre nutzen</div>
                            <div style="font-weight: 600; color: #3498db; margin-top: 5px;">
                                ${verwandtschaft === 'child' ? '400k€' : verwandtschaft === 'ehepartner' ? '500k€' : '200k€'} Freibetrag
                            </div>
                        </div>
                    `;
                }
                
                return `
                    <div class="widget-item">
                        <div style="font-weight: 600; color: #6c757d; margin-bottom: 5px;">🎁 Schenkung bereit</div>
                        <div style="font-size: 0.9em;">Immobilienwert eingeben für Strukturempfehlung</div>
                    </div>
                `;
            } catch (error) {
                console.error('Error generating Schenkung insights:', error);
                return this.generateDefaultInsights();
            }
        }

        generateStrategieInsights() {
            try {
                const alter = this.parseNumber(this.getElementValue('strategie_alter'), 0);
                const risiko = this.getElementValue('strategie_risiko', 'mittel');
                const weitereImmobilien = this.getElementValue('strategie_weitere_immobilien', 'wenige');
                
                if (alter > 0) {
                    let empfehlung = '';
                    let struktur = '';
                    let zusatzTipp = '';
                    
                    if (alter < 40) {
                        empfehlung = 'Langfristig Portfolio aufbauen';
                        if (weitereImmobilien === 'portfolio' || weitereImmobilien === 'grossprojekt') {
                            struktur = 'VV GmbH & Co. KG + Familienpool';
                            zusatzTipp = 'Skalierbare Strukturen wählen';
                        } else {
                            struktur = 'VV GmbH & Co. KG';
                            zusatzTipp = 'Gewerbesteuerfrei + flexibel';
                        }
                    } else if (alter < 55) {
                        empfehlung = 'Optimierung + Nachfolge';
                        if (risiko === 'hoch') {
                            struktur = 'Cross-Border + Familienpool';
                            zusatzTipp = 'International diversifizieren';
                        } else {
                            struktur = 'Share Deal + Familienpool';
                            zusatzTipp = '40% steuerfreier Gewinn möglich';
                        }
                    } else {
                        empfehlung = 'Nachfolgeplanung fokussieren';
                        struktur = 'Familienpool + Bruchteilsgemeinschaft';
                        zusatzTipp = 'Steueroptimierte Übertragung';
                    }
                    
                    return `
                        <div class="widget-item success">
                            <div style="font-weight: 600; color: #27ae60; margin-bottom: 5px;">🎯 Strategie (${alter} J.)</div>
                            <div style="font-size: 0.9em;">${empfehlung}</div>
                            <div style="font-weight: 600; color: #27ae60; margin-top: 5px;">
                                ${struktur}
                            </div>
                        </div>
                        <div class="widget-item">
                            <div style="font-weight: 600; color: #3498db; margin-bottom: 5px;">💡 Immobilien-spezifisch</div>
                            <div style="font-size: 0.9em;">${zusatzTipp}</div>
                            <div style="font-weight: 600; color: #3498db; margin-top: 5px;">
                                Asset vs Share Deal beachten
                            </div>
                        </div>
                    `;
                }
                
                return `
                    <div class="widget-item">
                        <div style="font-weight: 600; color: #6c757d; margin-bottom: 5px;">🎯 Strategie bereit</div>
                        <div style="font-size: 0.9em;">Alter eingeben für maßgeschneiderte Immobilien-Strategie</div>
                    </div>
                `;
            } catch (error) {
                console.error('Error generating Strategie insights:', error);
                return this.generateDefaultInsights();
            }
        }

        generateDefaultInsights() {
            return `
                <div class="widget-item">
                    <div style="font-weight: 600; color: #6c757d; margin-bottom: 5px;">💡 Bereit für Ihre Daten</div>
                    <div style="font-size: 0.9em;">Geben Sie die relevanten Werte ein für personalisierte Empfehlungen</div>
                </div>
                <div class="widget-item">
                    <div style="font-weight: 600; color: #3498db; margin-bottom: 5px;">🏆 Top-Strukturen 2025</div>
                    <div style="font-size: 0.9em;">Familienpool • Share Deal • Cross-Border</div>
                    <div style="font-weight: 600; color: #3498db; margin-top: 5px;">
                        VV GmbH & Co. KG gewerbesteuerfrei
                    </div>
                </div>
                <div class="widget-item">
                    <div style="font-weight: 600; color: #27ae60; margin-bottom: 5px;">⚡ Neue Optimierungen</div>
                    <div style="font-size: 0.9em;">Asset vs Share Deal • Bruchteilsgemeinschaft</div>
                    <div style="font-weight: 600; color: #27ae60; margin-top: 5px;">
                        Bis zu 40% steuerfreier Gewinn
                    </div>
                </div>
            `;
        }

        // Export and utility methods
        exportReport() {
            try {
                const reportData = {
                    formData: this.collectAllFormData(),
                    timestamp: new Date().toISOString(),
                    version: this.config.version
                };
                
                this.modules.export.generatePDFReport(reportData);
                this.showToast('📋 Bericht wurde erstellt', 'success');
            } catch (error) {
                console.error('Export error:', error);
                this.showToast('❌ Fehler beim Export', 'error');
            }
        }

        resetData() {
            if (confirm('Möchten Sie wirklich alle Daten zurücksetzen?')) {
                this.modules.storage.clear();
                
                document.querySelectorAll('input').forEach(input => {
                    if (input.type === 'number') {
                        input.value = input.getAttribute('value') || '';
                    }
                });
                
                document.querySelectorAll('select').forEach(select => {
                    select.selectedIndex = 0;
                });
                
                ['verkauf-results', 'grundsteuer-results', 'erbschaft-results', 
                 'schenkung-results', 'cashflow-results', 'strategie-results'].forEach(id => {
                    const container = document.getElementById(id);
                    if (container) container.innerHTML = '';
                });
                
                this.showToast('✅ Alle Daten wurden zurückgesetzt', 'success');
            }
        }

        loadExample() {
            const exampleData = {
                kaufpreis: 450000,
                verkaufspreis: 650000,
                nebenkosten_kauf: 45000,
                nebenkosten_verkauf: 32500,
                modernisierung: 40000,
                haltedauer: 7,
                steuersatz: 42,
                kirchensteuer: 8,
                bundesland: 'by',
                // Zusätzliche Beispieldaten für andere Module
                grundstueckswert: 520000,
                gemeinde_hebesatz: 520,
                immobilienwert_erbe: 650000,
                verwandtschaftsgrad: 'kind',
                schenkung_immobilienwert: 650000,
                jahresmiete_schenkung: 26000,
                cf_jahresmiete: 26000,
                cf_instandhaltung: 3000,
                strategie_alter: 48,
                strategie_einkommen: 95000
            };

            this.populateFormData(exampleData);
            this.saveData();
            this.updateDashboardWidget();
            this.updateSidebarDashboard();
            
            this.showToast('💡 Beispieldaten geladen - München, Premium-Mehrfamilienhaus, 650k€', 'success');
            
            setTimeout(() => {
                if (this.hasMinimumData(this.getCurrentSection())) {
                    this.triggerCalculation(this.getCurrentSection());
                }
            }, 500);
        }

        showExtendedAnalyse() {
            try {
                const formData = this.collectAllFormData();
                const kaufpreis = this.parseNumber(formData.kaufpreis);
                const verkaufspreis = this.parseNumber(formData.verkaufspreis);
                const gewinn = verkaufspreis - kaufpreis;
                const haltedauer = this.parseNumber(formData.haltedauer);
                
                // Strategieempfehlung basierend auf Gewinn und Haltedauer
                let empfehlung = '';
                let timelineAktiv = [];
                
                if (gewinn > 500000) {
                    empfehlung = '🏆 Cross-Border DE-LU/CH Struktur mit EU-Holding';
                    timelineAktiv = ['optimierung', 'exit'];
                } else if (gewinn > 200000) {
                    empfehlung = '🏢 VV GmbH & Co. KG mit Share Deal (40% steuerfrei)';
                    timelineAktiv = haltedauer < 8 ? ['kauf', 'optimierung'] : ['optimierung'];
                } else {
                    empfehlung = '🏠 VV GbR oder Familienpool für einfache Strukturen';
                    timelineAktiv = haltedauer >= 10 ? ['exit'] : ['haltung'];
                }

                const analyseHTML = `
                    <div class="alert alert-success">
                        <div class="alert-content">
                            <div class="alert-title">🔍 Erweiterte Immobilien-Analyse - BFH 2025</div>
                            <div style="margin-top: 15px;">
                                <strong>📈 Portfolio-Bewertung:</strong><br>
                                • Aktueller Verkaufsgewinn: ${this.formatCurrency(gewinn)}<br>
                                • Optimale Rechtsform: ${empfehlung}<br>
                                • Maximales Steueroptimierungspotential: ${this.formatCurrency(gewinn * 0.18)}<br>
                                • Empfohlener Umsetzungszeitraum: ${haltedauer < 8 ? '6-12 Monate' : '3-6 Monate'}
                            </div>
                            
                            <div style="margin-top: 15px;">
                                <strong>⚖️ Rechtliche Rahmenbedingungen 2025:</strong><br>
                                • <strong>BFH-Urteil:</strong> VV GmbH & Co. KG gewerbesteuerfrei bei reiner Vermietung<br>
                                • <strong>Share Deal:</strong> 40% des Gewinns steuerfrei nach §8b KStG<br>
                                • <strong>Zinswende:</strong> Nießbrauchswerte um 20-30% gesunken = Schenkungschancen<br>
                                • <strong>Cross-Border:</strong> EU-Strukturen ab 500k€ Portfolio hochattraktiv
                            </div>
                            
                            <div style="margin-top: 15px;">
                                <strong>💡 Sofort-Optimierungen:</strong><br>
                                1. <strong>Struktur-Check:</strong> Aktuelle Rechtsform binnen 30 Tagen prüfen<br>
                                2. <strong>Timing:</strong> ${haltedauer < 10 ? `Noch ${(10-haltedauer).toFixed(1)} Jahre bis steuerfrei` : 'Verkauf jetzt steuerfrei möglich'}<br>
                                3. <strong>Nachfolge:</strong> ${gewinn > 200000 ? 'Schenkungsstrategie entwickeln' : 'Einfache Übertragung planen'}<br>
                                4. <strong>Portfolio:</strong> Weitere Immobilien in gleicher Struktur bündeln
                            </div>
                        </div>
                    </div>
                    
                    <div class="card mt-4">
                        <div class="card-header">
                            <h3 class="card-title">📝 Konkreter Maßnahmenplan</h3>
                        </div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Priorität</th>
                                    <th>Maßnahme</th>
                                    <th>Zeitrahmen</th>
                                    <th>Kosten</th>
                                    <th>Ersparnis</th>
                                    <th>ROI</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="best-row">
                                    <td>🔥 HOCH</td>
                                    <td><strong>Strukturwechsel VV GmbH & Co. KG</strong></td>
                                    <td>3-6 Monate</td>
                                    <td>${this.formatCurrency(3500)}</td>
                                    <td>${this.formatCurrency(gewinn * 0.15)}</td>
                                    <td>${Math.round((gewinn * 0.15) / 3500)}x</td>
                                </tr>
                                <tr>
                                    <td>⚡ MITTEL</td>
                                    <td>Steuerliches Gutachten Immobilienwert</td>
                                    <td>1-2 Monate</td>
                                    <td>${this.formatCurrency(2000)}</td>
                                    <td>${this.formatCurrency(gewinn * 0.08)}</td>
                                    <td>${Math.round((gewinn * 0.08) / 2000)}x</td>
                                </tr>
                                <tr>
                                    <td>📋 LANG</td>
                                    <td>Nachfolgeplanung & Schenkungsstrategie</td>
                                    <td>6-18 Monate</td>
                                    <td>${this.formatCurrency(4500)}</td>
                                    <td>${this.formatCurrency(gewinn * 0.25)}</td>
                                    <td>${Math.round((gewinn * 0.25) / 4500)}x</td>
                                </tr>
                                ${gewinn > 500000 ? `
                                <tr>
                                    <td>🌍 EXPERT</td>
                                    <td>Cross-Border Struktur (DE-LU/CH)</td>
                                    <td>6-12 Monate</td>
                                    <td>${this.formatCurrency(15000)}</td>
                                    <td>${this.formatCurrency(gewinn * 0.18)}</td>
                                    <td>${Math.round((gewinn * 0.18) / 15000)}x</td>
                                </tr>
                                ` : ''}
                            </tbody>
                        </table>
                    </div>

                    <div class="alert alert-warning mt-3">
                        <div class="alert-content">
                            <div class="alert-title">⚠️ Wichtige Fristen & Deadlines</div>
                            <p><strong>3-Objekte-Regel:</strong> Max. 3 Verkäufe in 5 Jahren für Vermögensverwaltung<br>
                            <strong>10-Jahres-Frist:</strong> ${haltedauer >= 10 ? '✅ Erreicht - steuerfrei!' : `⏰ Noch ${(10-haltedauer).toFixed(1)} Jahre`}<br>
                            <strong>Schenkung-Freibeträge:</strong> Alle 10 Jahre neu nutzbar<br>
                            <strong>BFH-Rechtsprechung:</strong> Aktuell gültig, aber Gesetzesänderungen möglich</p>
                        </div>
                    </div>
                `;

                // Zur Strategie-Sektion wechseln und Analyse anzeigen
                this.navigate('strategie');
                setTimeout(() => {
                    const container = document.getElementById('strategie-results');
                    if (container) {
                        container.innerHTML = analyseHTML;
                    }
                }, 300);
                
                this.showToast('🔍 Erweiterte Analyse wurde erstellt', 'success');
                
            } catch (error) {
                console.error('Extended analysis error:', error);
                this.showToast('❌ Fehler bei der erweiterten Analyse', 'error');
            }
        }

        triggerCalculation(section) {
            const calculationMethods = {
                'verkauf': () => this.calculateVerkauf(),
                'grundsteuer': () => this.calculateGrundsteuer(),
                'erbschaft': () => this.calculateErbschaft(),
                'schenkung': () => this.calculateSchenkung(),
                'cashflow': () => this.calculateCashFlow(),
                'strategie': () => this.calculateStrategie()
            };

            const method = calculationMethods[section];
            if (method) {
                method();
            }
        }

        getCalculationResults() {
            // Sammle alle verfügbaren Berechnungsergebnisse
            const results = {};
            
            // Verkauf Ergebnisse
            const verkaufContainer = document.getElementById('verkauf-results');
            if (verkaufContainer && verkaufContainer.innerHTML.trim()) {
                results.verkauf = {
                    hasResults: true,
                    timestamp: Date.now()
                };
            }
            
            // Grundsteuer Ergebnisse
            const grundsteuerContainer = document.getElementById('grundsteuer-results');
            if (grundsteuerContainer && grundsteuerContainer.innerHTML.trim()) {
                results.grundsteuer = {
                    hasResults: true,
                    timestamp: Date.now()
                };
            }
            
            // Weitere Ergebnisse...
            ['erbschaft', 'schenkung', 'cashflow', 'strategie'].forEach(section => {
                const container = document.getElementById(`${section}-results`);
                if (container && container.innerHTML.trim()) {
                    results[section] = {
                        hasResults: true,
                        timestamp: Date.now()
                    };
                }
            });
            
            return results;
        }

        // Enhanced Event Handling with Better Performance
        attachEventHandlers(section) {
            const inputs = document.querySelectorAll('#app-content input, #app-content select');
            
            // Debounced input handler für Live-Updates
            const debouncedHandler = this.debounce((input) => {
                this.handleInputChange(input, section);
            }, 300);

            // Immediate handler für wichtige Felder
            const immediateHandler = (input) => {
                this.handleImportantFieldChange(input, section);
            };

            inputs.forEach(input => {
                // Remove existing listeners to prevent duplicates
                input.removeEventListener('input', debouncedHandler);
                input.removeEventListener('change', debouncedHandler);
                
                // Add new listeners
                input.addEventListener('input', () => {
                    // Für wichtige Felder sofortiges Dashboard-Update
                    if (this.isImportantField(input.id)) {
                        immediateHandler(input);
                    }
                    debouncedHandler(input);
                });
                
                input.addEventListener('change', () => debouncedHandler(input));
                
                // Add validation on blur
                input.addEventListener('blur', () => this.validateInput(input));
            });

            // Add form validation indicators
            this.setupFormValidation();
        }

        isImportantField(fieldId) {
            const importantFields = [
                'kaufpreis', 'verkaufspreis', 'haltedauer', 'steuersatz',
                'grundstueckswert', 'immobilienwert_erbe', 'schenkung_immobilienwert',
                'cf_jahresmiete', 'strategie_alter'
            ];
            return importantFields.includes(fieldId);
        }

        handleImportantFieldChange(input, section) {
            // Sofortiges Dashboard-Update für wichtige Felder
            clearTimeout(this.immediateUpdateTimeout);
            this.immediateUpdateTimeout = setTimeout(() => {
                this.updateDashboardWidget();
                this.updateSidebarDashboard();
            }, 100);
        }

        // Enhanced auto-save with conflict resolution
        saveData() {
            try {
                const formData = this.collectAllFormData();
                const metadata = {
                    version: this.config.version,
                    timestamp: Date.now(),
                    section: this.state.currentSection,
                    userAgent: navigator.userAgent,
                    calculations: this.getCalculationResults()
                };
                
                // Check for conflicts
                const existingData = this.modules.storage.load('immobilien-suite-data');
                if (existingData && existingData.metadata) {
                    const timeDiff = Date.now() - existingData.metadata.timestamp;
                    if (timeDiff < 5000) { // Less than 5 seconds
                        // Potential conflict - merge data
                        formData = this.mergeFormData(existingData.formData, formData);
                    }
                }
                
                this.modules.storage.save('immobilien-suite-data', { formData, metadata });
                this.state.lastSave = Date.now();
                this.state.isDirty = false;
                
                // Erfolgs-Feedback nur bei manueller Speicherung
                if (this.manualSave) {
                    this.showToast('✅ Daten erfolgreich gespeichert', 'success');
                    this.manualSave = false;
                }
                
                if (this.config.debug) {
                    console.log('Data saved successfully');
                }
                
            } catch (error) {
                console.error('Error saving data:', error);
                this.showToast('⚠️ Daten konnten nicht gespeichert werden', 'warning');
            }
        }

        mergeFormData(existingData, newData) {
            // Intelligente Datenzusammenführung
            const merged = { ...existingData };
            
            Object.entries(newData).forEach(([key, value]) => {
                if (value && value.toString().trim() !== '') {
                    merged[key] = value;
                }
            });
            
            return merged;
        }
    }

    // Essential Supporting Modules (Simplified for space)

    class ValidationModule {
        constructor(config) {
            this.config = config;
        }

        validateVerkaufData(data) {
            const errors = [];
            
            if (!data.kaufpreis || data.kaufpreis <= 0) {
                errors.push('Kaufpreis muss größer als 0 sein');
            }
            
            if (!data.verkaufspreis || data.verkaufspreis <= 0) {
                errors.push('Verkaufspreis muss größer als 0 sein');
            }
            
            if (data.verkaufspreis <= data.kaufpreis) {
                errors.push('Verkaufspreis sollte höher als Kaufpreis sein');
            }
            
            return {
                isValid: errors.length === 0,
                errors
            };
        }

        validateField(input) {
            const value = input.value;
            const type = input.type;
            const min = parseFloat(input.min);
            const max = parseFloat(input.max);
            const required = input.required;

            if (required && !value) {
                return { isValid: false, error: 'Dieses Feld ist erforderlich' };
            }

            if (type === 'number' && value) {
                const num = parseFloat(value);
                if (isNaN(num)) {
                    return { isValid: false, error: 'Bitte geben Sie eine gültige Zahl ein' };
                }
                if (!isNaN(min) && num < min) {
                    return { isValid: false, error: `Wert muss mindestens ${min} sein` };
                }
                if (!isNaN(max) && num > max) {
                    return { isValid: false, error: `Wert darf maximal ${max} sein` };
                }
            }

            return { isValid: true };
        }
    }

    // Enhanced Tax Calculator Module (Core calculation engine)
    class EnhancedTaxCalculatorModule {
        constructor(config) {
            this.config = config;
            this.cache = new Map();
            
            // 2025 tax rates and thresholds
            this.hebesaetze = {
                'bw': 380, 'by': 340, 'be': 410, 'bb': 400, 'hb': 430,
                'hh': 470, 'he': 420, 'mv': 350, 'ni': 380, 'nw': 450,
                'rp': 440, 'sl': 430, 'sn': 420, 'st': 390, 'sh': 370, 'th': 360
            };

            this.legalStructures = {
                'privatverkauf': { 
                    name: 'Privatverkauf', 
                    advantages: ['Steuerfrei nach 10 Jahren', 'Einfachste Abwicklung'],
                    suitableFor: 'Alle Immobilien'
                },
                'vv_gmbh_co_kg': { 
                    name: 'VV GmbH & Co. KG', 
                    advantages: ['BFH 2025: Gewerbesteuerfrei!', 'Haftungsbeschränkung', 'Flexibel'],
                    suitableFor: 'Vermögensverwaltung, ab 200k€ Gewinn'
                },
                'familienpool': {
                    name: 'Familienpool (GbR)',
                    advantages: ['Steuerverteilung auf Familie', 'Progression brechen'],
                    suitableFor: 'Familien mit mehreren Steuerpflichtigen'
                },
                'asset_deal': { 
                    name: 'Asset Deal (GmbH)', 
                    disadvantages: ['Doppelbesteuerung'],
                    suitableFor: 'Selten optimal für Immobilien'
                },
                'share_deal': {
                    name: 'Share Deal (GmbH)',
                    advantages: ['40% steuerfreier Gewinn (§8b KStG)'],
                    suitableFor: 'Ab 5% Beteiligung, größere Gewinne'
                },
                'bruchteilsgemeinschaft': {
                    name: 'Bruchteilsgemeinschaft',
                    advantages: ['Aufteilung auf mehrere Personen', 'Transparent'],
                    suitableFor: 'Mehrere Eigentümer, familiäre Strukturen'
                },
                'cross_border': { 
                    name: 'Cross-Border Strukturen', 
                    advantages: ['Steueroptimierung'], 
                    minimum_profit: 300000,
                    suitableFor: 'Große Gewinne, internationale Investoren'
                }
            };
        }

        async calculateVerkaufsteuer(data) {
            const cacheKey = JSON.stringify(data);
            if (this.cache.has(cacheKey)) {
                return this.cache.get(cacheKey);
            }

            const results = await this.performVerkaufCalculation(data);
            this.cache.set(cacheKey, results);
            return results;
        }

        async performVerkaufCalculation(data) {
            const anschaffungskosten = data.kaufpreis + data.nebenkostenKauf + data.modernisierung;
            const grossProfit = data.verkaufspreis - data.nebenkostenVerkauf - anschaffungskosten;
            
            if (grossProfit <= 0) {
                return this.createNoProfitResult(grossProfit);
            }

            const structures = [];
            const hebesatz = this.hebesaetze[data.bundesland] || 450;

            // 1. Privatverkauf
            const privateTax = this.calculateSpeculationTax(grossProfit, data.haltedauer, data.steuersatz, data.kirchensteuer);
            structures.push({
                name: 'Privatverkauf',
                grossProfit,
                tax: privateTax,
                netProfit: grossProfit - privateTax,
                taxRate: grossProfit > 0 ? (privateTax / grossProfit * 100) : 0,
                advantages: data.haltedauer >= 10 ? ['Steuerfrei nach 10 Jahren'] : ['Einfache Abwicklung'],
                disadvantages: data.haltedauer < 10 ? ['Spekulationssteuer'] : [],
                recommendation: data.haltedauer >= 10 ? 'optimal' : 'prüfenswert'
            });

            // 2. VV GmbH & Co. KG (2025: Gewerbesteuerfrei!)
            structures.push({
                name: 'VV GmbH & Co. KG',
                grossProfit,
                tax: privateTax, // No trade tax since 2025
                netProfit: grossProfit - privateTax,
                taxRate: grossProfit > 0 ? (privateTax / grossProfit * 100) : 0,
                advantages: ['BFH 2025: Gewerbesteuerfrei!', 'Haftungsbeschränkung', 'Nach 10 Jahren steuerfrei'],
                disadvantages: ['Komplexere Struktur'],
                recommendation: 'optimal'
            });

            // Add more structures...
            const additionalStructures = this.generateAdditionalStructures(data, grossProfit, hebesatz);
            structures.push(...additionalStructures);

            // Sort by net profit
            structures.sort((a, b) => b.netProfit - a.netProfit);

            return {
                structures,
                maxNetProfit: Math.max(...structures.map(s => s.netProfit)),
                bestStructure: structures[0],
                totalSavings: structures[0].netProfit - structures[structures.length - 1].netProfit,
                recommendation: this.generateRecommendation(structures[0], data)
            };
        }

        calculateSpeculationTax(profit, holdingPeriod, taxRate, churchTax) {
            if (profit <= 0 || holdingPeriod >= 10) return 0;
            
            const incomeTax = profit * (taxRate / 100);
            const churchTaxAmount = incomeTax * (churchTax / 100);
            const solidarityTax = incomeTax * 0.055;
            
            return incomeTax + churchTaxAmount + solidarityTax;
        }

        generateAdditionalStructures(data, grossProfit, hebesatz) {
            const structures = [];
            const personalTax = this.calculateSpeculationTax(grossProfit, data.haltedauer, data.steuersatz, data.kirchensteuer);
            const corporateTax = grossProfit * 0.15; // Körperschaftsteuer 15%
            const tradeTax = grossProfit * (hebesatz / 100) * 0.035; // Gewerbesteuer
            const combinedCorporateTax = corporateTax + tradeTax + (corporateTax * 0.055); // Mit Soli

            // 3. VV GbR (Gesellschaft bürgerlichen Rechts)
            structures.push({
                name: 'VV GbR',
                grossProfit,
                tax: personalTax,
                netProfit: grossProfit - personalTax,
                taxRate: grossProfit > 0 ? (personalTax / grossProfit * 100) : 0,
                advantages: ['Transparente Besteuerung', 'Verlustverrechnung möglich', 'Einfache Gründung'],
                disadvantages: ['Persönliche Haftung', 'Spekulationssteuer unter 10 Jahren'],
                recommendation: data.haltedauer >= 10 ? 'gut' : 'prüfenswert'
            });

            // 4. Familienpool / Familiengesellschaft (GbR)
            const familyTax = personalTax * 0.7; // Steuerverteilung auf Familienmitglieder
            
            structures.push({
                name: 'Familienpool (GbR)',
                grossProfit,
                tax: familyTax,
                netProfit: grossProfit - familyTax,
                taxRate: grossProfit > 0 ? (familyTax / grossProfit * 100) : 0,
                advantages: ['Steuerverteilung auf Familie', 'Progression brechen', 'Generationenübergreifend'],
                disadvantages: ['Mehrere Gesellschafter nötig', 'Gesellschaftsvertrag erforderlich'],
                recommendation: 'optimal'
            });

            // 5. VV GmbH - Asset Deal (Immobilienverkauf)
            const gmbhAssetTax = combinedCorporateTax + (grossProfit - combinedCorporateTax) * 0.26375;
            
            structures.push({
                name: 'VV GmbH (Asset Deal)',
                grossProfit,
                tax: gmbhAssetTax,
                netProfit: grossProfit - gmbhAssetTax,
                taxRate: grossProfit > 0 ? (gmbhAssetTax / grossProfit * 100) : 0,
                advantages: ['Haftungsbeschränkung', 'Planbare Besteuerung'],
                disadvantages: ['Doppelbesteuerung', 'Gewerbesteuer'],
                recommendation: 'nicht empfohlen'
            });

            // 6. VV GmbH - Share Deal (Anteilsverkauf)
            const gmbhShareTax = personalTax * 0.6; // Nur 60% der Anteile steuerpflichtig (§8b KStG)
            
            structures.push({
                name: 'VV GmbH (Share Deal)',
                grossProfit,
                tax: gmbhShareTax,
                netProfit: grossProfit - gmbhShareTax,
                taxRate: grossProfit > 0 ? (gmbhShareTax / grossProfit * 100) : 0,
                advantages: ['40% steuerfreier Gewinn (§8b KStG)', 'Haftungsbeschränkung'],
                disadvantages: ['5% Mindestbeteiligung erforderlich', 'Komplexe Struktur'],
                recommendation: grossProfit >= 200000 ? 'gut' : 'prüfenswert'
            });

            // 7. GmbH mit Thesaurierung (Gewinne einbehalten)
            const thesaurierungTax = combinedCorporateTax; // Keine Ausschüttung
            
            structures.push({
                name: 'VV GmbH (Thesaurierung)',
                grossProfit,
                tax: thesaurierungTax,
                netProfit: grossProfit - thesaurierungTax,
                taxRate: grossProfit > 0 ? (thesaurierungTax / grossProfit * 100) : 0,
                advantages: ['Niedrigste Sofortbelastung', 'Reinvestition möglich', 'Spätere Optimierung'],
                disadvantages: ['Geld in GmbH "gefangen"', 'Spätere Ausschüttungsbelastung'],
                recommendation: 'gut'
            });

            // 8. Bruchteilsgemeinschaft
            const bruchteilTax = personalTax * 0.8; // Etwas günstiger durch Aufteilung
            
            structures.push({
                name: 'Bruchteilsgemeinschaft',
                grossProfit,
                tax: bruchteilTax,
                netProfit: grossProfit - bruchteilTax,
                taxRate: grossProfit > 0 ? (bruchteilTax / grossProfit * 100) : 0,
                advantages: ['Aufteilung auf mehrere Personen', 'Einfache Struktur', 'Steuerlich transparent'],
                disadvantages: ['Alle Eigentümer müssen zustimmen', 'Komplizierte Verwaltung'],
                recommendation: 'gut'
            });

            // 9. VV Kommanditgesellschaft (KG)
            const kgTax = personalTax; // Transparente Besteuerung
            
            structures.push({
                name: 'VV Kommanditgesellschaft',
                grossProfit,
                tax: kgTax,
                netProfit: grossProfit - kgTax,
                taxRate: grossProfit > 0 ? (kgTax / grossProfit * 100) : 0,
                advantages: ['Haftungsbeschränkung für Kommanditisten', 'Transparente Besteuerung', 'Flexible Gewinnverteilung'],
                disadvantages: ['Komplementär haftet unbeschränkt', 'Spekulationssteuer bei <10 Jahren'],
                recommendation: 'gut'
            });

            // 10. Cross-Border DE-LU (Luxemburg)
            if (grossProfit >= 500000) {
                const luxTax = grossProfit * 0.17; // Luxemburg niedrigere Körperschaftsteuer
                
                structures.push({
                    name: 'Cross-Border DE-LU',
                    grossProfit,
                    tax: luxTax,
                    netProfit: grossProfit - luxTax,
                    taxRate: grossProfit > 0 ? (luxTax / grossProfit * 100) : 0,
                    advantages: ['Nur 17% Körperschaftsteuer', 'EU-Holding-Vorteile', 'Keine deutsche Gewerbesteuer'],
                    disadvantages: ['Mindestgewinn 500.000€', 'Komplexe Struktur', 'Hohe Beratungskosten'],
                    recommendation: grossProfit >= 1000000 ? 'optimal' : 'prüfenswert'
                });
            }

            // 11. Cross-Border DE-AT (Österreich)
            if (grossProfit >= 300000) {
                const atTax = grossProfit * 0.23; // Österreich KESt
                
                structures.push({
                    name: 'Cross-Border DE-AT',
                    grossProfit,
                    tax: atTax,
                    netProfit: grossProfit - atTax,
                    taxRate: grossProfit > 0 ? (atTax / grossProfit * 100) : 0,
                    advantages: ['23% Steuerbelastung', 'Einfachere Struktur als LU', 'Deutsche Sprache'],
                    disadvantages: ['Mindestgewinn 300.000€', 'DBA-Grenzen beachten'],
                    recommendation: grossProfit >= 500000 ? 'gut' : 'prüfenswert'
                });
            }

            // 12. Cross-Border DE-CH (Schweiz) 
            if (grossProfit >= 400000) {
                const chTax = grossProfit * 0.12; // Schweiz sehr niedrige Besteuerung
                
                structures.push({
                    name: 'Cross-Border DE-CH',
                    grossProfit,
                    tax: chTax,
                    netProfit: grossProfit - chTax,
                    taxRate: grossProfit > 0 ? (chTax / grossProfit * 100) : 0,
                    advantages: ['Nur 12% Steuerbelastung', 'Politische Stabilität', 'Starker Franken'],
                    disadvantages: ['Hohe Gründungskosten', 'Währungsrisiko', 'Substance Requirements'],
                    recommendation: grossProfit >= 750000 ? 'optimal' : 'gut'
                });
            }

            // 13. Gemeinnützige Stiftung (bei >1 Mio.)
            if (grossProfit >= 1000000) {
                const stiftungTax = grossProfit * 0.05; // Sehr niedrige Besteuerung
                
                structures.push({
                    name: 'Gemeinnützige Stiftung',
                    grossProfit,
                    tax: stiftungTax,
                    netProfit: grossProfit - stiftungTax,
                    taxRate: grossProfit > 0 ? (stiftungTax / grossProfit * 100) : 0,
                    advantages: ['Nur 5% Besteuerung', 'Steuerfreie Rücklagen', 'Gemeinnützige Zwecke'],
                    disadvantages: ['Mindestausstattung 1 Mio.€', 'Zweckbindung', 'Keine private Nutzung'],
                    recommendation: 'prüfenswert'
                });
            }

            // 14. Erbengemeinschaft (Sonderfall)
            if (data.isInheritance) {
                const erbschaftTax = personalTax * 0.5; // 50% Ermäßigung durch Erbfall
                
                structures.push({
                    name: 'Erbengemeinschaft',
                    grossProfit,
                    tax: erbschaftTax,
                    netProfit: grossProfit - erbschaftTax,
                    taxRate: grossProfit > 0 ? (erbschaftTax / grossProfit * 100) : 0,
                    advantages: ['50% Steuerermäßigung möglich', 'Aufteilung auf Erben'],
                    disadvantages: ['Alle Erben müssen zustimmen', 'Zeitdruck durch Erbauseinandersetzung'],
                    recommendation: 'gut'
                });
            }

            return structures;
        }

        generateRecommendation(bestStructure, data) {
            const profit = data.verkaufspreis - data.kaufpreis;
            
            if (data.haltedauer >= 10) {
                return `Steuerfreier Verkauf nach 10 Jahren ist optimal. Für weitere Immobilien empfehlen wir ${profit >= 200000 ? 'einen Familienpool (GbR) zur Steuerverteilung' : 'eine VV GmbH & Co. KG'} zur strukturierten Optimierung.`;
            }
            
            if (profit >= 1000000) {
                return `Bei Ihrem sehr hohen Gewinn sind Cross-Border-Strukturen oder gemeinnützige Stiftungen optimal. ${bestStructure.name} kann Ihre Steuerbelastung auf unter 17% senken - eine Ersparnis von über ${this.formatCurrency(profit * 0.25)}.`;
            }
            
            if (profit >= 500000) {
                return `Für große Gewinne ist ${bestStructure.name} nach Prüfung aller immobilienrelevanten Strukturen optimal. Cross-Border-Strukturen (DE-LU, DE-CH) und Share Deals wurden speziell für Ihre Gewinnhöhe analysiert.`;
            }
            
            if (profit >= 200000) {
                return `Bei mittleren Gewinnen bietet ein Share Deal über GmbH 40% steuerfreien Gewinn (§8b KStG). ${bestStructure.name} ist nach Vergleich mit Familienpool, Bruchteilsgemeinschaft und VV-Strukturen die beste Wahl.`;
            }
            
            if (profit >= 100000) {
                return `Für Ihren Gewinn ist ein Familienpool (GbR) zur Steuerverteilung meist optimal. ${bestStructure.name} nutzt die Progression optimal - verglichen mit allen immobilienspezifischen Alternativen.`;
            }
            
            return `Nach Analyse aller immobilienrelevanten Rechtsformen (inkl. Familienpool, Asset/Share Deal, Bruchteilsgemeinschaft) ist ${bestStructure.name} optimal mit ${this.formatCurrency(bestStructure.netProfit)} Nettogewinn.`;
        }

        createNoProfitResult(grossProfit) {
            return {
                structures: [{
                    name: 'Kein Gewinn',
                    grossProfit,
                    tax: 0,
                    netProfit: grossProfit,
                    taxRate: 0,
                    advantages: ['Keine Steuer'],
                    disadvantages: ['Verlust'],
                    recommendation: 'Verkauf überdenken'
                }],
                maxNetProfit: grossProfit,
                bestStructure: null,
                totalSavings: 0,
                recommendation: 'Bei Verlust fallen keine Steuern an.'
            };
        }

        formatCurrency(amount) {
            return new Intl.NumberFormat('de-DE', {
                style: 'currency',
                currency: 'EUR',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }
    }

    // Essential Supporting Modules (Basic implementations)
    class StorageModule {
        save(key, data) {
            try {
                memoryStorage.setItem(key, JSON.stringify({
                    data,
                    timestamp: Date.now(),
                    version: '3.0.0'
                }));
            } catch (error) {
                console.error('Storage save error:', error);
            }
        }

        load(key) {
            try {
                const stored = memoryStorage.getItem(key);
                if (!stored) return null;
                return JSON.parse(stored).data;
            } catch (error) {
                console.error('Storage load error:', error);
                return null;
            }
        }

        clear() {
            memoryStorage.clear();
        }
    }

    class UIModule {
        constructor(app) {
            this.app = app;
            this.setupEventListeners();
        }

        setupEventListeners() {
            // Global keyboard shortcuts and UI interactions
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey || e.metaKey) {
                    switch (e.key) {
                        case 's':
                            e.preventDefault();
                            this.app.saveData();
                            break;
                        case 'e':
                            e.preventDefault();
                            this.app.exportReport();
                            break;
                    }
                }
            });
        }
    }

    class ChartModule {
        // Chart generation methods
    }

    class DashboardModule {
        constructor(app) {
            this.app = app;
            this.updateInterval = null;
            this.isActive = false;
            this.init();
        }

        init() {
            // Initialize sidebar dashboard
            this.isActive = true;
            setTimeout(() => {
                this.updateSidebarDashboard();
            }, 100);
        }

        startLiveUpdates() {
            if (this.updateInterval) {
                clearInterval(this.updateInterval);
            }
            
            this.isActive = true;
            
            // Immediate update
            setTimeout(() => {
                this.updateLiveInsights();
                this.updateSidebarDashboard();
            }, 200);
            
            // Regular updates every 5 seconds
            this.updateInterval = setInterval(() => {
                if (this.isActive) {
                    this.updateLiveInsights();
                    this.updateSidebarDashboard();
                }
            }, 5000);
        }

        updateLiveInsights() {
            if (this.app && this.app.updateDashboardWidget) {
                this.app.updateDashboardWidget();
            }
        }

        updateSidebarDashboard() {
            try {
                const sidebarDashboard = document.getElementById('dashboard-content');
                if (sidebarDashboard && this.app && this.isActive) {
                    const insights = this.app.generateCurrentInsights();
                    if (insights && insights.trim()) {
                        sidebarDashboard.innerHTML = insights;
                    } else {
                        sidebarDashboard.innerHTML = this.getDefaultContent();
                    }
                }
            } catch (error) {
                console.error('Sidebar dashboard update error:', error);
                const sidebarDashboard = document.getElementById('dashboard-content');
                if (sidebarDashboard) {
                    sidebarDashboard.innerHTML = this.getErrorContent();
                }
            }
        }

        getDefaultContent() {
            return `
                <div class="widget-item">
                    <div style="font-weight: 600; color: #3498db; margin-bottom: 5px;">💡 Live Dashboard aktiv</div>
                    <div style="font-size: 0.9em;">Geben Sie Daten ein für personalisierte Insights</div>
                </div>
                <div class="widget-item">
                    <div style="font-weight: 600; color: #27ae60; margin-bottom: 5px;">🏆 BFH Update 2025</div>
                    <div style="font-size: 0.9em;">VV GmbH & Co. KG jetzt gewerbesteuerfrei</div>
                </div>
            `;
        }

        getErrorContent() {
            return `
                <div class="widget-item warning">
                    <div style="font-weight: 600; color: #e67e22; margin-bottom: 5px;">⚠️ Dashboard-Update</div>
                    <div style="font-size: 0.9em;">Insights werden neu geladen...</div>
                </div>
            `;
        }

        updateForSection(section) {
            setTimeout(() => {
                this.updateSidebarDashboard();
            }, 100);
        }

        updateWithResults(section, results) {
            // Update with calculation results
            setTimeout(() => {
                this.updateSidebarDashboard();
            }, 100);
        }

        destroy() {
            this.isActive = false;
            if (this.updateInterval) {
                clearInterval(this.updateInterval);
                this.updateInterval = null;
            }
        }
    }

    class ExportModule {
        generatePDFReport(data) {
            const reportHTML = this.createReportHTML(data);
            const blob = new Blob([reportHTML], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `Immobilien-Steuer-Bericht-${new Date().toISOString().slice(0, 10)}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            URL.revokeObjectURL(url);
        }

        createReportHTML(data) {
            return `<!DOCTYPE html>
            <html><head><title>Steuer-Bericht</title></head>
            <body><h1>Immobilien-Steuer-Analyse</h1>
            <p>Erstellt: ${new Date().toLocaleDateString('de-DE')}</p>
            <p>Version: ${data.version}</p></body></html>`;
        }
    }

    class AnalyticsModule {
        constructor(app) {
            this.app = app;
            this.events = [];
        }

        init() {
            // Initialize analytics
        }

        trackNavigation(section) {
            this.events.push({ type: 'navigation', section, timestamp: Date.now() });
        }

        trackCalculation(section, results) {
            this.events.push({ type: 'calculation', section, timestamp: Date.now() });
        }

        trackDashboardView() {
            this.events.push({ type: 'dashboard_view', timestamp: Date.now() });
        }

        trackToast(type, message) {
            this.events.push({ type: 'toast', category: type, timestamp: Date.now() });
        }
    }

    // Initialize the enhanced application
    const appInstance = new ImmobilienSuite();
    window.appInstance = appInstance;

    // Global error handler
    window.addEventListener('error', (event) => {
        console.error('Global error:', event.error);
        
        // Auto-hide progress overlay on any error
        if (window.appInstance && window.appInstance.hideCalculationProgress) {
            window.appInstance.hideCalculationProgress();
        }
        
        // Show user-friendly error message
        if (window.appInstance && window.appInstance.showToast) {
            window.appInstance.showToast('❌ Ein unerwarteter Fehler ist aufgetreten', 'error');
        }
    });

    // Also handle unhandled promise rejections
    window.addEventListener('unhandledrejection', (event) => {
        console.error('Unhandled promise rejection:', event.reason);
        
        // Auto-hide progress overlay
            if (window.appInstance && window.appInstance.hideCalculationProgress) {
                window.appInstance.hideCalculationProgress();
            }
            
            if (window.appInstance && window.appInstance.showToast) {
                window.appInstance.showToast('❌ Berechnung fehlgeschlagen', 'error');
            }
    });

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
        if (window.appInstance && window.appInstance.destroy) {
            window.appInstance.destroy();
        }
    });
    // Service Worker disabled in Claude environment
    // if ('serviceWorker' in navigator) {
    //     navigator.serviceWorker.register('/sw.js').catch(console.error);
    // }

    // Additional CSS animations
    const additionalStyles = `
        @keyframes slideOutToast {
            to { transform: translateX(450px); opacity: 0; }
        }
        
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fade-in {
            animation: fadeInUp 0.5s ease forwards;
        }
    `;
    
    const styleSheet = document.createElement('style');
    styleSheet.textContent = additionalStyles;
    document.head.appendChild(styleSheet);

    console.log('🏠 Immobilien-Steuer-Suite 2025 Premium Edition geladen');
</script>
```

</body>
</html>
