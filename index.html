<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Immobilien-Steuer-Suite 2025 - Premium Edition</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5rem;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group input.error {
            border-color: #e74c3c;
            background-color: #fdf2f2;
        }

        .error-message {
            color: #e74c3c;
            font-size: 14px;
            margin-top: 5px;
            display: none;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 20px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .results {
            grid-column: 1 / -1;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-top: 20px;
        }

        .results h2 {
            color: #667eea;
            margin-bottom: 25px;
            font-size: 1.8rem;
            text-align: center;
        }

        .result-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .result-item {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .result-item h3 {
            color: #555;
            margin-bottom: 10px;
            font-size: 1rem;
        }

        .result-item .value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #667eea;
        }

        .optimization-tips {
            background: #e8f5e8;
            border-left: 4px solid #27ae60;
            padding: 20px;
            margin-top: 20px;
            border-radius: 0 10px 10px 0;
        }

        .optimization-tips h3 {
            color: #27ae60;
            margin-bottom: 15px;
        }

        .optimization-tips ul {
            list-style-type: none;
            padding-left: 0;
        }

        .optimization-tips li {
            margin-bottom: 10px;
            padding-left: 20px;
            position: relative;
        }

        .optimization-tips li:before {
            content: "‚úì";
            position: absolute;
            left: 0;
            color: #27ae60;
            font-weight: bold;
        }

        .test-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-top: 30px;
        }

        .test-results {
            margin-top: 20px;
        }

        .test-item {
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            font-family: monospace;
        }

        .test-pass {
            background-color: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }

        .test-fail {
            background-color: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .card {
                padding: 20px;
            }
        }

        .hidden {
            display: none;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #667eea;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background-color: #e0e0e0;
            border-radius: 3px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
        }

        .advanced-options {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9ff;
            border-radius: 10px;
            border: 1px solid #e0e6ff;
        }

        .advanced-options h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-item input[type="checkbox"] {
            width: auto;
            margin: 0;
        }

        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
            color: #667eea;
            margin-left: 5px;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè† Immobilien-Steuer-Suite 2025</h1>
            <p>Premium Edition - Professionelle Steueroptimierung f√ºr Immobilieninvestoren</p>
        </div>

        <div class="main-content">
            <div class="card">
                <h2>üìä Immobilien-Daten</h2>
                <form id="taxForm">
                    <div class="form-group">
                        <label for="kaufpreis">Kaufpreis (‚Ç¨) <span class="tooltip">‚ÑπÔ∏è<span class="tooltiptext">Der urspr√ºngliche Kaufpreis der Immobilie</span></span></label>
                        <input type="number" id="kaufpreis" name="kaufpreis" min="0" step="1000" required>
                        <div class="error-message" id="kaufpreis-error">Bitte geben Sie einen g√ºltigen Kaufpreis ein</div>
                    </div>

                    <div class="form-group">
                        <label for="verkaufspreis">Verkaufspreis (‚Ç¨) <span class="tooltip">‚ÑπÔ∏è<span class="tooltiptext">Der geplante oder erzielte Verkaufspreis</span></span></label>
                        <input type="number" id="verkaufspreis" name="verkaufspreis" min="0" step="1000" required>
                        <div class="error-message" id="verkaufspreis-error">Bitte geben Sie einen g√ºltigen Verkaufspreis ein</div>
                    </div>

                    <div class="form-group">
                        <label for="haltedauer">Haltedauer (Jahre) <span class="tooltip">‚ÑπÔ∏è<span class="tooltiptext">Anzahl Jahre zwischen Kauf und Verkauf</span></span></label>
                        <input type="number" id="haltedauer" name="haltedauer" min="0" max="50" step="0.1" required>
                        <div class="error-message" id="haltedauer-error">Bitte geben Sie eine g√ºltige Haltedauer ein</div>
                    </div>

                    <div class="form-group">
                        <label for="nebenkosten">Nebenkosten (‚Ç¨) <span class="tooltip">‚ÑπÔ∏è<span class="tooltiptext">Makler, Notar, Grunderwerbsteuer etc.</span></span></label>
                        <input type="number" id="nebenkosten" name="nebenkosten" min="0" step="100" value="0">
                        <div class="error-message" id="nebenkosten-error">Nebenkosten d√ºrfen nicht negativ sein</div>
                    </div>

                    <div class="form-group">
                        <label for="renovierungskosten">Renovierungskosten (‚Ç¨) <span class="tooltip">‚ÑπÔ∏è<span class="tooltiptext">Investitionen in die Immobilie w√§hrend der Haltedauer</span></span></label>
                        <input type="number" id="renovierungskosten" name="renovierungskosten" min="0" step="100" value="0">
                        <div class="error-message" id="renovierungskosten-error">Renovierungskosten d√ºrfen nicht negativ sein</div>
                    </div>
                </form>
            </div>

            <div class="card">
                <h2>‚öôÔ∏è Steueroptimierung</h2>
                
                <div class="form-group">
                    <label for="steuersatz">Pers√∂nlicher Steuersatz (%)</label>
                    <select id="steuersatz" name="steuersatz">
                        <option value="14">14% (Eingangssteuersatz)</option>
                        <option value="25">25% (Mittlerer Satz)</option>
                        <option value="35">35% (H√∂herer Satz)</option>
                        <option value="42" selected>42% (Spitzensteuersatz)</option>
                        <option value="45">45% (Reichensteuer)</option>
                    </select>
                </div>

                <div class="advanced-options">
                    <h3>üéØ Erweiterte Optimierungsstrategien</h3>
                    
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="shareDeal" name="shareDeal">
                            <label for="shareDeal">Share Deal Struktur <span class="tooltip">‚ÑπÔ∏è<span class="tooltiptext">Verkauf von Gesellschaftsanteilen statt Immobilie</span></span></label>
                        </div>
                        
                        <div class="checkbox-item">
                            <input type="checkbox" id="crossBorder" name="crossBorder">
                            <label for="crossBorder">Cross-Border Struktur <span class="tooltip">‚ÑπÔ∏è<span class="tooltiptext">Internationale Steueroptimierung</span></span></label>
                        </div>
                        
                        <div class="checkbox-item">
                            <input type="checkbox" id="familyPool" name="familyPool">
                            <label for="familyPool">Familien-Pool <span class="tooltip">‚ÑπÔ∏è<span class="tooltiptext">Verteilung auf Familienmitglieder</span></span></label>
                        </div>

                        <div class="checkbox-item">
                            <input type="checkbox" id="foundation" name="foundation">
                            <label for="foundation">Stiftungsstruktur <span class="tooltip">‚ÑπÔ∏è<span class="tooltiptext">F√ºr sehr hohe Gewinne ab 1 Mio. ‚Ç¨</span></span></label>
                        </div>
                    </div>
                </div>

                <button type="button" class="btn" onclick="calculateTax()">
                    üßÆ Steuer berechnen
                </button>
            </div>
        </div>

        <div class="results hidden" id="results">
            <h2>üìà Berechnungsergebnisse</h2>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="result-grid" id="resultGrid">
                <!-- Results will be populated here -->
            </div>
            <div class="optimization-tips" id="optimizationTips">
                <!-- Optimization tips will be populated here -->
            </div>
        </div>

        <div class="test-section">
            <h2>üß™ Automatische Tests</h2>
            <button type="button" class="btn" onclick="runTests()">Tests ausf√ºhren</button>
            <div class="test-results" id="testResults"></div>
        </div>
    </div>

    <script>
        // Enhanced Tax Calculator with Advanced Features
        class ImmobilienSteuerSuite {
            constructor() {
                this.testResults = [];
                this.calculations = {};
            }

            validateInput(value, fieldName, min = 0, max = Infinity) {
                const numValue = parseFloat(value);
                
                if (isNaN(numValue)) {
                    throw new Error(`${fieldName} muss eine g√ºltige Zahl sein`);
                }
                
                if (numValue < min) {
                    throw new Error(`${fieldName} darf nicht kleiner als ${min} sein`);
                }
                
                if (numValue > max) {
                    throw new Error(`${fieldName} darf nicht gr√∂√üer als ${max} sein`);
                }
                
                return numValue;
            }

            calculateBasicTax(data) {
                const gewinn = data.verkaufspreis - data.kaufpreis - data.nebenkosten - data.renovierungskosten;
                
                if (data.haltedauer >= 10) {
                    return {
                        gewinn: gewinn,
                        steuer: 0,
                        steuerbefreit: true,
                        grund: "10-Jahres-Regel"
                    };
                }
                
                const steuer = gewinn * (data.steuersatz / 100);
                return {
                    gewinn: gewinn,
                    steuer: Math.max(0, steuer),
                    steuerbefreit: false,
                    grund: "Spekulationssteuer"
                };
            }

            calculateShareDeal(data) {
                if (!data.shareDeal) return null;
                
                const gewinn = data.verkaufspreis - data.kaufpreis - data.nebenkosten - data.renovierungskosten;
                const grunderwerbsteuerErsparnis = data.verkaufspreis * 0.035; // 3.5% durchschnittlich
                const steuerErsparnis = gewinn * 0.15; // 15% Ersparnis durch Share Deal
                
                return {
                    gewinn: gewinn,
                    steuer: Math.max(0, gewinn * (data.steuersatz / 100) - steuerErsparnis),
                    ersparnis: steuerErsparnis + grunderwerbsteuerErsparnis,
                    struktur: "Share Deal"
                };
            }

            calculateCrossBorder(data) {
                if (!data.crossBorder) return null;
                
                const gewinn = data.verkaufspreis - data.kaufpreis - data.nebenkosten - data.renovierungskosten;
                
                // Cross-Border nur bei hohen Transaktionen sinnvoll
                if (gewinn < 500000) {
                    return null;
                }
                
                const steuerErsparnis = gewinn * 0.25; // 25% Ersparnis durch internationale Struktur
                
                return {
                    gewinn: gewinn,
                    steuer: Math.max(0, gewinn * (data.steuersatz / 100) - steuerErsparnis),
                    ersparnis: steuerErsparnis,
                    struktur: "Cross-Border"
                };
            }

            calculateFamilyPool(data) {
                if (!data.familyPool) return null;
                
                const gewinn = data.verkaufspreis - data.kaufpreis - data.nebenkosten - data.renovierungskosten;
                const familienMitglieder = 4; // Annahme: 4 Familienmitglieder
                const gewinnProPerson = gewinn / familienMitglieder;
                const steuerProPerson = gewinnProPerson * (data.steuersatz / 100);
                const gesamtSteuer = steuerProPerson * familienMitglieder * 0.7; // 30% Ersparnis
                
                return {
                    gewinn: gewinn,
                    steuer: Math.max(0, gesamtSteuer),
                    ersparnis: (gewinn * (data.steuersatz / 100)) - gesamtSteuer,
                    struktur: "Familien-Pool"
                };
            }

            calculateFoundation(data) {
                if (!data.foundation) return null;
                
                const gewinn = data.verkaufspreis - data.kaufpreis - data.nebenkosten - data.renovierungskosten;
                
                // Stiftung nur bei sehr hohen Gewinnen sinnvoll
                if (gewinn < 1000000) {
                    return null;
                }
                
                const stiftungssteuer = gewinn * 0.17; // 17% Stiftungssteuer
                const normaleSteuer = gewinn * (data.steuersatz / 100);
                
                return {
                    gewinn: gewinn,
                    steuer: stiftungssteuer,
                    ersparnis: normaleSteuer - stiftungssteuer,
                    struktur: "Stiftung"
                };
            }

            calculate(formData) {
                try {
                    // Validate all inputs
                    const data = {
                        kaufpreis: this.validateInput(formData.kaufpreis, "Kaufpreis", 1000),
                        verkaufspreis: this.validateInput(formData.verkaufspreis, "Verkaufspreis", 1000),
                        haltedauer: this.validateInput(formData.haltedauer, "Haltedauer", 0, 50),
                        nebenkosten: this.validateInput(formData.nebenkosten, "Nebenkosten", 0),
                        renovierungskosten: this.validateInput(formData.renovierungskosten, "Renovierungskosten", 0),
                        steuersatz: this.validateInput(formData.steuersatz, "Steuersatz", 14, 45),
                        shareDeal: formData.shareDeal || false,
                        crossBorder: formData.crossBorder || false,
                        familyPool: formData.familyPool || false,
                        foundation: formData.foundation || false
                    };

                    const results = {
                        basic: this.calculateBasicTax(data),
                        shareDeal: this.calculateShareDeal(data),
                        crossBorder: this.calculateCrossBorder(data),
                        familyPool: this.calculateFamilyPool(data),
                        foundation: this.calculateFoundation(data)
                    };

                    // Store for testing
                    this.calculations = { data, results };
                    
                    return results;
                } catch (error) {
                    throw error;
                }
            }

            // Test Suite
            runTests() {
                this.testResults = [];
                
                // Test 1: Basic Tax Calculation
                this.test("Basic Tax Calculation", () => {
                    const result = this.calculate({
                        kaufpreis: 300000,
                        verkaufspreis: 400000,
                        haltedauer: 5,
                        nebenkosten: 20000,
                        renovierungskosten: 10000,
                        steuersatz: 42
                    });
                    
                    const expectedGewinn = 400000 - 300000 - 20000 - 10000; // 70000
                    const expectedSteuer = 70000 * 0.42; // 29400
                    
                    return result.basic.gewinn === expectedGewinn && 
                           Math.abs(result.basic.steuer - expectedSteuer) < 1;
                });

                // Test 2: 10-Year Rule
                this.test("10-Year Rule Test", () => {
                    const result = this.calculate({
                        kaufpreis: 300000,
                        verkaufspreis: 400000,
                        haltedauer: 10,
                        nebenkosten: 20000,
                        renovierungskosten: 10000,
                        steuersatz: 42
                    });
                    
                    return result.basic.steuer === 0 && result.basic.steuerbefreit === true;
                });

                // Test 3: Cross-Border Calculation
                this.test("Cross-Border Calculation", () => {
                    const result = this.calculate({
                        kaufpreis: 500000,
                        verkaufspreis: 1200000,
                        haltedauer: 5,
                        nebenkosten: 50000,
                        renovierungskosten: 50000,
                        steuersatz: 42,
                        crossBorder: true
                    });
                    
                    return result.crossBorder !== null && result.crossBorder.struktur === "Cross-Border";
                });

                // Test 4: Share Deal Benefits
                this.test("Share Deal Benefits", () => {
                    const result = this.calculate({
                        kaufpreis: 300000,
                        verkaufspreis: 500000,
                        haltedauer: 5,
                        nebenkosten: 20000,
                        renovierungskosten: 10000,
                        steuersatz: 42,
                        shareDeal: true
                    });
                    
                    return result.shareDeal !== null && result.shareDeal.struktur === "Share Deal";
                });

                // Test 5: Family Pool Benefits
                this.test("Family Pool Benefits", () => {
                    const result = this.calculate({
                        kaufpreis: 300000,
                        verkaufspreis: 500000,
                        haltedauer: 5,
                        nebenkosten: 20000,
                        renovierungskosten: 10000,
                        steuersatz: 42,
                        familyPool: true
                    });
                    
                    return result.familyPool !== null && result.familyPool.struktur === "Familien-Pool";
                });

                // Test 6: Input Validation
                this.test("Input Validation", () => {
                    try {
                        this.calculate({
                            kaufpreis: "invalid",
                            verkaufspreis: 400000,
                            haltedauer: 5,
                            nebenkosten: 20000,
                            renovierungskosten: 10000,
                            steuersatz: 42
                        });
                        return false;
                    } catch (error) {
                        return error.message.includes("g√ºltige Zahl");
                    }
                });

                // Test 7: Edge Cases
                this.test("Edge Cases", () => {
                    const result = this.calculate({
                        kaufpreis: 500000,
                        verkaufspreis: 2000000,
                        haltedauer: 5,
                        nebenkosten: 50000,
                        renovierungskosten: 50000,
                        steuersatz: 42,
                        foundation: true
                    });
                    
                    return result.foundation !== null && result.foundation.struktur === "Stiftung";
                });

                // Test 8: Negative Values
                this.test("Negative Values", () => {
                    try {
                        this.calculate({
                            kaufpreis: 400000,
                            verkaufspreis: 300000,
                            haltedauer: 5,
                            nebenkosten: -10000,
                            renovierungskosten: 10000,
                            steuersatz: 42
                        });
                        return false;
                    } catch (error) {
                        return error.message.includes("nicht kleiner als 0");
                    }
                });

                // Test 9: Performance Test
                this.test("Calculation Performance", () => {
                    const start = performance.now();
                    
                    for (let i = 0; i < 1000; i++) {
                        this.calculate({
                            kaufpreis: 300000 + i,
                            verkaufspreis: 400000 + i,
                            haltedauer: 5,
                            nebenkosten: 20000,
                            renovierungskosten: 10000,
                            steuersatz: 42
                        });
                    }
                    
                    const end = performance.now();
                    return (end - start) < 1000; // Should complete in less than 1 second
                });

                // Test 10: Large Dataset Handling
                this.test("Large Dataset Handling", () => {
                    try {
                        const result = this.calculate({
                            kaufpreis: 50000000,
                            verkaufspreis: 100000000,
                            haltedauer: 5,
                            nebenkosten: 2000000,
                            renovierungskosten: 1000000,
                            steuersatz: 42
                        });
                        
                        return result.basic.gewinn > 0 && result.basic.steuer > 0;
                    } catch (error) {
                        return false;
                    }
                });

                // Test 11: Memory Storage
                this.test("Memory Storage", () => {
                    const testData = {
                        kaufpreis: 300000,
                        verkaufspreis: 400000,
                        haltedauer: 5,
                        nebenkosten: 20000,
                        renovierungskosten: 10000,
                        steuersatz: 42
                    };
                    
                    this.calculate(testData);
                    
                    return this.calculations.data && 
                           this.calculations.data.kaufpreis === testData.kaufpreis;
                });

                // Test 12: Data Persistence
                this.test("Data Persistence", () => {
                    const testData = {
                        kaufpreis: 300000,
                        verkaufspreis: 400000,
                        haltedauer: 5,
                        nebenkosten: 20000,
                        renovierungskosten: 10000,
                        steuersatz: 42
                    };
                    
                    // Simulate saving to localStorage
                    localStorage.setItem('taxCalculation', JSON.stringify(testData));
                    const saved = JSON.parse(localStorage.getItem('taxCalculation'));
                    
                    return saved && saved.kaufpreis === testData.kaufpreis;
                });

                // Test 13: Form Validation UI
                this.test("Form Validation UI", () => {
                    // Test negative value detection
                    const nebenkostenInput = document.getElementById('nebenkosten');
                    nebenkostenInput.value = '-1000';
                    
                    const isValid = this.validateFormInput(nebenkostenInput);
                    return !isValid; // Should return false for negative values
                });

                // Test 14: Navigation Functionality
                this.test("Navigation Functionality", () => {
                    const resultsSection = document.getElementById('results');
                    const testSection = document.querySelector('.test-section');
                    
                    return resultsSection && testSection && 
                           resultsSection.classList.contains('hidden');
                });

                return this.testResults;
            }

            test(name, testFunction) {
                try {
                    const result = testFunction();
                    this.testResults.push({
                        name: name,
                        passed: result,
                        error: null
                    });
                } catch (error) {
                    this.testResults.push({
                        name: name,
                        passed: false,
                        error: error.message
                    });
                }
            }

            validateFormInput(input) {
                const value = parseFloat(input.value);
                const min = parseFloat(input.getAttribute('min')) || 0;
                
                if (isNaN(value) || value < min) {
                    input.classList.add('error');
                    const errorElement = document.getElementById(input.id + '-error');
                    if (errorElement) {
                        errorElement.style.display = 'block';
                    }
                    return false;
                }
                
                input.classList.remove('error');
                const errorElement = document.getElementById(input.id + '-error');
                if (errorElement) {
                    errorElement.style.display = 'none';
                }
                return true;
            }

            formatCurrency(amount) {
                return new Intl.NumberFormat('de-DE', {
                    style: 'currency',
                    currency: 'EUR'
                }).format(amount);
            }

            formatPercentage(value) {
                return new Intl.NumberFormat('de-DE', {
                    style: 'percent',
                    minimumFractionDigits: 1,
                    maximumFractionDigits: 1
                }).format(value / 100);
            }
        }

        // Global instance
        const steuerSuite = new ImmobilienSteuerSuite();

        // Form validation
        function validateForm() {
            const inputs = document.querySelectorAll('#taxForm input[required]');
            let isValid = true;
            
            inputs.forEach(input => {
                if (!steuerSuite.validateFormInput(input)) {
                    isValid = false;
                }
            });
            
            return isValid;
        }

        // Calculate tax function
        function calculateTax() {
            if (!validateForm()) {
                alert('Bitte korrigieren Sie die Eingabefehler.');
                return;
            }

            const formData = {
                kaufpreis: document.getElementById('kaufpreis').value,
                verkaufspreis: document.getElementById('verkaufspreis').value,
                haltedauer: document.getElementById('haltedauer').value,
                nebenkosten: document.getElementById('nebenkosten').value,
                renovierungskosten: document.getElementById('renovierungskosten').value,
                steuersatz: document.getElementById('steuersatz').value,
                shareDeal: document.getElementById('shareDeal').checked,
                crossBorder: document.getElementById('crossBorder').checked,
                familyPool: document.getElementById('familyPool').checked,
                foundation: document.getElementById('foundation').checked
            };

            try {
                const results = steuerSuite.calculate(formData);
                displayResults(results);
            } catch (error) {
                alert('Fehler bei der Berechnung: ' + error.message);
            }
        }

        // Display results function
        function displayResults(results) {
            const resultsDiv = document.getElementById('results');
            const resultGrid = document.getElementById('resultGrid');
            const optimizationTips = document.getElementById('optimizationTips');
            const progressFill = document.getElementById('progressFill');

            // Show results section
            resultsDiv.classList.remove('hidden');

            // Animate progress bar
            setTimeout(() => {
                progressFill.style.width = '100%';
            }, 100);

            // Clear previous results
            resultGrid.innerHTML = '';

            // Display basic calculation
            const basicResult = document.createElement('div');
            basicResult.className = 'result-item';
            basicResult.innerHTML = `
                <h3>Grundberechnung</h3>
                <div class="value">${steuerSuite.formatCurrency(results.basic.gewinn)}</div>
                <p>Gewinn</p>
                <div class="value">${steuerSuite.formatCurrency(results.basic.steuer)}</div>
                <p>Steuer ${results.basic.steuerbefreit ? '(befreit)' : ''}</p>
            `;
            resultGrid.appendChild(basicResult);

            // Display optimization results
            const optimizations = ['shareDeal', 'crossBorder', 'familyPool', 'foundation'];
            optimizations.forEach(opt => {
                if (results[opt]) {
                    const optResult = document.createElement('div');
                    optResult.className = 'result-item';
                    optResult.innerHTML = `
                        <h3>${results[opt].struktur}</h3>
                        <div class="value">${steuerSuite.formatCurrency(results[opt].steuer)}</div>
                        <p>Steuer</p>
                        <div class="value">${steuerSuite.formatCurrency(results[opt].ersparnis || 0)}</div>
                        <p>Ersparnis</p>
                    `;
                    resultGrid.appendChild(optResult);
                }
            });

            // Generate optimization tips
            const tips = [];
            if (results.basic.haltedauer < 10) {
                tips.push('Erw√§gen Sie eine l√§ngere Haltedauer von mindestens 10 Jahren f√ºr Steuerbefreiung');
            }
            if (results.shareDeal) {
                tips.push('Share Deal Struktur kann erhebliche Steuervorteile bieten');
            }
            if (results.crossBorder) {
                tips.push('Internationale Strukturen sind bei hohen Gewinnen besonders effektiv');
            }
            if (results.familyPool) {
                tips.push('Familien-Pool erm√∂glicht Verteilung der Steuerlast');
            }
            if (results.foundation) {
                tips.push('Stiftungsstrukturen sind bei sehr hohen Gewinnen optimal');
            }

            optimizationTips.innerHTML = `
                <h3>üí° Optimierungsempfehlungen</h3>
                <ul>
                    ${tips.map(tip => `<li>${tip}</li>`).join('')}
                </ul>
            `;
        }

        // Run tests function
        function runTests() {
            const testResults = steuerSuite.runTests();
            const testResultsDiv = document.getElementById('testResults');
            
            testResultsDiv.innerHTML = '';
            
            const summary = document.createElement('div');
            const passed = testResults.filter(t => t.passed).length;
            const total = testResults.length;
            
            summary.innerHTML = `
                <h3>Test Ergebnisse: ${passed}/${total} bestanden</h3>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${(passed/total)*100}%"></div>
                </div>
            `;
            testResultsDiv.appendChild(summary);
            
            testResults.forEach(test => {
                const testDiv = document.createElement('div');
                testDiv.className = `test-item ${test.passed ? 'test-pass' : 'test-fail'}`;
                testDiv.innerHTML = `
                    <strong>${test.passed ? '‚úì' : '‚úó'} ${test.name}</strong>
                    ${test.error ? `<br><small>Fehler: ${test.error}</small>` : ''}
                `;
                testResultsDiv.appendChild(testDiv);
            });
        }

        // Add event listeners for real-time validation
        document.addEventListener('DOMContentLoaded', function() {
            const inputs = document.querySelectorAll('#taxForm input');
            inputs.forEach(input => {
                input.addEventListener('blur', function() {
                    steuerSuite.validateFormInput(this);
                });
                
                input.addEventListener('input', function() {
                    if (this.classList.contains('error')) {
                        steuerSuite.validateFormInput(this);
                    }
                });
            });
        });
    </script>
</body>
</html>