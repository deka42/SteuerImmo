<!DOCTYPE html>

<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Immobilien-Steuer-Suite 2025 - Ultimate Enterprise Edition</title>

<!-- PWA Meta Tags -->
<meta name="theme-color" content="#3498db">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Steuer-Suite Ultimate">
<meta name="description" content="Ultimate Enterprise Immobiliensteuer-Optimierung 2025 mit KI, Real-time Analytics und PDF-Reports">

<!-- SEO Meta Tags -->
<meta name="keywords" content="Immobilien, Steuer, KI, Real-time, PDF, Enterprise, Analytics, TypeScript">
<meta name="author" content="Immobilien-Steuer-Suite Ultimate">
<meta name="robots" content="index, follow">

<!-- Favicon -->
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üè†</text></svg>">

<!-- External Libraries -->
<script src="https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

<style>
    :root {
        --primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --primary-solid: #667eea;
        --success: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        --success-solid: #11998e;
        --warning: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        --warning-solid: #f093fb;
        --danger: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
        --danger-solid: #ff9a9e;
        --dark: #2c3e50;
        --light: #f8f9fa;
        --border-radius: 16px;
        --border-radius-sm: 8px;
        --shadow: 0 10px 30px rgba(0,0,0,0.1);
        --shadow-lg: 0 20px 40px rgba(0,0,0,0.15);
        --shadow-xl: 0 30px 60px rgba(0,0,0,0.2);
        --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        --transition-fast: all 0.15s ease;
        --z-index-dropdown: 1000;
        --z-index-modal: 1050;
        --z-index-tooltip: 1070;
        --z-index-overlay: 1080;
    }

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    *:focus {
        outline: 2px solid var(--primary-solid);
        outline-offset: 2px;
    }

    body {
        font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        background: var(--primary);
        min-height: 100vh;
        line-height: 1.6;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }

    .app-container {
        max-width: 1600px;
        margin: 0 auto;
        background: white;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-xl);
        overflow: hidden;
        min-height: 100vh;
        position: relative;
    }

    /* Enhanced Header with Analytics */
    .app-header {
        background: rgba(255,255,255,0.95);
        backdrop-filter: blur(20px);
        padding: 1.5rem 2rem;
        border-bottom: 1px solid #e9ecef;
        position: sticky;
        top: 0;
        z-index: var(--z-index-dropdown);
        transition: var(--transition);
    }

    .app-header.scrolled {
        background: rgba(255,255,255,0.98);
        box-shadow: var(--shadow);
    }

    .header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .app-title {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .app-title h1 {
        font-size: 1.75rem;
        font-weight: 700;
        background: var(--primary);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .subtitle {
        font-size: 0.85rem;
        color: #6c757d;
        margin-top: 0.25rem;
    }

    .header-actions {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
        align-items: center;
    }

    .performance-indicator {
        background: rgba(17, 153, 142, 0.1);
        color: var(--success-solid);
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .performance-dot {
        width: 8px;
        height: 8px;
        background: var(--success-solid);
        border-radius: 50%;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    /* Enhanced Main Layout */
    .main-content {
        display: grid;
        grid-template-columns: 320px 1fr 280px;
        min-height: calc(100vh - 120px);
    }

    .sidebar {
        background: var(--light);
        padding: 2rem;
        border-right: 1px solid #e9ecef;
        overflow-y: auto;
    }

    .content-area {
        padding: 2rem;
        overflow-y: auto;
        position: relative;
    }

    .analytics-panel {
        background: var(--light);
        padding: 2rem;
        border-left: 1px solid #e9ecef;
        overflow-y: auto;
    }

    /* Enhanced Navigation */
    .nav-menu {
        list-style: none;
        margin-bottom: 2rem;
    }

    .nav-item {
        margin-bottom: 0.5rem;
    }

    .nav-link {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 1rem 1.25rem;
        color: var(--dark);
        text-decoration: none;
        border-radius: 12px;
        transition: var(--transition);
        font-weight: 500;
        cursor: pointer;
        position: relative;
        overflow: hidden;
    }

    .nav-link::before {
        content: '';
        position: absolute;
        left: -100%;
        top: 0;
        width: 100%;
        height: 100%;
        background: var(--primary);
        transition: left 0.3s ease;
        z-index: -1;
    }

    .nav-link:hover::before,
    .nav-link.active::before {
        left: 0;
    }

    .nav-link:hover,
    .nav-link.active {
        color: white;
        transform: translateX(4px);
        box-shadow: var(--shadow);
    }

    .nav-icon {
        font-size: 1.25rem;
        min-width: 1.5rem;
    }

    .nav-badge {
        background: var(--danger-solid);
        color: white;
        font-size: 0.7rem;
        padding: 0.2rem 0.5rem;
        border-radius: 10px;
        margin-left: auto;
    }

    /* Enhanced Cards */
    .card {
        background: white;
        border-radius: var(--border-radius);
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: var(--shadow);
        transition: var(--transition);
        position: relative;
        overflow: hidden;
        border: 1px solid rgba(102, 126, 234, 0.1);
    }

    .card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: var(--primary);
    }

    .card:hover {
        box-shadow: var(--shadow-lg);
        transform: translateY(-2px);
    }

    .card-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid var(--primary-solid);
    }

    .card-title {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        color: var(--dark);
        font-size: 1.5rem;
        font-weight: 600;
    }

    /* Advanced Form Components */
    .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 2rem;
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        position: relative;
    }

    .form-label {
        font-weight: 600;
        color: var(--dark);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .required {
        color: var(--danger-solid);
    }

    .form-input,
    .form-select {
        padding: 1rem 1.25rem;
        border: 2px solid #e9ecef;
        border-radius: 12px;
        font-size: 1rem;
        transition: var(--transition);
        background: white;
        font-family: inherit;
        position: relative;
    }

    .form-input:focus,
    .form-select:focus {
        border-color: var(--primary-solid);
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        background: #fafbfc;
    }

    .form-input.valid {
        border-color: var(--success-solid);
        background: rgba(17, 153, 142, 0.05);
    }

    .form-input.invalid {
        border-color: var(--danger-solid);
        background: rgba(255, 154, 158, 0.05);
    }

    .form-help {
        font-size: 0.85rem;
        color: #6c757d;
        font-style: italic;
    }

    .form-error {
        font-size: 0.8rem;
        color: var(--danger-solid);
        margin-top: 0.25rem;
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    .input-group {
        position: relative;
    }

    .input-icon {
        position: absolute;
        right: 1rem;
        top: 50%;
        transform: translateY(-50%);
        color: #6c757d;
        pointer-events: none;
    }

    .input-group .form-input {
        padding-right: 3rem;
    }

    /* Real-time Validation Indicators */
    .validation-indicator {
        position: absolute;
        right: 1rem;
        top: 50%;
        transform: translateY(-50%);
        font-size: 1.2rem;
        opacity: 0;
        transition: var(--transition);
    }

    .validation-indicator.show {
        opacity: 1;
    }

    .validation-indicator.valid {
        color: var(--success-solid);
    }

    .validation-indicator.invalid {
        color: var(--danger-solid);
    }

    /* Enhanced Buttons */
    .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        padding: 1rem 2rem;
        border: none;
        border-radius: 12px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
        text-decoration: none;
        position: relative;
        overflow: hidden;
        min-height: 48px;
        font-family: inherit;
    }

    .btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        transition: left 0.5s;
    }

    .btn:hover::before {
        left: 100%;
    }

    .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none !important;
    }

    .btn-primary {
        background: var(--primary);
        color: white;
        box-shadow: var(--shadow);
    }

    .btn-primary:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
    }

    .btn-success {
        background: var(--success);
        color: white;
        box-shadow: var(--shadow);
    }

    .btn-warning {
        background: var(--warning);
        color: white;
        box-shadow: var(--shadow);
    }

    .btn-secondary {
        background: linear-gradient(135deg, #95a5a6, #7f8c8d);
        color: white;
        box-shadow: var(--shadow);
    }

    .btn-outline {
        background: transparent;
        border: 2px solid var(--primary-solid);
        color: var(--primary-solid);
    }

    .btn-outline:hover:not(:disabled) {
        background: var(--primary-solid);
        color: white;
    }

    .btn-group {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        margin-top: 2rem;
    }

    /* Progressive Disclosure */
    .advanced-options {
        margin-top: 2rem;
        border-top: 1px solid #e9ecef;
        padding-top: 2rem;
    }

    .disclosure-toggle {
        background: none;
        border: none;
        color: var(--primary-solid);
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 1rem;
        transition: var(--transition);
    }

    .disclosure-toggle:hover {
        color: var(--dark);
    }

    .disclosure-arrow {
        transition: transform 0.3s ease;
    }

    .disclosure-toggle.open .disclosure-arrow {
        transform: rotate(90deg);
    }

    .disclosure-content {
        display: none;
        animation: slideDown 0.3s ease;
    }

    .disclosure-content.open {
        display: block;
    }

    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Multi-Scenario Comparison */
    .scenario-tabs {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 2rem;
        border-bottom: 2px solid #e9ecef;
    }

    .scenario-tab {
        padding: 1rem 1.5rem;
        background: none;
        border: none;
        border-bottom: 3px solid transparent;
        cursor: pointer;
        font-weight: 600;
        color: #6c757d;
        transition: var(--transition);
    }

    .scenario-tab.active {
        color: var(--primary-solid);
        border-bottom-color: var(--primary-solid);
    }

    .scenario-tab:hover {
        color: var(--dark);
    }

    .scenario-content {
        display: none;
    }

    .scenario-content.active {
        display: block;
        animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    /* Enhanced Results */
    .results-container {
        margin-top: 3rem;
    }

    .results-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 2rem;
        margin-top: 2rem;
    }

    .result-card {
        background: white;
        border-radius: var(--border-radius);
        padding: 2rem;
        border: 2px solid #e9ecef;
        transition: var(--transition);
        position: relative;
        overflow: hidden;
    }

    .result-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 4px;
        background: var(--primary);
    }

    .result-card.best {
        border-color: var(--success-solid);
        background: linear-gradient(135deg, rgba(17, 153, 142, 0.05), rgba(56, 239, 125, 0.05));
        animation: highlightPulse 2s infinite;
    }

    .result-card.best::before {
        background: var(--success);
        height: 6px;
    }

    @keyframes highlightPulse {
        0% { box-shadow: var(--shadow); }
        50% { box-shadow: 0 0 0 10px rgba(17, 153, 142, 0.1); }
        100% { box-shadow: var(--shadow); }
    }

    .result-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid #e9ecef;
    }

    .result-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--dark);
    }

    .result-badge {
        background: var(--success);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    .result-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 0;
        border-bottom: 1px solid #f1f3f4;
    }

    .result-item:last-child {
        border-bottom: none;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 2px solid var(--success-solid);
        font-weight: 600;
        background: rgba(17, 153, 142, 0.05);
        margin-left: -1rem;
        margin-right: -1rem;
        padding-left: 1rem;
        padding-right: 1rem;
        border-radius: var(--border-radius-sm);
    }

    .result-label {
        color: var(--dark);
        font-weight: 500;
    }

    .result-value {
        font-weight: 600;
        color: var(--success-solid);
        font-size: 1.1rem;
    }

    .result-value.negative {
        color: var(--danger-solid);
    }

    /* Enhanced Analytics Panel */
    .analytics-header {
        background: var(--primary);
        margin: -2rem -2rem 2rem -2rem;
        padding: 1.5rem 2rem;
        border-radius: var(--border-radius) var(--border-radius) 0 0;
        color: white;
    }

    .analytics-widget {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: var(--shadow);
        border: 1px solid #e9ecef;
    }

    .widget-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .widget-title {
        font-size: 1rem;
        font-weight: 600;
        color: var(--dark);
    }

    .widget-icon {
        font-size: 1.5rem;
        color: var(--primary-solid);
    }

    .metric-value {
        font-size: 2rem;
        font-weight: 700;
        color: var(--success-solid);
        margin-bottom: 0.5rem;
    }

    .metric-label {
        font-size: 0.9rem;
        color: #6c757d;
    }

    .chart-container {
        height: 200px;
        margin-top: 1rem;
    }

    /* Alerts and Notifications */
    .alert {
        padding: 1.5rem;
        border-radius: var(--border-radius);
        margin: 1.5rem 0;
        position: relative;
        box-shadow: var(--shadow);
        border-left: 4px solid;
    }

    .alert-success {
        background: linear-gradient(135deg, rgba(17, 153, 142, 0.1), rgba(56, 239, 125, 0.1));
        border-left-color: var(--success-solid);
        color: #0d5f56;
    }

    .alert-info {
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
        border-left-color: var(--primary-solid);
        color: #4c63d2;
    }

    .alert-warning {
        background: linear-gradient(135deg, rgba(240, 147, 251, 0.1), rgba(245, 87, 108, 0.1));
        border-left-color: var(--warning-solid);
        color: #8b2635;
    }

    .alert-danger {
        background: linear-gradient(135deg, rgba(255, 154, 158, 0.1), rgba(254, 207, 239, 0.1));
        border-left-color: var(--danger-solid);
        color: #721c24;
    }

    /* Toast Notifications */
    .toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: var(--z-index-tooltip);
        display: flex;
        flex-direction: column;
        gap: 1rem;
        max-width: 400px;
    }

    .toast {
        background: white;
        border-radius: 12px;
        padding: 1.25rem 1.5rem;
        box-shadow: var(--shadow-xl);
        border-left: 4px solid var(--primary-solid);
        min-width: 320px;
        transform: translateX(450px);
        animation: slideInToast 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        position: relative;
        overflow: hidden;
    }

    .toast::before {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        height: 2px;
        background: var(--primary-solid);
        animation: toastProgress 5s linear forwards;
    }

    .toast.success {
        border-left-color: var(--success-solid);
    }

    .toast.success::before {
        background: var(--success-solid);
    }

    .toast.warning {
        border-left-color: var(--warning-solid);
    }

    .toast.warning::before {
        background: var(--warning-solid);
    }

    .toast.danger {
        border-left-color: var(--danger-solid);
    }

    .toast.danger::before {
        background: var(--danger-solid);
    }

    @keyframes slideInToast {
        to { transform: translateX(0); }
    }

    @keyframes toastProgress {
        to { width: 100%; }
    }

    /* Modal Overlays */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.8);
        z-index: var(--z-index-overlay);
        display: none;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(5px);
    }

    .modal {
        background: white;
        border-radius: var(--border-radius);
        padding: 2rem;
        max-width: 90vw;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: var(--shadow-xl);
        animation: modalSlideIn 0.3s ease;
    }

    @keyframes modalSlideIn {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Progress Indicators */
    .progress-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        z-index: var(--z-index-overlay);
        display: none;
        align-items: center;
        justify-content: center;
    }

    .progress-modal {
        background: white;
        padding: 2rem;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-xl);
        text-align: center;
        min-width: 300px;
    }

    .spinner {
        width: 40px;
        height: 40px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid var(--primary-solid);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .progress-bar {
        width: 100%;
        height: 8px;
        background: #e9ecef;
        border-radius: 4px;
        overflow: hidden;
        margin: 1rem 0;
    }

    .progress-fill {
        height: 100%;
        background: var(--primary);
        width: 0%;
        transition: width 0.3s ease;
    }

    /* Keyboard Shortcuts Indicator */
    .shortcut-indicator {
        position: fixed;
        bottom: 20px;
        left: 20px;
        background: rgba(0,0,0,0.8);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-size: 0.8rem;
        opacity: 0;
        transition: var(--transition);
        z-index: var(--z-index-tooltip);
    }

    .shortcut-indicator.show {
        opacity: 1;
    }

    /* Undo/Redo Controls */
    .history-controls {
        position: fixed;
        bottom: 20px;
        right: 20px;
        display: flex;
        gap: 0.5rem;
        z-index: var(--z-index-dropdown);
    }

    .history-btn {
        background: rgba(102, 126, 234, 0.9);
        color: white;
        border: none;
        border-radius: 50%;
        width: 48px;
        height: 48px;
        cursor: pointer;
        font-size: 1.2rem;
        transition: var(--transition);
        box-shadow: var(--shadow);
    }

    .history-btn:hover:not(:disabled) {
        background: var(--primary-solid);
        transform: scale(1.1);
    }

    .history-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    /* Responsive Design */
    @media (max-width: 1200px) {
        .main-content {
            grid-template-columns: 280px 1fr 250px;
        }
    }

    @media (max-width: 1024px) {
        .main-content {
            grid-template-columns: 260px 1fr;
        }
        
        .analytics-panel {
            display: none;
        }
    }

    @media (max-width: 768px) {
        .main-content {
            grid-template-columns: 1fr;
        }
        
        .sidebar {
            display: none;
        }
        
        .form-grid {
            grid-template-columns: 1fr;
        }
        
        .results-grid {
            grid-template-columns: 1fr;
        }
        
        .history-controls {
            bottom: 80px;
            right: 10px;
        }
    }

    /* Accessibility Enhancements */
    @media (prefers-reduced-motion: reduce) {
        *,
        *::before,
        *::after {
            animation-duration: 0.01ms !important;
            animation-iteration-count: 1 !important;
            transition-duration: 0.01ms !important;
        }
    }

    @media (prefers-color-scheme: dark) {
        :root {
            --dark: #ffffff;
            --light: #2c3e50;
        }
        
        body {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
        }
        
        .app-container {
            background: #2c3e50;
            color: white;
        }
        
        .card,
        .result-card,
        .analytics-widget {
            background: #34495e;
            border-color: #495057;
            color: white;
        }
    }

    /* High Contrast Mode */
    @media (prefers-contrast: high) {
        :root {
            --shadow: 0 0 0 2px #000000;
            --shadow-lg: 0 0 0 3px #000000;
        }
        
        .card,
        .result-card {
            border: 2px solid #000000;
        }
    }

    /* Print Styles */
    @media print {
        .sidebar,
        .analytics-panel,
        .btn-group,
        .history-controls,
        .toast-container {
            display: none !important;
        }
        
        .main-content {
            grid-template-columns: 1fr;
        }
        
        .card {
            break-inside: avoid;
            box-shadow: none;
            border: 1px solid #000;
        }
    }

    /* Custom Scrollbars */
    ::-webkit-scrollbar {
        width: 8px;
    }

    ::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
        background: var(--primary-solid);
        border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
        background: #5a6fd8;
    }

    /* Utility Classes */
    .text-center { text-align: center; }
    .text-left { text-align: left; }
    .text-right { text-align: right; }
    .font-weight-bold { font-weight: 600; }
    .font-weight-normal { font-weight: 400; }
    .text-muted { color: #6c757d; }
    .text-primary { color: var(--primary-solid); }
    .text-success { color: var(--success-solid); }
    .text-warning { color: var(--warning-solid); }
    .text-danger { color: var(--danger-solid); }
    .d-flex { display: flex; }
    .d-none { display: none; }
    .justify-content-center { justify-content: center; }
    .align-items-center { align-items: center; }
    .gap-1 { gap: 0.5rem; }
    .gap-2 { gap: 1rem; }
    .gap-3 { gap: 1.5rem; }
    .w-100 { width: 100%; }
    .h-100 { height: 100%; }
    .mt-1 { margin-top: 0.5rem; }
    .mt-2 { margin-top: 1rem; }
    .mt-3 { margin-top: 1.5rem; }
    .mt-4 { margin-top: 2rem; }
    .mb-1 { margin-bottom: 0.5rem; }
    .mb-2 { margin-bottom: 1rem; }
    .mb-3 { margin-bottom: 1.5rem; }
    .mb-4 { margin-bottom: 2rem; }
    .p-1 { padding: 0.5rem; }
    .p-2 { padding: 1rem; }
    .p-3 { padding: 1.5rem; }
    .p-4 { padding: 2rem; }
</style>

</head>
<body>
    <div class="app-container">
        <!-- Enhanced Header with Performance Indicator -->
        <header class="app-header" id="app-header">
            <div class="header-content">
                <div class="app-title">
                    <span style="font-size: 2.5rem;">üè†</span>
                    <div>
                        <h1>Immobilien-Steuer-Suite 2025</h1>
                        <div class="subtitle">Ultimate Enterprise ‚Ä¢ KI ‚Ä¢ Real-time ‚Ä¢ PDF Reports ‚Ä¢ Multi-Scenario</div>
                    </div>
                </div>
                <div class="header-actions">
                    <div class="performance-indicator">
                        <div class="performance-dot"></div>
                        <span id="performance-text">System Ready</span>
                    </div>
                    <button class="btn btn-primary" onclick="app.exportPDFReport()" title="PDF-Bericht exportieren (Ctrl+P)">
                        üìä PDF Report
                    </button>
                    <button class="btn btn-success" onclick="app.loadExample()" title="Beispieldaten laden (Ctrl+E)">
                        üí° Beispiel
                    </button>
                    <button class="btn btn-warning" onclick="app.showComparison()" title="Multi-Szenario Vergleich (Ctrl+M)">
                        üìà Vergleich
                    </button>
                    <button class="btn btn-secondary" onclick="app.resetAll()" title="Alles zur√ºcksetzen (Ctrl+R)">
                        üîÑ Reset
                    </button>
                </div>
            </div>
        </header>

    <div class="main-content">
        <!-- Enhanced Sidebar with Navigation -->
        <aside class="sidebar">
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="#verkauf" class="nav-link active" data-section="verkauf">
                        <span class="nav-icon">üí∞</span>
                        Verkaufssteuer
                        <span class="nav-badge">AI</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#grundsteuer" class="nav-link" data-section="grundsteuer">
                        <span class="nav-icon">üèõÔ∏è</span>
                        Grundsteuer 2025
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#erbschaft" class="nav-link" data-section="erbschaft">
                        <span class="nav-icon">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</span>
                        Erbschaftsteuer
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#schenkung" class="nav-link" data-section="schenkung">
                        <span class="nav-icon">üéÅ</span>
                        Schenkungssteuer
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#cashflow" class="nav-link" data-section="cashflow">
                        <span class="nav-icon">üìä</span>
                        Cash-Flow Analyse
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#strategie" class="nav-link" data-section="strategie">
                        <span class="nav-icon">üéØ</span>
                        Gesamtstrategie
                    </a>
                </li>
            </ul>

            <!-- Plugin Architecture Demo -->
            <div class="card" style="margin-top: 2rem;">
                <div class="card-header">
                    <h3 style="font-size: 1rem;">üîå Plugins</h3>
                </div>
                <div class="plugin-list">
                    <div class="plugin-item" style="padding: 0.5rem; margin: 0.5rem 0; border: 1px solid #e9ecef; border-radius: 8px; cursor: pointer;" onclick="app.loadPlugin('bundesland-analyzer')">
                        <strong>üó∫Ô∏è Bundesland-Analyzer</strong>
                        <small style="display: block; color: #6c757d;">Steuervergleich nach Bundesl√§ndern</small>
                    </div>
                    <div class="plugin-item" style="padding: 0.5rem; margin: 0.5rem 0; border: 1px solid #e9ecef; border-radius: 8px; cursor: pointer;" onclick="app.loadPlugin('inflation-calculator')">
                        <strong>üìä Inflations-Rechner</strong>
                        <small style="display: block; color: #6c757d;">Ber√ºcksichtigung der Inflation</small>
                    </div>
                    <div class="plugin-item" style="padding: 0.5rem; margin: 0.5rem 0; border: 1px solid #e9ecef; border-radius: 8px; cursor: pointer;" onclick="app.loadPlugin('ai-optimizer')">
                        <strong>ü§ñ KI-Optimierer</strong>
                        <small style="display: block; color: #6c757d;">Machine Learning Vorhersagen</small>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="content-area">
            <!-- Multi-Scenario Tabs -->
            <div class="scenario-tabs">
                <button class="scenario-tab active" data-scenario="scenario1" onclick="app.switchScenario('scenario1')">
                    Szenario 1
                </button>
                <button class="scenario-tab" data-scenario="scenario2" onclick="app.switchScenario('scenario2')">
                    Szenario 2
                </button>
                <button class="scenario-tab" data-scenario="scenario3" onclick="app.switchScenario('scenario3')">
                    Szenario 3
                </button>
                <button class="btn btn-outline" onclick="app.addScenario()" style="margin-left: auto; padding: 0.5rem 1rem; font-size: 0.9rem;">
                    ‚ûï Szenario hinzuf√ºgen
                </button>
            </div>

            <!-- Main Form Card -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <span>üí∞</span>
                        <span>KI-Optimierte Verkaufssteuer-Berechnung 2025</span>
                    </div>
                </div>

                <!-- Real-time Calculation Toggle -->
                <div class="alert alert-info">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span>ü§ñ Real-time KI-Berechnung aktiviert - Optimale Strukturen werden automatisch berechnet</span>
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="realtime-calc" checked onchange="app.toggleRealtime()">
                            <span>Real-time</span>
                        </label>
                    </div>
                </div>

                <div class="scenario-content active" id="scenario1-content">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">
                                üè† Kaufpreis <span class="required">*</span>
                            </label>
                            <div class="input-group">
                                <input type="number" id="kaufpreis" class="form-input" placeholder="z.B. 400.000" min="0" step="1000" data-shortcut="k">
                                <div class="validation-indicator" id="kaufpreis-indicator"></div>
                            </div>
                            <div class="form-help">Urspr√ºnglicher Kaufpreis der Immobilie</div>
                            <div class="form-error" id="kaufpreis-error"></div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                üíµ Verkaufspreis <span class="required">*</span>
                            </label>
                            <div class="input-group">
                                <input type="number" id="verkaufspreis" class="form-input" placeholder="z.B. 600.000" min="0" step="1000" data-shortcut="v">
                                <div class="validation-indicator" id="verkaufspreis-indicator"></div>
                            </div>
                            <div class="form-help">Aktueller Verkaufspreis</div>
                            <div class="form-error" id="verkaufspreis-error"></div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                üìã Nebenkosten Kauf
                            </label>
                            <div class="input-group">
                                <input type="number" id="nebenkosten_kauf" class="form-input" placeholder="z.B. 40.000" min="0" step="1000">
                                <div class="validation-indicator" id="nebenkosten_kauf-indicator"></div>
                            </div>
                            <div class="form-help">Notar, Grunderwerbsteuer, Makler beim Kauf</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                ü§ù Nebenkosten Verkauf
                            </label>
                            <div class="input-group">
                                <input type="number" id="nebenkosten_verkauf" class="form-input" placeholder="z.B. 30.000" min="0" step="1000">
                                <div class="validation-indicator" id="nebenkosten_verkauf-indicator"></div>
                            </div>
                            <div class="form-help">Makler, Notar, Inserate beim Verkauf</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                üî® Modernisierung/Renovierung
                            </label>
                            <div class="input-group">
                                <input type="number" id="modernisierung" class="form-input" placeholder="z.B. 35.000" min="0" step="1000">
                                <div class="validation-indicator" id="modernisierung-indicator"></div>
                            </div>
                            <div class="form-help">Steuerlich absetzbare Investitionen</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                ‚è±Ô∏è Haltedauer (Jahre) <span class="required">*</span>
                            </label>
                            <div class="input-group">
                                <input type="number" id="haltedauer" class="form-input" placeholder="z.B. 8" min="0" max="50" step="0.1" data-shortcut="h">
                                <div class="validation-indicator" id="haltedauer-indicator"></div>
                            </div>
                            <div class="form-help">Zeit zwischen Kauf und Verkauf</div>
                            <div class="form-error" id="haltedauer-error"></div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                üíº Pers√∂nlicher Steuersatz (%)
                            </label>
                            <select id="steuersatz" class="form-select">
                                <option value="14">14% (Eingangssteuersatz)</option>
                                <option value="24">24% (Mittlerer Bereich)</option>
                                <option value="32">32% (H√∂herer Bereich)</option>
                                <option value="42" selected>42% (Spitzensteuersatz)</option>
                                <option value="45">45% (Reichensteuer)</option>
                            </select>
                            <div class="form-help">Ihr aktueller Einkommensteuersatz</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                ‚õ™ Kirchensteuer (%)
                            </label>
                            <select id="kirchensteuer" class="form-select">
                                <option value="0">0% (Konfessionslos)</option>
                                <option value="8" selected>8% (Bayern, BW)</option>
                                <option value="9">9% (Andere Bundesl√§nder)</option>
                            </select>
                            <div class="form-help">Kirchensteuer je nach Bundesland</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                üó∫Ô∏è Bundesland
                            </label>
                            <select id="bundesland" class="form-select">
                                <option value="bw">Baden-W√ºrttemberg</option>
                                <option value="by">Bayern</option>
                                <option value="be">Berlin</option>
                                <option value="bb">Brandenburg</option>
                                <option value="hb">Bremen</option>
                                <option value="hh">Hamburg</option>
                                <option value="he">Hessen</option>
                                <option value="mv">Mecklenburg-Vorpommern</option>
                                <option value="ni">Niedersachsen</option>
                                <option value="nw" selected>Nordrhein-Westfalen</option>
                                <option value="rp">Rheinland-Pfalz</option>
                                <option value="sl">Saarland</option>
                                <option value="sn">Sachsen</option>
                                <option value="st">Sachsen-Anhalt</option>
                                <option value="sh">Schleswig-Holstein</option>
                                <option value="th">Th√ºringen</option>
                            </select>
                            <div class="form-help">F√ºr bundeslandspezifische Steuerberechnung</div>
                        </div>
                    </div>

                    <!-- Progressive Disclosure for Advanced Options -->
                    <div class="advanced-options">
                        <button class="disclosure-toggle" onclick="app.toggleAdvanced()">
                            <span class="disclosure-arrow">‚ñ∂</span>
                            Erweiterte Optionen
                        </button>
                        <div class="disclosure-content" id="advanced-content">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">
                                        üí∞ Zus√§tzliche Werbungskosten
                                    </label>
                                    <input type="number" id="werbungskosten" class="form-input" placeholder="z.B. 5.000" min="0" step="100">
                                    <div class="form-help">Weitere steuerlich absetzbare Kosten</div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">
                                        üìä Abschreibungen (AfA)
                                    </label>
                                    <input type="number" id="abschreibungen" class="form-input" placeholder="z.B. 12.000" min="0" step="100">
                                    <div class="form-help">J√§hrliche Abschreibungen bei Vermietung</div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">
                                        üèóÔ∏è Immobilientyp
                                    </label>
                                    <select id="immobilientyp" class="form-select">
                                        <option value="eigenheim">Eigenheim/Privatnutzung</option>
                                        <option value="vermietung">Vermietungsimmobilie</option>
                                        <option value="gewerbe">Gewerbeimmobilie</option>
                                        <option value="mischnutzung">Mischnutzung</option>
                                    </select>
                                    <div class="form-help">Art der Immobiliennutzung</div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">
                                        üí± Inflationsbereinigung
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                                        <input type="checkbox" id="inflation-adjustment">
                                        <span>Kaufpreis inflationsbereinigt berechnen</span>
                                    </label>
                                    <div class="form-help">Automatische Anpassung an Inflation seit Kauf</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="app.calculateOptimal()" title="Optimale Berechnung starten (Ctrl+Enter)">
                            üßÆ KI-Optimierung starten
                        </button>
                        <button class="btn btn-success" onclick="app.loadExample()" title="Beispieldaten laden (Ctrl+E)">
                            üí° Beispiel laden
                        </button>
                        <button class="btn btn-warning" onclick="app.exportPDFReport()" title="PDF-Bericht erstellen (Ctrl+P)">
                            üìä PDF-Report
                        </button>
                        <button class="btn btn-secondary" onclick="app.resetForm()" title="Formular zur√ºcksetzen (Ctrl+R)">
                            üîÑ Zur√ºcksetzen
                        </button>
                    </div>
                </div>

                <!-- Additional Scenario Contents (placeholders) -->
                <div class="scenario-content" id="scenario2-content">
                    <div class="alert alert-info">
                        <h3>üìä Szenario 2</h3>
                        <p>Vergleichsszenario f√ºr What-If-Analysen. Kopieren Sie Werte aus Szenario 1 und modifizieren Sie einzelne Parameter.</p>
                    </div>
                    <!-- Form would be duplicated here -->
                </div>

                <div class="scenario-content" id="scenario3-content">
                    <div class="alert alert-info">
                        <h3>üéØ Szenario 3</h3>
                        <p>Drittes Szenario f√ºr umfassende Vergleichsanalysen.</p>
                    </div>
                    <!-- Form would be duplicated here -->
                </div>
            </div>

            <!-- Results Container -->
            <div class="results-container" id="results-container">
                <!-- Results will be dynamically inserted here -->
            </div>
        </main>

        <!-- Enhanced Analytics Panel -->
        <aside class="analytics-panel">
            <div class="analytics-header">
                <h3>üìä Real-time Analytics</h3>
            </div>

            <div class="analytics-widget">
                <div class="widget-header">
                    <span class="widget-title">Performance</span>
                    <span class="widget-icon">‚ö°</span>
                </div>
                <div class="metric-value" id="calc-time">0ms</div>
                <div class="metric-label">Berechnungszeit</div>
            </div>

            <div class="analytics-widget">
                <div class="widget-header">
                    <span class="widget-title">Optimierung</span>
                    <span class="widget-icon">üéØ</span>
                </div>
                <div class="metric-value" id="savings-potential">‚Ç¨0</div>
                <div class="metric-label">Max. Ersparnis</div>
            </div>

            <div class="analytics-widget">
                <div class="widget-header">
                    <span class="widget-title">Steuerquote</span>
                    <span class="widget-icon">üìà</span>
                </div>
                <div class="metric-value" id="tax-rate">0%</div>
                <div class="metric-label">Effektive Belastung</div>
                <div class="chart-container">
                    <canvas id="tax-chart" width="200" height="100"></canvas>
                </div>
            </div>

            <div class="analytics-widget">
                <div class="widget-header">
                    <span class="widget-title">Session</span>
                    <span class="widget-icon">üìä</span>
                </div>
                <div style="font-size: 0.9rem; color: #6c757d;">
                    <div>Berechnungen: <span id="calc-count">0</span></div>
                    <div>Cache Hits: <span id="cache-hits">0</span></div>
                    <div>Fehlerrate: <span id="error-rate">0%</span></div>
                </div>
            </div>

            <!-- Live API Documentation -->
            <div class="analytics-widget">
                <div class="widget-header">
                    <span class="widget-title">API Docs</span>
                    <span class="widget-icon">üìö</span>
                </div>
                <div style="font-size: 0.8rem;">
                    <div><code>POST /api/calculate</code></div>
                    <div><code>GET /api/structures</code></div>
                    <div><code>POST /api/compare</code></div>
                    <button class="btn btn-outline" onclick="app.showAPIDocumentation()" style="margin-top: 0.5rem; padding: 0.25rem 0.5rem; font-size: 0.7rem;">
                        üìñ Vollst√§ndige Docs
                    </button>
                </div>
            </div>
        </aside>
    </div>

    <!-- Keyboard Shortcuts Indicator -->
    <div class="shortcut-indicator" id="shortcut-indicator"></div>

    <!-- Undo/Redo Controls -->
    <div class="history-controls">
        <button class="history-btn" id="undo-btn" onclick="app.undo()" title="R√ºckg√§ngig (Ctrl+Z)" disabled>
            ‚Ü∂
        </button>
        <button class="history-btn" id="redo-btn" onclick="app.redo()" title="Wiederholen (Ctrl+Y)" disabled>
            ‚Ü∑
        </button>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <!-- Progress Overlay -->
    <div class="progress-overlay" id="progress-overlay">
        <div class="progress-modal">
            <div class="spinner"></div>
            <h3 id="progress-title">Berechnung l√§uft...</h3>
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
            <p id="progress-text">KI-Algorithmus analysiert optimale Steuerstrukturen...</p>
            <button class="btn btn-secondary" onclick="app.cancelCalculation()" style="margin-top: 1rem;">
                Abbrechen
            </button>
        </div>
    </div>

    <!-- Modal Overlays -->
    <div class="modal-overlay" id="comparison-modal">
        <div class="modal" style="max-width: 1200px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <h2>üìà Multi-Szenario Vergleich</h2>
                <button onclick="app.closeModal('comparison-modal')" style="background: none; border: none; font-size: 2rem; cursor: pointer;">√ó</button>
            </div>
            <div id="comparison-content">
                <!-- Comparison table will be generated here -->
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="api-docs-modal">
        <div class="modal" style="max-width: 800px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <h2>üìö API Dokumentation</h2>
                <button onclick="app.closeModal('api-docs-modal')" style="background: none; border: none; font-size: 2rem; cursor: pointer;">√ó</button>
            </div>
            <div id="api-docs-content">
                <h3>Immobilien-Steuer-Suite API v4.0</h3>
                <pre style="background: #f8f9fa; padding: 1rem; border-radius: 8px; overflow-x: auto;">
POST /api/v4/calculate
{
"kaufpreis": 400000,
"verkaufspreis": 600000,
"haltedauer": 8,
"steuersatz": 42,
"bundesland": "nw"
}

Response:
{
"structures": [‚Ä¶],
"optimal": {‚Ä¶},
"savings": 45000,
"calculationTime": "45ms"
}
</pre>
</div>
</div>
</div>
</div>

    <!-- Enhanced Error Handling and Module Structure -->
    <script>
        // Enhanced Error Handling and Module Structure Improvements
        class EnhancedErrorHandler {
            constructor() {
                this.errorLog = [];
                this.setupGlobalHandlers();
            }

            setupGlobalHandlers() {
                window.addEventListener('error', (event) => {
                    this.logError({
                        type: 'JavaScript Error',
                        message: event.message,
                        filename: event.filename,
                        lineno: event.lineno,
                        timestamp: new Date().toISOString()
                    });
                });

                window.addEventListener('unhandledrejection', (event) => {
                    this.logError({
                        type: 'Unhandled Promise Rejection',
                        message: event.reason?.message || event.reason,
                        timestamp: new Date().toISOString()
                    });
                });
            }

            logError(error) {
                this.errorLog.push(error);
                console.error('Application Error:', error);
                
                // Send to analytics service (if available)
                this.reportToAnalytics(error);
            }

            reportToAnalytics(error) {
                // Implementation for error reporting service
                if (typeof gtag !== 'undefined') {
                    gtag('event', 'exception', {
                        description: error.message,
                        fatal: false
                    });
                }
            }
        }

        // Improved PDF Export with Better Error Handling
        class EnhancedPDFExporter {
            constructor() {
                this.jsPDFLibrary = null;
                this.loadAttempts = 0;
                this.maxLoadAttempts = 3;
            }

            async ensureLibraryLoaded() {
                if (this.jsPDFLibrary) return this.jsPDFLibrary;

                // Try multiple CDN sources
                const cdnSources = [
                    'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js',
                    'https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js',
                    'https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js'
                ];

                for (const source of cdnSources) {
                    try {
                        await this.loadFromCDN(source);
                        this.jsPDFLibrary = this.getJsPDFConstructor();
                        if (this.jsPDFLibrary) return this.jsPDFLibrary;
                    } catch (error) {
                        console.warn(`Failed to load jsPDF from ${source}:`, error);
                        continue;
                    }
                }

                throw new Error('Failed to load jsPDF library from any CDN source');
            }

            loadFromCDN(url) {
                return new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = url;
                    script.onload = () => {
                        setTimeout(resolve, 200); // Give library time to initialize
                    };
                    script.onerror = () => reject(new Error(`Failed to load ${url}`));
                    document.head.appendChild(script);
                });
            }

            getJsPDFConstructor() {
                // Try different ways jsPDF might be exposed
                if (window.jspdf?.jsPDF) return window.jspdf.jsPDF;
                if (window.jsPDF) return window.jsPDF;
                if (typeof jsPDF !== 'undefined') return jsPDF;
                return null;
            }

            async exportReport(data) {
                try {
                    const jsPDFConstructor = await this.ensureLibraryLoaded();
                    const doc = new jsPDFConstructor({
                        orientation: 'portrait',
                        unit: 'mm',
                        format: 'a4'
                    });

                    await this.generatePDFContent(doc, data);
                    
                    const filename = `Steueroptimierung_${new Date().toISOString().split('T')[0]}.pdf`;
                    doc.save(filename);
                    
                    return { success: true, filename };
                } catch (error) {
                    console.error('PDF Export failed:', error);
                    throw new Error(`PDF-Export fehlgeschlagen: ${error.message}`);
                }
            }

            async generatePDFContent(doc, data) {
                // Enhanced PDF generation with better error handling
                try {
                    this.addHeader(doc);
                    this.addInputData(doc, data);
                    
                    if (data.results) {
                        this.addResults(doc, data.results);
                    }
                    
                    this.addFooter(doc);
                } catch (error) {
                    console.error('Error generating PDF content:', error);
                    throw error;
                }
            }

            addHeader(doc) {
                doc.setFontSize(20);
                doc.setTextColor('#667eea');
                doc.text('üè† Immobilien-Steuer-Suite 2025', 20, 30);
                
                doc.setFontSize(12);
                doc.setTextColor('#000000');
                doc.text('Ultimate Enterprise Edition - Steueroptimierung Bericht', 20, 40);
                doc.text(`Erstellt am: ${new Date().toLocaleDateString('de-DE')}`, 20, 50);
            }

            addInputData(doc, data) {
                let yPos = 70;
                doc.setFontSize(16);
                doc.setTextColor('#2c3e50');
                doc.text('Eingabedaten:', 20, yPos);
                yPos += 15;
                
                doc.setFontSize(10);
                doc.setTextColor('#000000');
                
                if (data.kaufpreis) {
                    doc.text(`Kaufpreis: ${this.formatCurrency(data.kaufpreis)}`, 25, yPos);
                    yPos += 10;
                }
                if (data.verkaufspreis) {
                    doc.text(`Verkaufspreis: ${this.formatCurrency(data.verkaufspreis)}`, 25, yPos);
                    yPos += 10;
                }
                if (data.haltedauer) {
                    doc.text(`Haltedauer: ${data.haltedauer} Jahre`, 25, yPos);
                    yPos += 10;
                }
                if (data.steuersatz) {
                    doc.text(`Steuersatz: ${data.steuersatz}%`, 25, yPos);
                    yPos += 10;
                }
            }

            addResults(doc, results) {
                let yPos = 140;
                doc.setFontSize(16);
                doc.setTextColor('#2c3e50');
                doc.text('Berechnungsergebnisse:', 20, yPos);
                yPos += 15;
                
                doc.setFontSize(10);
                doc.setTextColor('#000000');
                
                if (results.structures && results.structures.length > 0) {
                    results.structures.forEach((structure, index) => {
                        if (yPos > 250) {
                            doc.addPage();
                            yPos = 30;
                        }
                        
                        doc.setFontSize(12);
                        doc.setTextColor(structure.isBest ? '#27ae60' : '#2c3e50');
                        doc.text(`${index + 1}. ${structure.name}${structure.isBest ? ' (OPTIMAL)' : ''}`, 25, yPos);
                        yPos += 10;
                        
                        doc.setFontSize(10);
                        doc.setTextColor('#000000');
                        doc.text(`   Nettogewinn: ${this.formatCurrency(structure.netProfit)}`, 30, yPos);
                        yPos += 8;
                        doc.text(`   Steuerlast: ${this.formatCurrency(structure.tax)}`, 30, yPos);
                        yPos += 8;
                        doc.text(`   Steuersatz: ${structure.taxRate.toFixed(2)}%`, 30, yPos);
                        yPos += 15;
                    });
                }
            }

            addFooter(doc) {
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setTextColor('#6c757d');
                    doc.text(`Seite ${i} von ${pageCount}`, 20, 285);
                    doc.text('Immobilien-Steuer-Suite 2025 Ultimate Enterprise', 120, 285);
                }
            }

            formatCurrency(amount) {
                return new Intl.NumberFormat('de-DE', {
                    style: 'currency',
                    currency: 'EUR',
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                }).format(amount || 0);
            }
        }

        // Modular Calculation System
        class TaxCalculationEngine {
            constructor() {
                this.calculators = new Map();
                this.registerCalculators();
            }

            registerCalculators() {
                this.calculators.set('verkauf', new VerkaufsteuerCalculator());
                this.calculators.set('grundsteuer', new GrundsteuerCalculator());
                this.calculators.set('erbschaft', new ErbschaftsteuerCalculator());
                this.calculators.set('schenkung', new SchenkungsteuerCalculator());
                this.calculators.set('cashflow', new CashflowCalculator());
            }

            async calculate(type, data) {
                const calculator = this.calculators.get(type);
                if (!calculator) {
                    throw new Error(`Unknown calculation type: ${type}`);
                }

                try {
                    return await calculator.calculate(data);
                } catch (error) {
                    console.error(`Calculation error for ${type}:`, error);
                    throw new Error(`Fehler bei ${type}-Berechnung: ${error.message}`);
                }
            }

            getAvailableCalculators() {
                return Array.from(this.calculators.keys());
            }
        }

        // Base Calculator Class
        class BaseCalculator {
            constructor(name) {
                this.name = name;
                this.validationRules = new Map();
            }

            addValidationRule(field, rule) {
                this.validationRules.set(field, rule);
            }

            validate(data) {
                const errors = [];
                
                for (const [field, rule] of this.validationRules) {
                    try {
                        if (!rule.validator(data[field])) {
                            errors.push({
                                field,
                                message: rule.message
                            });
                        }
                    } catch (error) {
                        errors.push({
                            field,
                            message: `Validation error: ${error.message}`
                        });
                    }
                }

                return {
                    isValid: errors.length === 0,
                    errors
                };
            }

            async calculate(data) {
                const validation = this.validate(data);
                if (!validation.isValid) {
                    throw new Error(`Validation failed: ${validation.errors.map(e => e.message).join(', ')}`);
                }

                return this.performCalculation(data);
            }

            performCalculation(data) {
                throw new Error('performCalculation must be implemented by subclass');
            }
        }

        // Enhanced Verkaufsteuer Calculator
        class VerkaufsteuerCalculator extends BaseCalculator {
            constructor() {
                super('verkaufsteuer');
                this.setupValidation();
            }

            setupValidation() {
                this.addValidationRule('kaufpreis', {
                    validator: (value) => value > 0,
                    message: 'Kaufpreis muss gr√∂√üer als 0 sein'
                });

                this.addValidationRule('verkaufspreis', {
                    validator: (value) => value > 0,
                    message: 'Verkaufspreis muss gr√∂√üer als 0 sein'
                });

                this.addValidationRule('haltedauer', {
                    validator: (value) => value >= 0 && value <= 100,
                    message: 'Haltedauer muss zwischen 0 und 100 Jahren liegen'
                });
            }

            performCalculation(data) {
                const anschaffungskosten = data.kaufpreis + (data.nebenkosten_kauf || 0) + (data.modernisierung || 0);
                const grossProfit = data.verkaufspreis - (data.nebenkosten_verkauf || 0) - anschaffungskosten;
                
                if (grossProfit <= 0) {
                    return { 
                        grossProfit, 
                        structures: [],
                        message: 'Kein steuerpflichtiger Gewinn vorhanden'
                    };
                }

                const structures = this.calculateStructures(grossProfit, data);
                
                return {
                    grossProfit,
                    structures,
                    maxNetProfit: structures.length > 0 ? structures[0].netProfit : 0,
                    totalSavings: structures.length > 1 ? structures[0].netProfit - structures[structures.length - 1].netProfit : 0
                };
            }

            calculateStructures(grossProfit, data) {
                const baseTax = this.calculateSpeculationTax(grossProfit, data.haltedauer, data.steuersatz, data.kirchensteuer);
                const structures = [];

                const structureConfigs = [
                    { name: 'Privatverkauf', factor: 1.0, minProfit: 0 },
                    { name: 'VV GmbH & Co. KG (BFH 2025)', factor: 0.85, minProfit: 0 },
                    { name: 'Familienpool (GbR)', factor: 0.75, minProfit: 50000 },
                    { name: 'Share Deal (GmbH)', factor: 0.60, minProfit: 100000 },
                    { name: 'Cross-Border Holding', factor: 0.45, minProfit: 500000 },
                    { name: 'Cross-Border Struktur (Niederlande)', factor: 0.40, minProfit: 750000 },
                    { name: 'Familienstiftung', factor: 0.35, minProfit: 1000000 },
                    { name: 'Stiftung & Co. KG', factor: 0.30, minProfit: 1500000 }
                ];

                for (const config of structureConfigs) {
                    if (grossProfit >= config.minProfit) {
                        const tax = baseTax * config.factor;
                        const netProfit = grossProfit - tax;
                        
                        structures.push({
                            name: config.name,
                            grossProfit,
                            tax,
                            netProfit,
                            taxRate: grossProfit > 0 ? (tax / grossProfit * 100) : 0,
                            isBest: false
                        });
                    }
                }

                structures.sort((a, b) => b.netProfit - a.netProfit);
                if (structures.length > 0) {
                    structures[0].isBest = true;
                }

                return structures;
            }

            calculateSpeculationTax(profit, holdingPeriod, taxRate, churchTax) {
                if (holdingPeriod >= 10) return 0;
                
                const incomeTax = profit * (taxRate / 100);
                const churchTaxAmount = incomeTax * (churchTax / 100);
                const solidarityTax = incomeTax * 0.055;
                
                return incomeTax + churchTaxAmount + solidarityTax;
            }
        }

        // Placeholder calculators for other modules
        class GrundsteuerCalculator extends BaseCalculator {
            constructor() {
                super('grundsteuer');
            }

            performCalculation(data) {
                // Implementation for Grundsteuer calculation
                return { message: 'Grundsteuer calculation not yet implemented' };
            }
        }

        class ErbschaftsteuerCalculator extends BaseCalculator {
            constructor() {
                super('erbschaftsteuer');
            }

            performCalculation(data) {
                // Implementation for Erbschaftsteuer calculation
                return { message: 'Erbschaftsteuer calculation not yet implemented' };
            }
        }

        class SchenkungsteuerCalculator extends BaseCalculator {
            constructor() {
                super('schenkungsteuer');
            }

            performCalculation(data) {
                // Implementation for Schenkungsteuer calculation
                return { message: 'Schenkungsteuer calculation not yet implemented' };
            }
        }

        class CashflowCalculator extends BaseCalculator {
            constructor() {
                super('cashflow');
            }

            performCalculation(data) {
                // Implementation for Cashflow calculation
                return { message: 'Cashflow calculation not yet implemented' };
            }
        }

        // Enhanced State Management
        class ApplicationState {
            constructor() {
                this.state = new Proxy({}, {
                    set: (target, property, value) => {
                        const oldValue = target[property];
                        target[property] = value;
                        this.notify(property, value, oldValue);
                        return true;
                    }
                });

                this.subscribers = new Map();
                this.history = [];
                this.historyIndex = -1;
            }

            subscribe(property, callback) {
                if (!this.subscribers.has(property)) {
                    this.subscribers.set(property, new Set());
                }
                this.subscribers.get(property).add(callback);
            }

            unsubscribe(property, callback) {
                const callbacks = this.subscribers.get(property);
                if (callbacks) {
                    callbacks.delete(callback);
                }
            }

            notify(property, newValue, oldValue) {
                const callbacks = this.subscribers.get(property);
                if (callbacks) {
                    callbacks.forEach(callback => {
                        try {
                            callback(newValue, oldValue, property);
                        } catch (error) {
                            console.error('Error in state subscriber:', error);
                        }
                    });
                }
            }

            set(property, value) {
                this.saveToHistory();
                this.state[property] = value;
            }

            get(property) {
                return this.state[property];
            }

            saveToHistory() {
                if (this.historyIndex < this.history.length - 1) {
                    this.history = this.history.slice(0, this.historyIndex + 1);
                }
                
                this.history.push(JSON.parse(JSON.stringify(this.state)));
                this.historyIndex = this.history.length - 1;
                
                // Limit history size
                if (this.history.length > 50) {
                    this.history.shift();
                    this.historyIndex--;
                }
            }

            undo() {
                if (this.historyIndex > 0) {
                    this.historyIndex--;
                    this.state = { ...this.history[this.historyIndex] };
                    return true;
                }
                return false;
            }

            redo() {
                if (this.historyIndex < this.history.length - 1) {
                    this.historyIndex++;
                    this.state = { ...this.history[this.historyIndex] };
                    return true;
                }
                return false;
            }
        }

        // Initialize enhanced modules
        const errorHandler = new EnhancedErrorHandler();
        const enhancedPdfExporter = new EnhancedPDFExporter();
        const calculationEngine = new TaxCalculationEngine();
        const appState = new ApplicationState();

        // Make them globally available
        window.errorHandler = errorHandler;
        window.enhancedPdfExporter = enhancedPdfExporter;
        window.calculationEngine = calculationEngine;
        window.appState = appState;
    </script>

<!-- Web Worker for Background Calculations -->
<script id="worker-script" type="text/plain">
    // Tax Calculator Web Worker
    class TaxCalculatorWorker {
        constructor() {
            this.cache = new Map();
        }

        calculate(data) {
            const cacheKey = JSON.stringify(data);
            if (this.cache.has(cacheKey)) {
                return this.cache.get(cacheKey);
            }

            const results = this.performCalculation(data);
            this.cache.set(cacheKey, results);
            return results;
        }

        performCalculation(data) {
            const anschaffungskosten = data.kaufpreis + (data.nebenkosten_kauf || 0) + (data.modernisierung || 0);
            const grossProfit = data.verkaufspreis - (data.nebenkosten_verkauf || 0) - anschaffungskosten;
            
            if (grossProfit <= 0) {
                return { grossProfit, structures: [] };
            }

            const structures = [];
            const baseTax = this.calculateSpeculationTax(grossProfit, data.haltedauer, data.steuersatz, data.kirchensteuer);

            // Enhanced structure calculations with 2025 updates
            const structureConfigs = [
                { name: 'Privatverkauf', factor: 1.0, minProfit: 0 },
                { name: 'VV GmbH & Co. KG (BFH 2025)', factor: 0.85, minProfit: 0 },
                { name: 'Familienpool (GbR)', factor: 0.75, minProfit: 50000 },
                { name: 'Share Deal (GmbH)', factor: 0.60, minProfit: 100000 },
                { name: 'Cross-Border Holding (Luxemburg)', factor: 0.45, minProfit: 500000 },
                { name: 'Cross-Border Struktur (Niederlande)', factor: 0.50, minProfit: 500000 },
                { name: 'Familienstiftung', factor: 0.35, minProfit: 1000000 },
                { name: 'Stiftung & Co. KG', factor: 0.40, minProfit: 1000000 }
            ];

            for (const config of structureConfigs) {
                if (grossProfit >= config.minProfit) {
                    const tax = baseTax * config.factor;
                    const netProfit = grossProfit - tax;
                    
                    structures.push({
                        name: config.name,
                        grossProfit,
                        tax,
                        netProfit,
                        taxRate: grossProfit > 0 ? (tax / grossProfit * 100) : 0,
                        advantages: this.getAdvantages(config.name),
                        disadvantages: this.getDisadvantages(config.name),
                        recommendation: this.getRecommendation(config.name, data)
                    });
                }
            }

            structures.sort((a, b) => b.netProfit - a.netProfit);
            if (structures.length > 0) {
                structures[0].isBest = true;
            }

            return {
                grossProfit,
                structures,
                maxNetProfit: structures.length > 0 ? structures[0].netProfit : 0,
                totalSavings: structures.length > 1 ? structures[0].netProfit - structures[structures.length - 1].netProfit : 0
            };
        }

        calculateSpeculationTax(profit, holdingPeriod, taxRate, churchTax) {
            if (holdingPeriod >= 10) return 0;
            
            const incomeTax = profit * (taxRate / 100);
            const churchTaxAmount = incomeTax * (churchTax / 100);
            const solidarityTax = incomeTax * 0.055;
            
            return incomeTax + churchTaxAmount + solidarityTax;
        }

        getAdvantages(structureName) {
            const advantages = {
                'Privatverkauf': ['Steuerfrei nach 10 Jahren', 'Einfachste Abwicklung', 'Keine Gr√ºndungskosten'],
                'VV GmbH & Co. KG (BFH 2025)': ['BFH 2025: Gewerbesteuerfrei!', 'Haftungsbeschr√§nkung', 'Flexibilit√§t'],
                'Familienpool (GbR)': ['Steuerverteilung auf Familie', 'Progression brechen', 'Transparente Besteuerung'],
                'Share Deal (GmbH)': ['40% steuerfreier Gewinn (¬ß8b KStG)', 'Keine Grunderwerbsteuer', 'Planungssicherheit'],
                'Cross-Border Holding (Luxemburg)': ['EU-Holding-Richtlinie', 'Internationale Steueroptimierung', 'Niedrige Substanzsteuer'],
                'Cross-Border Struktur (Niederlande)': ['Doppelbesteuerungsabkommen', 'EU-konform', 'Steuerliche Transparenz'],
                'Familienstiftung': ['Generationen√ºbergreifend', 'Verm√∂gensschutz', 'Erbschaftsteueroptimierung'],
                'Stiftung & Co. KG': ['Flexible Gewinnverteilung', 'Haftungsbeschr√§nkung', 'Steueroptimierung']
            };
            return advantages[structureName] || [];
        }

        getDisadvantages(structureName) {
            const disadvantages = {
                'Privatverkauf': ['Spekulationssteuer unter 10 Jahren', 'Keine Optimierungsm√∂glichkeiten'],
                'VV GmbH & Co. KG (BFH 2025)': ['Komplexere Struktur', 'Gr√ºndungskosten', 'Laufende Verwaltung'],
                'Familienpool (GbR)': ['Mehrere Gesellschafter n√∂tig', 'Gesellschaftsvertrag erforderlich'],
                'Share Deal (GmbH)': ['Mindestens 5% Beteiligung', 'GmbH-Gr√ºndung erforderlich', 'Komplexe Struktur'],
                'Cross-Border Holding (Luxemburg)': ['Hohe Beratungskosten', 'Komplexe Struktur', 'Substanzanforderungen'],
                'Cross-Border Struktur (Niederlande)': ['Internationale Struktur', 'Compliance-Aufwand', 'Beratungsintensiv'],
                'Familienstiftung': ['Hohe Gr√ºndungskosten', 'Komplexe Verwaltung', 'Bindungswirkung'],
                'Stiftung & Co. KG': ['Sehr komplex', 'Hohe Kosten', 'Verwaltungsaufwand']
            };
            return disadvantages[structureName] || [];
        }

        getRecommendation(structureName, data) {
            if (data.haltedauer >= 10) return 'Optimal bei steuerfreiem Verkauf';
            if (structureName.includes('Cross-Border')) return 'F√ºr internationale Gro√üinvestoren';
            if (structureName.includes('Stiftung')) return 'F√ºr sehr hohe Verm√∂gen';
            if (structureName.includes('Share Deal')) return 'Sehr gut f√ºr gr√∂√üere Gewinne';
            if (structureName.includes('Familienpool')) return 'Optimal f√ºr Familien';
            return 'Empfehlenswert';
        }
    }

    const calculator = new TaxCalculatorWorker();

    self.onmessage = function(e) {
        const { id, data } = e.data;
        try {
            const result = calculator.calculate(data);
            self.postMessage({ id, result, success: true });
        } catch (error) {
            self.postMessage({ id, error: error.message, success: false });
        }
    };
</script>

<script>
    /**
     * Ultimate Enterprise Immobilien-Steuer-Suite 2025
     * Enhanced with all advanced features
     */
    
    class UltimateImmobilienSuite {
        constructor() {
            this.version = '4.0.0-ultimate';
            this.scenarios = new Map();
            this.currentScenario = 'scenario1';
            this.history = [];
            this.historyIndex = -1;
            this.realtimeEnabled = true;
            this.calculationTimeout = null;
            this.worker = null;
            this.workerMessageId = 0;
            this.workerCallbacks = new Map();
            this.cache = new Map();
            this.analytics = {
                calculations: 0,
                cacheHits: 0,
                errors: 0,
                startTime: Date.now()
            };
            this.plugins = new Map();
            this.keyboardShortcuts = new Map();
            this.chart = null;
            
            this.init();
        }

        async init() {
            console.log('üöÄ Initializing Ultimate Enterprise Suite...');
            
            try {
                await this.initializeWebWorker();
                this.setupEventListeners();
                this.setupKeyboardShortcuts();
                this.setupScenarios();
                this.setupPluginArchitecture();
                this.initializeAnalytics();
                this.loadSavedData();
                
                // Load initial content (Verkauf section)
                this.loadSectionContent('verkauf');
                
                this.showToast('üöÄ Ultimate Enterprise Suite geladen', 'success');
                this.updatePerformanceIndicator('Ready');
                
                console.log('‚úÖ Ultimate Suite initialized successfully');
            } catch (error) {
                console.error('‚ùå Initialization error:', error);
                this.showToast('‚ùå Fehler beim Laden: ' + error.message, 'danger');
            }
        }

        // Web Worker Implementation
        async initializeWebWorker() {
            if (typeof Worker !== 'undefined') {
                try {
                    const workerScript = document.getElementById('worker-script').textContent;
                    const blob = new Blob([workerScript], { type: 'application/javascript' });
                    const workerUrl = URL.createObjectURL(blob);
                    
                    this.worker = new Worker(workerUrl);
                    this.worker.onmessage = (e) => {
                        const { id, result, error, success } = e.data;
                        const callback = this.workerCallbacks.get(id);
                        
                        if (callback) {
                            this.workerCallbacks.delete(id);
                            if (success) {
                                callback.resolve(result);
                            } else {
                                callback.reject(new Error(error));
                            }
                        }
                    };
                    
                    console.log('‚úÖ Web Worker initialized');
                } catch (error) {
                    console.warn('‚ö†Ô∏è Web Worker not available, using main thread');
                }
            }
        }

        // Enhanced Calculation with Worker
        async calculateInWorker(data) {
            return new Promise((resolve, reject) => {
                if (!this.worker) {
                    // Fallback to main thread
                    resolve(this.calculateMainThread(data));
                    return;
                }

                const id = ++this.workerMessageId;
                this.workerCallbacks.set(id, { resolve, reject });
                
                this.worker.postMessage({ id, data });
                
                // Timeout after 5 seconds
                setTimeout(() => {
                    if (this.workerCallbacks.has(id)) {
                        this.workerCallbacks.delete(id);
                        reject(new Error('Calculation timeout'));
                    }
                }, 5000);
            });
        }

        // Main Thread Fallback
        calculateMainThread(data) {
            const anschaffungskosten = data.kaufpreis + (data.nebenkosten_kauf || 0) + (data.modernisierung || 0);
            const grossProfit = data.verkaufspreis - (data.nebenkosten_verkauf || 0) - anschaffungskosten;
            
            if (grossProfit <= 0) {
                return { grossProfit, structures: [] };
            }

            const structures = [];
            const baseTax = this.calculateSpeculationTax(grossProfit, data.haltedauer, data.steuersatz, data.kirchensteuer);

            const structureConfigs = [
                { name: 'Privatverkauf', factor: 1.0, minProfit: 0 },
                { name: 'VV GmbH & Co. KG (BFH 2025)', factor: 0.85, minProfit: 0 },
                { name: 'Familienpool (GbR)', factor: 0.75, minProfit: 50000 },
                { name: 'Share Deal (GmbH)', factor: 0.60, minProfit: 100000 },
                { name: 'Cross-Border Holding', factor: 0.45, minProfit: 500000 },
                { name: 'Familienstiftung', factor: 0.35, minProfit: 1000000 }
            ];

            for (const config of structureConfigs) {
                if (grossProfit >= config.minProfit) {
                    const tax = baseTax * config.factor;
                    const netProfit = grossProfit - tax;
                    
                    structures.push({
                        name: config.name,
                        grossProfit,
                        tax,
                        netProfit,
                        taxRate: grossProfit > 0 ? (tax / grossProfit * 100) : 0,
                        advantages: this.getAdvantages(config.name),
                        isBest: false
                    });
                }
            }

            structures.sort((a, b) => b.netProfit - a.netProfit);
            if (structures.length > 0) {
                structures[0].isBest = true;
            }

            return {
                grossProfit,
                structures,
                maxNetProfit: structures.length > 0 ? structures[0].netProfit : 0,
                totalSavings: structures.length > 1 ? structures[0].netProfit - structures[structures.length - 1].netProfit : 0
            };
        }

        calculateSpeculationTax(profit, holdingPeriod, taxRate, churchTax) {
            if (holdingPeriod >= 10) return 0;
            
            const incomeTax = profit * (taxRate / 100);
            const churchTaxAmount = incomeTax * (churchTax / 100);
            const solidarityTax = incomeTax * 0.055;
            
            return incomeTax + churchTaxAmount + solidarityTax;
        }

        getAdvantages(structureName) {
            const advantages = {
                'Privatverkauf': ['Steuerfrei nach 10 Jahren', 'Einfachste Abwicklung'],
                'VV GmbH & Co. KG (BFH 2025)': ['BFH 2025: Gewerbesteuerfrei!', 'Haftungsbeschr√§nkung'],
                'Familienpool (GbR)': ['Steuerverteilung auf Familie', 'Progression brechen'],
                'Share Deal (GmbH)': ['40% steuerfreier Gewinn (¬ß8b KStG)', 'Keine Grunderwerbsteuer'],
                'Cross-Border Holding': ['Internationale Steueroptimierung', 'EU-Richtlinien nutzen'],
                'Familienstiftung': ['Generationen√ºbergreifend', 'Maximale Steueroptimierung']
            };
            return advantages[structureName] || [];
        }

        setupEventListeners() {
            console.log('üîß Setting up event listeners...');
            
            // Wait for DOM to be ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', () => this.setupEventListenersInternal());
            } else {
                this.setupEventListenersInternal();
            }
        }

        setupEventListenersInternal() {
            // Real-time validation setup
            this.setupRealtimeValidation();
            
            // Navigation
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const section = link.getAttribute('data-section');
                    if (section) {
                        this.navigateToSection(section);
                    }
                });
            });

            // Form changes for real-time calculation
            document.addEventListener('input', (e) => {
                if (e.target.matches('.form-input, .form-select')) {
                    if (this.realtimeEnabled) {
                        this.debouncedCalculate();
                    }
                }
            });

            // Scroll effects
            window.addEventListener('scroll', () => {
                const header = document.getElementById('app-header');
                if (window.scrollY > 10) {
                    header.classList.add('scrolled');
                } else {
                    header.classList.remove('scrolled');
                }
            });

            console.log('‚úÖ Event listeners setup completed');
        }

        // Enhanced Debounced Real-time Calculation
        setupRealtimeValidation() {
            const inputs = document.querySelectorAll('.form-input, .form-select');
            
            inputs.forEach(input => {
                // Real-time validation
                input.addEventListener('input', this.debounce((e) => {
                    this.validateField(e.target);
                    if (this.realtimeEnabled) {
                        this.calculateOptimal();
                    }
                }, 300));

                // Immediate visual feedback
                input.addEventListener('input', (e) => {
                    this.showValidationIndicator(e.target);
                });

                input.addEventListener('blur', (e) => {
                    this.validateField(e.target);
                });
            });
        }

        // Debounce utility
        debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Enhanced Validation with Visual Feedback
        validateField(field) {
            const value = field.value;
            const fieldName = field.id;
            let isValid = true;
            let errorMessage = '';

            // Reset classes
            field.classList.remove('valid', 'invalid');

            // Required field validation
            if (field.hasAttribute('required') || ['kaufpreis', 'verkaufspreis', 'haltedauer'].includes(fieldName)) {
                if (!value || value.trim() === '') {
                    isValid = false;
                    errorMessage = 'Dieses Feld ist erforderlich';
                }
            }

            // Number validation
            if (field.type === 'number' && value) {
                const numValue = parseFloat(value);
                
                if (isNaN(numValue)) {
                    isValid = false;
                    errorMessage = 'Bitte geben Sie eine g√ºltige Zahl ein';
                } else if (numValue < 0) {
                    isValid = false;
                    errorMessage = 'Negative Werte sind nicht erlaubt';
                } else if (field.hasAttribute('min') && numValue < parseFloat(field.getAttribute('min'))) {
                    isValid = false;
                    errorMessage = `Wert muss mindestens ${field.getAttribute('min')} sein`;
                } else if (field.hasAttribute('max') && numValue > parseFloat(field.getAttribute('max'))) {
                    isValid = false;
                    errorMessage = `Wert darf h√∂chstens ${field.getAttribute('max')} sein`;
                }
            }

            // Update visual state
            if (value) {
                field.classList.add(isValid ? 'valid' : 'invalid');
            }

            this.updateValidationIndicator(field, isValid);
            this.showFieldError(field, isValid ? '' : errorMessage);

            return isValid;
        }

        showValidationIndicator(field) {
            const indicator = document.getElementById(field.id + '-indicator');
            if (indicator) {
                indicator.classList.add('show');
                // Hide after a delay
                setTimeout(() => indicator.classList.remove('show'), 2000);
            }
        }

        updateValidationIndicator(field, isValid) {
            const indicator = document.getElementById(field.id + '-indicator');
            if (indicator) {
                indicator.classList.remove('valid', 'invalid');
                if (field.value) {
                    indicator.classList.add(isValid ? 'valid' : 'invalid');
                    indicator.textContent = isValid ? '‚úì' : '‚úó';
                    indicator.classList.add('show');
                } else {
                    indicator.classList.remove('show');
                }
            }
        }

        showFieldError(field, message) {
            const errorDiv = document.getElementById(field.id + '-error');
            if (errorDiv) {
                errorDiv.textContent = message;
                errorDiv.style.display = message ? 'flex' : 'none';
            }
        }

        // Progressive Disclosure
        toggleAdvanced() {
            const toggle = document.querySelector('.disclosure-toggle');
            const content = document.getElementById('advanced-content');
            const arrow = document.querySelector('.disclosure-arrow');
            
            if (content.classList.contains('open')) {
                content.classList.remove('open');
                content.style.display = 'none';
                toggle.classList.remove('open');
            } else {
                content.classList.add('open');
                content.style.display = 'block';
                toggle.classList.add('open');
            }
        }

        // Multi-Scenario Management
        setupScenarios() {
            this.scenarios.set('scenario1', {
                name: 'Basis-Szenario',
                data: {},
                results: null
            });
            
            this.scenarios.set('scenario2', {
                name: 'Vergleichsszenario',
                data: {},
                results: null
            });
            
            this.scenarios.set('scenario3', {
                name: 'Optimiertes Szenario',
                data: {},
                results: null
            });
        }

        switchScenario(scenarioId) {
            // Save current scenario data
            if (this.currentScenario) {
                const scenario = this.scenarios.get(this.currentScenario);
                if (scenario) {
                    scenario.data = this.collectFormData();
                }
            }

            // Switch to new scenario
            this.currentScenario = scenarioId;
            
            // Update UI
            document.querySelectorAll('.scenario-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-scenario="${scenarioId}"]`).classList.add('active');
            
            document.querySelectorAll('.scenario-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(scenarioId + '-content').classList.add('active');
            
            // Load scenario data
            const scenario = this.scenarios.get(scenarioId);
            if (scenario && scenario.data) {
                this.populateForm(scenario.data);
            }
            
            this.showToast(`üìä Gewechselt zu ${scenario?.name || scenarioId}`, 'info');
        }

        addScenario() {
            const scenarioCount = this.scenarios.size + 1;
            const newId = `scenario${scenarioCount}`;
            
            this.scenarios.set(newId, {
                name: `Szenario ${scenarioCount}`,
                data: {},
                results: null
            });
            
            // Add tab
            const tabsContainer = document.querySelector('.scenario-tabs');
            const newTab = document.createElement('button');
            newTab.className = 'scenario-tab';
            newTab.setAttribute('data-scenario', newId);
            newTab.onclick = () => this.switchScenario(newId);
            newTab.textContent = `Szenario ${scenarioCount}`;
            
            tabsContainer.insertBefore(newTab, tabsContainer.lastElementChild);
            
            this.showToast(`‚ûï Neues Szenario ${scenarioCount} hinzugef√ºgt`, 'success');
        }

        // Keyboard Shortcuts
        setupKeyboardShortcuts() {
            this.keyboardShortcuts.set('ctrl+enter', () => this.calculateOptimal());
            this.keyboardShortcuts.set('ctrl+e', () => this.loadExample());
            this.keyboardShortcuts.set('ctrl+p', () => this.exportPDFReport());
            this.keyboardShortcuts.set('ctrl+r', () => this.resetForm());
            this.keyboardShortcuts.set('ctrl+m', () => this.showComparison());
            this.keyboardShortcuts.set('ctrl+z', () => this.undo());
            this.keyboardShortcuts.set('ctrl+y', () => this.redo());
            this.keyboardShortcuts.set('f1', () => this.showHelp());
            this.keyboardShortcuts.set('escape', () => this.closeAllModals());

            document.addEventListener('keydown', (e) => {
                const key = this.getKeyboardShortcut(e);
                const action = this.keyboardShortcuts.get(key);
                
                if (action) {
                    e.preventDefault();
                    action();
                    this.showShortcutIndicator(key);
                }
            });
        }

        getKeyboardShortcut(e) {
            const parts = [];
            if (e.ctrlKey) parts.push('ctrl');
            if (e.shiftKey) parts.push('shift');
            if (e.altKey) parts.push('alt');
            
            const key = e.key.toLowerCase();
            if (key !== 'control' && key !== 'shift' && key !== 'alt') {
                parts.push(key);
            }
            
            return parts.join('+');
        }

        showShortcutIndicator(shortcut) {
            const indicator = document.getElementById('shortcut-indicator');
            indicator.textContent = `‚å®Ô∏è ${shortcut.toUpperCase()}`;
            indicator.classList.add('show');
            
            setTimeout(() => {
                indicator.classList.remove('show');
            }, 2000);
        }

        // Undo/Redo Functionality
        saveToHistory() {
            const state = {
                timestamp: Date.now(),
                formData: this.collectFormData(),
                scenario: this.currentScenario
            };
            
            // Remove future history if we're in the middle
            if (this.historyIndex < this.history.length - 1) {
                this.history = this.history.slice(0, this.historyIndex + 1);
            }
            
            this.history.push(state);
            this.historyIndex = this.history.length - 1;
            
            // Limit history size
            if (this.history.length > 50) {
                this.history.shift();
                this.historyIndex--;
            }
            
            this.updateHistoryButtons();
        }

        undo() {
            if (this.historyIndex > 0) {
                this.historyIndex--;
                const state = this.history[this.historyIndex];
                this.populateForm(state.formData);
                this.switchScenario(state.scenario);
                this.updateHistoryButtons();
                this.showToast('‚Ü∂ R√ºckg√§ngig', 'info');
            }
        }

        redo() {
            if (this.historyIndex < this.history.length - 1) {
                this.historyIndex++;
                const state = this.history[this.historyIndex];
                this.populateForm(state.formData);
                this.switchScenario(state.scenario);
                this.updateHistoryButtons();
                this.showToast('‚Ü∑ Wiederholt', 'info');
            }
        }

        updateHistoryButtons() {
            const undoBtn = document.getElementById('undo-btn');
            const redoBtn = document.getElementById('redo-btn');
            
            undoBtn.disabled = this.historyIndex <= 0;
            redoBtn.disabled = this.historyIndex >= this.history.length - 1;
        }

        // Plugin Architecture
        setupPluginArchitecture() {
            this.plugins.set('bundesland-analyzer', {
                name: 'Bundesland-Analyzer',
                version: '1.0.0',
                load: () => this.loadBundeslandAnalyzer(),
                unload: () => this.unloadBundeslandAnalyzer()
            });

            this.plugins.set('inflation-calculator', {
                name: 'Inflations-Rechner',
                version: '1.0.0',
                load: () => this.loadInflationCalculator(),
                unload: () => this.unloadInflationCalculator()
            });

            this.plugins.set('ai-optimizer', {
                name: 'KI-Optimierer',
                version: '2.0.0',
                load: () => this.loadAIOptimizer(),
                unload: () => this.unloadAIOptimizer()
            });
        }

        loadPlugin(pluginId) {
            const plugin = this.plugins.get(pluginId);
            if (plugin) {
                plugin.load();
                this.showToast(`üîå Plugin "${plugin.name}" geladen`, 'success');
            }
        }

        loadBundeslandAnalyzer() {
            // Demo plugin functionality
            this.showModal('comparison-modal');
            document.getElementById('comparison-content').innerHTML = `
                <h3>üó∫Ô∏è Bundesland-Steuer-Vergleich</h3>
                <p>Dieses Plugin w√ºrde detaillierte Steuervergleiche zwischen verschiedenen Bundesl√§ndern anzeigen.</p>
                <div class="alert alert-info">
                    <strong>Demo-Modus:</strong> Vollst√§ndige Plugin-Funktionalit√§t in der Enterprise-Version verf√ºgbar.
                </div>
            `;
        }

        loadInflationCalculator() {
            const checkbox = document.getElementById('inflation-adjustment');
            if (checkbox) {
                checkbox.checked = true;
                this.showToast('üìä Inflation wird nun automatisch ber√ºcksichtigt', 'success');
            }
        }

        loadAIOptimizer() {
            this.updatePerformanceIndicator('KI-Modus aktiv');
            this.showToast('ü§ñ KI-Optimierer aktiviert - Erweiterte Berechnungen verf√ºgbar', 'success');
        }

        // Enhanced Calculation Method
        async calculateOptimal() {
            const startTime = performance.now();
            
            try {
                this.updatePerformanceIndicator('Berechnung l√§uft...');
                this.showProgress('KI-Algorithmus analysiert optimale Steuerstrukturen...', 10);
                
                const data = this.collectFormData();
                
                // Validation
                if (!this.validateFormData(data)) {
                    throw new Error('Bitte korrigieren Sie die Eingabefehler');
                }

                // Save to history
                this.saveToHistory();
                
                this.showProgress('Berechne optimale Rechtsformen...', 30);
                
                // Check cache first
                const cacheKey = JSON.stringify(data);
                let results;
                
                if (this.cache.has(cacheKey)) {
                    results = this.cache.get(cacheKey);
                    this.analytics.cacheHits++;
                    this.showProgress('Cache-Treffer gefunden...', 60);
                } else {
                    // Perform calculation (with or without worker)
                    results = await this.calculateInWorker(data);
                    this.cache.set(cacheKey, results);
                    this.showProgress('Berechnung abgeschlossen...', 80);
                }

                // Update analytics
                this.analytics.calculations++;
                const calculationTime = performance.now() - startTime;
                
                this.showProgress('Erstelle Ergebnisse...', 90);
                
                // Display results
                this.displayResults(results);
                this.updateAnalytics(results, calculationTime);
                
                this.showProgress('Fertig!', 100);
                
                setTimeout(() => {
                    this.hideProgress();
                    this.updatePerformanceIndicator('Berechnung abgeschlossen');
                }, 500);

            } catch (error) {
                console.error('‚ùå Calculation error:', error);
                this.analytics.errors++;
                this.hideProgress();
                this.updatePerformanceIndicator('Fehler');
                this.showToast('‚ùå Berechnung fehlgeschlagen: ' + error.message, 'danger');
            }
        }

        validateFormData(data) {
            let isValid = true;
            const errors = [];

            if (!data.kaufpreis || data.kaufpreis <= 0) {
                errors.push('Kaufpreis ist erforderlich');
                isValid = false;
            }

            if (!data.verkaufspreis || data.verkaufspreis <= 0) {
                errors.push('Verkaufspreis ist erforderlich');
                isValid = false;
            }

            if (data.haltedauer === undefined || data.haltedauer < 0) {
                errors.push('Haltedauer ist erforderlich');
                isValid = false;
            }

            if (!isValid) {
                errors.forEach(error => {
                    this.showToast('‚ö†Ô∏è ' + error, 'warning');
                });
            }

            return isValid;
        }

        // Enhanced Results Display
        displayResults(results) {
            const container = document.getElementById('results-container');
            
            if (!results || !results.structures || results.structures.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-info">
                        <h3>‚ÑπÔ∏è Keine Optimierung m√∂glich</h3>
                        <p>F√ºr diese Eingaben konnten keine Steueroptimierungen gefunden werden.</p>
                    </div>
                `;
                return;
            }

            let html = '';

            // Success Alert
            if (results.maxNetProfit > 0) {
                html += `
                    <div class="alert alert-success">
                        <h3>üéØ KI-Optimierung erfolgreich!</h3>
                        <p><strong>Beste Option:</strong> ${results.structures[0].name}</p>
                        <p><strong>Nettogewinn:</strong> ${this.formatCurrency(results.maxNetProfit)}</p>
                        ${results.totalSavings > 0 ? `<p><strong>Steuerersparnis:</strong> ${this.formatCurrency(results.totalSavings)}</p>` : ''}
                    </div>
                `;
            }

            // Results Grid
            html += '<div class="results-grid">';
            
            results.structures.forEach((structure, index) => {
                const badgeText = structure.isBest ? 'üëë OPTIMAL' : `#${index + 1}`;
                const cardClass = structure.isBest ? 'result-card best' : 'result-card';
                
                html += `
                    <div class="${cardClass}">
                        <div class="result-header">
                            <h3 class="result-title">${structure.name}</h3>
                            ${structure.isBest ? `<span class="result-badge">${badgeText}</span>` : ''}
                        </div>
                        <div class="result-item">
                            <span class="result-label">Bruttogewinn:</span>
                            <span class="result-value">${this.formatCurrency(structure.grossProfit)}</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Steuerbelastung:</span>
                            <span class="result-value">${this.formatCurrency(structure.tax)}</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Nettogewinn:</span>
                            <span class="result-value">${this.formatCurrency(structure.netProfit)}</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Effektiver Steuersatz:</span>
                            <span class="result-value">${structure.taxRate.toFixed(1)}%</span>
                        </div>
                        ${structure.advantages && structure.advantages.length > 0 ? `
                            <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e9ecef;">
                                <strong>‚úÖ Vorteile:</strong>
                                <ul style="margin: 0.5rem 0 0 1.5rem; font-size: 0.9rem;">
                                    ${structure.advantages.map(adv => `<li>${adv}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        ${structure.disadvantages && structure.disadvantages.length > 0 ? `
                            <div style="margin-top: 1rem;">
                                <strong>‚ö†Ô∏è Nachteile:</strong>
                                <ul style="margin: 0.5rem 0 0 1.5rem; font-size: 0.9rem; color: #6c757d;">
                                    ${structure.disadvantages.map(dis => `<li>${dis}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            html += '</div>';

            // Recommendation Summary
            if (results.structures.length > 0) {
                const bestStructure = results.structures[0];
                html += `
                    <div class="card mt-4">
                        <div class="card-header">
                            <h3 class="card-title">üí° KI-Empfehlung</h3>
                        </div>
                        <p>Basierend auf Ihrer Situation empfiehlt unser KI-Algorithmus die Struktur <strong>"${bestStructure.name}"</strong>.</p>
                        <p>Diese L√∂sung bietet Ihnen den h√∂chsten Nettogewinn von <strong>${this.formatCurrency(bestStructure.netProfit)}</strong> bei einem effektiven Steuersatz von nur <strong>${bestStructure.taxRate.toFixed(1)}%</strong>.</p>
                        ${results.totalSavings > 0 ? `<p class="text-success"><strong>Ihre Steuerersparnis betr√§gt ${this.formatCurrency(results.totalSavings)} gegen√ºber der ung√ºnstigsten Option.</strong></p>` : ''}
                    </div>
                `;
            }

            container.innerHTML = html;
            
            // Animate results
            setTimeout(() => {
                container.style.opacity = '0';
                container.style.transform = 'translateY(20px)';
                container.style.transition = 'all 0.5s ease';
                
                setTimeout(() => {
                    container.style.opacity = '1';
                    container.style.transform = 'translateY(0)';
                }, 100);
            }, 50);
        }

        // PDF Export with jsPDF
        async exportPDFReport() {
            try {
                // Wait a moment for libraries to load
                await new Promise(resolve => setTimeout(resolve, 100));
                
                // Check for jsPDF availability
                let jsPDFConstructor = null;
                
                if (window.jspdf && window.jspdf.jsPDF) {
                    jsPDFConstructor = window.jspdf.jsPDF;
                } else if (window.jsPDF) {
                    jsPDFConstructor = window.jsPDF;
                } else if (typeof jsPDF !== 'undefined') {
                    jsPDFConstructor = jsPDF;
                } else {
                    // Try to load jsPDF dynamically
                const doc = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });
                    
                    if (window.jspdf && window.jspdf.jsPDF) {
                        jsPDFConstructor = window.jspdf.jsPDF;
                    } else if (window.jsPDF) {
                        jsPDFConstructor = window.jsPDF;
                    } else {
                        throw new Error('PDF-Bibliothek konnte nicht geladen werden');
                    }
                }

                this.showProgress('Erstelle PDF-Bericht...', 20);

                const doc = new jsPDFConstructor();
                // Header
                doc.setFontSize(20);
                doc.setTextColor('#667eea');
                doc.text('üè† Immobilien-Steuer-Suite 2025', 20, 30);
                
                doc.setFontSize(12);
                doc.setTextColor('#000000');
                doc.text('Ultimate Enterprise Edition - Steueroptimierung Bericht', 20, 40);
                doc.text(`Erstellt am: ${new Date().toLocaleDateString('de-DE')}`, 20, 50);

                this.showProgress('Sammle Daten...', 40);

                // Input Data
                const data = this.collectFormData();
                let yPos = 70;
                
                doc.setFontSize(16);
                doc.setTextColor('#2c3e50');
                doc.text('Eingabedaten:', 20, yPos);
                yPos += 15;
                
                doc.setFontSize(10);
                doc.setTextColor('#000000');
                doc.text(`Kaufpreis: ${this.formatCurrency(data.kaufpreis)}`, 25, yPos);
                doc.text(`Verkaufspreis: ${this.formatCurrency(data.verkaufspreis)}`, 25, yPos + 10);
                doc.text(`Haltedauer: ${data.haltedauer} Jahre`, 25, yPos + 20);
                doc.text(`Steuersatz: ${data.steuersatz}%`, 25, yPos + 30);
                doc.text(`Kirchensteuer: ${data.kirchensteuer}%`, 25, yPos + 40);

                this.showProgress('Berechne Ergebnisse...', 60);

                // Calculate for PDF
                const results = await this.calculateInWorker(data);
                
                if (results && results.structures && results.structures.length > 0) {
                    yPos += 60;
                    
                    doc.setFontSize(16);
                    doc.setTextColor('#2c3e50');
                    doc.text('Optimierungsergebnisse:', 20, yPos);
                    yPos += 15;
                    
                    // Best structure
                    const best = results.structures[0];
                    doc.setFontSize(12);
                    doc.setTextColor('#11998e');
                    doc.text(`BESTE OPTION: ${best.name}`, 25, yPos);
                    yPos += 10;
                    
                    doc.setFontSize(10);
                    doc.setTextColor('#000000');
                    doc.text(`Nettogewinn: ${this.formatCurrency(best.netProfit)}`, 25, yPos);
                    doc.text(`Steuersatz: ${best.taxRate.toFixed(1)}%`, 25, yPos + 10);
                    doc.text(`Steuerbelastung: ${this.formatCurrency(best.tax)}`, 25, yPos + 20);
                    
                    yPos += 35;
                    
                    // All structures table
                    doc.setFontSize(12);
                    doc.setTextColor('#2c3e50');
                    doc.text('Alle Rechtsformen im Vergleich:', 20, yPos);
                    yPos += 15;
                    
                    // Table headers
                    doc.setFontSize(8);
                    doc.setTextColor('#000000');
                    doc.text('Struktur', 25, yPos);
                    doc.text('Nettogewinn', 80, yPos);
                    doc.text('Steuer', 130, yPos);
                    doc.text('Rate', 170, yPos);
                    yPos += 8;
                    
                    results.structures.forEach((structure, index) => {
                        if (yPos > 250) {
                            doc.addPage();
                            yPos = 30;
                        }
                        
                        doc.setTextColor(index === 0 ? '#11998e' : '#000000');
                        doc.text(structure.name.substring(0, 25), 25, yPos);
                        doc.text(this.formatCurrency(structure.netProfit), 80, yPos);
                        doc.text(this.formatCurrency(structure.tax), 130, yPos);
                        doc.text(`${structure.taxRate.toFixed(1)}%`, 170, yPos);
                        yPos += 8;
                    });
                }

                this.showProgress('Generiere PDF...', 80);

                // Footer
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setTextColor('#6c757d');
                    doc.text(`Seite ${i} von ${pageCount}`, 20, 285);
                    doc.text('Immobilien-Steuer-Suite 2025 Ultimate Enterprise', 120, 285);
                }

                this.showProgress('Download startet...', 100);

                // Save PDF
                const filename = `Steueroptimierung_${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(filename);

                setTimeout(() => {
                    this.hideProgress();
                    this.showToast('üìÑ PDF-Bericht erfolgreich erstellt', 'success');
                }, 500);

            } catch (error) {
                console.error('PDF Export Error:', error);
                this.hideProgress();
                this.showToast('‚ùå PDF-Export fehlgeschlagen: ' + error.message, 'danger');
            }
        }

        async loadJsPDFDynamic() {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
                script.onload = () => {
                    // Give the library time to initialize
                    setTimeout(() => {
                        if (window.jspdf || window.jsPDF || typeof jsPDF !== 'undefined') {
                            resolve();
                        } else {
                            reject(new Error('jsPDF failed to initialize'));
                        }
                    }, 200);
                };
                script.onerror = () => reject(new Error('Failed to load jsPDF script'));
                document.head.appendChild(script);
            });
        }

        // Enhanced Analytics
        updateAnalytics(results, calculationTime) {
            // Update performance metrics
            document.getElementById('calc-time').textContent = Math.round(calculationTime) + 'ms';
            document.getElementById('calc-count').textContent = this.analytics.calculations;
            document.getElementById('cache-hits').textContent = this.analytics.cacheHits;
            
            const errorRate = this.analytics.calculations > 0 ? 
                (this.analytics.errors / this.analytics.calculations * 100).toFixed(1) : '0';
            document.getElementById('error-rate').textContent = errorRate + '%';

            if (results && results.structures && results.structures.length > 0) {
                const maxSavings = results.totalSavings || 0;
                const bestTaxRate = results.structures[0].taxRate || 0;
                
                document.getElementById('savings-potential').textContent = this.formatCurrency(maxSavings);
                document.getElementById('tax-rate').textContent = bestTaxRate.toFixed(1) + '%';

                // Update chart
                this.updateTaxChart(results.structures);
            }
        }

        updateTaxChart(structures) {
            const canvas = document.getElementById('tax-chart');
            const ctx = canvas.getContext('2d');

            if (this.chart) {
                this.chart.destroy();
            }

            const labels = structures.slice(0, 4).map(s => s.name.split(' ')[0]);
            const data = structures.slice(0, 4).map(s => s.taxRate);
            const colors = structures.slice(0, 4).map((s, i) => 
                i === 0 ? '#11998e' : `hsl(${200 + i * 30}, 60%, 60%)`
            );

            this.chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Steuersatz %',
                        data: data,
                        backgroundColor: colors,
                        borderColor: colors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        updatePerformanceIndicator(text) {
            const indicator = document.getElementById('performance-text');
            if (indicator) {
                indicator.textContent = text;
            }
        }

        // Multi-Scenario Comparison
        showComparison() {
            const scenarios = Array.from(this.scenarios.entries());
            const hasData = scenarios.some(([id, scenario]) => 
                scenario.data && Object.keys(scenario.data).length > 0
            );

            if (!hasData) {
                this.showToast('‚ö†Ô∏è Keine Szenarien zum Vergleichen vorhanden', 'warning');
                return;
            }

            this.showModal('comparison-modal');
            
            let html = `
                <div class="alert alert-info">
                    <h3>üìä Multi-Szenario Vergleichsanalyse</h3>
                    <p>Vergleich aller berechneten Szenarien mit detaillierter Aufschl√ºsselung.</p>
                </div>
                
                <table class="data-table" style="width: 100%; border-collapse: collapse; margin-top: 2rem;">
                    <thead>
                        <tr style="background: linear-gradient(135deg, #667eea, #764ba2); color: white;">
                            <th style="padding: 1rem; text-align: left;">Szenario</th>
                            <th style="padding: 1rem; text-align: right;">Kaufpreis</th>
                            <th style="padding: 1rem; text-align: right;">Verkaufspreis</th>
                            <th style="padding: 1rem; text-align: right;">Gewinn</th>
                            <th style="padding: 1rem; text-align: right;">Beste Option</th>
                            <th style="padding: 1rem; text-align: right;">Nettogewinn</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            scenarios.forEach(([id, scenario]) => {
                if (scenario.data && Object.keys(scenario.data).length > 0) {
                    const data = scenario.data;
                    const grossProfit = (data.verkaufspreis || 0) - (data.kaufpreis || 0) - 
                                      (data.nebenkosten_kauf || 0) - (data.nebenkosten_verkauf || 0) - 
                                      (data.modernisierung || 0);
                    
                    html += `
                        <tr style="border-bottom: 1px solid #e9ecef;">
                            <td style="padding: 1rem; font-weight: 600;">${scenario.name}</td>
                            <td style="padding: 1rem; text-align: right;">${this.formatCurrency(data.kaufpreis || 0)}</td>
                            <td style="padding: 1rem; text-align: right;">${this.formatCurrency(data.verkaufspreis || 0)}</td>
                            <td style="padding: 1rem; text-align: right;">${this.formatCurrency(grossProfit)}</td>
                            <td style="padding: 1rem; text-align: right;">-</td>
                            <td style="padding: 1rem; text-align: right;">-</td>
                        </tr>
                    `;
                }
            });

            html += `
                    </tbody>
                </table>
                
                <div class="btn-group" style="margin-top: 2rem;">
                    <button class="btn btn-primary" onclick="app.calculateAllScenarios()">
                        üßÆ Alle Szenarien berechnen
                    </button>
                    <button class="btn btn-secondary" onclick="app.exportComparisonPDF()">
                        üìä Vergleich als PDF
                    </button>
                </div>
            `;

            document.getElementById('comparison-content').innerHTML = html;
        }

        async calculateAllScenarios() {
            const scenarios = Array.from(this.scenarios.entries());
            const results = new Map();

            this.showProgress('Berechne alle Szenarien...', 0);

            for (let i = 0; i < scenarios.length; i++) {
                const [id, scenario] = scenarios[i];
                if (scenario.data && Object.keys(scenario.data).length > 0) {
                    this.showProgress(`Berechne ${scenario.name}...`, (i / scenarios.length) * 100);
                    
                    try {
                        const result = await this.calculateInWorker(scenario.data);
                        results.set(id, result);
                    } catch (error) {
                        console.error(`Error calculating scenario ${id}:`, error);
                    }
                }
            }

            this.hideProgress();
            this.updateComparisonTable(results);
        }

        updateComparisonTable(results) {
            // Implementation would update the comparison table with calculated results
            this.showToast('üìä Alle Szenarien berechnet', 'success');
        }

        // Event Handlers f√ºr alle Module
        setupGrundsteuerEventHandlers() {
            // Grundsteuer Event Handlers
            this.setupRealtimeValidation();
            console.log('Setting up Grundsteuer event handlers');
        }

        setupErbschaftEventHandlers() {
            // Erbschaft Event Handlers
            this.setupRealtimeValidation();
            console.log('Setting up Erbschaft event handlers');
        }

        setupSchenkungEventHandlers() {
            // Schenkung Event Handlers
            this.setupRealtimeValidation();
            console.log('Setting up Schenkung event handlers');
        }

        setupCashflowEventHandlers() {
            // Cashflow Event Handlers
            this.setupRealtimeValidation();
            console.log('Setting up Cashflow event handlers');
        }

        setupStrategieEventHandlers() {
            // Strategie Event Handlers (renamed from setupStrategiesEventHandlers)
            this.setupRealtimeValidation();
            console.log('Setting up Strategie event handlers');
        }

        // Cash-Flow Berechnungen
        async calculateCashflow() {
            try {
                this.showProgress('Berechne Cash-Flow Analyse...', 20);
                
                const data = this.collectCashflowData();
                const results = await this.performCashflowCalculation(data);
                
                this.showProgress('Erstelle Cash-Flow Ergebnisse...', 80);
                this.displayCashflowResults(results);
                
                setTimeout(() => {
                    this.hideProgress();
                    this.showToast('üìä Cash-Flow erfolgreich analysiert', 'success');
                }, 500);

            } catch (error) {
                this.hideProgress();
                this.showToast('‚ùå Cash-Flow Analyse fehlgeschlagen: ' + error.message, 'danger');
            }
        }

        collectCashflowData() {
            return {
                mieteinnahmen: parseFloat(document.getElementById('mieteinnahmen')?.value) || 0,
                betriebskosten: parseFloat(document.getElementById('betriebskosten')?.value) || 0,
                finanzierungskosten: parseFloat(document.getElementById('finanzierungskosten')?.value) || 0,
                abschreibungen: parseFloat(document.getElementById('cashflow_abschreibungen')?.value) || 0,
                steuersatz: parseFloat(document.getElementById('cashflow_steuersatz')?.value) || 42,
                analysezeitraum: parseInt(document.getElementById('analysezeitraum')?.value) || 5,
                mietsteigerung: parseFloat(document.getElementById('mietsteigerung')?.value) || 2.5,
                verkaufserloes: parseFloat(document.getElementById('verkaufserloes')?.value) || 0,
                reinvestition: document.getElementById('reinvestition')?.value || 'keine'
            };
        }

        async performCashflowCalculation(data) {
            const jahre = [];
            let kumulierterCashflow = 0;
            let aktuelle_miete = data.mieteinnahmen;
            
            // J√§hrliche Berechnung
            for (let jahr = 1; jahr <= data.analysezeitraum; jahr++) {
                // Mietsteigerung ber√ºcksichtigen
                if (jahr > 1) {
                    aktuelle_miete *= (1 + data.mietsteigerung / 100);
                }
                
                const jahres_mieteinnahmen = aktuelle_miete * 12;
                const jahres_betriebskosten = data.betriebskosten * 12;
                const jahres_finanzierung = data.finanzierungskosten * 12;
                
                // Netto-Einkommen vor Steuern
                const netto_einkommen = jahres_mieteinnahmen - jahres_betriebskosten - jahres_finanzierung;
                
                // Steuerliches Ergebnis (mit Abschreibungen)
                const steuerliches_ergebnis = netto_einkommen - data.abschreibungen;
                
                // Steuern berechnen
                const steuern = Math.max(0, steuerliches_ergebnis * (data.steuersatz / 100));
                
                // Cash-Flow nach Steuern
                const cashflow_nach_steuern = netto_einkommen - steuern;
                
                kumulierterCashflow += cashflow_nach_steuern;
                
                jahre.push({
                    jahr,
                    mieteinnahmen: jahres_mieteinnahmen,
                    betriebskosten: jahres_betriebskosten,
                    finanzierungskosten: jahres_finanzierung,
                    netto_einkommen,
                    abschreibungen: data.abschreibungen,
                    steuerliches_ergebnis,
                    steuern,
                    cashflow_nach_steuern,
                    kumulierter_cashflow: kumulierterCashflow
                });
            }
            
            // Verkaufserl√∂s am Ende
            let verkaufs_cashflow = 0;
            if (data.verkaufserloes > 0) {
                // Vereinfachte Verkaufssteuer-Berechnung
                const verkaufssteuer = data.verkaufserloes * 0.1; // Beispiel
                verkaufs_cashflow = data.verkaufserloes - verkaufssteuer;
            }
            
            const gesamt_cashflow = kumulierterCashflow + verkaufs_cashflow;
            
            // Strategieempfehlungen
            const strategien = this.getCashflowStrategien(data, gesamt_cashflow);
            
            return {
                jahre,
                kumulierter_cashflow: kumulierterCashflow,
                verkaufs_cashflow,
                gesamt_cashflow,
                durchschnittlicher_cashflow: kumulierterCashflow / data.analysezeitraum,
                roi: data.verkaufserloes > 0 ? (gesamt_cashflow / data.verkaufserloes * 100) : 0,
                strategien
            };
        }

        getCashflowStrategien(data, gesamtCashflow) {
            const strategien = [];
            
            if (data.reinvestition === 'portfolio') {
                strategien.push({
                    name: 'Portfolio-Erweiterung',
                    beschreibung: 'Reinvestition in weitere Immobilien f√ºr Diversifikation',
                    potential: gesamtCashflow * 0.15,
                    empfehlung: 'Bei stabilem Cash-Flow empfehlenswert'
                });
            }
            
            if (data.mietsteigerung < 3) {
                strategien.push({
                    name: 'Mietoptimierung',
                    beschreibung: 'Marktmiete pr√ºfen und ggf. anpassen',
                    potential: data.mieteinnahmen * 12 * 0.1,
                    empfehlung: 'Regelm√§√üige Marktanalyse durchf√ºhren'
                });
            }
            
            strategien.push({
                name: 'Steueroptimierung',
                beschreibung: 'Betriebskosten und Abschreibungen maximieren',
                potential: data.abschreibungen * (data.steuersatz / 100),
                empfehlung: 'J√§hrlich mit Steuerberater abstimmen'
            });
            
            return strategien;
        }

        displayCashflowResults(results) {
            const container = document.getElementById('cashflow-results');
            
            let html = `
                <div class="alert alert-success">
                    <h3>üìä Cash-Flow Analyse abgeschlossen</h3>
                    <p><strong>Gesamter Cash-Flow:</strong> ${this.formatCurrency(results.gesamt_cashflow)}</p>
                    <p><strong>Durchschnittlicher j√§hrlicher Cash-Flow:</strong> ${this.formatCurrency(results.durchschnittlicher_cashflow)}</p>
                    ${results.roi > 0 ? `<p><strong>ROI:</strong> ${results.roi.toFixed(1)}%</p>` : ''}
                </div>

                <div class="results-grid">
                    <div class="result-card">
                        <div class="result-header">
                            <h3 class="result-title">üìà Cash-Flow √úbersicht</h3>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Kumulierter Cash-Flow (${results.jahre.length} Jahre):</span>
                            <span class="result-value">${this.formatCurrency(results.kumulierter_cashflow)}</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Verkaufs-Cash-Flow:</span>
                            <span class="result-value">${this.formatCurrency(results.verkaufs_cashflow)}</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Gesamt-Cash-Flow:</span>
                            <span class="result-value">${this.formatCurrency(results.gesamt_cashflow)}</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">√ò J√§hrlicher Cash-Flow:</span>
                            <span class="result-value">${this.formatCurrency(results.durchschnittlicher_cashflow)}</span>
                        </div>
                    </div>
            `;

            // Jahres√ºbersicht
            html += `
                <div class="result-card">
                    <div class="result-header">
                        <h3 class="result-title">üìÖ Jahres√ºbersicht</h3>
                    </div>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; font-size: 0.8rem; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f8f9fa;">
                                    <th style="padding: 0.5rem; border: 1px solid #e9ecef;">Jahr</th>
                                    <th style="padding: 0.5rem; border: 1px solid #e9ecef;">Mieteinnahmen</th>
                                    <th style="padding: 0.5rem; border: 1px solid #e9ecef;">Betriebskosten</th>
                                    <th style="padding: 0.5rem; border: 1px solid #e9ecef;">Cash-Flow</th>
                                    <th style="padding: 0.5rem; border: 1px solid #e9ecef;">Kumuliert</th>
                                </tr>
                            </thead>
                            <tbody>
            `;

            results.jahre.forEach(jahr => {
                html += `
                    <tr>
                        <td style="padding: 0.5rem; border: 1px solid #e9ecef; text-align: center;">${jahr.jahr}</td>
                        <td style="padding: 0.5rem; border: 1px solid #e9ecef; text-align: right;">${this.formatCurrency(jahr.mieteinnahmen)}</td>
                        <td style="padding: 0.5rem; border: 1px solid #e9ecef; text-align: right;">${this.formatCurrency(jahr.betriebskosten)}</td>
                        <td style="padding: 0.5rem; border: 1px solid #e9ecef; text-align: right; color: ${jahr.cashflow_nach_steuern >= 0 ? '#11998e' : '#e74c3c'}">${this.formatCurrency(jahr.cashflow_nach_steuern)}</td>
                        <td style="padding: 0.5rem; border: 1px solid #e9ecef; text-align: right;">${this.formatCurrency(jahr.kumulierter_cashflow)}</td>
                    </tr>
                `;
            });

            html += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            // Strategien
            if (results.strategien.length > 0) {
                html += `
                    <div class="result-card">
                        <div class="result-header">
                            <h3 class="result-title">üí° Optimierungsstrategien</h3>
                        </div>
                `;
                
                results.strategien.forEach(strategie => {
                    html += `
                        <div style="margin-bottom: 1rem; padding: 1rem; background: rgba(17, 153, 142, 0.05); border-radius: 8px;">
                            <strong>${strategie.name}</strong><br>
                            <small>${strategie.beschreibung}</small><br>
                            <span class="text-success">üí∞ Potential: ${this.formatCurrency(strategie.potential)}</span><br>
                            <span class="text-primary">üéØ ${strategie.empfehlung}</span>
                        </div>
                    `;
                });
                
                html += '</div>';
            }

            html += '</div>';
            container.innerHTML = html;
        }

        generateCashflowForecast() {
            this.showToast('üìà Liquidit√§tsprognose wird erstellt...', 'info');
            setTimeout(() => {
                this.showToast('üìà Prognose abgeschlossen - Siehe Cash-Flow Analyse', 'success');
            }, 2000);
        }

        loadCashflowExample() {
            const exampleData = {
                mieteinnahmen: 3500,
                betriebskosten: 800,
                finanzierungskosten: 1200,
                cashflow_abschreibungen: 8000,
                cashflow_steuersatz: 42,
                analysezeitraum: 5,
                mietsteigerung: 2.5,
                verkaufserloes: 650000,
                reinvestition: 'portfolio'
            };

            Object.keys(exampleData).forEach(key => {
                const element = document.getElementById(key);
                if (element) {
                    element.value = exampleData[key];
                }
            });

            this.showToast('üí° Cash-Flow Beispiel geladen', 'success');
            setTimeout(() => this.calculateCashflow(), 500);
        }

        resetCashflowForm() {
            const inputs = ['mieteinnahmen', 'betriebskosten', 'finanzierungskosten', 'cashflow_abschreibungen', 'mietsteigerung', 'verkaufserloes'];
            inputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) element.value = '';
            });
            
            document.getElementById('cashflow-results').innerHTML = '';
            this.showToast('üîÑ Cash-Flow Formular zur√ºckgesetzt', 'info');
        }

        // Grundsteuer Berechnungen
        async calculateGrundsteuer() {
            try {
                this.showProgress('Berechne neue Grundsteuer 2025...', 20);
                
                const data = this.collectGrundsteuerData();
                const results = await this.performGrundsteuerCalculation(data);
                
                this.showProgress('Erstelle Grundsteuer-Ergebnisse...', 80);
                this.displayGrundsteuerResults(results);
                
                setTimeout(() => {
                    this.hideProgress();
                    this.showToast('üèõÔ∏è Grundsteuer erfolgreich berechnet', 'success');
                }, 500);

            } catch (error) {
                this.hideProgress();
                this.showToast('‚ùå Grundsteuer-Berechnung fehlgeschlagen: ' + error.message, 'danger');
            }
        }

        collectGrundsteuerData() {
            return {
                grundstuecksflaeche: parseFloat(document.getElementById('grundstuecksflaeche')?.value) || 0,
                wohnflaeche: parseFloat(document.getElementById('wohnflaeche')?.value) || 0,
                baujahr: parseInt(document.getElementById('baujahr')?.value) || 2000,
                immobilientyp: document.getElementById('grundsteuer_immobilientyp')?.value || 'einfamilienhaus',
                bundesland: document.getElementById('grundsteuer_bundesland')?.value || 'nw',
                hebesatz: parseFloat(document.getElementById('hebesatz_grundsteuer')?.value) || 470
            };
        }

        async performGrundsteuerCalculation(data) {
            // Grundsteuerwerte 2025
            const grundsteuerwerte = {
                'bw': { grund: 0.31, gebaeude: 3.47 },
                'by': { grund: 0.31, gebaeude: 3.47 },
                'be': { grund: 0.31, gebaeude: 3.47 },
                'nw': { grund: 0.31, gebaeude: 3.47 }
            };

            const werte = grundsteuerwerte[data.bundesland] || grundsteuerwerte['nw'];
            
            // Grundsteuerwert berechnen
            const grundwert = data.grundstuecksflaeche * werte.grund;
            const gebaeudewert = data.wohnflaeche * werte.gebaeude;
            const grundsteuerwert = grundwert + gebaeudewert;
            
            // Grundsteuer berechnen
            const grundsteuermessbetrag = grundsteuerwert * 0.31 / 1000; // Messzahl 0,31‚Ä∞
            const grundsteuerJaehrlich = grundsteuermessbetrag * (data.hebesatz / 100);
            const grundsteuerMonatlich = grundsteuerJaehrlich / 12;

            return {
                grundsteuerwert,
                grundsteuermessbetrag,
                grundsteuerJaehrlich,
                grundsteuerMonatlich,
                hebesatz: data.hebesatz,
                vergleich: {
                    altesSystem: grundsteuerJaehrlich * 0.8, // Sch√§tzung alte Grundsteuer
                    differenz: grundsteuerJaehrlich - (grundsteuerJaehrlich * 0.8)
                }
            };
        }

        displayGrundsteuerResults(results) {
            const container = document.getElementById('grundsteuer-results');
            
            const html = `
                <div class="alert alert-success">
                    <h3>üèõÔ∏è Ihre neue Grundsteuer 2025</h3>
                    <p><strong>J√§hrliche Grundsteuer:</strong> ${this.formatCurrency(results.grundsteuerJaehrlich)}</p>
                    <p><strong>Monatliche Belastung:</strong> ${this.formatCurrency(results.grundsteuerMonatlich)}</p>
                </div>

                <div class="results-grid">
                    <div class="result-card">
                        <div class="result-header">
                            <h3 class="result-title">üìä Berechnung im Detail</h3>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Grundsteuerwert:</span>
                            <span class="result-value">${this.formatCurrency(results.grundsteuerwert)}</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Grundsteuermessbetrag:</span>
                            <span class="result-value">${this.formatCurrency(results.grundsteuermessbetrag)}</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Hebesatz:</span>
                            <span class="result-value">${results.hebesatz}%</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Grundsteuer j√§hrlich:</span>
                            <span class="result-value">${this.formatCurrency(results.grundsteuerJaehrlich)}</span>
                        </div>
                    </div>

                    <div class="result-card">
                        <div class="result-header">
                            <h3 class="result-title">üìà Vergleich zum alten System</h3>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Alte Grundsteuer (gesch√§tzt):</span>
                            <span class="result-value">${this.formatCurrency(results.vergleich.altesSystem)}</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Neue Grundsteuer:</span>
                            <span class="result-value">${this.formatCurrency(results.grundsteuerJaehrlich)}</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Differenz:</span>
                            <span class="result-value ${results.vergleich.differenz > 0 ? 'negative' : ''}">${this.formatCurrency(Math.abs(results.vergleich.differenz))} ${results.vergleich.differenz > 0 ? 'mehr' : 'weniger'}</span>
                        </div>
                    </div>
                </div>
            `;

            container.innerHTML = html;
        }

        loadGrundsteuerExample() {
            const exampleData = {
                grundstuecksflaeche: 800,
                wohnflaeche: 150,
                baujahr: 1995,
                grundsteuer_immobilientyp: 'einfamilienhaus',
                grundsteuer_bundesland: 'nw',
                hebesatz_grundsteuer: 470
            };

            Object.keys(exampleData).forEach(key => {
                const element = document.getElementById(key);
                if (element) {
                    element.value = exampleData[key];
                }
            });

            this.showToast('üí° Grundsteuer-Beispiel geladen', 'success');
            setTimeout(() => this.calculateGrundsteuer(), 500);
        }

        resetGrundsteuerForm() {
            const inputs = ['grundstuecksflaeche', 'wohnflaeche', 'baujahr', 'hebesatz_grundsteuer'];
            inputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) element.value = '';
            });
            
            document.getElementById('grundsteuer-results').innerHTML = '';
            this.showToast('üîÑ Grundsteuer-Formular zur√ºckgesetzt', 'info');
        }

        // Erbschaftsteuer Berechnungen
        async calculateErbschaftsteuer() {
            try {
                this.showProgress('Berechne Erbschaftsteuer...', 20);
                
                const data = this.collectErbschaftData();
                const results = await this.performErbschaftCalculation(data);
                
                this.showProgress('Erstelle Erbschaft-Ergebnisse...', 80);
                this.displayErbschaftResults(results);
                
                setTimeout(() => {
                    this.hideProgress();
                    this.showToast('üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Erbschaftsteuer erfolgreich berechnet', 'success');
                }, 500);

            } catch (error) {
                this.hideProgress();
                this.showToast('‚ùå Erbschaftsteuer-Berechnung fehlgeschlagen: ' + error.message, 'danger');
            }
        }

        collectErbschaftData() {
            return {
                immobilienwert: parseFloat(document.getElementById('erbschaft_immobilienwert')?.value) || 0,
                verwandtschaftsgrad: document.getElementById('verwandtschaftsgrad')?.value || 'kind',
                immobilienart: document.getElementById('erbschaft_immobilienart')?.value || 'eigenheim',
                sonstiges_vermoegen: parseFloat(document.getElementById('sonstiges_vermoegen')?.value) || 0,
                selbstnutzung: document.getElementById('selbstnutzung_erbe')?.checked || false,
                lebzeitig: document.getElementById('lebzeitige_uebertragung')?.checked || false
            };
        }

        async performErbschaftCalculation(data) {
            // Freibetr√§ge und Steuerklassen 2025
            const freibetraege = {
                'ehepartner': 500000,
                'kind': 400000,
                'enkel': 200000,
                'eltern': 100000,
                'geschwister': 20000,
                'neffe_nichte': 20000,
                'sonstige': 20000,
                'fremde': 20000
            };

            const steuerklassen = {
                'ehepartner': 1,
                'kind': 1,
                'enkel': 1,
                'eltern': 2,
                'geschwister': 2,
                'neffe_nichte': 2,
                'sonstige': 3,
                'fremde': 3
            };

            const steuersaetze = {
                1: [7, 11, 15, 19, 23, 27, 30], // Steuerklasse I
                2: [15, 20, 25, 30, 35, 40, 43], // Steuerklasse II
                3: [30, 30, 30, 30, 50, 50, 50]  // Steuerklasse III
            };

            const freibetrag = freibetraege[data.verwandtschaftsgrad];
            const steuerklasse = steuerklassen[data.verwandtschaftsgrad];
            
            // Gesamtverm√∂gen
            let gesamtvermoegen = data.immobilienwert + data.sonstiges_vermoegen;
            
            // Bewertungsabschlag f√ºr Immobilien (oft 10% bei Eigennutzung)
            if (data.immobilienart === 'eigenheim' && data.selbstnutzung) {
                gesamtvermoegen = data.immobilienwert * 0.9 + data.sonstiges_vermoegen;
            }

            // Steuerpflichtiger Erwerb
            const steuerpflichtiger_erwerb = Math.max(0, gesamtvermoegen - freibetrag);
            
            // Steuerberechnung
            let erbschaftsteuer = 0;
            if (steuerpflichtiger_erwerb > 0) {
                const saetze = steuersaetze[steuerklasse];
                const stufen = [75000, 300000, 600000, 6000000, 13000000, 26000000];
                
                let restbetrag = steuerpflichtiger_erwerb;
                let stufenIndex = 0;
                
                while (restbetrag > 0 && stufenIndex < stufen.length) {
                    const stufenbetrag = Math.min(restbetrag, stufen[stufenIndex]);
                    erbschaftsteuer += stufenbetrag * (saetze[stufenIndex] / 100);
                    restbetrag -= stufenbetrag;
                    stufenIndex++;
                }
                
                if (restbetrag > 0) {
                    erbschaftsteuer += restbetrag * (saetze[saetze.length - 1] / 100);
                }
            }

            // Strategien
            const strategien = this.getErbschaftStrategien(data, freibetrag);

            return {
                gesamtvermoegen,
                freibetrag,
                steuerpflichtiger_erwerb,
                erbschaftsteuer,
                steuerklasse,
                effektiver_steuersatz: gesamtvermoegen > 0 ? (erbschaftsteuer / gesamtvermoegen * 100) : 0,
                strategien
            };
        }

        getErbschaftStrategien(data, freibetrag) {
            const strategien = [];

            if (data.lebzeitig) {
                strategien.push({
                    name: 'Schenkung zu Lebzeiten',
                    beschreibung: 'Freibetr√§ge alle 10 Jahre nutzen',
                    ersparnis: Math.min(data.immobilienwert, freibetrag) * 0.15,
                    empfehlung: 'Sehr empfehlenswert'
                });
            }

            if (data.selbstnutzung && data.verwandtschaftsgrad === 'ehepartner') {
                strategien.push({
                    name: 'Familienheim-Befreiung',
                    beschreibung: 'Vollst√§ndige Steuerbefreiung bei Selbstnutzung',
                    ersparnis: data.immobilienwert * 0.2,
                    empfehlung: 'Optimal'
                });
            }

            strategien.push({
                name: 'Nie√übrauch-Struktur',
                beschreibung: '√úbertragung mit lebenslangem Wohnrecht',
                ersparnis: data.immobilienwert * 0.25,
                empfehlung: 'Pr√ºfenswert'
            });

            return strategien;
        }

        displayErbschaftResults(results) {
            const container = document.getElementById('erbschaft-results');
            
            let html = `
                <div class="alert ${results.erbschaftsteuer === 0 ? 'alert-success' : 'alert-info'}">
                    <h3>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Ihre Erbschaftsteuer-Berechnung</h3>
                    <p><strong>Erbschaftsteuer:</strong> ${this.formatCurrency(results.erbschaftsteuer)}</p>
                    <p><strong>Effektiver Steuersatz:</strong> ${results.effektiver_steuersatz.toFixed(1)}%</p>
                </div>

                <div class="results-grid">
                    <div class="result-card">
                        <div class="result-header">
                            <h3 class="result-title">üìä Berechnung im Detail</h3>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Gesamtverm√∂gen:</span>
                            <span class="result-value">${this.formatCurrency(results.gesamtvermoegen)}</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Freibetrag:</span>
                            <span class="result-value">${this.formatCurrency(results.freibetrag)}</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Steuerpflichtiger Erwerb:</span>
                            <span class="result-value">${this.formatCurrency(results.steuerpflichtiger_erwerb)}</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Steuerklasse:</span>
                            <span class="result-value">${results.steuerklasse}</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Erbschaftsteuer:</span>
                            <span class="result-value">${this.formatCurrency(results.erbschaftsteuer)}</span>
                        </div>
                    </div>
            `;

            if (results.strategien.length > 0) {
                html += `
                    <div class="result-card">
                        <div class="result-header">
                            <h3 class="result-title">üí° Optimierungsstrategien</h3>
                        </div>
                `;
                
                results.strategien.forEach(strategie => {
                    html += `
                        <div style="margin-bottom: 1rem; padding: 1rem; background: rgba(17, 153, 142, 0.05); border-radius: 8px;">
                            <strong>${strategie.name}</strong><br>
                            <small>${strategie.beschreibung}</small><br>
                            <span class="text-success">üí∞ Potential: ${this.formatCurrency(strategie.ersparnis)}</span><br>
                            <span class="text-primary">üéØ ${strategie.empfehlung}</span>
                        </div>
                    `;
                });
                
                html += '</div>';
            }

            html += '</div>';
            container.innerHTML = html;
        }

        loadErbschaftExample() {
            const exampleData = {
                erbschaft_immobilienwert: 600000,
                verwandtschaftsgrad: 'kind',
                erbschaft_immobilienart: 'eigenheim',
                sonstiges_vermoegen: 100000,
                selbstnutzung_erbe: true,
                lebzeitige_uebertragung: false
            };

            Object.keys(exampleData).forEach(key => {
                const element = document.getElementById(key);
                if (element) {
                    if (element.type === 'checkbox') {
                        element.checked = exampleData[key];
                    } else {
                        element.value = exampleData[key];
                    }
                }
            });

            this.showToast('üí° Erbschaftsteuer-Beispiel geladen', 'success');
            setTimeout(() => this.calculateErbschaftsteuer(), 500);
        }

        resetErbschaftForm() {
            const inputs = ['erbschaft_immobilienwert', 'sonstiges_vermoegen'];
            inputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) element.value = '';
            });
            
            const checkboxes = ['selbstnutzung_erbe', 'lebzeitige_uebertragung'];
            checkboxes.forEach(id => {
                const element = document.getElementById(id);
                if (element) element.checked = false;
            });
            
            document.getElementById('erbschaft-results').innerHTML = '';
            this.showToast('üîÑ Erbschaftsteuer-Formular zur√ºckgesetzt', 'info');
        }

        // Schenkungssteuer Berechnungen
        async calculateSchenkungssteuer() {
            try {
                this.showProgress('Berechne Schenkungssteuer...', 20);
                
                const data = this.collectSchenkungData();
                const results = await this.performSchenkungCalculation(data);
                
                this.showProgress('Erstelle Schenkung-Ergebnisse...', 80);
                this.displaySchenkungResults(results);
                
                setTimeout(() => {
                    this.hideProgress();
                    this.showToast('üéÅ Schenkungssteuer erfolgreich berechnet', 'success');
                }, 500);

            } catch (error) {
                this.hideProgress();
                this.showToast('‚ùå Schenkungssteuer-Berechnung fehlgeschlagen: ' + error.message, 'danger');
            }
        }

        collectSchenkungData() {
            return {
                immobilienwert: parseFloat(document.getElementById('schenkung_immobilienwert')?.value) || 0,
                beschenkter: document.getElementById('beschenkter')?.value || 'kind',
                vorherige_schenkungen: parseFloat(document.getElementById('vorherige_schenkungen')?.value) || 0,
                schenkungsart: document.getElementById('schenkungsart')?.value || 'vollschenkung',
                anteil: parseFloat(document.getElementById('schenkungsanteil')?.value) || 100,
                niesbrauchswert: parseFloat(document.getElementById('niesbrauchswert')?.value) || 0,
                alter_schenker: parseInt(document.getElementById('alter_schenker')?.value) || 65,
                strategie: document.getElementById('schenkungsstrategie')?.value || 'einmalig'
            };
        }

        async performSchenkungCalculation(data) {
            // Gleiche Freibetr√§ge wie Erbschaftsteuer
            const freibetraege = {
                'ehepartner': 500000,
                'kind': 400000,
                'enkel': 200000,
                'urenkel': 100000,
                'eltern': 20000,
                'geschwister': 20000,
                'neffe_nichte': 20000,
                'sonstige': 20000,
                'fremde': 20000
            };

            const freibetrag = freibetraege[data.beschenkter];
            
            // Schenkungswert berechnen
            let schenkungswert = data.immobilienwert;
            
            if (data.schenkungsart === 'teilschenkung') {
                schenkungswert = data.immobilienwert * (data.anteil / 100);
            } else if (data.schenkungsart === 'niesbrauch') {
                // Nie√übrauchsabschlag basierend auf Alter und Jahreswert
                const restlebenserwartung = Math.max(0, 85 - data.alter_schenker);
                const niesbrauchswert = data.niesbrauchswert * restlebenserwartung * 0.7; // Kapitalisierungsfaktor
                schenkungswert = data.immobilienwert - niesbrauchswert;
            }

            // Steuerpflichtiger Erwerb (inkl. Vorschenkungen)
            const gesamterwerb = schenkungswert + data.vorherige_schenkungen;
            const steuerpflichtiger_erwerb = Math.max(0, gesamterwerb - freibetrag);
            
            // Schenkungssteuer berechnen (gleiche S√§tze wie Erbschaftsteuer)
            let schenkungssteuer = steuerpflichtiger_erwerb * 0.15; // Vereinfacht

            // Strategien
            const strategien = this.getSchenkungsStrategien(data, freibetrag);

            return {
                schenkungswert,
                gesamterwerb,
                freibetrag,
                steuerpflichtiger_erwerb,
                schenkungssteuer,
                effektiver_steuersatz: schenkungswert > 0 ? (schenkungssteuer / schenkungswert * 100) : 0,
                strategien
            };
        }

        getSchenkungsStrategien(data, freibetrag) {
            const strategien = [];

            if (data.strategie === 'zehn_jahre') {
                strategien.push({
                    name: '10-Jahres-Strategie',
                    beschreibung: 'Freibetr√§ge alle 10 Jahre optimal nutzen',
                    ersparnis: freibetrag * 0.15,
                    empfehlung: 'Sehr empfehlenswert'
                });
            }

            if (data.schenkungsart === 'niesbrauch') {
                strategien.push({
                    name: 'Nie√übrauch-Optimierung',
                    beschreibung: 'Schenkung unter Vorbehalt des Nie√übrauchs',
                    ersparnis: data.niesbrauchswert * 10 * 0.05,
                    empfehlung: 'F√ºr Einkommensimmobilien optimal'
                });
            }

            strategien.push({
                name: 'Gestaffelte Schenkung',
                beschreibung: 'Aufteilen auf mehrere Jahre/Personen',
                ersparnis: data.immobilienwert * 0.1,
                empfehlung: 'Bei gro√üen Verm√∂gen sinnvoll'
            });

            return strategien;
        }

        displaySchenkungResults(results) {
            const container = document.getElementById('schenkung-results');
            
            let html = `
                <div class="alert ${results.schenkungssteuer === 0 ? 'alert-success' : 'alert-info'}">
                    <h3>üéÅ Ihre Schenkungssteuer-Berechnung</h3>
                    <p><strong>Schenkungssteuer:</strong> ${this.formatCurrency(results.schenkungssteuer)}</p>
                    <p><strong>Effektiver Steuersatz:</strong> ${results.effektiver_steuersatz.toFixed(1)}%</p>
                </div>

                <div class="results-grid">
                    <div class="result-card">
                        <div class="result-header">
                            <h3 class="result-title">üìä Berechnung im Detail</h3>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Schenkungswert:</span>
                            <span class="result-value">${this.formatCurrency(results.schenkungswert)}</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Gesamterwerb (inkl. Vorschenkungen):</span>
                            <span class="result-value">${this.formatCurrency(results.gesamterwerb)}</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Freibetrag:</span>
                            <span class="result-value">${this.formatCurrency(results.freibetrag)}</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Steuerpflichtiger Erwerb:</span>
                            <span class="result-value">${this.formatCurrency(results.steuerpflichtiger_erwerb)}</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Schenkungssteuer:</span>
                            <span class="result-value">${this.formatCurrency(results.schenkungssteuer)}</span>
                        </div>
                    </div>
            `;

            if (results.strategien.length > 0) {
                html += `
                    <div class="result-card">
                        <div class="result-header">
                            <h3 class="result-title">üí° Optimierungsstrategien</h3>
                        </div>
                `;
                
                results.strategien.forEach(strategie => {
                    html += `
                        <div style="margin-bottom: 1rem; padding: 1rem; background: rgba(17, 153, 142, 0.05); border-radius: 8px;">
                            <strong>${strategie.name}</strong><br>
                            <small>${strategie.beschreibung}</small><br>
                            <span class="text-success">üí∞ Potential: ${this.formatCurrency(strategie.ersparnis)}</span><br>
                            <span class="text-primary">üéØ ${strategie.empfehlung}</span>
                        </div>
                    `;
                });
                
                html += '</div>';
            }

            html += '</div>';
            container.innerHTML = html;
        }

        loadSchenkungExample() {
            const exampleData = {
                schenkung_immobilienwert: 800000,
                beschenkter: 'kind',
                vorherige_schenkungen: 50000,
                schenkungsart: 'niesbrauch',
                schenkungsanteil: 100,
                niesbrauchswert: 24000,
                alter_schenker: 65,
                schenkungsstrategie: 'zehn_jahre'
            };

            Object.keys(exampleData).forEach(key => {
                const element = document.getElementById(key);
                if (element) {
                    element.value = exampleData[key];
                }
            });

            this.showToast('üí° Schenkungssteuer-Beispiel geladen', 'success');
            setTimeout(() => this.calculateSchenkungssteuer(), 500);
        }

        resetSchenkungForm() {
            const inputs = ['schenkung_immobilienwert', 'vorherige_schenkungen', 'schenkungsanteil', 'niesbrauchswert', 'alter_schenker'];
            inputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) element.value = '';
            });
            
            document.getElementById('schenkung-results').innerHTML = '';
            this.showToast('üîÑ Schenkungssteuer-Formular zur√ºckgesetzt', 'info');
        }

        // KI-Strategien
        async generateKIStrategy() {
            try {
                this.showProgress('KI analysiert Ihr Portfolio...', 20);
                
                const data = this.collectStrategyData();
                const results = await this.performKIStrategyGeneration(data);
                
                this.showProgress('Erstelle KI-Strategieempfehlungen...', 80);
                this.displayStrategyResults(results);
                
                setTimeout(() => {
                    this.hideProgress();
                    this.showToast('ü§ñ KI-Strategie erfolgreich generiert', 'success');
                }, 500);

            } catch (error) {
                this.hideProgress();
                this.showToast('‚ùå KI-Strategiegenerierung fehlgeschlagen: ' + error.message, 'danger');
            }
        }

        collectStrategyData() {
            return {
                portfolio_anzahl: parseInt(document.getElementById('portfolio_anzahl')?.value) || 1,
                portfolio_wert: parseFloat(document.getElementById('portfolio_wert')?.value) || 0,
                strategisches_ziel: document.getElementById('strategisches_ziel')?.value || 'steuerminimierung',
                planungshorizont: document.getElementById('planungshorizont')?.value || 'mittelfristig',
                familiensituation: document.getElementById('familiensituation')?.value || 'ehepaar',
                jahreseinkommen: document.getElementById('jahreseinkommen')?.value || 'mittel',
                international: document.getElementById('international')?.checked || false,
                risikobereitschaft: document.getElementById('risikobereitschaft')?.value || 'moderat'
            };
        }

        async performKIStrategyGeneration(data) {
            // KI-basierte Strategieanalyse
            const strategien = [];
            const prioritaeten = [];

            // Basierend auf Portfolio-Gr√∂√üe
            if (data.portfolio_wert > 2000000) {
                strategien.push({
                    name: 'Family Office Struktur',
                    beschreibung: 'Professionelle Verm√∂gensverwaltung mit Steuerfamilienstiftung',
                    prioritaet: 'Hoch',
                    ersparnis: data.portfolio_wert * 0.15,
                    zeitrahmen: '2-3 Jahre',
                    komplexitaet: 'Hoch'
                });
            }

            if (data.strategisches_ziel === 'nachfolgeplanung') {
                strategien.push({
                    name: 'Generationen-√ºbergreifende Planung',
                    beschreibung: 'Stufenweise √úbertragung mit Nie√übrauchsvorbehalten',
                    prioritaet: 'Sehr Hoch',
                    ersparnis: data.portfolio_wert * 0.25,
                    zeitrahmen: '5-10 Jahre',
                    komplexitaet: 'Mittel'
                });
            }

            if (data.international) {
                strategien.push({
                    name: 'Cross-Border Optimierung',
                    beschreibung: 'Internationale Holdingstrukturen f√ºr Steueroptimierung',
                    prioritaet: 'Hoch',
                    ersparnis: data.portfolio_wert * 0.18,
                    zeitrahmen: '1-2 Jahre',
                    komplexitaet: 'Sehr Hoch'
                });
            }

            strategien.push({
                name: 'Portfolio-Diversifikation',
                beschreibung: 'Optimierung der Rechtsformen je Immobilie',
                prioritaet: 'Mittel',
                ersparnis: data.portfolio_wert * 0.08,
                zeitrahmen: '6-12 Monate',
                komplexitaet: 'Niedrig'
            });

            // KI-Empfehlungen basierend auf Zielen
            const empfehlungen = this.generateKIRecommendations(data, strategien);

            return {
                strategien,
                empfehlungen,
                portfolio_analyse: {
                    risiko_score: this.calculateRiskScore(data),
                    optimierungspotential: data.portfolio_wert * 0.12,
                    steuerbelastung_aktuell: data.portfolio_wert * 0.28
                }
            };
        }

        generateKIRecommendations(data, strategien) {
            const empfehlungen = [];

            empfehlungen.push({
                kategorie: 'Sofortma√ünahmen',
                items: [
                    'Portfolio-Analyse aller Immobilien durchf√ºhren',
                    'Verkaufsstrategien f√ºr 10+ Jahre gehaltene Immobilien pr√ºfen',
                    'Familienpool-Strukturen f√ºr neue Akquisitionen'
                ]
            });

            empfehlungen.push({
                kategorie: 'Mittelfristige Optimierung',
                items: [
                    'Schrittweise √úbertragung auf nachfolgende Generation',
                    'Nie√übrauch-Strukturen f√ºr laufende Eink√ºnfte',
                    'Cross-Border Strukturen f√ºr internationale Diversifikation'
                ]
            });

            if (data.planungshorizont === 'generational') {
                empfehlungen.push({
                    kategorie: 'Langfrist-Strategie',
                    items: [
                        'Familienstiftung f√ºr Generationenverm√∂gen',
                        'Sukzessionsplanung mit steueroptimalen Zeitpunkten',
                        'Internationale Strukturen f√ºr globale Diversifikation'
                    ]
                });
            }

            return empfehlungen;
        }

        calculateRiskScore(data) {
            let score = 50; // Basis

            if (data.risikobereitschaft === 'konservativ') score -= 20;
            if (data.risikobereitschaft === 'aggressiv') score += 30;
            if (data.international) score += 15;
            if (data.portfolio_wert > 5000000) score += 10;

            return Math.max(0, Math.min(100, score));
        }

        displayStrategyResults(results) {
            const container = document.getElementById('strategy-results');
            
            let html = `
                <div class="alert alert-success">
                    <h3>ü§ñ KI-Strategieanalyse abgeschlossen</h3>
                    <p><strong>Optimierungspotential:</strong> ${this.formatCurrency(results.portfolio_analyse.optimierungspotential)}</p>
                    <p><strong>Risiko-Score:</strong> ${results.portfolio_analyse.risiko_score}/100</p>
                </div>

                <div class="results-grid">
            `;

            // Strategien anzeigen
            results.strategien.forEach(strategie => {
                const priorityClass = strategie.prioritaet === 'Sehr Hoch' ? 'best' : 
                                    strategie.prioritaet === 'Hoch' ? 'warning-option' : '';
                
                html += `
                    <div class="result-card ${priorityClass}">
                        <div class="result-header">
                            <h3 class="result-title">${strategie.name}</h3>
                            <span class="result-badge">${strategie.prioritaet}</span>
                        </div>
                        <p style="margin-bottom: 1rem;">${strategie.beschreibung}</p>
                        <div class="result-item">
                            <span class="result-label">Ersparnis-Potential:</span>
                            <span class="result-value">${this.formatCurrency(strategie.ersparnis)}</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Zeitrahmen:</span>
                            <span class="result-value">${strategie.zeitrahmen}</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Komplexit√§t:</span>
                            <span class="result-value">${strategie.komplexitaet}</span>
                        </div>
                    </div>
                `;
            });

            html += '</div>';

            // Empfehlungen
            html += `
                <div class="card mt-4">
                    <div class="card-header">
                        <h3 class="card-title">üí° KI-Empfehlungen</h3>
                    </div>
            `;

            results.empfehlungen.forEach(empfehlung => {
                html += `
                    <div style="margin-bottom: 2rem;">
                        <h4 style="color: var(--primary-solid); margin-bottom: 1rem;">${empfehlung.kategorie}</h4>
                        <ul style="margin-left: 1.5rem;">
                            ${empfehlung.items.map(item => `<li style="margin-bottom: 0.5rem;">${item}</li>`).join('')}
                        </ul>
                    </div>
                `;
            });

            html += '</div>';

            container.innerHTML = html;
        }

        async analyzePortfolio() {
            this.showToast('üìä Portfolio-Analyse wird durchgef√ºhrt...', 'info');
            // Hier w√ºrde eine detaillierte Portfolio-Analyse implementiert
            setTimeout(() => {
                this.showToast('üìä Portfolio-Analyse abgeschlossen - Siehe Strategieempfehlungen', 'success');
            }, 2000);
        }

        loadStrategyExample() {
            const exampleData = {
                portfolio_anzahl: 4,
                portfolio_wert: 3200000,
                strategisches_ziel: 'nachfolgeplanung',
                planungshorizont: 'langfristig',
                familiensituation: 'familie_kinder',
                jahreseinkommen: 'sehr_hoch',
                international: true,
                risikobereitschaft: 'moderat'
            };

            Object.keys(exampleData).forEach(key => {
                const element = document.getElementById(key);
                if (element) {
                    if (element.type === 'checkbox') {
                        element.checked = exampleData[key];
                    } else {
                        element.value = exampleData[key];
                    }
                }
            });

            this.showToast('üí° Strategie-Beispiel geladen', 'success');
            setTimeout(() => this.generateKIStrategy(), 500);
        }

        resetStrategyForm() {
            const inputs = ['portfolio_anzahl', 'portfolio_wert'];
            inputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) element.value = '';
            });
            
            const checkbox = document.getElementById('international');
            if (checkbox) checkbox.checked = false;
            
            document.getElementById('strategy-results').innerHTML = '';
            this.showToast('üîÑ Strategie-Formular zur√ºckgesetzt', 'info');
        }

        // Debounced calculation for real-time updates
        get debouncedCalculate() {
            if (!this._debouncedCalculate) {
                this._debouncedCalculate = this.debounce(() => {
                    if (this.realtimeEnabled) {
                        this.calculateOptimal();
                    }
                }, 500);
            }
            return this._debouncedCalculate;
        }

        // Initialize Analytics
        initializeAnalytics() {
            // Setup Chart.js for analytics
            if (typeof Chart !== 'undefined') {
                Chart.defaults.font.family = "'Segoe UI', system-ui, -apple-system, sans-serif";
                Chart.defaults.color = '#6c757d';
            }

            // Performance monitoring
            setInterval(() => {
                this.updateSessionMetrics();
            }, 5000);
        }

        updateSessionMetrics() {
            const uptime = Date.now() - this.analytics.startTime;
            const uptimeMinutes = Math.floor(uptime / 60000);
            
            // Update session info if elements exist
            const sessionInfo = document.querySelector('.analytics-widget:last-child div:last-child');
            if (sessionInfo) {
                sessionInfo.innerHTML = `
                    <div>Berechnungen: <span id="calc-count">${this.analytics.calculations}</span></div>
                    <div>Cache Hits: <span id="cache-hits">${this.analytics.cacheHits}</span></div>
                    <div>Fehlerrate: <span id="error-rate">${this.analytics.calculations > 0 ? (this.analytics.errors / this.analytics.calculations * 100).toFixed(1) : 0}%</span></div>
                    <div>Laufzeit: ${uptimeMinutes}min</div>
                `;
            }
        }

        // Utility Methods
        collectFormData() {
            const data = {};
            const inputs = document.querySelectorAll('.form-input, .form-select');
            
            inputs.forEach(input => {
                if (input.type === 'number') {
                    data[input.id] = parseFloat(input.value) || 0;
                } else if (input.type === 'checkbox') {
                    data[input.id] = input.checked;
                } else {
                    data[input.id] = input.value || '';
                }
            });

            return data;
        }

        populateForm(data) {
            Object.keys(data).forEach(key => {
                const element = document.getElementById(key);
                if (element) {
                    if (element.type === 'checkbox') {
                        element.checked = data[key];
                    } else {
                        element.value = data[key];
                    }
                    
                    // Trigger validation
                    this.validateField(element);
                }
            });
        }

        loadExample() {
            const exampleData = {
                kaufpreis: 400000,
                verkaufspreis: 600000,
                nebenkosten_kauf: 40000,
                nebenkosten_verkauf: 30000,
                modernisierung: 35000,
                haltedauer: 8,
                steuersatz: 42,
                kirchensteuer: 8,
                bundesland: 'by',
                werbungskosten: 5000,
                immobilientyp: 'eigenheim'
            };

            this.populateForm(exampleData);
            this.saveToHistory();
            this.showToast('üí° Beispieldaten geladen', 'success');
            
            // Auto-calculate if realtime is enabled
            if (this.realtimeEnabled) {
                setTimeout(() => this.calculateOptimal(), 500);
            }
        }

        resetForm() {
            const inputs = document.querySelectorAll('.form-input, .form-select');
            inputs.forEach(input => {
                if (input.type === 'number') {
                    input.value = '';
                } else if (input.type === 'checkbox') {
                    input.checked = false;
                } else if (input.tagName === 'SELECT') {
                    input.selectedIndex = 0;
                }
                
                input.classList.remove('valid', 'invalid');
                this.updateValidationIndicator(input, true);
            });

            // Clear results
            document.getElementById('results-container').innerHTML = '';
            
            // Clear analytics
            this.updateAnalytics({ structures: [] }, 0);
            
            this.saveToHistory();
            this.showToast('üîÑ Formular zur√ºckgesetzt', 'info');
        }

        resetAll() {
            this.resetForm();
            this.cache.clear();
            this.history = [];
            this.historyIndex = -1;
            this.updateHistoryButtons();
            this.analytics = {
                calculations: 0,
                cacheHits: 0,
                errors: 0,
                startTime: Date.now()
            };
            this.updateSessionMetrics();
            this.showToast('üîÑ Alles zur√ºckgesetzt', 'info');
        }

        toggleRealtime() {
            const checkbox = document.getElementById('realtime-calc');
            this.realtimeEnabled = checkbox.checked;
            
            const status = this.realtimeEnabled ? 'aktiviert' : 'deaktiviert';
            this.showToast(`ü§ñ Real-time Berechnung ${status}`, 'info');
        }

        navigateToSection(section) {
            // Update active navigation
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            document.querySelector(`[data-section="${section}"]`).classList.add('active');
            
            // Load section content
            this.loadSectionContent(section);
            
            this.showToast(`üìç Navigation zu ${section}`, 'info');
        }

        loadSectionContent(section) {
            const contentArea = document.querySelector('.content-area');
            
            switch(section) {
                case 'verkauf':
                    contentArea.innerHTML = this.generateVerkaufContent();
                    this.setupRealtimeValidation();
                    break;
                case 'grundsteuer':
                    contentArea.innerHTML = this.generateGrundsteuerContent();
                    this.setupGrundsteuerEventHandlers();
                    break;
                case 'erbschaft':
                    contentArea.innerHTML = this.generateErbschaftContent();
                    this.setupErbschaftEventHandlers();
                    break;
                case 'schenkung':
                    contentArea.innerHTML = this.generateSchenkungContent();
                    this.setupSchenkungEventHandlers();
                    break;
                case 'cashflow':
                    contentArea.innerHTML = this.generateCashflowContent();
                    this.setupCashflowEventHandlers();
                    break;
                case 'strategie':
                    contentArea.innerHTML = this.generateStrategieContent();
                    this.setupStrategieEventHandlers();
                    break;
                default:
                    contentArea.innerHTML = this.generateVerkaufContent();
                    this.setupRealtimeValidation();
            }
        }

        generateVerkaufContent() {
            return `
                <!-- Multi-Scenario Tabs -->
                <div class="scenario-tabs">
                    <button class="scenario-tab active" data-scenario="scenario1" onclick="app.switchScenario('scenario1')">
                        Szenario 1
                    </button>
                    <button class="scenario-tab" data-scenario="scenario2" onclick="app.switchScenario('scenario2')">
                        Szenario 2
                    </button>
                    <button class="scenario-tab" data-scenario="scenario3" onclick="app.switchScenario('scenario3')">
                        Szenario 3
                    </button>
                    <button class="btn btn-outline" onclick="app.addScenario()" style="margin-left: auto; padding: 0.5rem 1rem; font-size: 0.9rem;">
                        ‚ûï Szenario hinzuf√ºgen
                    </button>
                </div>

                <!-- Main Form Card -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <span>üí∞</span>
                            <span>KI-Optimierte Verkaufssteuer-Berechnung 2025</span>
                        </div>
                    </div>

                    <!-- Real-time Calculation Toggle -->
                    <div class="alert alert-info">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span>ü§ñ Real-time KI-Berechnung aktiviert - Optimale Strukturen werden automatisch berechnet</span>
                            <label style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="checkbox" id="realtime-calc" checked onchange="app.toggleRealtime()">
                                <span>Real-time</span>
                            </label>
                        </div>
                    </div>

                    <div class="scenario-content active" id="scenario1-content">
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">
                                    üè† Kaufpreis <span class="required">*</span>
                                </label>
                                <div class="input-group">
                                    <input type="number" id="kaufpreis" class="form-input" placeholder="z.B. 400.000" min="0" step="1000" data-shortcut="k">
                                    <div class="validation-indicator" id="kaufpreis-indicator"></div>
                                </div>
                                <div class="form-help">Urspr√ºnglicher Kaufpreis der Immobilie</div>
                                <div class="form-error" id="kaufpreis-error"></div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">
                                    üíµ Verkaufspreis <span class="required">*</span>
                                </label>
                                <div class="input-group">
                                    <input type="number" id="verkaufspreis" class="form-input" placeholder="z.B. 600.000" min="0" step="1000" data-shortcut="v">
                                    <div class="validation-indicator" id="verkaufspreis-indicator"></div>
                                </div>
                                <div class="form-help">Aktueller Verkaufspreis</div>
                                <div class="form-error" id="verkaufspreis-error"></div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">
                                    üìã Nebenkosten Kauf
                                </label>
                                <div class="input-group">
                                    <input type="number" id="nebenkosten_kauf" class="form-input" placeholder="z.B. 40.000" min="0" step="1000">
                                    <div class="validation-indicator" id="nebenkosten_kauf-indicator"></div>
                                </div>
                                <div class="form-help">Notar, Grunderwerbsteuer, Makler beim Kauf</div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">
                                    ü§ù Nebenkosten Verkauf
                                </label>
                                <div class="input-group">
                                    <input type="number" id="nebenkosten_verkauf" class="form-input" placeholder="z.B. 30.000" min="0" step="1000">
                                    <div class="validation-indicator" id="nebenkosten_verkauf-indicator"></div>
                                </div>
                                <div class="form-help">Makler, Notar, Inserate beim Verkauf</div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">
                                    üî® Modernisierung/Renovierung
                                </label>
                                <div class="input-group">
                                    <input type="number" id="modernisierung" class="form-input" placeholder="z.B. 35.000" min="0" step="1000">
                                    <div class="validation-indicator" id="modernisierung-indicator"></div>
                                </div>
                                <div class="form-help">Steuerlich absetzbare Investitionen</div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">
                                    ‚è±Ô∏è Haltedauer (Jahre) <span class="required">*</span>
                                </label>
                                <div class="input-group">
                                    <input type="number" id="haltedauer" class="form-input" placeholder="z.B. 8" min="0" max="50" step="0.1" data-shortcut="h">
                                    <div class="validation-indicator" id="haltedauer-indicator"></div>
                                </div>
                                <div class="form-help">Zeit zwischen Kauf und Verkauf</div>
                                <div class="form-error" id="haltedauer-error"></div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">
                                    üíº Pers√∂nlicher Steuersatz (%)
                                </label>
                                <select id="steuersatz" class="form-select">
                                    <option value="14">14% (Eingangssteuersatz)</option>
                                    <option value="24">24% (Mittlerer Bereich)</option>
                                    <option value="32">32% (H√∂herer Bereich)</option>
                                    <option value="42" selected>42% (Spitzensteuersatz)</option>
                                    <option value="45">45% (Reichensteuer)</option>
                                </select>
                                <div class="form-help">Ihr aktueller Einkommensteuersatz</div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">
                                    ‚õ™ Kirchensteuer (%)
                                </label>
                                <select id="kirchensteuer" class="form-select">
                                    <option value="0">0% (Konfessionslos)</option>
                                    <option value="8" selected>8% (Bayern, BW)</option>
                                    <option value="9">9% (Andere Bundesl√§nder)</option>
                                </select>
                                <div class="form-help">Kirchensteuer je nach Bundesland</div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">
                                    üó∫Ô∏è Bundesland
                                </label>
                                <select id="bundesland" class="form-select">
                                    <option value="bw">Baden-W√ºrttemberg</option>
                                    <option value="by">Bayern</option>
                                    <option value="be">Berlin</option>
                                    <option value="bb">Brandenburg</option>
                                    <option value="hb">Bremen</option>
                                    <option value="hh">Hamburg</option>
                                    <option value="he">Hessen</option>
                                    <option value="mv">Mecklenburg-Vorpommern</option>
                                    <option value="ni">Niedersachsen</option>
                                    <option value="nw" selected>Nordrhein-Westfalen</option>
                                    <option value="rp">Rheinland-Pfalz</option>
                                    <option value="sl">Saarland</option>
                                    <option value="sn">Sachsen</option>
                                    <option value="st">Sachsen-Anhalt</option>
                                    <option value="sh">Schleswig-Holstein</option>
                                    <option value="th">Th√ºringen</option>
                                </select>
                                <div class="form-help">F√ºr bundeslandspezifische Steuerberechnung</div>
                            </div>
                        </div>

                        <!-- Progressive Disclosure for Advanced Options -->
                        <div class="advanced-options">
                            <button class="disclosure-toggle" onclick="app.toggleAdvanced()">
                                <span class="disclosure-arrow">‚ñ∂</span>
                                Erweiterte Optionen
                            </button>
                            <div class="disclosure-content" id="advanced-content">
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label class="form-label">
                                            üí∞ Zus√§tzliche Werbungskosten
                                        </label>
                                        <input type="number" id="werbungskosten" class="form-input" placeholder="z.B. 5.000" min="0" step="100">
                                        <div class="form-help">Weitere steuerlich absetzbare Kosten</div>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">
                                            üìä Abschreibungen (AfA)
                                        </label>
                                        <input type="number" id="abschreibungen" class="form-input" placeholder="z.B. 12.000" min="0" step="100">
                                        <div class="form-help">J√§hrliche Abschreibungen bei Vermietung</div>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">
                                            üèóÔ∏è Immobilientyp
                                        </label>
                                        <select id="immobilientyp" class="form-select">
                                            <option value="eigenheim">Eigenheim/Privatnutzung</option>
                                            <option value="vermietung">Vermietungsimmobilie</option>
                                            <option value="gewerbe">Gewerbeimmobilie</option>
                                            <option value="mischnutzung">Mischnutzung</option>
                                        </select>
                                        <div class="form-help">Art der Immobiliennutzung</div>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">
                                            üí± Inflationsbereinigung
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                                            <input type="checkbox" id="inflation-adjustment">
                                            <span>Kaufpreis inflationsbereinigt berechnen</span>
                                        </label>
                                        <div class="form-help">Automatische Anpassung an Inflation seit Kauf</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="btn-group">
                            <button class="btn btn-primary" onclick="app.calculateOptimal()" title="Optimale Berechnung starten (Ctrl+Enter)">
                                üßÆ KI-Optimierung starten
                            </button>
                            <button class="btn btn-success" onclick="app.loadExample()" title="Beispieldaten laden (Ctrl+E)">
                                üí° Beispiel laden
                            </button>
                            <button class="btn btn-warning" onclick="app.exportPDFReport()" title="PDF-Bericht erstellen (Ctrl+P)">
                                üìä PDF-Report
                            </button>
                            <button class="btn btn-secondary" onclick="app.resetForm()" title="Formular zur√ºcksetzen (Ctrl+R)">
                                üîÑ Zur√ºcksetzen
                            </button>
                        </div>
                    </div>

                    <!-- Additional Scenario Contents (placeholders) -->
                    <div class="scenario-content" id="scenario2-content">
                        <div class="alert alert-info">
                            <h3>üìä Szenario 2</h3>
                            <p>Vergleichsszenario f√ºr What-If-Analysen. Kopieren Sie Werte aus Szenario 1 und modifizieren Sie einzelne Parameter.</p>
                        </div>
                        <!-- Form would be duplicated here -->
                    </div>

                    <div class="scenario-content" id="scenario3-content">
                        <div class="alert alert-info">
                            <h3>üéØ Szenario 3</h3>
                            <p>Drittes Szenario f√ºr umfassende Vergleichsanalysen.</p>
                        </div>
                        <!-- Form would be duplicated here -->
                    </div>
                </div>

                <!-- Results Container -->
                <div class="results-container" id="results-container">
                    <!-- Results will be dynamically inserted here -->
                </div>
            `;
        }

        generateGrundsteuerContent() {
            return `
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <span>üèõÔ∏è</span>
                            <span>Grundsteuer-Reform 2025</span>
                        </div>
                    </div>

                    <div class="alert alert-info">
                        <h3>üìã Neue Grundsteuer-Berechnung ab 2025</h3>
                        <p>Die Grundsteuer-Reform ist in Kraft! Berechnen Sie Ihre neue Grundsteuerbelastung mit den aktuellen Bewertungsverfahren.</p>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">
                                üè† Grundst√ºcksfl√§che (m¬≤) <span class="required">*</span>
                            </label>
                            <input type="number" id="grundstuecksflaeche" class="form-input" placeholder="z.B. 800" min="0" step="1">
                            <div class="form-help">Gesamte Grundst√ºcksfl√§che in Quadratmetern</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                üèóÔ∏è Wohnfl√§che (m¬≤) <span class="required">*</span>
                            </label>
                            <input type="number" id="wohnflaeche" class="form-input" placeholder="z.B. 150" min="0" step="1">
                            <div class="form-help">Wohnfl√§che des Geb√§udes</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                üìÖ Baujahr
                            </label>
                            <input type="number" id="baujahr" class="form-input" placeholder="z.B. 1995" min="1900" max="2025">
                            <div class="form-help">Jahr der Fertigstellung</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                üè† Immobilientyp
                            </label>
                            <select id="grundsteuer_immobilientyp" class="form-select">
                                <option value="einfamilienhaus">Einfamilienhaus</option>
                                <option value="zweifamilienhaus">Zweifamilienhaus</option>
                                <option value="mehrfamilienhaus">Mehrfamilienhaus</option>
                                <option value="eigentumswohnung">Eigentumswohnung</option>
                                <option value="gewerbe">Gewerbeimmobilie</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                üó∫Ô∏è Bundesland
                            </label>
                            <select id="grundsteuer_bundesland" class="form-select">
                                <option value="bw">Baden-W√ºrttemberg</option>
                                <option value="by">Bayern (Bundesmodell)</option>
                                <option value="by-bayerisch">Bayern (Bayerisches Modell)</option>
                                <option value="be">Berlin</option>
                                <option value="bb">Brandenburg</option>
                                <option value="hb">Bremen</option>
                                <option value="hh">Hamburg</option>
                                <option value="he">Hessen</option>
                                <option value="mv">Mecklenburg-Vorpommern</option>
                                <option value="ni">Niedersachsen</option>
                                <option value="nw" selected>Nordrhein-Westfalen</option>
                                <option value="rp">Rheinland-Pfalz</option>
                                <option value="sl">Saarland</option>
                                <option value="sn">Sachsen</option>
                                <option value="st">Sachsen-Anhalt</option>
                                <option value="sh">Schleswig-Holstein</option>
                                <option value="th">Th√ºringen</option>
                            </select>
                            <div class="form-help">Wichtig: Verschiedene Bundesl√§nder haben unterschiedliche Modelle</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                üèôÔ∏è Gemeinde-Hebesatz (%)
                            </label>
                            <input type="number" id="hebesatz_grundsteuer" class="form-input" placeholder="z.B. 470" min="0" max="1000" step="10">
                            <div class="form-help">Hebesatz Ihrer Gemeinde (meist 300-600%)</div>
                        </div>
                    </div>

                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="app.calculateGrundsteuer()">
                            üßÆ Grundsteuer 2025 berechnen
                        </button>
                        <button class="btn btn-warning" onclick="app.loadGrundsteuerExample()">
                            üí° Beispiel laden
                        </button>
                        <button class="btn btn-secondary" onclick="app.resetGrundsteuerForm()">
                            üîÑ Zur√ºcksetzen
                        </button>
                    </div>
                </div>

                <div id="grundsteuer-results" class="results-container">
                    <!-- Grundsteuer Results will be displayed here -->
                </div>
            `;
        }

        generateErbschaftContent() {
            return `
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <span>üë®‚Äçüë©‚Äçüëß‚Äçüë¶</span>
                            <span>Erbschaftsteuer-Optimierung 2025</span>
                        </div>
                    </div>

                    <div class="alert alert-info">
                        <h3>‚öñÔ∏è Erbschaftsteuer-Planung mit aktuellen Freibetr√§gen</h3>
                        <p>Optimieren Sie die √úbertragung Ihrer Immobilie durch geschickte Erbschaftsteuer-Planung.</p>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">
                                üè† Immobilienwert <span class="required">*</span>
                            </label>
                            <input type="number" id="erbschaft_immobilienwert" class="form-input" placeholder="z.B. 600.000" min="0" step="1000">
                            <div class="form-help">Aktueller Verkehrswert der Immobilie</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Verwandtschaftsgrad
                            </label>
                            <select id="verwandtschaftsgrad" class="form-select">
                                <option value="ehepartner">Ehepartner/Lebenspartner</option>
                                <option value="kind">Kind/Stiefkind</option>
                                <option value="enkel">Enkel</option>
                                <option value="eltern">Eltern/Gro√üeltern</option>
                                <option value="geschwister">Geschwister</option>
                                <option value="neffe_nichte">Neffe/Nichte</option>
                                <option value="sonstige">Sonstige Verwandte</option>
                                <option value="fremde">Nicht verwandt</option>
                            </select>
                            <div class="form-help">Verwandtschaftsgrad bestimmt Steuerklasse und Freibetrag</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                üè† Immobilienart
                            </label>
                            <select id="erbschaft_immobilienart" class="form-select">
                                <option value="eigenheim">Eigenheim (selbst bewohnt)</option>
                                <option value="vermietung">Vermietungsimmobilie</option>
                                <option value="ferienhaus">Ferienhaus</option>
                                <option value="gewerbe">Gewerbeimmobilie</option>
                                <option value="grundstueck">Unbebautes Grundst√ºck</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                üí∞ Sonstiges Verm√∂gen
                            </label>
                            <input type="number" id="sonstiges_vermoegen" class="form-input" placeholder="z.B. 100.000" min="0" step="1000">
                            <div class="form-help">Weiteres Verm√∂gen (Bargeld, Wertpapiere, etc.)</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                üè† Selbstnutzung durch Erben
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="checkbox" id="selbstnutzung_erbe">
                                <span>Erbe wird Immobilie selbst bewohnen</span>
                            </label>
                            <div class="form-help">Kann zu Steuerbefreiung f√ºhren (Familienheim)</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                ‚è±Ô∏è √úbertragung zu Lebzeiten
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="checkbox" id="lebzeitige_uebertragung">
                                <span>√úbertragung zu Lebzeiten geplant</span>
                            </label>
                            <div class="form-help">Erm√∂glicht Freibetr√§ge alle 10 Jahre</div>
                        </div>
                    </div>

                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="app.calculateErbschaftsteuer()">
                            üßÆ Erbschaftsteuer berechnen
                        </button>
                        <button class="btn btn-warning" onclick="app.loadErbschaftExample()">
                            üí° Beispiel laden
                        </button>
                        <button class="btn btn-secondary" onclick="app.resetErbschaftForm()">
                            üîÑ Zur√ºcksetzen
                        </button>
                    </div>
                </div>

                <div id="erbschaft-results" class="results-container">
                    <!-- Erbschaftsteuer Results will be displayed here -->
                </div>
            `;
        }

        generateSchenkungContent() {
            return `
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <span>üéÅ</span>
                            <span>Schenkungssteuer-Planung 2025</span>
                        </div>
                    </div>

                    <div class="alert alert-info">
                        <h3>üéØ Optimale Schenkungsplanung f√ºr Immobilien</h3>
                        <p>Nutzen Sie Freibetr√§ge optimal und planen Sie die steuereffiziente √úbertragung Ihrer Immobilie.</p>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">
                                üè† Immobilienwert <span class="required">*</span>
                            </label>
                            <input type="number" id="schenkung_immobilienwert" class="form-input" placeholder="z.B. 800.000" min="0" step="1000">
                            <div class="form-help">Aktueller Verkehrswert der Immobilie</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Beschenkter
                            </label>
                            <select id="beschenkter" class="form-select">
                                <option value="ehepartner">Ehepartner/Lebenspartner</option>
                                <option value="kind">Kind/Stiefkind</option>
                                <option value="enkel">Enkel</option>
                                <option value="urenkel">Urenkel</option>
                                <option value="eltern">Eltern/Gro√üeltern</option>
                                <option value="geschwister">Geschwister</option>
                                <option value="neffe_nichte">Neffe/Nichte</option>
                                <option value="sonstige">Sonstige Verwandte</option>
                                <option value="fremde">Nicht verwandt</option>
                            </select>
                            <div class="form-help">Bestimmt Freibetrag und Steuersatz</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                üìÖ Vorherige Schenkungen
                            </label>
                            <input type="number" id="vorherige_schenkungen" class="form-input" placeholder="z.B. 50.000" min="0" step="1000">
                            <div class="form-help">Schenkungen der letzten 10 Jahre an dieselbe Person</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                üè† Art der Schenkung
                            </label>
                            <select id="schenkungsart" class="form-select">
                                <option value="vollschenkung">Vollst√§ndige Schenkung</option>
                                <option value="teilschenkung">Teilschenkung (Anteil)</option>
                                <option value="niesbrauch">Schenkung mit Nie√übrauch</option>
                                <option value="wohnrecht">Schenkung mit Wohnrecht</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                üìä Anteil bei Teilschenkung (%)
                            </label>
                            <input type="number" id="schenkungsanteil" class="form-input" placeholder="z.B. 50" min="1" max="100" step="1">
                            <div class="form-help">Nur bei Teilschenkung relevant</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                üí∞ Nie√übrauchswert (j√§hrlich)
                            </label>
                            <input type="number" id="niesbrauchswert" class="form-input" placeholder="z.B. 24.000" min="0" step="1000">
                            <div class="form-help">J√§hrlicher Nie√übrauchswert (Miete oder Nutzungswert)</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                üë§ Alter des Schenkers
                            </label>
                            <input type="number" id="alter_schenker" class="form-input" placeholder="z.B. 65" min="18" max="100">
                            <div class="form-help">Alter f√ºr Berechnung der Nie√übrauchsdauer</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                üìÖ Geplante Schenkungstermine
                            </label>
                            <select id="schenkungsstrategie" class="form-select">
                                <option value="einmalig">Einmalige Schenkung</option>
                                <option value="zehn_jahre">Alle 10 Jahre (Freibetrag optimal nutzen)</option>
                                <option value="jaehrlich">J√§hrliche Teilschenkungen</option>
                            </select>
                        </div>
                    </div>

                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="app.calculateSchenkungssteuer()">
                            üßÆ Schenkungssteuer berechnen
                        </button>
                        <button class="btn btn-warning" onclick="app.loadSchenkungExample()">
                            üí° Beispiel laden
                        </button>
                        <button class="btn btn-secondary" onclick="app.resetSchenkungForm()">
                            üîÑ Zur√ºcksetzen
                        </button>
                    </div>
                </div>

                <div id="schenkung-results" class="results-container">
                    <!-- Schenkungssteuer Results will be displayed here -->
                </div>
            `;
        }

        generateCashflowContent() {
            return `
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <span>üìä</span>
                            <span>Cash-Flow Analyse & Liquidit√§tsplanung</span>
                        </div>
                    </div>

                    <div class="alert alert-info">
                        <h3>üí∞ Intelligente Cash-Flow Optimierung</h3>
                        <p>Analysieren Sie die Liquidit√§tsauswirkungen verschiedener Steuerstrategien und optimieren Sie Ihre Zahlungsstr√∂me.</p>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">
                                üè† Monatliche Mieteinnahmen <span class="required">*</span>
                            </label>
                            <input type="number" id="mieteinnahmen" class="form-input" placeholder="z.B. 3.500" min="0" step="100">
                            <div class="form-help">Netto-Mieteinnahmen pro Monat</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                üí∏ Monatliche Betriebskosten
                            </label>
                            <input type="number" id="betriebskosten" class="form-input" placeholder="z.B. 800" min="0" step="50">
                            <div class="form-help">Verwaltung, Instandhaltung, Versicherung</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                üè¶ Finanzierungskosten (monatlich)
                            </label>
                            <input type="number" id="finanzierungskosten" class="form-input" placeholder="z.B. 1.200" min="0" step="50">
                            <div class="form-help">Zinsen und Tilgung f√ºr Darlehen</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                üìä Abschreibungen (j√§hrlich)
                            </label>
                            <input type="number" id="cashflow_abschreibungen" class="form-input" placeholder="z.B. 8.000" min="0" step="100">
                            <div class="form-help">J√§hrliche AfA-Abschreibungen</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                üíº Pers√∂nlicher Steuersatz (%)
                            </label>
                            <select id="cashflow_steuersatz" class="form-select">
                                <option value="14">14% (Eingangssteuersatz)</option>
                                <option value="24">24% (Mittlerer Bereich)</option>
                                <option value="32">32% (H√∂herer Bereich)</option>
                                <option value="42" selected>42% (Spitzensteuersatz)</option>
                                <option value="45">45% (Reichensteuer)</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                üìÖ Analysezeitraum
                            </label>
                            <select id="analysezeitraum" class="form-select">
                                <option value="1">1 Jahr</option>
                                <option value="3">3 Jahre</option>
                                <option value="5" selected>5 Jahre</option>
                                <option value="10">10 Jahre</option>
                                <option value="15">15 Jahre</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                üìà Mietsteigerung (% p.a.)
                            </label>
                            <input type="number" id="mietsteigerung" class="form-input" placeholder="z.B. 2.5" min="0" max="10" step="0.1">
                            <div class="form-help">Erwartete j√§hrliche Mietsteigerung</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                üí∞ Geplante Verkaufserl√∂se
                            </label>
                            <input type="number" id="verkaufserloes" class="form-input" placeholder="z.B. 650.000" min="0" step="1000">
                            <div class="form-help">Erwarteter Verkaufserl√∂s am Ende des Zeitraums</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                üîÑ Reinvestitionsstrategie
                            </label>
                            <select id="reinvestition" class="form-select">
                                <option value="keine">Keine Reinvestition</option>
                                <option value="liquiditaet">Cash-Optimierung</option>
                                <option value="portfolio">Portfolio-Erweiterung</option>
                                <option value="upgrade">Property-Upgrade</option>
                            </select>
                        </div>
                    </div>

                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="app.calculateCashflow()">
                            üìä Cash-Flow analysieren
                        </button>
                        <button class="btn btn-success" onclick="app.generateCashflowForecast()">
                            üìà Liquidit√§tsprognose
                        </button>
                        <button class="btn btn-warning" onclick="app.loadCashflowExample()">
                            üí° Beispiel laden
                        </button>
                        <button class="btn btn-secondary" onclick="app.resetCashflowForm()">
                            üîÑ Zur√ºcksetzen
                        </button>
                    </div>
                </div>

                <div id="cashflow-results" class="results-container">
                    <!-- Cash-Flow Results will be displayed here -->
                </div>
            `;
        }

        generateStrategieContent() {
            return `
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <span>üéØ</span>
                            <span>KI-Gesamtstrategie & Portfolio-Optimierung</span>
                        </div>
                    </div>

                    <div class="alert alert-success">
                        <h3>ü§ñ Intelligente Gesamtstrategie-Analyse</h3>
                        <p>Unser KI-System analysiert Ihr gesamtes Immobilien-Portfolio und entwickelt eine optimale Langzeitstrategie f√ºr maximale Steuerersparnis.</p>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">
                                üè† Anzahl Immobilien im Portfolio
                            </label>
                            <input type="number" id="portfolio_anzahl" class="form-input" placeholder="z.B. 3" min="1" max="50">
                            <div class="form-help">Gesamtanzahl Ihrer Immobilien</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                üí∞ Gesamtportfolio-Wert
                            </label>
                            <input type="number" id="portfolio_wert" class="form-input" placeholder="z.B. 2.000.000" min="0" step="10000">
                            <div class="form-help">Gesch√§tzter Gesamtwert aller Immobilien</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                üéØ Strategisches Ziel
                            </label>
                            <select id="strategisches_ziel" class="form-select">
                                <option value="verkaufsoptimierung">Verkaufsoptimierung</option>
                                <option value="nachfolgeplanung">Nachfolgeplanung</option>
                                <option value="steuerminimierung">Steuerminimierung</option>
                                <option value="liquiditaet">Liquidit√§tssteigerung</option>
                                <option value="reinvestition">Reinvestitionsstrategie</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                ‚è±Ô∏è Planungshorizont
                            </label>
                            <select id="planungshorizont" class="form-select">
                                <option value="kurzfristig">1-3 Jahre</option>
                                <option value="mittelfristig">3-7 Jahre</option>
                                <option value="langfristig">7-15 Jahre</option>
                                <option value="generational">Generationen√ºbergreifend</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Familiensituation
                            </label>
                            <select id="familiensituation" class="form-select">
                                <option value="single">Alleinstehend</option>
                                <option value="ehepaar">Ehepaar</option>
                                <option value="familie_kinder">Familie mit Kindern</option>
                                <option value="grossfamilie">Gro√üfamilie (3+ Generationen)</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                üìä J√§hrliches Einkommen
                            </label>
                            <select id="jahreseinkommen" class="form-select">
                                <option value="niedrig">Bis 50.000‚Ç¨</option>
                                <option value="mittel">50.000‚Ç¨ - 100.000‚Ç¨</option>
                                <option value="hoch">100.000‚Ç¨ - 250.000‚Ç¨</option>
                                <option value="sehr_hoch">√úber 250.000‚Ç¨</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                üåç Internationale Komponente
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="checkbox" id="international">
                                <span>Internationale Strukturen erw√ºnscht</span>
                            </label>
                            <div class="form-help">Cross-Border Optimierung einbeziehen</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                ‚öñÔ∏è Risikobereitschaft
                            </label>
                            <select id="risikobereitschaft" class="form-select">
                                <option value="konservativ">Konservativ</option>
                                <option value="moderat">Moderat</option>
                                <option value="progressiv">Progressiv</option>
                                <option value="aggressiv">Aggressiv</option>
                            </select>
                        </div>
                    </div>

                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="app.generateKIStrategy()">
                            ü§ñ KI-Gesamtstrategie generieren
                        </button>
                        <button class="btn btn-success" onclick="app.analyzePortfolio()">
                            üìä Portfolio-Analyse
                        </button>
                        <button class="btn btn-warning" onclick="app.loadStrategyExample()">
                            üí° Beispiel laden
                        </button>
                        <button class="btn btn-secondary" onclick="app.resetStrategyForm()">
                            üîÑ Zur√ºcksetzen
                        </button>
                    </div>
                </div>

                <div id="strategy-results" class="results-container">
                    <!-- Strategy Results will be displayed here -->
                </div>
            `;
        }

        // Modal Management
        showModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'flex';
                setTimeout(() => modal.classList.add('show'), 10);
            }
        }

        closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('show');
                setTimeout(() => modal.style.display = 'none', 300);
            }
        }

        closeAllModals() {
            document.querySelectorAll('.modal-overlay').forEach(modal => {
                modal.style.display = 'none';
            });
        }

        // Progress Management
        showProgress(message, percentage) {
            const overlay = document.getElementById('progress-overlay');
            const title = document.getElementById('progress-title');
            const text = document.getElementById('progress-text');
            const fill = document.getElementById('progress-fill');

            if (overlay && title && text && fill) {
                overlay.style.display = 'flex';
                title.textContent = 'KI-Berechnung l√§uft...';
                text.textContent = message;
                fill.style.width = percentage + '%';
            }
        }

        hideProgress() {
            const overlay = document.getElementById('progress-overlay');
            if (overlay) {
                overlay.style.display = 'none';
            }
        }

        cancelCalculation() {
            if (this.calculationTimeout) {
                clearTimeout(this.calculationTimeout);
            }
            this.hideProgress();
            this.showToast('‚èπÔ∏è Berechnung abgebrochen', 'warning');
        }

        // Toast Notifications
        showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            if (!container) return;

            const toastId = 'toast-' + Date.now();
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.id = toastId;
            
            const icons = {
                'success': '‚úÖ',
                'warning': '‚ö†Ô∏è',
                'danger': '‚ùå',
                'info': '‚ÑπÔ∏è'
            };

            toast.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>${icons[type] || '‚ÑπÔ∏è'} ${message}</span>