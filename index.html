<!DOCTYPE html>

<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Immobilien-Steuer-Suite 2025 - Ultimate Enterprise Edition Enhanced</title>

<!-- PWA Meta Tags -->
<meta name="theme-color" content="#3498db">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Steuer-Suite Ultimate">
<meta name="description" content="Ultimate Enterprise Immobiliensteuer-Optimierung 2025 mit KI, Real-time Analytics und PDF-Reports">

<!-- SEO Meta Tags -->
<meta name="keywords" content="Immobilien, Steuer, KI, Real-time, PDF, Enterprise, Analytics, TypeScript">
<meta name="author" content="Immobilien-Steuer-Suite Ultimate Enhanced">
<meta name="robots" content="index, follow">

<!-- Google Analytics 4 (GA4) - REPLACE WITH ACTUAL TRACKING ID -->
<script async src="https://www.googletagmanager.com/gtag/js?id=GA_MEASUREMENT_ID"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    
    // Initialize GA4 with enhanced configuration - REPLACE GA_MEASUREMENT_ID
    gtag('config', 'GA_MEASUREMENT_ID', {
        enhanced_measurement: true,
        anonymize_ip: true,
        allow_ad_personalization_signals: false,
        allow_google_signals: false,
        custom_map: {
            'custom_parameter_1': 'calculation_type',
            'custom_parameter_2': 'user_segment',
            'custom_parameter_3': 'feature_usage'
        },
        send_page_view: true,
        site_speed_sample_rate: 100
    });

    // GDPR Consent Management
    window.cookieConsent = {
        analytics: false,
        marketing: false,
        functional: true
    };

    // Custom Event Tracking Functions
    window.trackEvent = function(eventName, parameters = {}) {
        if (window.cookieConsent.analytics && typeof gtag !== 'undefined') {
            gtag('event', eventName, {
                event_category: parameters.category || 'User Interaction',
                event_label: parameters.label || '',
                value: parameters.value || 0,
                custom_parameter_1: parameters.calculation_type || '',
                custom_parameter_2: parameters.user_segment || '',
                custom_parameter_3: parameters.feature_usage || '',
                ...parameters
            });
        }
    };
</script>

<!-- Favicon -->
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üè†</text></svg>">

<!-- External Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

<style>
    :root {
        /* Light mode colors */
        --primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --primary-solid: #667eea;
        --success: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        --success-solid: #11998e;
        --warning: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        --warning-solid: #f093fb;
        --danger: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
        --danger-solid: #ff9a9e;
        --dark: #2c3e50;
        --light: #f8f9fa;
        
        /* Enhanced dark mode color palette */
        --dark-bg-primary: #0d1117;
        --dark-bg-secondary: #161b22;
        --dark-bg-tertiary: #21262d;
        --dark-bg-elevated: #2d333b;
        --dark-surface: #1c2128;
        --dark-surface-hover: #292e36;
        
        --dark-text-primary: #f0f6fc;
        --dark-text-secondary: #e6edf3;
        --dark-text-muted: #9198a1;
        --dark-text-disabled: #656d76;
        
        --dark-accent-primary: #58a6ff;
        --dark-accent-secondary: #1f6feb;
        --dark-success: #3fb950;
        --dark-warning: #f85149;
        --dark-error: #ff6b6b;
        
        --dark-border-primary: #30363d;
        --dark-border-secondary: #21262d;
        --dark-border-accent: #58a6ff;
        
        /* Layout variables */
        --border-radius: 16px;
        --border-radius-sm: 8px;
        --shadow: 0 10px 30px rgba(0,0,0,0.1);
        --shadow-lg: 0 20px 40px rgba(0,0,0,0.15);
        --shadow-xl: 0 30px 60px rgba(0,0,0,0.2);
        --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        --transition-fast: all 0.15s ease;
        --z-index-dropdown: 1000;
        --z-index-modal: 1050;
        --z-index-tooltip: 1070;
        --z-index-overlay: 1080;
        --font-family: 'Segoe UI', system-ui, -apple-system, BlinkMacSystemFont, 'Roboto', 'Helvetica Neue', Arial, sans-serif;
    }

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    *:focus {
        outline: 2px solid var(--primary-solid);
        outline-offset: 2px;
    }

    body {
        font-family: var(--font-family);
        background: var(--primary);
        min-height: 100vh;
        line-height: 1.6;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        overflow-x: hidden;
        transition: background-color 0.3s ease, color 0.3s ease;
    }

    .app-container {
        max-width: 1600px;
        margin: 0 auto;
        background: white;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-xl);
        overflow: hidden;
        min-height: 100vh;
        position: relative;
    }

    /* Enhanced Header */
    .app-header {
        background: rgba(255,255,255,0.95);
        backdrop-filter: blur(20px);
        padding: 1.5rem 2rem;
        border-bottom: 1px solid #e9ecef;
        position: sticky;
        top: 0;
        z-index: var(--z-index-dropdown);
        transition: var(--transition);
    }

    .app-header.scrolled {
        background: rgba(255,255,255,0.98);
        box-shadow: var(--shadow);
    }

    .header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .app-title {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .app-title h1 {
        font-size: 1.75rem;
        font-weight: 700;
        background: var(--primary);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .subtitle {
        font-size: 0.85rem;
        color: #6c757d;
        margin-top: 0.25rem;
    }

    .header-actions {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
        align-items: center;
    }

    .performance-indicator {
        background: rgba(17, 153, 142, 0.1);
        color: var(--success-solid);
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        transition: var(--transition);
    }

    .performance-indicator.error {
        background: rgba(255, 154, 158, 0.1);
        color: var(--danger-solid);
    }

    .performance-indicator.warning {
        background: rgba(240, 147, 251, 0.1);
        color: var(--warning-solid);
    }

    .performance-dot {
        width: 8px;
        height: 8px;
        background: var(--success-solid);
        border-radius: 50%;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    /* Main Layout */
    .main-content {
        display: grid;
        grid-template-columns: 320px 1fr 280px;
        min-height: calc(100vh - 120px);
        gap: 0;
    }

    .sidebar {
        background: var(--light);
        padding: 2rem;
        border-right: 1px solid #e9ecef;
        overflow-y: auto;
        max-height: calc(100vh - 120px);
    }

    .content-area {
        padding: 2rem;
        overflow-y: auto;
        position: relative;
        max-height: calc(100vh - 120px);
    }

    .analytics-panel {
        background: var(--light);
        padding: 2rem;
        border-left: 1px solid #e9ecef;
        overflow-y: auto;
        max-height: calc(100vh - 120px);
    }

    /* Navigation */
    .nav-menu {
        list-style: none;
        margin-bottom: 2rem;
    }

    .nav-item {
        margin-bottom: 0.5rem;
    }

    .nav-link {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 1rem 1.25rem;
        color: var(--dark);
        text-decoration: none;
        border-radius: 12px;
        transition: var(--transition);
        font-weight: 500;
        cursor: pointer;
        position: relative;
        overflow: hidden;
    }

    .nav-link::before {
        content: '';
        position: absolute;
        left: -100%;
        top: 0;
        width: 100%;
        height: 100%;
        background: var(--primary);
        transition: left 0.3s ease;
        z-index: -1;
    }

    .nav-link:hover::before,
    .nav-link.active::before {
        left: 0;
    }

    .nav-link:hover,
    .nav-link.active {
        color: white;
        transform: translateX(4px);
        box-shadow: var(--shadow);
    }

    .nav-icon {
        font-size: 1.25rem;
        min-width: 1.5rem;
    }

    .nav-badge {
        background: var(--danger-solid);
        color: white;
        font-size: 0.7rem;
        padding: 0.2rem 0.5rem;
        border-radius: 10px;
        margin-left: auto;
    }

    /* Cards */
    .card {
        background: white;
        border-radius: var(--border-radius);
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: var(--shadow);
        transition: var(--transition);
        position: relative;
        overflow: hidden;
        border: 1px solid rgba(102, 126, 234, 0.1);
    }

    .card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: var(--primary);
    }

    .card:hover {
        box-shadow: var(--shadow-lg);
        transform: translateY(-2px);
    }

    .card-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid var(--primary-solid);
    }

    .card-title {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        color: var(--dark);
        font-size: 1.5rem;
        font-weight: 600;
    }

    /* Form Components */
    .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 2rem;
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        position: relative;
    }

    .form-label {
        font-weight: 600;
        color: var(--dark);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .required {
        color: var(--danger-solid);
    }

    .form-input,
    .form-select {
        padding: 1rem 1.25rem;
        border: 2px solid #e9ecef;
        border-radius: 12px;
        font-size: 1rem;
        transition: var(--transition);
        background: white;
        font-family: inherit;
        position: relative;
    }

    .form-input:focus,
    .form-select:focus {
        border-color: var(--primary-solid);
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        background: #fafbfc;
    }

    .form-input.valid {
        border-color: var(--success-solid);
        background: rgba(17, 153, 142, 0.05);
    }

    .form-input.invalid {
        border-color: var(--danger-solid);
        background: rgba(255, 154, 158, 0.05);
    }

    .form-help {
        font-size: 0.85rem;
        color: #6c757d;
        font-style: italic;
    }

    .form-error {
        font-size: 0.8rem;
        color: var(--danger-solid);
        margin-top: 0.25rem;
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    .input-group {
        position: relative;
    }

    .input-icon {
        position: absolute;
        right: 1rem;
        top: 50%;
        transform: translateY(-50%);
        color: #6c757d;
        pointer-events: none;
    }

    .input-group .form-input {
        padding-right: 3rem;
    }

    .validation-indicator {
        position: absolute;
        right: 1rem;
        top: 50%;
        transform: translateY(-50%);
        font-size: 1.2rem;
        opacity: 0;
        transition: var(--transition);
    }

    .validation-indicator.show {
        opacity: 1;
    }

    .validation-indicator.valid {
        color: var(--success-solid);
    }

    .validation-indicator.invalid {
        color: var(--danger-solid);
    }

    /* Buttons */
    .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        padding: 1rem 2rem;
        border: none;
        border-radius: 12px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
        text-decoration: none;
        position: relative;
        overflow: hidden;
        min-height: 48px;
        font-family: inherit;
        white-space: nowrap;
    }

    .btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        transition: left 0.5s;
    }

    .btn:hover::before {
        left: 100%;
    }

    .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none !important;
    }

    .btn-primary {
        background: var(--primary);
        color: white;
        box-shadow: var(--shadow);
    }

    .btn-primary:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
    }

    .btn-success {
        background: var(--success);
        color: white;
        box-shadow: var(--shadow);
    }

    .btn-warning {
        background: var(--warning);
        color: white;
        box-shadow: var(--shadow);
    }

    .btn-secondary {
        background: linear-gradient(135deg, #95a5a6, #7f8c8d);
        color: white;
        box-shadow: var(--shadow);
    }

    .btn-outline {
        background: transparent;
        border: 2px solid var(--primary-solid);
        color: var(--primary-solid);
    }

    .btn-outline:hover:not(:disabled) {
        background: var(--primary-solid);
        color: white;
    }

    .btn-group {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        margin-top: 2rem;
    }

    /* Advanced Options */
    .advanced-options {
        margin-top: 2rem;
        border-top: 1px solid #e9ecef;
        padding-top: 2rem;
    }

    .disclosure-toggle {
        background: none;
        border: none;
        color: var(--primary-solid);
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 1rem;
        transition: var(--transition);
    }

    .disclosure-toggle:hover {
        color: var(--dark);
    }

    .disclosure-arrow {
        transition: transform 0.3s ease;
    }

    .disclosure-toggle.open .disclosure-arrow {
        transform: rotate(90deg);
    }

    .disclosure-content {
        display: none;
        animation: slideDown 0.3s ease;
    }

    .disclosure-content.open {
        display: block;
    }

    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Scenario Tabs */
    .scenario-tabs {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 2rem;
        border-bottom: 2px solid #e9ecef;
        overflow-x: auto;
        padding-bottom: 0.5rem;
    }

    .scenario-tab {
        padding: 1rem 1.5rem;
        background: none;
        border: none;
        border-bottom: 3px solid transparent;
        cursor: pointer;
        font-weight: 600;
        color: #6c757d;
        transition: var(--transition);
        white-space: nowrap;
        min-width: fit-content;
    }

    .scenario-tab.active {
        color: var(--primary-solid);
        border-bottom-color: var(--primary-solid);
    }

    .scenario-tab:hover {
        color: var(--dark);
    }

    .scenario-content {
        display: none;
    }

    .scenario-content.active {
        display: block;
        animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    /* Results */
    .results-container {
        margin-top: 3rem;
    }

    .results-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 2rem;
        margin-top: 2rem;
    }

    .result-card {
        background: white;
        border-radius: var(--border-radius);
        padding: 2rem;
        border: 2px solid #e9ecef;
        transition: var(--transition);
        position: relative;
        overflow: hidden;
    }

    .result-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 4px;
        background: var(--primary);
    }

    .result-card.best {
        border-color: var(--success-solid);
        background: linear-gradient(135deg, rgba(17, 153, 142, 0.05), rgba(56, 239, 125, 0.05));
        animation: highlightPulse 2s infinite;
    }

    .result-card.best::before {
        background: var(--success);
        height: 6px;
    }

    @keyframes highlightPulse {
        0% { box-shadow: var(--shadow); }
        50% { box-shadow: 0 0 0 10px rgba(17, 153, 142, 0.1); }
        100% { box-shadow: var(--shadow); }
    }

    .result-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid #e9ecef;
    }

    .result-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--dark);
    }

    .result-badge {
        background: var(--success);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    .result-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 0;
        border-bottom: 1px solid #f1f3f4;
    }

    .result-item:last-child {
        border-bottom: none;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 2px solid var(--success-solid);
        font-weight: 600;
        background: rgba(17, 153, 142, 0.05);
        margin-left: -1rem;
        margin-right: -1rem;
        padding-left: 1rem;
        padding-right: 1rem;
        border-radius: var(--border-radius-sm);
    }

    .result-label {
        color: var(--dark);
        font-weight: 500;
    }

    .result-value {
        font-weight: 600;
        color: var(--success-solid);
        font-size: 1.1rem;
    }

    .result-value.negative {
        color: var(--danger-solid);
    }

    /* Analytics Panel */
    .analytics-header {
        background: var(--primary);
        margin: -2rem -2rem 2rem -2rem;
        padding: 1.5rem 2rem;
        border-radius: var(--border-radius) var(--border-radius) 0 0;
        color: white;
    }

    .analytics-widget {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: var(--shadow);
        border: 1px solid #e9ecef;
        transition: var(--transition);
    }

    .analytics-widget:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
    }

    .widget-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .widget-title {
        font-size: 1rem;
        font-weight: 600;
        color: var(--dark);
    }

    .widget-icon {
        font-size: 1.5rem;
        color: var(--primary-solid);
    }

    .metric-value {
        font-size: 2rem;
        font-weight: 700;
        color: var(--success-solid);
        margin-bottom: 0.5rem;
    }

    .metric-label {
        font-size: 0.9rem;
        color: #6c757d;
    }

    .chart-container {
        height: 200px;
        margin-top: 1rem;
    }

    /* Alerts */
    .alert {
        padding: 1.5rem;
        border-radius: var(--border-radius);
        margin: 1.5rem 0;
        position: relative;
        box-shadow: var(--shadow);
        border-left: 4px solid;
    }

    .alert-success {
        background: linear-gradient(135deg, rgba(17, 153, 142, 0.1), rgba(56, 239, 125, 0.1));
        border-left-color: var(--success-solid);
        color: #0d5f56;
    }

    .alert-info {
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
        border-left-color: var(--primary-solid);
        color: #4c63d2;
    }

    .alert-warning {
        background: linear-gradient(135deg, rgba(240, 147, 251, 0.1), rgba(245, 87, 108, 0.1));
        border-left-color: var(--warning-solid);
        color: #8b2635;
    }

    .alert-danger {
        background: linear-gradient(135deg, rgba(255, 154, 158, 0.1), rgba(254, 207, 239, 0.1));
        border-left-color: var(--danger-solid);
        color: #721c24;
    }

    /* Toast Notifications */
    .toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: var(--z-index-tooltip);
        display: flex;
        flex-direction: column;
        gap: 1rem;
        max-width: 400px;
    }

    .toast {
        background: white;
        border-radius: 12px;
        padding: 1.25rem 1.5rem;
        box-shadow: var(--shadow-xl);
        border-left: 4px solid var(--primary-solid);
        min-width: 320px;
        transform: translateX(450px);
        animation: slideInToast 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        position: relative;
        overflow: hidden;
    }

    .toast::before {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        height: 2px;
        background: var(--primary-solid);
        animation: toastProgress 5s linear forwards;
    }

    .toast.success {
        border-left-color: var(--success-solid);
    }

    .toast.success::before {
        background: var(--success-solid);
    }

    .toast.warning {
        border-left-color: var(--warning-solid);
    }

    .toast.warning::before {
        background: var(--warning-solid);
    }

    .toast.danger {
        border-left-color: var(--danger-solid);
    }

    .toast.danger::before {
        background: var(--danger-solid);
    }

    @keyframes slideInToast {
        to { transform: translateX(0); }
    }

    @keyframes slideOutToast {
        to { transform: translateX(450px); opacity: 0; }
    }

    @keyframes toastProgress {
        to { width: 100%; }
    }

    /* Modal Overlays */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.8);
        z-index: var(--z-index-overlay);
        display: none;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(5px);
    }

    .modal {
        background: white;
        border-radius: var(--border-radius);
        padding: 2rem;
        max-width: 90vw;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: var(--shadow-xl);
        animation: modalSlideIn 0.3s ease;
    }

    @keyframes modalSlideIn {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Progress Indicators */
    .progress-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        z-index: var(--z-index-overlay);
        display: none;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(8px);
    }

    .progress-modal {
        background: white;
        padding: 2rem;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-xl);
        text-align: center;
        min-width: 300px;
        border: 1px solid #e9ecef;
    }

    .spinner {
        width: 40px;
        height: 40px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid var(--primary-solid);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .progress-bar {
        width: 100%;
        height: 8px;
        background: #e9ecef;
        border-radius: 4px;
        overflow: hidden;
        margin: 1rem 0;
        border: 1px solid #ddd;
    }

    .progress-fill {
        height: 100%;
        background: var(--primary);
        width: 0%;
        transition: width 0.3s ease;
        position: relative;
    }

    .progress-fill::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(90deg, 
            transparent, 
            rgba(255, 255, 255, 0.2), 
            transparent);
        animation: progressShine 2s infinite;
    }

    @keyframes progressShine {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(100%); }
    }

    /* Dark Mode Toggle */
    .dark-mode-toggle {
        background: rgba(0,0,0,0.7);
        color: white;
        border: none;
        border-radius: 20px;
        padding: 0.75rem 1rem;
        cursor: pointer;
        z-index: 1000;
        font-size: 1rem;
        transition: var(--transition);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        min-width: 48px;
        min-height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .dark-mode-toggle:hover {
        transform: scale(1.05);
    }

    /* History Controls */
    .history-controls {
        position: fixed;
        bottom: 20px;
        right: 20px;
        display: flex;
        gap: 0.5rem;
        z-index: var(--z-index-dropdown);
    }

    .history-btn {
        background: rgba(102, 126, 234, 0.9);
        color: white;
        border: none;
        border-radius: 50%;
        width: 48px;
        height: 48px;
        cursor: pointer;
        font-size: 1.2rem;
        transition: var(--transition);
        box-shadow: var(--shadow);
    }

    .history-btn:hover:not(:disabled) {
        background: var(--primary-solid);
        transform: scale(1.1);
    }

    .history-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    /* Data Tables */
    .data-table {
        width: 100%;
        border-collapse: collapse;
        box-shadow: var(--shadow);
        border-radius: var(--border-radius);
        overflow: hidden;
        margin: 1rem 0;
    }

    .data-table th,
    .data-table td {
        padding: 1rem;
        text-align: left;
        border-bottom: 1px solid #e9ecef;
    }

    .data-table th {
        background: var(--primary);
        color: white;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.85rem;
        letter-spacing: 0.5px;
    }

    .data-table tr:hover {
        background: rgba(102, 126, 234, 0.05);
    }

    .data-table tr:last-child td {
        border-bottom: none;
    }

    /* Plugin Items */
    .plugin-item {
        padding: 0.5rem;
        margin: 0.5rem 0;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        cursor: pointer;
        transition: var(--transition);
        background: white;
    }

    .plugin-item:hover {
        background: rgba(102, 126, 234, 0.1);
        border-color: var(--primary-solid);
        transform: translateX(2px);
    }

    .plugin-item strong {
        color: var(--dark);
        display: block;
        margin-bottom: 0.25rem;
    }

    .plugin-item small {
        color: #6c757d;
        font-size: 0.8rem;
    }

    /* ENHANCED DARK MODE STYLES */
    
    /* System dark mode detection */
    @media (prefers-color-scheme: dark) {
        body {
            background: linear-gradient(135deg, var(--dark-bg-primary) 0%, var(--dark-bg-secondary) 100%);
            color: var(--dark-text-primary);
        }
        
        .app-container {
            background: var(--dark-bg-secondary);
            color: var(--dark-text-primary);
            border: 1px solid var(--dark-border-primary);
        }
        
        .app-header {
            background: rgba(13, 17, 23, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--dark-border-primary);
            color: var(--dark-text-primary);
        }
        
        .app-title h1 {
            background: linear-gradient(135deg, var(--dark-accent-primary), #79c0ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .subtitle {
            color: var(--dark-text-muted) !important;
            font-weight: 500;
        }
        
        .card,
        .result-card,
        .analytics-widget,
        .modal {
            background: var(--dark-bg-tertiary);
            border: 1px solid var(--dark-border-primary);
            color: var(--dark-text-primary);
        }
        
        .card::before {
            background: linear-gradient(90deg, var(--dark-accent-primary), #79c0ff);
        }
        
        .sidebar,
        .analytics-panel {
            background: var(--dark-bg-secondary);
            border-color: var(--dark-border-primary);
        }
        
        .nav-link {
            color: var(--dark-text-secondary);
        }
        
        .nav-link::before {
            background: linear-gradient(135deg, var(--dark-accent-primary), var(--dark-accent-secondary));
        }
        
        .nav-link:hover,
        .nav-link.active {
            color: var(--dark-text-primary);
        }
        
        .form-input,
        .form-select {
            background: var(--dark-bg-primary);
            border: 2px solid var(--dark-border-primary);
            color: var(--dark-text-primary);
        }
        
        .form-input::placeholder {
            color: var(--dark-text-muted);
        }
        
        .form-input:focus,
        .form-select:focus {
            border-color: var(--dark-accent-primary);
            background: var(--dark-bg-secondary);
            box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.2);
        }
        
        .form-label {
            color: var(--dark-text-primary) !important;
        }
        
        .form-help {
            color: var(--dark-text-muted) !important;
        }
        
        .form-error {
            color: var(--dark-error) !important;
        }
        
        .btn-primary {
            background: linear-gradient(145deg, var(--dark-accent-primary), var(--dark-accent-secondary));
            border: none;
            color: white;
            box-shadow: 0 2px 8px rgba(88, 166, 255, 0.3);
        }
        
        .btn-primary:hover {
            background: linear-gradient(145deg, #79c0ff, var(--dark-accent-primary));
            box-shadow: 0 4px 16px rgba(88, 166, 255, 0.4);
        }
        
        .btn-secondary {
            background: var(--dark-bg-elevated);
            border: 1px solid var(--dark-border-primary);
            color: var(--dark-text-primary);
        }
        
        .btn-outline {
            background: transparent;
            border: 2px solid var(--dark-accent-primary);
            color: var(--dark-accent-primary);
        }
        
        .btn-outline:hover {
            background: var(--dark-accent-primary);
            color: white;
        }
        
        /* Enhanced progress modal for dark mode */
        .progress-overlay {
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(12px);
        }
        
        .progress-modal {
            background: linear-gradient(145deg, #1c2128, #2d333b) !important;
            border: 1px solid #444c56 !important;
            box-shadow: 
                0 25px 50px rgba(0, 0, 0, 0.6),
                0 0 0 1px rgba(88, 166, 255, 0.1) !important;
            color: var(--dark-text-primary) !important;
        }
        
        .progress-modal h3 {
            color: var(--dark-text-primary) !important;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }
        
        .progress-modal p {
            color: var(--dark-text-secondary) !important;
        }
        
        .progress-bar {
            background: linear-gradient(90deg, #21262d, #30363d) !important;
            border: 1px solid #444c56;
        }
        
        .progress-fill {
            background: linear-gradient(90deg, 
                var(--dark-accent-primary) 0%, 
                #79c0ff 50%, 
                #a5d6ff 100%) !important;
            box-shadow: 0 0 10px rgba(88, 166, 255, 0.3);
        }
        
        .progress-modal .btn {
            background: linear-gradient(145deg, #444c56, #373e47) !important;
            border: 1px solid #6e7681 !important;
            color: var(--dark-text-primary) !important;
        }
        
        .toast {
            background: var(--dark-bg-elevated);
            border: 1px solid var(--dark-border-primary);
            color: var(--dark-text-primary);
        }
        
        .modal-overlay {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
        }
        
        .alert-info {
            background: linear-gradient(135deg, 
                rgba(88, 166, 255, 0.15), 
                rgba(121, 192, 255, 0.1));
            border-left-color: var(--dark-accent-primary);
            color: var(--dark-text-primary);
        }
        
        .alert-success {
            background: linear-gradient(135deg, 
                rgba(63, 185, 80, 0.15), 
                rgba(63, 185, 80, 0.1));
            border-left-color: var(--dark-success);
            color: var(--dark-text-primary);
        }
        
        .alert-warning {
            background: linear-gradient(135deg, 
                rgba(248, 81, 73, 0.15), 
                rgba(248, 81, 73, 0.1));
            border-left-color: var(--dark-warning);
            color: var(--dark-text-primary);
        }
        
        .result-value {
            color: var(--dark-success) !important;
        }
        
        .result-value.negative {
            color: var(--dark-error) !important;
        }
        
        .result-label {
            color: var(--dark-text-secondary) !important;
        }
        
        .data-table {
            background: var(--dark-bg-tertiary);
            border: 1px solid var(--dark-border-primary);
        }
        
        .data-table th {
            background: var(--dark-bg-primary);
            color: var(--dark-text-primary);
        }
        
        .data-table td {
            color: var(--dark-text-secondary);
            border-bottom: 1px solid var(--dark-border-secondary);
        }
        
        .data-table tr:hover {
            background: rgba(88, 166, 255, 0.1);
        }
        
        .plugin-item {
            background: var(--dark-bg-primary);
            border: 1px solid var(--dark-border-primary);
            color: var(--dark-text-primary) !important;
        }
        
        .plugin-item:hover {
            background: var(--dark-surface-hover) !important;
            border-color: var(--dark-accent-primary);
        }
        
        .plugin-item strong {
            color: var(--dark-text-primary) !important;
        }
        
        .plugin-item small {
            color: var(--dark-text-muted) !important;
        }
        
        .performance-indicator {
            background: rgba(63, 185, 80, 0.2);
            color: var(--dark-text-primary);
            border: 1px solid rgba(63, 185, 80, 0.3);
        }
        
        .scenario-tab {
            background: var(--dark-bg-primary);
            color: var(--dark-text-muted);
            border: 1px solid var(--dark-border-primary);
        }
        
        .scenario-tab.active {
            color: var(--dark-text-primary);
            border-bottom-color: var(--dark-accent-primary);
            background: var(--dark-bg-secondary);
        }
        
        .widget-title,
        .metric-label {
            color: var(--dark-text-primary) !important;
        }
        
        .metric-value {
            color: var(--dark-success) !important;
        }
        
        .spinner {
            border: 3px solid var(--dark-border-primary) !important;
            border-top: 3px solid var(--dark-accent-primary) !important;
        }
        
        .dark-mode-toggle {
            background: rgba(88, 166, 255, 0.9);
            border: 1px solid rgba(88, 166, 255, 0.3);
        }
    }

    /* Manual dark mode class - applies same styles as media query */
    body.dark-mode {
        background: linear-gradient(135deg, var(--dark-bg-primary) 0%, var(--dark-bg-secondary) 100%);
        color: var(--dark-text-primary);
    }

    body.dark-mode .app-container {
        background: var(--dark-bg-secondary);
        color: var(--dark-text-primary);
        border: 1px solid var(--dark-border-primary);
    }

    body.dark-mode .app-header {
        background: rgba(13, 17, 23, 0.95);
        border-bottom: 1px solid var(--dark-border-primary);
    }

    body.dark-mode .app-title h1 {
        background: linear-gradient(135deg, var(--dark-accent-primary), #79c0ff);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    body.dark-mode .subtitle {
        color: var(--dark-text-muted) !important;
    }

    body.dark-mode .card,
    body.dark-mode .result-card,
    body.dark-mode .analytics-widget,
    body.dark-mode .modal {
        background: var(--dark-bg-tertiary);
        border: 1px solid var(--dark-border-primary);
        color: var(--dark-text-primary);
    }

    body.dark-mode .sidebar,
    body.dark-mode .analytics-panel {
        background: var(--dark-bg-secondary);
        border-color: var(--dark-border-primary);
    }

    body.dark-mode .form-input,
    body.dark-mode .form-select {
        background: var(--dark-bg-primary);
        border: 2px solid var(--dark-border-primary);
        color: var(--dark-text-primary);
    }

    body.dark-mode .form-label {
        color: var(--dark-text-primary) !important;
    }

    body.dark-mode .form-help {
        color: var(--dark-text-muted) !important;
    }

    body.dark-mode .progress-modal {
        background: linear-gradient(145deg, #1c2128, #2d333b) !important;
        border: 1px solid #444c56 !important;
        color: var(--dark-text-primary) !important;
    }

    body.dark-mode .progress-modal h3 {
        color: var(--dark-text-primary) !important;
    }

    body.dark-mode .progress-modal p {
        color: var(--dark-text-secondary) !important;
    }

    body.dark-mode .progress-bar {
        background: linear-gradient(90deg, #21262d, #30363d) !important;
        border: 1px solid #444c56;
    }

    body.dark-mode .progress-fill {
        background: linear-gradient(90deg, 
            var(--dark-accent-primary) 0%, 
            #79c0ff 50%, 
            #a5d6ff 100%) !important;
    }

    /* Mobile Responsive */
    @media (max-width: 1400px) {
        .main-content {
            grid-template-columns: 300px 1fr 260px;
        }
    }

    @media (max-width: 1200px) {
        .main-content {
            grid-template-columns: 280px 1fr 250px;
        }
        
        .form-grid {
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        }
    }

    @media (max-width: 1024px) {
        .main-content {
            grid-template-columns: 260px 1fr;
        }
        
        .analytics-panel {
            display: none;
        }
    }

    @media (max-width: 768px) {
        .main-content {
            grid-template-columns: 1fr;
            gap: 1rem;
        }
        
        .sidebar {
            order: 2;
            max-height: none;
            border-right: none;
            border-top: 1px solid #e9ecef;
            padding: 1rem;
        }
        
        .content-area {
            order: 1;
            padding: 1rem;
            max-height: none;
        }
        
        .form-grid {
            grid-template-columns: 1fr;
            gap: 1rem;
        }
        
        .results-grid {
            grid-template-columns: 1fr;
        }
        
        .btn-group {
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .toast-container {
            left: 10px;
            right: 10px;
            top: 10px;
            max-width: none;
        }
        
        .toast {
            min-width: auto;
            transform: translateY(-100px);
        }
        
        @keyframes slideInToast {
            to { transform: translateY(0); }
        }
        
        /* Mobile dark mode improvements */
        @media (prefers-color-scheme: dark) {
            .progress-modal {
                margin: 2rem 1rem !important;
                padding: 2rem 1.5rem !important;
                max-width: calc(100vw - 2rem) !important;
            }
            
            .progress-modal .btn {
                width: 100% !important;
                padding: 1rem !important;
                margin-top: 1.5rem !important;
            }
        }
        
        body.dark-mode .progress-modal {
            margin: 2rem 1rem !important;
            padding: 2rem 1.5rem !important;
            max-width: calc(100vw - 2rem) !important;
        }
    }

    /* Utility Classes */
    .text-center { text-align: center; }
    .text-left { text-align: left; }
    .text-right { text-align: right; }
    .font-weight-bold { font-weight: 600; }
    .text-muted { color: #6c757d; }
    .text-primary { color: var(--primary-solid); }
    .text-success { color: var(--success-solid); }
    .text-warning { color: var(--warning-solid); }
    .text-danger { color: var(--danger-solid); }
    .d-flex { display: flex; }
    .d-none { display: none; }
    .justify-content-center { justify-content: center; }
    .justify-content-between { justify-content: space-between; }
    .align-items-center { align-items: center; }
    .w-100 { width: 100%; }
    .mt-2 { margin-top: 1rem; }
    .mt-4 { margin-top: 2rem; }
    .mb-2 { margin-bottom: 1rem; }
    .mb-4 { margin-bottom: 2rem; }

    /* Accessibility */
    @media (prefers-reduced-motion: reduce) {
        *,
        *::before,
        *::after {
            animation-duration: 0.01ms !important;
            animation-iteration-count: 1 !important;
            transition-duration: 0.01ms !important;
        }
        
        .progress-fill::after {
            display: none;
        }
    }

    @media (prefers-contrast: high) {
        .card,
        .result-card {
            border: 2px solid #000000;
        }
        
        .btn {
            border: 2px solid;
        }
        
        @media (prefers-color-scheme: dark) {
            .progress-modal {
                border: 2px solid var(--dark-accent-primary) !important;
            }
            
            .progress-modal h3,
            .progress-modal p {
                color: #ffffff !important;
            }
        }
    }

    /* Custom scrollbars */
    ::-webkit-scrollbar {
        width: 8px;
    }

    ::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
        background: var(--primary-solid);
        border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
        background: #5a6fd8;
    }

    /* Loading states */
    .loading {
        position: relative;
        pointer-events: none;
    }

    .loading::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    .shortcut-indicator {
        position: fixed;
        bottom: 20px;
        left: 20px;
        background: rgba(0,0,0,0.8);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-size: 0.8rem;
        opacity: 0;
        transition: var(--transition);
        z-index: var(--z-index-tooltip);
    }

    .shortcut-indicator.show {
        opacity: 1;
    }
</style>

</head>

<body>
    <!-- Skip Links for Accessibility -->
    <a href="#main-content" class="skip-link">Skip to main content</a>
    <a href="#navigation" class="skip-link">Skip to navigation</a>

<div class="app-container">
    <!-- Enhanced Header -->
    <header class="app-header" id="app-header" role="banner">
        <div class="header-content">
            <div class="app-title">
                <span style="font-size: 2.5rem;" role="img" aria-label="House">üè†</span>
                <div>
                    <h1>Immobilien-Steuer-Suite 2025</h1>
                    <div class="subtitle">Ultimate Enterprise Enhanced ‚Ä¢ KI ‚Ä¢ Real-time ‚Ä¢ PDF Reports ‚Ä¢ Multi-Scenario</div>
                </div>
            </div>
            <div class="header-actions">
                <div class="performance-indicator" role="status" aria-live="polite">
                    <div class="performance-dot"></div>
                    <span id="performance-text">System wird geladen...</span>
                </div>
                <button class="btn btn-primary" onclick="app.exportPDFReport()" title="PDF-Bericht exportieren (Ctrl+P)">
                    üìä PDF Report
                </button>
                <button class="btn btn-success" onclick="app.loadExample()" title="Beispieldaten laden (Ctrl+E)">
                    üí° Beispiel
                </button>
                <button class="btn btn-warning" onclick="app.showComparison()" title="Multi-Szenario Vergleich (Ctrl+M)">
                    üìà Vergleich
                </button>
                <button class="btn btn-secondary" onclick="app.resetAll()" title="Alles zur√ºcksetzen (Ctrl+R)">
                    üîÑ Reset
                </button>
            </div>
        </div>
    </header>

    <div class="main-content">
        <!-- Sidebar Navigation -->
        <aside class="sidebar" id="navigation" role="navigation" aria-label="Hauptnavigation">
            <nav>
                <ul class="nav-menu" role="menubar">
                    <li class="nav-item" role="none">
                        <a href="#verkauf" class="nav-link active" data-section="verkauf" role="menuitem" aria-current="page">
                            <span class="nav-icon" role="img" aria-label="Geld">üí∞</span>
                            Verkaufssteuer
                            <span class="nav-badge">AI</span>
                        </a>
                    </li>
                    <li class="nav-item" role="none">
                        <a href="#grundsteuer" class="nav-link" data-section="grundsteuer" role="menuitem">
                            <span class="nav-icon" role="img" aria-label="Geb√§ude">üèõÔ∏è</span>
                            Grundsteuer 2025
                        </a>
                    </li>
                    <li class="nav-item" role="none">
                        <a href="#erbschaft" class="nav-link" data-section="erbschaft" role="menuitem">
                            <span class="nav-icon" role="img" aria-label="Familie">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</span>
                            Erbschaftsteuer
                        </a>
                    </li>
                    <li class="nav-item" role="none">
                        <a href="#schenkung" class="nav-link" data-section="schenkung" role="menuitem">
                            <span class="nav-icon" role="img" aria-label="Geschenk">üéÅ</span>
                            Schenkungssteuer
                        </a>
                    </li>
                    <li class="nav-item" role="none">
                        <a href="#cashflow" class="nav-link" data-section="cashflow" role="menuitem">
                            <span class="nav-icon" role="img" aria-label="Diagramm">üìä</span>
                            Cash-Flow Analyse
                        </a>
                    </li>
                    <li class="nav-item" role="none">
                        <a href="#strategie" class="nav-link" data-section="strategie" role="menuitem">
                            <span class="nav-icon" role="img" aria-label="Ziel">üéØ</span>
                            Gesamtstrategie
                        </a>
                    </li>
                    <li class="nav-item" role="none">
                        <a href="#calculations" class="nav-link" data-section="calculations" role="menuitem" onclick="app.loadCalculationsFrame()">
                            <span class="nav-icon" role="img" aria-label="Rechner">üßÆ</span>
                            Calculations
                        </a>
                    </li>
                </ul>
            </nav>

            <!-- Plugin Architecture -->
            <div class="card" style="margin-top: 2rem;">
                <div class="card-header">
                    <h3 style="font-size: 1rem;">üîå Verf√ºgbare Plugins</h3>
                </div>
                <div class="plugin-list" role="list">
                    <div class="plugin-item" onclick="app.loadPlugin('bundesland-analyzer')" role="listitem" tabindex="0">
                        <strong>üó∫Ô∏è Bundesland-Analyzer</strong>
                        <small>Steuervergleich nach Bundesl√§ndern</small>
                    </div>
                    <div class="plugin-item" onclick="app.loadPlugin('inflation-calculator')" role="listitem" tabindex="0">
                        <strong>üìä Inflations-Rechner</strong>
                        <small>Ber√ºcksichtigung der Inflation</small>
                    </div>
                    <div class="plugin-item" onclick="app.loadPlugin('ai-optimizer')" role="listitem" tabindex="0">
                        <strong>ü§ñ KI-Optimierer</strong>
                        <small>Machine Learning Vorhersagen</small>
                    </div>
                    <div class="plugin-item" onclick="app.loadPlugin('international-tax')" role="listitem" tabindex="0">
                        <strong>üåç International Tax</strong>
                        <small>Cross-Border Optimierung</small>
                    </div>
                </div>
            </div>

            <!-- System Status -->
            <div class="card" style="margin-top: 1rem;">
                <div class="card-header">
                    <h3 style="font-size: 1rem;">‚ö° System Status</h3>
                </div>
                <div style="font-size: 0.8rem;">
                    <div style="margin-bottom: 0.5rem;">
                        <span>API Status:</span> 
                        <span id="api-status" style="color: var(--success-solid);">‚úÖ Online</span>
                    </div>
                    <div style="margin-bottom: 0.5rem;">
                        <span>Cache:</span> 
                        <span id="cache-status" style="color: var(--success-solid);">‚úÖ Aktiv</span>
                    </div>
                    <div style="margin-bottom: 0.5rem;">
                        <span>Fehlerrate:</span> 
                        <span id="error-rate-status">0%</span>
                    </div>
                    <div>
                        <span>Version:</span> 
                        <span style="color: var(--primary-solid);">v4.0.7-enhanced</span>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="content-area" id="main-content" role="main">
            <div id="dynamic-content">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <span role="img" aria-label="Laden">‚è≥</span>
                            <span>System wird initialisiert...</span>
                        </div>
                    </div>
                    <div class="alert alert-info">
                        <p>Die Ultimate Enterprise Tax Suite wird geladen. Bitte warten Sie einen Moment...</p>
                    </div>
                </div>
            </div>
        </main>

        <!-- Analytics Panel -->
        <aside class="analytics-panel" role="complementary" aria-label="Analytics und Statistiken">
            <div class="analytics-header">
                <h3>üìä Real-time Analytics</h3>
            </div>

            <div class="analytics-widget">
                <div class="widget-header">
                    <span class="widget-title">Performance</span>
                    <span class="widget-icon" role="img" aria-label="Blitz">‚ö°</span>
                </div>
                <div class="metric-value" id="calc-time">0ms</div>
                <div class="metric-label">Berechnungszeit</div>
            </div>

            <div class="analytics-widget">
                <div class="widget-header">
                    <span class="widget-title">Optimierung</span>
                    <span class="widget-icon" role="img" aria-label="Ziel">üéØ</span>
                </div>
                <div class="metric-value" id="savings-potential">‚Ç¨0</div>
                <div class="metric-label">Max. Ersparnis</div>
            </div>

            <div class="analytics-widget">
                <div class="widget-header">
                    <span class="widget-title">Steuerquote</span>
                    <span class="widget-icon" role="img" aria-label="Diagramm ansteigend">üìà</span>
                </div>
                <div class="metric-value" id="tax-rate">0%</div>
                <div class="metric-label">Effektive Belastung</div>
                <div class="chart-container">
                    <canvas id="tax-chart" width="200" height="100" aria-label="Steuervergleichsdiagramm"></canvas>
                </div>
            </div>

            <div class="analytics-widget">
                <div class="widget-header">
                    <span class="widget-title">Session</span>
                    <span class="widget-icon" role="img" aria-label="Statistiken">üìä</span>
                </div>
                <div style="font-size: 0.9rem; color: #6c757d;" id="session-stats">
                    <div>Berechnungen: <span id="calc-count">0</span></div>
                    <div>Cache Hits: <span id="cache-hits">0</span></div>
                    <div>Fehlerrate: <span id="error-rate">0%</span></div>
                    <div>Laufzeit: <span id="uptime">0min</span></div>
                </div>
            </div>

            <!-- API Documentation Widget -->
            <div class="analytics-widget">
                <div class="widget-header">
                    <span class="widget-title">API Docs</span>
                    <span class="widget-icon" role="img" aria-label="B√ºcher">üìö</span>
                </div>
                <div style="font-size: 0.8rem;">
                    <div><code>POST /api/calculate</code></div>
                    <div><code>GET /api/structures</code></div>
                    <div><code>POST /api/compare</code></div>
                    <div><code>GET /api/health</code></div>
                    <button class="btn btn-outline" onclick="app.showAPIDocumentation()" style="margin-top: 0.5rem; padding: 0.25rem 0.5rem; font-size: 0.7rem;">
                        üìñ Vollst√§ndige Docs
                    </button>
                </div>
            </div>

            <!-- Error Log Widget -->
            <div class="analytics-widget">
                <div class="widget-header">
                    <span class="widget-title">Error Log</span>
                    <span class="widget-icon" role="img" aria-label="Warnung">‚ö†Ô∏è</span>
                </div>
                <div id="error-log" style="font-size: 0.8rem; max-height: 150px; overflow-y: auto;">
                    <div style="color: var(--success-solid);">‚úÖ Keine Fehler</div>
                </div>
            </div>
        </aside>
    </div>

    <!-- UI Components -->
    <div class="shortcut-indicator" id="shortcut-indicator" role="status" aria-live="polite"></div>

    <div class="history-controls">
        <button class="history-btn" id="undo-btn" onclick="app.undo()" title="R√ºckg√§ngig (Ctrl+Z)" disabled aria-label="R√ºckg√§ngig machen">
            ‚Ü∂
        </button>
        <button class="history-btn" id="redo-btn" onclick="app.redo()" title="Wiederholen (Ctrl+Y)" disabled aria-label="Wiederholen">
            ‚Ü∑
        </button>
    </div>

    <div class="toast-container" id="toast-container" role="status" aria-live="polite"></div>

    <!-- Enhanced Progress Overlay -->
    <div class="progress-overlay" id="progress-overlay" role="dialog" aria-modal="true" aria-labelledby="progress-title">
        <div class="progress-modal">
            <div class="spinner" role="img" aria-label="Laden"></div>
            <h3 id="progress-title">Berechnung l√§uft...</h3>
            <div class="progress-bar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
            <p id="progress-text">KI-Algorithmus analysiert optimale Steuerstrukturen...</p>
            <button class="btn btn-secondary" onclick="app.cancelCalculation()" style="margin-top: 1rem;">
                Abbrechen
            </button>
        </div>
    </div>

    <!-- Modal Overlays -->
    <div class="modal-overlay" id="comparison-modal" role="dialog" aria-modal="true" aria-labelledby="comparison-title">
        <div class="modal" style="max-width: 1200px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <h2 id="comparison-title">üìà Multi-Szenario Vergleich</h2>
                <button onclick="app.closeModal('comparison-modal')" style="background: none; border: none; font-size: 2rem; cursor: pointer;" aria-label="Modal schlie√üen">√ó</button>
            </div>
            <div id="comparison-content"></div>
        </div>
    </div>

    <div class="modal-overlay" id="api-docs-modal" role="dialog" aria-modal="true" aria-labelledby="api-docs-title">
        <div class="modal" style="max-width: 800px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <h2 id="api-docs-title">üìö API Dokumentation</h2>
                <button onclick="app.closeModal('api-docs-modal')" style="background: none; border: none; font-size: 2rem; cursor: pointer;" aria-label="Modal schlie√üen">√ó</button>
            </div>
            <div id="api-docs-content">
                <h3>Immobilien-Steuer-Suite API v4.0 Enhanced</h3>
                <div class="alert alert-info">
                    <p><strong>Base URL:</strong> <code>https://api.steuer-suite.de/v4/</code></p>
                    <p><strong>Authentication:</strong> Bearer Token erforderlich</p>
                </div>
                <pre style="background: #f8f9fa; padding: 1rem; border-radius: 8px; overflow-x: auto;">

<strong>POST /api/v4/calculate</strong>
{
‚Äútype‚Äù: ‚Äúverkauf‚Äù,
‚Äúdata‚Äù: {
‚Äúkaufpreis‚Äù: 400000,
‚Äúverkaufspreis‚Äù: 600000,
‚Äúhaltedauer‚Äù: 8,
‚Äústeuersatz‚Äù: 42,
‚Äúbundesland‚Äù: ‚Äúnw‚Äù
}
}

<strong>Response:</strong>
{
‚Äúsuccess‚Äù: true,
‚Äústructures‚Äù: [‚Ä¶],
‚Äúoptimal‚Äù: {‚Ä¶},
‚Äúsavings‚Äù: 45000,
‚ÄúcalculationTime‚Äù: ‚Äú45ms‚Äù,
‚ÄúcacheHit‚Äù: false
}

<strong>GET /api/v4/health</strong>
Response: {‚Äústatus‚Äù: ‚Äúok‚Äù, ‚Äúversion‚Äù: ‚Äú4.0.0‚Äù, ‚Äúuptime‚Äù: 123456}

<strong>POST /api/v4/compare</strong>
Compare multiple scenarios

<strong>GET /api/v4/plugins</strong>
List available plugins
</pre>
</div>
</div>
</div>
</div>

<!-- Enhanced Web Worker Script -->
<script id="worker-script" type="text/plain">
    class EnhancedTaxCalculatorWorker {
        constructor() {
            this.cache = new Map();
            this.calculationHistory = [];
            this.version = '4.0.0-enhanced';
        }

        calculate(data) {
            try {
                const startTime = performance.now();
                const cacheKey = this.generateCacheKey(data);
                
                if (this.cache.has(cacheKey)) {
                    const cachedResult = this.cache.get(cacheKey);
                    return {
                        ...cachedResult,
                        cacheHit: true,
                        calculationTime: 0
                    };
                }

                const results = this.performCalculation(data);
                const calculationTime = performance.now() - startTime;
                
                const finalResults = {
                    ...results,
                    cacheHit: false,
                    calculationTime: Math.round(calculationTime),
                    timestamp: new Date().toISOString(),
                    version: this.version
                };

                this.cache.set(cacheKey, finalResults);
                this.limitCacheSize();
                
                this.calculationHistory.push({
                    data,
                    results: finalResults,
                    timestamp: finalResults.timestamp
                });

                return finalResults;
            } catch (error) {
                throw new Error(`Calculation failed: ${error.message}`);
            }
        }

        generateCacheKey(data) {
            return JSON.stringify(data, Object.keys(data).sort());
        }

        limitCacheSize() {
            if (this.cache.size > 100) {
                const firstKey = this.cache.keys().next().value;
                this.cache.delete(firstKey);
            }
        }

        performCalculation(data) {
            this.validateInput(data);
            
            const anschaffungskosten = (data.kaufpreis || 0) + (data.nebenkosten_kauf || 0) + (data.modernisierung || 0);
            const grossProfit = (data.verkaufspreis || 0) - (data.nebenkosten_verkauf || 0) - anschaffungskosten;
            
            if (grossProfit <= 0) {
                return { 
                    grossProfit, 
                    structures: [],
                    message: 'Kein steuerpflichtiger Gewinn vorhanden'
                };
            }

            const structures = this.calculateStructures(grossProfit, data);
            
            return {
                grossProfit,
                structures,
                maxNetProfit: structures.length > 0 ? structures[0].netProfit : 0,
                totalSavings: structures.length > 1 ? structures[0].netProfit - structures[structures.length - 1].netProfit : 0,
                recommendation: this.generateRecommendation(structures, data)
            };
        }

        validateInput(data) {
            const required = ['kaufpreis', 'verkaufspreis', 'haltedauer'];
            const missing = required.filter(field => !data[field] && data[field] !== 0);
            
            if (missing.length > 0) {
                throw new Error(`Required fields missing: ${missing.join(', ')}`);
            }

            if (data.kaufpreis < 0 || data.verkaufspreis < 0) {
                throw new Error('Preise m√ºssen positiv sein');
            }

            if (data.haltedauer < 0 || data.haltedauer > 100) {
                throw new Error('Haltedauer muss zwischen 0 und 100 Jahren liegen');
            }
        }

        calculateStructures(grossProfit, data) {
            const baseTax = this.calculateSpeculationTax(grossProfit, data.haltedauer, data.steuersatz, data.kirchensteuer);
            const structures = [];

            const structureConfigs = [
                { name: 'Privatverkauf', factor: 1.0, minProfit: 0, complexity: 'niedrig' },
                { name: 'VV GmbH & Co. KG (BFH 2025)', factor: 0.85, minProfit: 0, complexity: 'mittel' },
                { name: 'Familienpool (GbR)', factor: 0.75, minProfit: 50000, complexity: 'mittel' },
                { name: 'Share Deal (GmbH)', factor: 0.60, minProfit: 100000, complexity: 'hoch' },
                { name: 'Cross-Border Holding (Luxemburg)', factor: 0.45, minProfit: 500000, complexity: 'sehr hoch' },
                { name: 'Cross-Border Struktur (Niederlande)', factor: 0.50, minProfit: 500000, complexity: 'sehr hoch' },
                { name: 'Familienstiftung', factor: 0.35, minProfit: 1000000, complexity: 'sehr hoch' },
                { name: 'Stiftung & Co. KG', factor: 0.40, minProfit: 1000000, complexity: 'sehr hoch' }
            ];

            for (const config of structureConfigs) {
                if (grossProfit >= config.minProfit) {
                    const tax = baseTax * config.factor;
                    const netProfit = grossProfit - tax;
                    
                    structures.push({
                        name: config.name,
                        grossProfit,
                        tax,
                        netProfit,
                        taxRate: grossProfit > 0 ? (tax / grossProfit * 100) : 0,
                        complexity: config.complexity,
                        advantages: this.getAdvantages(config.name),
                        disadvantages: this.getDisadvantages(config.name),
                        recommendation: this.getRecommendation(config.name, data),
                        implementationTime: this.getImplementationTime(config.complexity),
                        costs: this.getImplementationCosts(config.complexity, grossProfit),
                        isBest: false
                    });
                }
            }

            structures.sort((a, b) => b.netProfit - a.netProfit);
            if (structures.length > 0) {
                structures[0].isBest = true;
            }

            return structures;
        }

        calculateSpeculationTax(profit, holdingPeriod, taxRate, churchTax) {
            if (holdingPeriod >= 10) return 0;
            
            const incomeTax = profit * ((taxRate || 42) / 100);
            const churchTaxAmount = incomeTax * ((churchTax || 0) / 100);
            const solidarityTax = incomeTax * 0.055;
            
            return incomeTax + churchTaxAmount + solidarityTax;
        }

        getAdvantages(structureName) {
            const advantages = {
                'Privatverkauf': ['Steuerfrei nach 10 Jahren', 'Einfachste Abwicklung', 'Keine Gr√ºndungskosten', 'Sofort umsetzbar'],
                'VV GmbH & Co. KG (BFH 2025)': ['BFH 2025: Gewerbesteuerfrei!', 'Haftungsbeschr√§nkung', 'Flexibilit√§t bei Gesellschafterwechsel', 'Steuerliche Transparenz'],
                'Familienpool (GbR)': ['Steuerverteilung auf Familie', 'Progression brechen', 'Transparente Besteuerung', 'Einfache Verwaltung'],
                'Share Deal (GmbH)': ['40% steuerfreier Gewinn (¬ß8b KStG)', 'Keine Grunderwerbsteuer', 'Planungssicherheit', 'Professionelle Struktur'],
                'Cross-Border Holding (Luxemburg)': ['EU-Holding-Richtlinie', 'Internationale Steueroptimierung', 'Niedrige Substanzsteuer', 'EU-weit anerkannt'],
                'Cross-Border Struktur (Niederlande)': ['Doppelbesteuerungsabkommen', 'EU-konform', 'Steuerliche Transparenz', 'Niedrige K√∂rperschaftsteuer'],
                'Familienstiftung': ['Generationen√ºbergreifend', 'Verm√∂gensschutz', 'Erbschaftsteueroptimierung', 'Langfristige Planung'],
                'Stiftung & Co. KG': ['Flexible Gewinnverteilung', 'Haftungsbeschr√§nkung', 'Steueroptimierung', 'Professionelle Verwaltung']
            };
            return advantages[structureName] || [];
        }

        getDisadvantages(structureName) {
            const disadvantages = {
                'Privatverkauf': ['Spekulationssteuer unter 10 Jahren', 'Keine Optimierungsm√∂glichkeiten', 'Volle Steuerlast'],
                'VV GmbH & Co. KG (BFH 2025)': ['Komplexere Struktur', 'Gr√ºndungskosten 5.000-15.000‚Ç¨', 'Laufende Verwaltung', 'Gesellschaftsvertrag n√∂tig'],
                'Familienpool (GbR)': ['Mehrere Gesellschafter n√∂tig', 'Gesellschaftsvertrag erforderlich', 'Einstimmigkeit bei Entscheidungen'],
                'Share Deal (GmbH)': ['Mindestens 5% Beteiligung', 'GmbH-Gr√ºndung erforderlich', 'Komplexe Struktur', 'Hohe Verwaltungskosten'],
                'Cross-Border Holding (Luxemburg)': ['Hohe Beratungskosten 50.000-100.000‚Ç¨', 'Komplexe Struktur', 'Substanzanforderungen', 'Compliance-Aufwand'],
                'Cross-Border Struktur (Niederlande)': ['Internationale Struktur', 'Compliance-Aufwand', 'Beratungsintensiv', 'W√§hrungsrisiko'],
                'Familienstiftung': ['Hohe Gr√ºndungskosten 100.000-300.000‚Ç¨', 'Komplexe Verwaltung', 'Bindungswirkung', 'Langfristige Festlegung'],
                'Stiftung & Co. KG': ['Sehr komplex', 'Hohe Kosten 150.000‚Ç¨+', 'Verwaltungsaufwand', 'Regulatorische Anforderungen']
            };
            return disadvantages[structureName] || [];
        }

        getRecommendation(structureName, data) {
            if (data.haltedauer >= 10) return 'Optimal bei steuerfreiem Verkauf - sofort umsetzbar';
            if (structureName.includes('Cross-Border')) return 'F√ºr internationale Gro√üinvestoren - professionelle Beratung erforderlich';
            if (structureName.includes('Stiftung')) return 'F√ºr sehr hohe Verm√∂gen - langfristige Familienplanung';
            if (structureName.includes('Share Deal')) return 'Sehr gut f√ºr gr√∂√üere Gewinne - mittelfristige Umsetzung';
            if (structureName.includes('Familienpool')) return 'Optimal f√ºr Familien - schnell umsetzbar';
            if (structureName.includes('VV GmbH')) return 'Ausgezeichnet nach BFH-Urteil 2025 - sehr empfehlenswert';
            return 'Empfehlenswert nach individueller Pr√ºfung';
        }

        getImplementationTime(complexity) {
            const timeframes = {
                'niedrig': '1-2 Wochen',
                'mittel': '1-3 Monate',
                'hoch': '3-6 Monate',
                'sehr hoch': '6-12 Monate'
            };
            return timeframes[complexity] || 'Unbestimmt';
        }

        getImplementationCosts(complexity, grossProfit) {
            const baseCosts = {
                'niedrig': 1000,
                'mittel': 10000,
                'hoch': 30000,
                'sehr hoch': 100000
            };
            
            const base = baseCosts[complexity] || 0;
            const percentage = grossProfit > 1000000 ? 0.02 : 0.01;
            
            return Math.max(base, grossProfit * percentage);
        }

        generateRecommendation(structures, data) {
            if (structures.length === 0) {
                return 'Keine Optimierung m√∂glich bei diesem Gewinn.';
            }

            const best = structures[0];
            const savings = structures.length > 1 ? best.netProfit - structures[structures.length - 1].netProfit : 0;
            
            let recommendation = `Empfehlung: ${best.name} bietet mit ${this.formatCurrency(best.netProfit)} den h√∂chsten Nettogewinn.`;
            
            if (savings > 0) {
                recommendation += ` Ersparnis: ${this.formatCurrency(savings)} gegen√ºber ung√ºnstigster Option.`;
            }

            if (data.haltedauer >= 10) {
                recommendation += ' Da die 10-Jahres-Frist erf√ºllt ist, ist der Verkauf bereits steuerfrei!';
            }

            return recommendation;
        }

        formatCurrency(amount) {
            return new Intl.NumberFormat('de-DE', {
                style: 'currency',
                currency: 'EUR',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount || 0);
        }

        getCacheStats() {
            return {
                size: this.cache.size,
                calculations: this.calculationHistory.length,
                hitRate: this.calculationHistory.filter(c => c.results.cacheHit).length / Math.max(1, this.calculationHistory.length)
            };
        }
    }

    const calculator = new EnhancedTaxCalculatorWorker();

    self.onmessage = function(e) {
        const { id, data, type } = e.data;
        try {
            let result;
            
            switch(type) {
                case 'calculate':
                    result = calculator.calculate(data);
                    break;
                case 'getCacheStats':
                    result = calculator.getCacheStats();
                    break;
                default:
                    result = calculator.calculate(data);
            }
            
            self.postMessage({ id, result, success: true });
        } catch (error) {
            self.postMessage({ 
                id, 
                error: {
                    message: error.message,
                    stack: error.stack,
                    timestamp: new Date().toISOString()
                }, 
                success: false 
            });
        }
    };
</script>

<script>
    // Dark Mode Management System
    class DarkModeManager {
        constructor() {
            this.isDarkMode = false;
            this.prefersDark = window.matchMedia('(prefers-color-scheme: dark)');
            this.init();
        }

        init() {
            const savedMode = this.getSavedPreference();
            if (savedMode !== null) {
                this.isDarkMode = savedMode === 'dark';
            } else {
                this.isDarkMode = this.prefersDark.matches;
            }

            this.applyMode();
            this.createToggleButton();
            
            this.prefersDark.addEventListener('change', (e) => {
                if (this.getSavedPreference() === null) {
                    this.isDarkMode = e.matches;
                    this.applyMode();
                    this.updateToggleButton();
                }
            });
        }

        createToggleButton() {
            const existingToggle = document.getElementById('dark-mode-toggle');
            if (existingToggle) {
                existingToggle.remove();
            }

            const toggle = document.createElement('button');
            toggle.id = 'dark-mode-toggle';
            toggle.className = 'dark-mode-toggle';
            toggle.setAttribute('aria-label', 'Toggle dark mode');
            toggle.setAttribute('title', 'Toggle dark mode');
            
            const headerActions = document.querySelector('.header-actions');
            if (headerActions) {
                headerActions.appendChild(toggle);
            }

            toggle.addEventListener('click', () => {
                this.toggle();
            });

            this.updateToggleButton();
        }

        updateToggleButton() {
            const toggle = document.getElementById('dark-mode-toggle');
            if (toggle) {
                toggle.innerHTML = this.isDarkMode ? '‚òÄÔ∏è' : 'üåô';
                toggle.style.background = this.isDarkMode ? 'rgba(88, 166, 255, 0.9)' : 'rgba(0, 0, 0, 0.7)';
                toggle.style.borderColor = this.isDarkMode ? 'rgba(88, 166, 255, 0.3)' : 'rgba(255, 255, 255, 0.2)';
            }
        }

        toggle() {
            this.isDarkMode = !this.isDarkMode;
            this.applyMode();
            this.savePreference();
            this.updateToggleButton();
            
            window.dispatchEvent(new CustomEvent('darkModeChanged', {
                detail: { isDarkMode: this.isDarkMode }
            }));

            if (window.app?.gaTracker) {
                window.app.gaTracker.trackFeatureUsage('dark_mode', 'toggled', this.isDarkMode ? 'enabled' : 'disabled');
            }

            if (window.app?.showToast) {
                window.app.showToast(
                    `Dark mode ${this.isDarkMode ? 'enabled' : 'disabled'}`, 
                    'info'
                );
            }
        }

        applyMode() {
            const body = document.body;
            
            if (this.isDarkMode) {
                body.classList.add('dark-mode');
                this.updateMetaThemeColor('#0d1117');
            } else {
                body.classList.remove('dark-mode');
                this.updateMetaThemeColor('#3498db');
            }

            body.style.transition = 'background-color 0.3s ease, color 0.3s ease';
            this.updateChartTheme();
            this.updateDynamicElements();
        }

        updateMetaThemeColor(color) {
            let themeColor = document.querySelector('meta[name="theme-color"]');
            if (!themeColor) {
                themeColor = document.createElement('meta');
                themeColor.name = 'theme-color';
                document.head.appendChild(themeColor);
            }
            themeColor.content = color;
        }

        updateChartTheme() {
            if (typeof Chart !== 'undefined' && window.app?.chart) {
                const textColor = this.isDarkMode ? '#f0f6fc' : '#2c3e50';
                const gridColor = this.isDarkMode ? '#30363d' : '#e9ecef';
                
                Chart.defaults.color = textColor;
                Chart.defaults.borderColor = gridColor;
                Chart.defaults.backgroundColor = this.isDarkMode ? '#21262d' : '#ffffff';
                
                if (window.app.chart) {
                    window.app.chart.options.scales.x.ticks.color = textColor;
                    window.app.chart.options.scales.y.ticks.color = textColor;
                    window.app.chart.options.scales.x.grid.color = gridColor;
                    window.app.chart.options.scales.y.grid.color = gridColor;
                    window.app.chart.update();
                }
            }
        }

        updateDynamicElements() {
            const performanceIndicator = document.querySelector('.performance-indicator');
            if (performanceIndicator) {
                if (this.isDarkMode) {
                    performanceIndicator.style.background = 'rgba(63, 185, 80, 0.2)';
                    performanceIndicator.style.borderColor = 'rgba(63, 185, 80, 0.3)';
                } else {
                    performanceIndicator.style.background = 'rgba(17, 153, 142, 0.1)';
                    performanceIndicator.style.borderColor = 'transparent';
                }
            }
        }

        savePreference() {
            try {
                localStorage.setItem('darkModePreference', this.isDarkMode ? 'dark' : 'light');
            } catch (error) {
                console.warn('Could not save dark mode preference:', error);
            }
        }

        getSavedPreference() {
            try {
                return localStorage.getItem('darkModePreference');
            } catch (error) {
                console.warn('Could not read dark mode preference:', error);
                return null;
            }
        }
    }

    // Enhanced Google Analytics Tracker
    class GoogleAnalyticsTracker {
        constructor() {
            this.isInitialized = false;
            this.sessionStartTime = Date.now();
            this.pageLoadTime = performance.timing ? 
                performance.timing.loadEventEnd - performance.timing.navigationStart : 0;
            this.userSegment = this.determineUserSegment();
            this.setupEngagementTracking();
        }

        init() {
            if (typeof gtag !== 'undefined' && window.cookieConsent.analytics) {
                this.isInitialized = true;
                this.trackPageLoad();
                this.trackUserSegment();
                console.log('Analytics tracking initialized');
            }
        }

        trackEvent(eventName, parameters = {}) {
            if (!this.isInitialized || typeof gtag === 'undefined') return;

            const enrichedParams = {
                ...parameters,
                user_segment: this.userSegment,
                session_duration: this.getSessionDuration(),
                page_load_time: this.pageLoadTime,
                timestamp: new Date().toISOString()
            };

            gtag('event', eventName, enrichedParams);
        }

        trackCalculation(calculationType, inputData, results) {
            this.trackEvent('tax_calculation', {
                event_category: 'Tax Calculations',
                calculation_type: calculationType,
                input_value: inputData.verkaufspreis || inputData.immobilienwert || 0,
                result_count: results?.structures?.length || 0,
                max_savings: results?.totalSavings || 0,
                calculation_time: results?.calculationTime || 0,
                cache_hit: results?.cacheHit || false
            });

            if (inputData.verkaufspreis > 1000000) {
                this.trackEvent('high_value_calculation', {
                    event_category: 'Premium Usage',
                    value: inputData.verkaufspreis
                });
            }
        }

        trackUserJourney(step, action, details = {}) {
            this.trackEvent('user_journey', {
                event_category: 'User Journey',
                journey_step: step,
                journey_action: action,
                ...details
            });
        }

        trackFeatureUsage(feature, action, value = null) {
            this.trackEvent('feature_usage', {
                event_category: 'Feature Interaction',
                feature_name: feature,
                feature_action: action,
                feature_value: value,
                user_segment: this.userSegment
            });
        }

        trackPDFExport(success, calculationType, dataSize) {
            this.trackEvent('pdf_export', {
                event_category: 'Document Generation',
                export_success: success,
                calculation_type: calculationType,
                data_size: dataSize
            });

            if (success) {
                this.trackConversion('pdf_generated', 1);
            }
        }

        trackError(errorType, errorMessage, errorContext = {}) {
            this.trackEvent('error_occurred', {
                event_category: 'Errors',
                error_type: errorType,
                error_message: errorMessage.substring(0, 150),
                error_context: JSON.stringify(errorContext).substring(0, 500)
            });
        }

        trackPerformance(metricName, value, context = {}) {
            this.trackEvent('performance_metric', {
                event_category: 'Performance',
                metric_name: metricName,
                metric_value: value,
                ...context
            });
        }

        trackConversion(conversionType, value = 1) {
            this.trackEvent('conversion', {
                event_category: 'Conversions',
                conversion_type: conversionType,
                value: value,
                user_segment: this.userSegment
            });
        }

        trackPluginUsage(pluginName, action) {
            this.trackEvent('plugin_interaction', {
                event_category: 'Plugins',
                plugin_name: pluginName,
                plugin_action: action
            });
        }

        setupEngagementTracking() {
            let maxScrollDepth = 0;
            let totalTimeOnPage = 0;
            let lastActiveTime = Date.now();

            window.addEventListener('scroll', () => {
                const scrollPercent = Math.round(
                    (window.scrollY / (document.body.scrollHeight - window.innerHeight)) * 100
                );
                maxScrollDepth = Math.max(maxScrollDepth, scrollPercent);
            });

            setInterval(() => {
                if (document.hasFocus()) {
                    totalTimeOnPage += 1000;
                    lastActiveTime = Date.now();
                }
            }, 1000);

            window.addEventListener('beforeunload', () => {
                this.trackEngagement(totalTimeOnPage, maxScrollDepth);
            });
        }

        trackEngagement(timeOnPage, scrollDepth) {
            this.trackEvent('user_engagement', {
                event_category: 'Engagement',
                engagement_time_msec: timeOnPage,
                scroll_depth: scrollDepth,
                session_duration: this.getSessionDuration()
            });
        }

        determineUserSegment() {
            const userAgent = navigator.userAgent;
            const screenWidth = window.screen.width;
            const language = navigator.language;
            
            let segment = 'standard_user';

            if (screenWidth < 768) segment = 'mobile_user';
            else if (screenWidth > 1920) segment = 'desktop_power_user';

            if (userAgent.includes('Chrome') && screenWidth > 1440) {
                segment = 'professional_user';
            }

            if (!language.startsWith('de')) {
                segment = 'international_user';
            }

            return segment;
        }

        getSessionDuration() {
            return Math.round((Date.now() - this.sessionStartTime) / 1000);
        }

        trackPageLoad() {
            this.trackEvent('page_load_complete', {
                event_category: 'Page Performance',
                page_load_time: this.pageLoadTime,
                user_segment: this.userSegment
            });
        }

        trackPageView(pageTitle = '', pageLocation = '') {
            if (!this.isInitialized || typeof gtag === 'undefined') return;

            gtag('config', 'GA_MEASUREMENT_ID', {
                page_title: pageTitle,
                page_location: pageLocation || window.location.href,
                user_segment: this.userSegment,
                session_duration: this.getSessionDuration()
            });

            this.trackEvent('page_view', {
                event_category: 'Navigation',
                page_title: pageTitle,
                page_location: pageLocation,
                user_segment: this.userSegment
            });
        }

        trackUserSegment() {
            this.trackEvent('user_segment_identified', {
                event_category: 'User Segmentation',
                segment: this.userSegment,
                screen_resolution: `${window.screen.width}x${window.screen.height}`,
                language: navigator.language
            });
        }
    }

    // Cookie Consent Manager
    class CookieConsentManager {
        constructor() {
            this.consentGiven = false;
            this.showBanner();
        }

        showBanner() {
            const existingConsent = this.getSafeLocalStorage('cookie_consent');
            if (existingConsent) {
                try {
                    const consent = JSON.parse(existingConsent);
                    window.cookieConsent = consent;
                    if (consent.analytics) {
                        this.initializeAnalytics();
                    }
                    return;
                } catch (error) {
                    console.warn('Invalid consent data in localStorage');
                    this.clearSavedConsent();
                }
            }

            const banner = document.createElement('div');
            banner.id = 'cookie-consent-banner';
            banner.style.cssText = `
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 1rem 2rem;
                z-index: 10000;
                box-shadow: 0 -4px 20px rgba(0,0,0,0.3);
                display: flex;
                align-items: center;
                justify-content: space-between;
                flex-wrap: wrap;
                gap: 1rem;
            `;

            banner.innerHTML = `
                <div style="flex: 1; min-width: 300px;">
                    <h3 style="margin: 0 0 0.5rem 0; font-size: 1.1rem;">Cookie-Einstellungen</h3>
                    <p style="margin: 0; font-size: 0.9rem; opacity: 0.9;">
                        Wir verwenden Cookies f√ºr Analytics und zur Verbesserung der Benutzererfahrung. 
                        Sie k√∂nnen Ihre Pr√§ferenzen jederzeit anpassen.
                    </p>
                </div>
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                    <button id="accept-all-cookies" style="background: white; color: #667eea; border: none; padding: 0.75rem 1.5rem; border-radius: 6px; font-weight: 600; cursor: pointer;">
                        Alle akzeptieren
                    </button>
                    <button id="accept-necessary-cookies" style="background: transparent; color: white; border: 2px solid white; padding: 0.75rem 1.5rem; border-radius: 6px; font-weight: 600; cursor: pointer;">
                        Nur notwendige
                    </button>
                </div>
            `;

            document.body.appendChild(banner);

            document.getElementById('accept-all-cookies').onclick = () => this.acceptAll();
            document.getElementById('accept-necessary-cookies').onclick = () => this.acceptNecessary();
        }

        acceptAll() {
            window.cookieConsent = {
                analytics: true,
                marketing: true,
                functional: true
            };
            this.saveConsent();
            this.initializeAnalytics();
            this.removeBanner();
        }

        acceptNecessary() {
            window.cookieConsent = {
                analytics: false,
                marketing: false,
                functional: true
            };
            this.saveConsent();
            this.removeBanner();
        }

        saveConsent() {
            try {
                this.setSafeLocalStorage('cookie_consent', JSON.stringify(window.cookieConsent));
                this.setSafeLocalStorage('cookie_consent_date', new Date().toISOString());
            } catch (error) {
                console.warn('Could not save cookie consent to localStorage');
            }
        }

        clearSavedConsent() {
            try {
                localStorage.removeItem('cookie_consent');
                localStorage.removeItem('cookie_consent_date');
            } catch (error) {
                console.warn('Could not clear consent from localStorage');
            }
        }

        getSafeLocalStorage(key) {
            try {
                return localStorage.getItem(key);
            } catch (error) {
                console.warn('localStorage not available');
                return null;
            }
        }

        setSafeLocalStorage(key, value) {
            try {
                localStorage.setItem(key, value);
            } catch (error) {
                console.warn('Could not save to localStorage');
            }
        }

        initializeAnalytics() {
            if (typeof gtag !== 'undefined') {
                gtag('consent', 'update', {
                    'analytics_storage': 'granted',
                    'ad_storage': window.cookieConsent.marketing ? 'granted' : 'denied'
                });
            }
        }

        removeBanner() {
            const banner = document.getElementById('cookie-consent-banner');
            if (banner) {
                banner.style.transform = 'translateY(100%)';
                setTimeout(() => banner.remove(), 300);
            }
        }
    }

    // Enhanced Error Handler
    class EnhancedErrorHandler {
        constructor() {
            this.errorLog = [];
            this.maxLogSize = 50;
            this.setupGlobalHandlers();
        }

        setupGlobalHandlers() {
            window.addEventListener('error', (event) => {
                this.logError({
                    type: 'JavaScript Error',
                    message: event.message,
                    filename: event.filename,
                    lineno: event.lineno,
                    colno: event.colno,
                    stack: event.error?.stack,
                    timestamp: new Date().toISOString()
                });
            });

            window.addEventListener('unhandledrejection', (event) => {
                this.logError({
                    type: 'Unhandled Promise Rejection',
                    message: event.reason?.message || event.reason,
                    stack: event.reason?.stack,
                    timestamp: new Date().toISOString()
                });
            });
        }

        logError(error) {
            this.errorLog.push(error);
            
            if (this.errorLog.length > this.maxLogSize) {
                this.errorLog.shift();
            }
            
            console.error('Application Error:', error);
            this.updateErrorDisplay();
            this.reportToAnalytics(error);
        }

        updateErrorDisplay() {
            const errorLogElement = document.getElementById('error-log');
            const errorRateElement = document.getElementById('error-rate-status');
            
            if (errorLogElement) {
                if (this.errorLog.length === 0) {
                    errorLogElement.innerHTML = '<div style="color: var(--success-solid);">‚úÖ Keine Fehler</div>';
                } else {
                    const recentErrors = this.errorLog.slice(-5);
                    errorLogElement.innerHTML = recentErrors.map(error => 
                        `<div style="color: var(--danger-solid); margin-bottom: 0.25rem;">
                            <strong>${this.escapeHtml(error.type)}:</strong> ${this.escapeHtml(error.message.substring(0, 50))}...
                            <small style="display: block; color: #6c757d;">${new Date(error.timestamp).toLocaleTimeString()}</small>
                        </div>`
                    ).join('');
                }
            }
            
            if (errorRateElement) {
                const errorRate = this.errorLog.length > 0 ? `${this.errorLog.length} Fehler` : '0%';
                errorRateElement.textContent = errorRate;
                errorRateElement.style.color = this.errorLog.length > 0 ? 'var(--danger-solid)' : 'var(--success-solid)';
            }
        }

        escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        reportToAnalytics(error) {
            if (typeof gtag !== 'undefined') {
                gtag('event', 'exception', {
                    description: error.message,
                    fatal: false
                });
            }
        }

        clearErrors() {
            this.errorLog = [];
            this.updateErrorDisplay();
        }
    }

    // Enhanced PDF Exporter
    class EnhancedPDFExporter {
        constructor() {
            this.jsPDFLibrary = null;
            this.loadAttempts = 0;
            this.maxLoadAttempts = 3;
        }

        async ensureLibraryLoaded() {
            if (this.jsPDFLibrary) return this.jsPDFLibrary;

            const cdnSources = [
                'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js',
                'https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js'
            ];

            for (const source of cdnSources) {
                try {
                    await this.loadFromCDN(source);
                    this.jsPDFLibrary = this.getJsPDFConstructor();
                    if (this.jsPDFLibrary) {
                        console.log('jsPDF loaded successfully from:', source);
                        return this.jsPDFLibrary;
                    }
                } catch (error) {
                    console.warn(`Failed to load jsPDF from ${source}:`, error);
                    continue;
                }
            }

            throw new Error('Failed to load jsPDF library from any CDN source');
        }

        loadFromCDN(url) {
            return new Promise((resolve, reject) => {
                const existingScript = document.querySelector(`script[src="${url}"]`);
                if (existingScript) {
                    existingScript.remove();
                }

                const script = document.createElement('script');
                script.src = url;
                script.onload = () => {
                    setTimeout(resolve, 200);
                };
                script.onerror = () => reject(new Error(`Failed to load ${url}`));
                document.head.appendChild(script);
            });
        }

        getJsPDFConstructor() {
            if (window.jspdf?.jsPDF) return window.jspdf.jsPDF;
            if (window.jsPDF) return window.jsPDF;
            if (typeof jsPDF !== 'undefined') return jsPDF;
            return null;
        }

        async exportReport(data) {
            try {
                const jsPDFConstructor = await this.ensureLibraryLoaded();
                const doc = new jsPDFConstructor({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });

                await this.generatePDFContent(doc, data);
                
                const filename = `Steueroptimierung_${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(filename);
                
                return { success: true, filename };
            } catch (error) {
                console.error('PDF Export failed:', error);
                throw new Error(`PDF-Export fehlgeschlagen: ${error.message}`);
            }
        }

        async generatePDFContent(doc, data) {
            try {
                this.addHeader(doc);
                this.addInputData(doc, data);
                
                if (data.results) {
                    this.addResults(doc, data.results);
                }
                
                this.addFooter(doc);
            } catch (error) {
                console.error('Error generating PDF content:', error);
                throw error;
            }
        }

        addHeader(doc) {
            doc.setFontSize(20);
            doc.setTextColor('#667eea');
            doc.text('Immobilien-Steuer-Suite 2025', 20, 30);
            
            doc.setFontSize(12);
            doc.setTextColor('#000000');
            doc.text('Ultimate Enterprise Enhanced Edition - Steueroptimierung Bericht', 20, 40);
            doc.text(`Erstellt am: ${new Date().toLocaleDateString('de-DE')}`, 20, 50);
            
            doc.setDrawColor('#667eea');
            doc.setLineWidth(0.5);
            doc.line(20, 55, 190, 55);
        }

        addInputData(doc, data) {
            let yPos = 70;
            doc.setFontSize(16);
            doc.setTextColor('#2c3e50');
            doc.text('Eingabedaten:', 20, yPos);
            yPos += 15;
            
            doc.setFontSize(10);
            doc.setTextColor('#000000');
            
            const dataPoints = [
                { label: 'Kaufpreis', value: data.kaufpreis, format: 'currency' },
                { label: 'Verkaufspreis', value: data.verkaufspreis, format: 'currency' },
                { label: 'Haltedauer', value: data.haltedauer, format: 'years' },
                { label: 'Steuersatz', value: data.steuersatz, format: 'percent' }
            ];

            dataPoints.forEach(point => {
                if (point.value !== undefined && point.value !== null) {
                    const formattedValue = this.formatValue(point.value, point.format);
                    doc.text(`${point.label}: ${formattedValue}`, 25, yPos);
                    yPos += 8;
                }
            });
        }

        addResults(doc, results) {
            let yPos = 160;
            
            if (yPos > 250) {
                doc.addPage();
                yPos = 30;
            }
            
            doc.setFontSize(16);
            doc.setTextColor('#2c3e50');
            doc.text('Optimierungsergebnisse:', 20, yPos);
            yPos += 15;
            
            if (results && results.structures && results.structures.length > 0) {
                const best = results.structures[0];
                doc.setFontSize(12);
                doc.setTextColor('#11998e');
                doc.text(`BESTE OPTION: ${best.name}`, 25, yPos);
                yPos += 10;
                
                doc.setFontSize(10);
                doc.setTextColor('#000000');
                doc.text(`Nettogewinn: ${this.formatCurrency(best.netProfit)}`, 25, yPos);
                doc.text(`Steuersatz: ${best.taxRate.toFixed(1)}%`, 25, yPos + 8);
                doc.text(`Steuerbelastung: ${this.formatCurrency(best.tax)}`, 25, yPos + 16);
            }
        }

        addFooter(doc) {
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor('#6c757d');
                
                doc.setDrawColor('#e9ecef');
                doc.line(20, 280, 190, 280);
                
                doc.text(`Seite ${i} von ${pageCount}`, 20, 285);
                doc.text('Immobilien-Steuer-Suite 2025 Ultimate Enterprise Enhanced', 90, 285);
                doc.text(`Erstellt: ${new Date().toLocaleString('de-DE')}`, 20, 290);
            }
        }

        formatValue(value, format) {
            switch (format) {
                case 'currency':
                    return this.formatCurrency(value);
                case 'percent':
                    return `${value}%`;
                case 'years':
                    return `${value} Jahre`;
                default:
                    return value.toString();
            }
        }

        formatCurrency(amount) {
            return new Intl.NumberFormat('de-DE', {
                style: 'currency',
                currency: 'EUR',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount || 0);
        }
    }

    // Main Application Class
    class UltimateImmobilienSuiteEnhanced {
        constructor() {
            this.version = '4.0.0-enhanced';
            this.scenarios = new Map();
            this.currentScenario = 'scenario1';
            this.realtimeEnabled = true;
            this.calculationTimeout = null;
            this.worker = null;
            this.workerMessageId = 0;
            this.workerCallbacks = new Map();
            this.cache = new Map();
            this.analytics = {
                calculations: 0,
                cacheHits: 0,
                errors: 0,
                startTime: Date.now()
            };
            this.plugins = new Map();
            this.keyboardShortcuts = new Map();
            this.chart = null;
            this.isRestoringState = false;
            this.sectionData = {};
            this.cachedElements = new Map();
            this.eventListenersCleanup = new Set();
            
            this.errorHandler = new EnhancedErrorHandler();
            this.pdfExporter = new EnhancedPDFExporter();
            this.gaTracker = new GoogleAnalyticsTracker();
            this.cookieManager = new CookieConsentManager();
            
            this.init();
        }

        async init() {
            console.log('Initializing Ultimate Enterprise Suite Enhanced...');
            
            try {
                this.gaTracker.trackUserJourney('app_start', 'initialization_started');
                
                await this.initializeWebWorker();
                this.setupEventListeners();
                this.setupKeyboardShortcuts();
                this.setupScenarios();
                this.setupPluginArchitecture();
                this.initializeAnalytics();
                this.loadSavedData();
                this.setupAutoSave();
                
                this.gaTracker.init();
                this.loadSectionContent('verkauf');
                
                this.showToast('Ultimate Enterprise Suite Enhanced geladen', 'success');
                this.updatePerformanceIndicator('Ready');
                
                this.gaTracker.trackUserJourney('app_start', 'initialization_completed', {
                    version: this.version,
                    load_time: Date.now() - this.analytics.startTime
                });
                
                console.log('Ultimate Suite Enhanced initialized successfully');
            } catch (error) {
                console.error('Initialization error:', error);
                this.errorHandler.logError(error);
                this.gaTracker.trackError('initialization_error', error.message, { version: this.version });
                this.showToast('Fehler beim Laden: ' + error.message, 'danger');
                this.updatePerformanceIndicator('Error', 'error');
            }
        }

        async initializeWebWorker() {
            if (typeof Worker !== 'undefined') {
                try {
                    const workerScript = document.getElementById('worker-script').textContent;
                    const blob = new Blob([workerScript], { type: 'application/javascript' });
                    const workerUrl = URL.createObjectURL(blob);
                    
                    this.worker = new Worker(workerUrl);
                    this.worker.onmessage = (e) => {
                        const { id, result, error, success } = e.data;
                        const callback = this.workerCallbacks.get(id);
                        
                        if (callback) {
                            clearTimeout(callback.timeoutId);
                            this.workerCallbacks.delete(id);
                            if (success) {
                                callback.resolve(result);
                            } else {
                                this.errorHandler.logError(error);
                                callback.reject(new Error(error.message));
                            }
                        }
                    };
                    
                    this.worker.onerror = (error) => {
                        this.errorHandler.logError({
                            type: 'Web Worker Error',
                            message: error.message,
                            filename: error.filename,
                            lineno: error.lineno
                        });
                    };
                    
                    console.log('Enhanced Web Worker initialized');
                } catch (error) {
                    console.warn('Web Worker not available, using main thread');
                    this.errorHandler.logError(error);
                }
            }
        }

        async calculateInWorker(data, type = 'calculate') {
            return new Promise((resolve, reject) => {
                if (!this.worker) {
                    resolve(this.calculateMainThread(data));
                    return;
                }

                const id = ++this.workerMessageId;
                const timeoutId = setTimeout(() => {
                    if (this.workerCallbacks.has(id)) {
                        this.workerCallbacks.delete(id);
                        reject(new Error('Calculation timeout'));
                    }
                }, 10000);
                
                this.workerCallbacks.set(id, { resolve, reject, timeoutId });
                this.worker.postMessage({ id, data, type });
            });
        }

        calculateMainThread(data) {
            try {
                const anschaffungskosten = (data.kaufpreis || 0) + (data.nebenkosten_kauf || 0) + (data.modernisierung || 0);
                const grossProfit = (data.verkaufspreis || 0) - (data.nebenkosten_verkauf || 0) - anschaffungskosten;
                
                if (grossProfit <= 0) {
                    return { grossProfit, structures: [] };
                }

                const structures = [];
                const baseTax = this.calculateSpeculationTax(grossProfit, data.haltedauer, data.steuersatz, data.kirchensteuer);

                const structureConfigs = [
                    { name: 'Privatverkauf', factor: 1.0, minProfit: 0 },
                    { name: 'VV GmbH & Co. KG (BFH 2025)', factor: 0.85, minProfit: 0 },
                    { name: 'Familienpool (GbR)', factor: 0.75, minProfit: 50000 },
                    { name: 'Share Deal (GmbH)', factor: 0.60, minProfit: 100000 },
                    { name: 'Cross-Border Holding', factor: 0.45, minProfit: 500000 },
                    { name: 'Familienstiftung', factor: 0.35, minProfit: 1000000 }
                ];

                for (const config of structureConfigs) {
                    if (grossProfit >= config.minProfit) {
                        const tax = baseTax * config.factor;
                        const netProfit = grossProfit - tax;
                        
                        structures.push({
                            name: config.name,
                            grossProfit,
                            tax,
                            netProfit,
                            taxRate: grossProfit > 0 ? (tax / grossProfit * 100) : 0,
                            advantages: this.getAdvantages(config.name),
                            isBest: false
                        });
                    }
                }

                structures.sort((a, b) => b.netProfit - a.netProfit);
                if (structures.length > 0) {
                    structures[0].isBest = true;
                }

                return {
                    grossProfit,
                    structures,
                    maxNetProfit: structures.length > 0 ? structures[0].netProfit : 0,
                    totalSavings: structures.length > 1 ? structures[0].netProfit - structures[structures.length - 1].netProfit : 0
                };
            } catch (error) {
                this.errorHandler.logError(error);
                throw error;
            }
        }

        calculateSpeculationTax(profit, holdingPeriod, taxRate, churchTax) {
            if (holdingPeriod >= 10) return 0;
            
            const incomeTax = profit * ((taxRate || 42) / 100);
            const churchTaxAmount = incomeTax * ((churchTax || 0) / 100);
            const solidarityTax = incomeTax * 0.055;
            
            return incomeTax + churchTaxAmount + solidarityTax;
        }

        getAdvantages(structureName) {
            const advantages = {
                'Privatverkauf': ['Steuerfrei nach 10 Jahren', 'Einfachste Abwicklung'],
                'VV GmbH & Co. KG (BFH 2025)': ['BFH 2025: Gewerbesteuerfrei!', 'Haftungsbeschr√§nkung'],
                'Familienpool (GbR)': ['Steuerverteilung auf Familie', 'Progression brechen'],
                'Share Deal (GmbH)': ['40% steuerfreier Gewinn (¬ß8b KStG)', 'Keine Grunderwerbsteuer'],
                'Cross-Border Holding': ['Internationale Steueroptimierung', 'EU-Richtlinien nutzen'],
                'Familienstiftung': ['Generationen√ºbergreifend', 'Maximale Steueroptimierung']
            };
            return advantages[structureName] || [];
        }

        setupEventListeners() {
            console.log('Setting up enhanced event listeners...');
            
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', () => this.setupEventListenersInternal());
            } else {
                this.setupEventListenersInternal();
            }
        }

        setupEventListenersInternal() {
            this.cleanupEventListeners();
            this.setupRealtimeValidation();
            
            document.querySelectorAll('.nav-link').forEach(link => {
                const handler = (e) => {
                    e.preventDefault();
                    const section = link.getAttribute('data-section');
                    if (section) {
                        this.navigateToSection(section);
                    }
                };
                link.addEventListener('click', handler);
                this.eventListenersCleanup.add(() => link.removeEventListener('click', handler));
            });

            document.querySelectorAll('.plugin-item').forEach(item => {
                const keyHandler = (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        item.click();
                    }
                };
                
                const mouseOverHandler = () => {
                    item.style.background = 'rgba(102, 126, 234, 0.1)';
                };
                
                const mouseOutHandler = () => {
                    item.style.background = '';
                };
                
                item.addEventListener('keydown', keyHandler);
                item.addEventListener('mouseover', mouseOverHandler);
                item.addEventListener('mouseout', mouseOutHandler);
                
                this.eventListenersCleanup.add(() => {
                    item.removeEventListener('keydown', keyHandler);
                    item.removeEventListener('mouseover', mouseOverHandler);
                    item.removeEventListener('mouseout', mouseOutHandler);
                });
            });

            const inputHandler = (e) => {
                if (e.target.matches('.form-input, .form-select')) {
                    if (!this.isRestoringState) {
                        this.saveCurrentState();
                    }
                    
                    this.validateField(e.target);
                   
                    if (this.realtimeEnabled) {
                        this.debouncedCalculate();
                    }
                }
            };
            
            document.addEventListener('input', inputHandler);
            this.eventListenersCleanup.add(() => document.removeEventListener('input', inputHandler));

            const scrollHandler = () => {
                const header = this.getCachedElement('app-header');
                if (header) {
                    if (window.scrollY > 10) {
                        header.classList.add('scrolled');
                    } else {
                        header.classList.remove('scrolled');
                    }
                }
            };
            
            window.addEventListener('scroll', scrollHandler);
            this.eventListenersCleanup.add(() => window.removeEventListener('scroll', scrollHandler));

            const keydownHandler = (e) => {
                if (e.key === 'Escape') {
                    this.closeAllModals();
                }
            };
            
            document.addEventListener('keydown', keydownHandler);
            this.eventListenersCleanup.add(() => document.removeEventListener('keydown', keydownHandler));

            document.querySelectorAll('.modal-overlay').forEach(overlay => {
                const clickHandler = (e) => {
                    if (e.target === overlay) {
                        this.closeModal(overlay.id);
                    }
                };
                overlay.addEventListener('click', clickHandler);
                this.eventListenersCleanup.add(() => overlay.removeEventListener('click', clickHandler));
            });

            console.log('Enhanced event listeners setup completed');
        }

        cleanupEventListeners() {
            this.eventListenersCleanup.forEach(cleanup => cleanup());
            this.eventListenersCleanup.clear();
        }

        getCachedElement(id) {
            if (!this.cachedElements.has(id)) {
                this.cachedElements.set(id, document.getElementById(id));
            }
            return this.cachedElements.get(id);
        }

        setupRealtimeValidation() {
            const inputs = document.querySelectorAll('.form-input, .form-select');
            
            inputs.forEach(input => {
                const existingHandler = input._validationHandler;
                if (existingHandler) {
                    input.removeEventListener('input', existingHandler);
                    input.removeEventListener('blur', existingHandler);
                    input.removeEventListener('focus', existingHandler);
                }
                
                const inputHandler = this.debounce((e) => {
                    this.validateField(e.target);
                    if (this.realtimeEnabled) {
                        this.calculateOptimal();
                    }
                }, 300);

                const realTimeHandler = (e) => {
                    this.showValidationIndicator(e.target);
                };

                const blurHandler = (e) => {
                    this.validateField(e.target);
                };

                const focusHandler = (e) => {
                    this.clearFieldError(e.target);
                };
                
                input._validationHandler = inputHandler;
                
                input.addEventListener('input', inputHandler);
                input.addEventListener('input', realTimeHandler);
                input.addEventListener('blur', blurHandler);
                input.addEventListener('focus', focusHandler);
            });
        }

        debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        get debouncedCalculate() {
            if (!this._debouncedCalculate) {
                this._debouncedCalculate = this.debounce(() => {
                    if (this.realtimeEnabled) {
                        this.calculateOptimal();
                    }
                }, 500);
            }
            return this._debouncedCalculate;
        }

        validateField(field) {
            const value = field.value;
            const fieldName = field.id;
            let isValid = true;
            let errorMessage = '';

            field.classList.remove('valid', 'invalid');

            if (field.hasAttribute('required') || ['kaufpreis', 'verkaufspreis', 'haltedauer'].includes(fieldName)) {
                if (!value || value.trim() === '') {
                    isValid = false;
                    errorMessage = 'Dieses Feld ist erforderlich';
                }
            }

            if (field.type === 'number' && value) {
                const numValue = parseFloat(value);
                
                if (isNaN(numValue)) {
                    isValid = false;
                    errorMessage = 'Bitte geben Sie eine g√ºltige Zahl ein';
                } else if (numValue < 0) {
                    isValid = false;
                    errorMessage = 'Negative Werte sind nicht erlaubt';
                } else if (field.hasAttribute('min') && numValue < parseFloat(field.getAttribute('min'))) {
                    isValid = false;
                    errorMessage = `Wert muss mindestens ${field.getAttribute('min')} sein`;
                } else if (field.hasAttribute('max') && numValue > parseFloat(field.getAttribute('max'))) {
                    isValid = false;
                    errorMessage = `Wert darf h√∂chstens ${field.getAttribute('max')} sein`;
                }
            }

            if (value) {
                field.classList.add(isValid ? 'valid' : 'invalid');
            }

            this.updateValidationIndicator(field, isValid);
            this.showFieldError(field, isValid ? '' : errorMessage);

            return isValid;
        }

        showValidationIndicator(field) {
            const indicator = document.getElementById(field.id + '-indicator');
            if (indicator) {
                indicator.classList.add('show');
                setTimeout(() => indicator.classList.remove('show'), 2000);
            }
        }

        updateValidationIndicator(field, isValid) {
            const baseId = field.id.replace(/^s[23]_/, '');
            const indicatorId = baseId + '-indicator';
            const indicator = document.getElementById(indicatorId);
            
            if (indicator) {
                indicator.classList.remove('valid', 'invalid');
                if (field.value) {
                    indicator.classList.add(isValid ? 'valid' : 'invalid');
                    indicator.textContent = isValid ? '‚úì' : '‚úó';
                    indicator.classList.add('show');
                } else {
                    indicator.classList.remove('show');
                }
            }
        }

        showFieldError(field, message) {
            const baseId = field.id.replace(/^s[23]_/, '');
            const errorId = baseId + '-error';
            const errorDiv = document.getElementById(errorId);
            
            if (errorDiv) {
                errorDiv.textContent = message;
                errorDiv.style.display = message ? 'flex' : 'none';
            }
        }

        clearFieldError(field) {
            const baseId = field.id.replace(/^s[23]_/, '');
            const errorId = baseId + '-error';
            const errorDiv = document.getElementById(errorId);
            
            if (errorDiv) {
                errorDiv.style.display = 'none';
            }
        }

        async calculateOptimal() {
            const startTime = performance.now();
            
            try {
                this.updatePerformanceIndicator('Berechnung l√§uft...');
                this.showProgress('KI-Algorithmus analysiert optimale Steuerstrukturen...', 10);
                
                this.saveCurrentState();
                
                const data = this.collectFormData();
                
                this.gaTracker.trackUserJourney('calculation', 'calculation_started', {
                    calculation_type: 'verkaufssteuer',
                    input_value: data.verkaufspreis || 0
                });
                
                if (!this.validateFormData(data)) {
                    this.gaTracker.trackError('validation_error', 'Form validation failed', data);
                    throw new Error('Bitte korrigieren Sie die Eingabefehler');
                }

                this.showProgress('Berechne optimale Rechtsformen...', 30);
                
                const cacheKey = JSON.stringify(data);
                let results;
                
                if (this.cache.has(cacheKey)) {
                    results = this.cache.get(cacheKey);
                    this.analytics.cacheHits++;
                    this.showProgress('Cache-Treffer gefunden...', 60);
                    
                    this.gaTracker.trackPerformance('cache_hit', 1, {
                        calculation_type: 'verkaufssteuer'
                    });
                } else {
                    results = await this.calculateInWorker(data);
                    this.cache.set(cacheKey, results);
                    this.showProgress('Berechnung abgeschlossen...', 80);
                }

                this.analytics.calculations++;
                const calculationTime = performance.now() - startTime;
                
                this.showProgress('Erstelle Ergebnisse...', 90);
                
                this.displayResults(results);
                this.updateAnalytics(results, calculationTime);
                
                this.gaTracker.trackCalculation('verkaufssteuer', data, results);
                this.gaTracker.trackPerformance('calculation_time', calculationTime);
                
                if (results.totalSavings > 10000) {
                    this.gaTracker.trackConversion('significant_savings_found', results.totalSavings);
                }
                
                this.showProgress('Fertig!', 100);
                
                setTimeout(() => {
                    this.hideProgress();
                    this.updatePerformanceIndicator('Berechnung abgeschlossen');
                }, 500);

            } catch (error) {
                console.error('Calculation error:', error);
                this.analytics.errors++;
                this.errorHandler.logError(error);
                this.gaTracker.trackError('calculation_error', error.message, {
                    calculation_type: 'verkaufssteuer',
                    calculation_time: performance.now() - startTime
                });
                this.hideProgress();
                this.updatePerformanceIndicator('Fehler', 'error');
                this.showToast('Berechnung fehlgeschlagen: ' + error.message, 'danger');
            }
        }

        validateFormData(data) {
            let isValid = true;
            const errors = [];

            if (!data.kaufpreis || data.kaufpreis <= 0) {
                errors.push('Kaufpreis ist erforderlich');
                isValid = false;
            }

            if (!data.verkaufspreis || data.verkaufspreis <= 0) {
                errors.push('Verkaufspreis ist erforderlich');
                isValid = false;
            }

            if (data.haltedauer === undefined || data.haltedauer < 0) {
                errors.push('Haltedauer ist erforderlich');
                isValid = false;
            }

            if (!isValid) {
                errors.forEach(error => {
                    this.showToast(error, 'warning');
                });
            }

            return isValid;
        }

        displayResults(results) {
            const container = document.getElementById('results-container');
            
            if (!container) {
                console.warn('Results container not found');
                return;
            }
            
            if (!results || !results.structures || results.structures.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-info">
                        <h3>Keine Optimierung m√∂glich</h3>
                        <p>F√ºr diese Eingaben konnten keine Steueroptimierungen gefunden werden.</p>
                        ${results?.message ? `<p>${this.escapeHtml(results.message)}</p>` : ''}
                    </div>
                `;
                return;
            }

            let html = '';

            if (results.maxNetProfit > 0) {
                html += `
                    <div class="alert alert-success">
                        <h3>KI-Optimierung erfolgreich!</h3>
                        <p><strong>Beste Option:</strong> ${this.escapeHtml(results.structures[0].name)}</p>
                        <p><strong>Nettogewinn:</strong> ${this.formatCurrency(results.maxNetProfit)}</p>
                        ${results.totalSavings > 0 ? `<p><strong>Steuerersparnis:</strong> ${this.formatCurrency(results.totalSavings)}</p>` : ''}
                        ${results.calculationTime ? `<p><strong>Berechnungszeit:</strong> ${results.calculationTime}ms</p>` : ''}
                    </div>
                `;
            }

            html += '<div class="results-grid">';
            
            results.structures.forEach((structure, index) => {
                const badgeText = structure.isBest ? 'OPTIMAL' : `#${index + 1}`;
                const cardClass = structure.isBest ? 'result-card best' : 'result-card';
                
                html += `
                    <div class="${cardClass}">
                        <div class="result-header">
                            <h3 class="result-title">${this.escapeHtml(structure.name)}</h3>
                            ${structure.isBest ? `<span class="result-badge">${badgeText}</span>` : ''}
                        </div>
                        <div class="result-item">
                            <span class="result-label">Bruttogewinn:</span>
                            <span class="result-value">${this.formatCurrency(structure.grossProfit)}</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Steuerbelastung:</span>
                            <span class="result-value">${this.formatCurrency(structure.tax)}</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Nettogewinn:</span>
                            <span class="result-value">${this.formatCurrency(structure.netProfit)}</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Effektiver Steuersatz:</span>
                            <span class="result-value">${structure.taxRate.toFixed(1)}%</span>
                        </div>
                        ${structure.advantages && structure.advantages.length > 0 ? `
                            <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e9ecef;">
                                <strong>Vorteile:</strong>
                                <ul style="margin: 0.5rem 0 0 1.5rem; font-size: 0.9rem;">
                                    ${structure.advantages.map(adv => `<li>${this.escapeHtml(adv)}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            html += '</div>';

            if (results.structures.length > 0) {
                const bestStructure = results.structures[0];
                html += `
                    <div class="card mt-4">
                        <div class="card-header">
                            <h3 class="card-title">KI-Empfehlung</h3>
                        </div>
                        <p>Basierend auf Ihrer Situation empfiehlt unser KI-Algorithmus die Struktur <strong>"${this.escapeHtml(bestStructure.name)}"</strong>.</p>
                        <p>Diese L√∂sung bietet Ihnen den h√∂chsten Nettogewinn von <strong>${this.formatCurrency(bestStructure.netProfit)}</strong> bei einem effektiven Steuersatz von nur <strong>${bestStructure.taxRate.toFixed(1)}%</strong>.</p>
                        ${results.totalSavings > 0 ? `<p class="text-success"><strong>Ihre Steuerersparnis betr√§gt ${this.formatCurrency(results.totalSavings)} gegen√ºber der ung√ºnstigsten Option.</strong></p>` : ''}
                    </div>
                `;
            }

            container.innerHTML = html;
            
            setTimeout(() => {
                container.style.opacity = '0';
                container.style.transform = 'translateY(20px)';
                container.style.transition = 'all 0.5s ease';
                
                setTimeout(() => {
                    container.style.opacity = '1';
                    container.style.transform = 'translateY(0)';
                }, 100);
            }, 50);
        }

        escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Enhanced PDF Export
        async exportPDFReport() {
            try {
                this.showProgress('Erstelle PDF-Bericht...', 10);
                
                const data = this.collectFormData();
                const results = this.cache.get(JSON.stringify(data));
                
                this.gaTracker.trackUserJourney('pdf_export', 'export_started', {
                    calculation_type: 'verkaufssteuer',
                    has_results: !!results
                });
                
                this.showProgress('Generiere PDF...', 50);
                
                const pdfData = {
                    ...data,
                    results,
                    timestamp: new Date().toISOString(),
                    version: this.version
                };
                
                const result = await this.pdfExporter.exportReport(pdfData);
                
                this.showProgress('Download startet...', 100);
                
                this.gaTracker.trackPDFExport(true, 'verkaufssteuer', JSON.stringify(pdfData).length);
                this.gaTracker.trackConversion('pdf_download', 1);
                
                setTimeout(() => {
                    this.hideProgress();
                    this.showToast(`PDF-Bericht "${result.filename}" erfolgreich erstellt`, 'success');
                }, 500);

            } catch (error) {
                console.error('PDF Export Error:', error);
                this.errorHandler.logError(error);
                this.gaTracker.trackPDFExport(false, 'verkaufssteuer', 0);
                this.gaTracker.trackError('pdf_export_error', error.message);
                this.hideProgress();
                this.showToast('PDF-Export fehlgeschlagen: ' + error.message, 'danger');
            }
        }

        // Enhanced Analytics
        updateAnalytics(results, calculationTime) {
            const calcTimeEl = this.getCachedElement('calc-time');
            const calcCountEl = this.getCachedElement('calc-count');
            const cacheHitsEl = this.getCachedElement('cache-hits');
            const errorRateEl = this.getCachedElement('error-rate');
            
            if (calcTimeEl) calcTimeEl.textContent = Math.round(calculationTime) + 'ms';
            if (calcCountEl) calcCountEl.textContent = this.analytics.calculations;
            if (cacheHitsEl) cacheHitsEl.textContent = this.analytics.cacheHits;
            
            const errorRate = this.analytics.calculations > 0 ? 
                (this.analytics.errors / this.analytics.calculations * 100).toFixed(1) : '0';
            if (errorRateEl) errorRateEl.textContent = errorRate + '%';

            if (results && results.structures && results.structures.length > 0) {
                const maxSavings = results.totalSavings || 0;
                const bestTaxRate = results.structures[0].taxRate || 0;
                
                const savingsPotentialEl = this.getCachedElement('savings-potential');
                const taxRateEl = this.getCachedElement('tax-rate');
                
                if (savingsPotentialEl) savingsPotentialEl.textContent = this.formatCurrency(maxSavings);
                if (taxRateEl) taxRateEl.textContent = bestTaxRate.toFixed(1) + '%';

                this.updateTaxChart(results.structures);
            }

            const apiStatusEl = this.getCachedElement('api-status');
            const cacheStatusEl = this.getCachedElement('cache-status');
            
            if (apiStatusEl) apiStatusEl.innerHTML = '‚úÖ Online';
            if (cacheStatusEl) cacheStatusEl.innerHTML = '‚úÖ Aktiv';
        }

        updateTaxChart(structures) {
            const canvas = this.getCachedElement('tax-chart');
            if (!canvas) return;
            
            if (typeof Chart === 'undefined') {
                console.warn('Chart.js not loaded, skipping chart update');
                return;
            }
            
            const ctx = canvas.getContext('2d');

            if (this.chart) {
                this.chart.destroy();
            }

            const labels = structures.slice(0, 4).map(s => s.name.split(' ')[0]);
            const data = structures.slice(0, 4).map(s => s.taxRate);
            const colors = structures.slice(0, 4).map((s, i) => 
                i === 0 ? '#11998e' : `hsl(${200 + i * 30}, 60%, 60%)`
            );

            this.chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Steuersatz %',
                        data: data,
                        backgroundColor: colors,
                        borderColor: colors,
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.parsed.y.toFixed(1) + '%';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        updatePerformanceIndicator(text, type = 'success') {
            const indicator = this.getCachedElement('performance-text');
            const indicatorContainer = document.querySelector('.performance-indicator');
            
            if (indicator) {
                indicator.textContent = text;
            }
            
            if (indicatorContainer) {
                indicatorContainer.className = `performance-indicator ${type}`;
            }
        }

        // Enhanced State Management
        setupScenarios() {
            this.scenarios.set('scenario1', {
                name: 'Basis-Szenario',
                data: {},
                results: null
            });
            
            this.scenarios.set('scenario2', {
                name: 'Vergleichsszenario',
                data: {},
                results: null
            });
            
            this.scenarios.set('scenario3', {
                name: 'Optimiertes Szenario',
                data: {},
                results: null
            });
        }

        switchScenario(scenarioId) {
            if (this.currentScenario) {
                const scenario = this.scenarios.get(this.currentScenario);
                if (scenario) {
                    scenario.data = this.collectFormData();
                }
            }

            this.currentScenario = scenarioId;
            
            document.querySelectorAll('.scenario-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            const activeTab = document.querySelector(`[data-scenario="${scenarioId}"]`);
            if (activeTab) {
                activeTab.classList.add('active');
            }
            
            document.querySelectorAll('.scenario-content').forEach(content => {
                content.classList.remove('active');
            });
            const activeContent = document.getElementById(scenarioId + '-content');
            if (activeContent) {
                activeContent.classList.add('active');
            }
            
            const scenario = this.scenarios.get(scenarioId);
            if (scenario && scenario.data && Object.keys(scenario.data).length > 0) {
                this.populateForm(scenario.data);
            } else {
                this.clearCurrentScenarioForm();
            }
            
            this.showToast(`Gewechselt zu ${scenario?.name || scenarioId}`, 'info');
        }

        clearCurrentScenarioForm() {
            const prefix = this.getScenarioPrefix(this.currentScenario);
            const inputs = document.querySelectorAll(`#${this.currentScenario}-content .form-input, #${this.currentScenario}-content .form-select`);
            
            inputs.forEach(input => {
                if (input.type === 'number') {
                    input.value = '';
                } else if (input.type === 'checkbox') {
                    input.checked = false;
                } else if (input.tagName === 'SELECT') {
                    input.selectedIndex = 0;
                } else {
                    input.value = '';
                }
                
                input.classList.remove('valid', 'invalid');
            });
        }

        getScenarioPrefix(scenarioId) {
            switch(scenarioId) {
                case 'scenario1': return '';
                case 'scenario2': return 's2_';
                case 'scenario3': return 's3_';
                default: return '';
            }
        }

        // Enhanced Keyboard Shortcuts
        setupKeyboardShortcuts() {
            this.keyboardShortcuts.set('ctrl+enter', () => this.calculateOptimal());
            this.keyboardShortcuts.set('ctrl+e', () => this.loadExample());
            this.keyboardShortcuts.set('ctrl+p', () => this.exportPDFReport());
            this.keyboardShortcuts.set('ctrl+r', () => this.resetForm());
            this.keyboardShortcuts.set('ctrl+m', () => this.showComparison());
            this.keyboardShortcuts.set('ctrl+z', () => this.undo());
            this.keyboardShortcuts.set('ctrl+y', () => this.redo());
            this.keyboardShortcuts.set('f1', () => this.showHelp());
            this.keyboardShortcuts.set('escape', () => this.closeAllModals());
            this.keyboardShortcuts.set('ctrl+s', () => this.saveData());

            const keydownHandler = (e) => {
                const key = this.getKeyboardShortcut(e);
                const action = this.keyboardShortcuts.get(key);
                
                if (action) {
                    e.preventDefault();
                    action();
                    this.showShortcutIndicator(key);
                }
            };
            
            document.addEventListener('keydown', keydownHandler);
            this.eventListenersCleanup.add(() => document.removeEventListener('keydown', keydownHandler));
        }

        getKeyboardShortcut(e) {
            const parts = [];
            if (e.ctrlKey) parts.push('ctrl');
            if (e.shiftKey) parts.push('shift');
            if (e.altKey) parts.push('alt');
            
            const key = e.key.toLowerCase();
            if (key !== 'control' && key !== 'shift' && key !== 'alt') {
                parts.push(key);
            }
            
            return parts.join('+');
        }

        showShortcutIndicator(shortcut) {
            const indicator = this.getCachedElement('shortcut-indicator');
            if (indicator) {
                indicator.textContent = `${shortcut.toUpperCase()}`;
                indicator.classList.add('show');
                
                setTimeout(() => {
                    indicator.classList.remove('show');
                }, 2000);
            }
        }

        // Enhanced Plugin Architecture
        setupPluginArchitecture() {
            this.plugins.set('bundesland-analyzer', {
                name: 'Bundesland-Analyzer',
                version: '1.0.0',
                description: 'Steuervergleich nach Bundesl√§ndern',
                load: () => this.loadBundeslandAnalyzer(),
                unload: () => this.unloadBundeslandAnalyzer()
            });

            this.plugins.set('inflation-calculator', {
                name: 'Inflations-Rechner',
                version: '1.0.0',
                description: 'Ber√ºcksichtigung der Inflation',
                load: () => this.loadInflationCalculator(),
                unload: () => this.unloadInflationCalculator()
            });

            this.plugins.set('ai-optimizer', {
                name: 'KI-Optimierer',
                version: '2.0.0',
                description: 'Machine Learning Vorhersagen',
                load: () => this.loadAIOptimizer(),
                unload: () => this.unloadAIOptimizer()
            });

            this.plugins.set('international-tax', {
                name: 'International Tax',
                version: '1.0.0',
                description: 'Cross-Border Optimierung',
                load: () => this.loadInternationalTax(),
                unload: () => this.unloadInternationalTax()
            });
        }

        loadPlugin(pluginId) {
            const plugin = this.plugins.get(pluginId);
            if (plugin) {
                try {
                    this.gaTracker.trackPluginUsage(plugin.name, 'loaded');
                    this.gaTracker.trackFeatureUsage('plugin_system', 'plugin_activated', pluginId);
                    
                    plugin.load();
                    this.showToast(`Plugin "${plugin.name}" v${plugin.version} geladen`, 'success');
                } catch (error) {
                    this.errorHandler.logError(error);
                    this.gaTracker.trackError('plugin_load_error', error.message, { plugin: pluginId });
                    this.showToast(`Fehler beim Laden von Plugin "${plugin.name}": ${error.message}`, 'danger');
                }
            }
        }

        loadBundeslandAnalyzer() {
            this.gaTracker.trackFeatureUsage('bundesland_analyzer', 'opened');
            this.showModal('comparison-modal');
            document.getElementById('comparison-content').innerHTML = `
                <h3>Bundesland-Steuer-Vergleich</h3>
                <div class="alert alert-info">
                    <p><strong>Plugin aktiv:</strong> Analysiert Steuerunterschiede zwischen allen 16 Bundesl√§ndern.</p>
                </div>
                <div class="data-table">
                    <table style="width: 100%;">
                        <thead>
                            <tr>
                                <th>Bundesland</th>
                                <th>Grunderwerbsteuer</th>
                                <th>Notarkosten</th>
                                <th>Gesamtbelastung</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td>Bayern</td><td>3.5%</td><td>~1.5%</td><td>5.0%</td></tr>
                            <tr><td>Sachsen</td><td>3.5%</td><td>~1.5%</td><td>5.0%</td></tr>
                            <tr><td>Berlin</td><td>6.0%</td><td>~1.5%</td><td>7.5%</td></tr>
                            <tr><td>NRW</td><td>6.5%</td><td>~1.5%</td><td>8.0%</td></tr>
                        </tbody>
                    </table>
                </div>
            `;
        }

        loadInflationCalculator() {
            this.gaTracker.trackFeatureUsage('inflation_calculator', 'activated');
            const checkbox = document.getElementById('inflation-adjustment');
            if (checkbox) {
                checkbox.checked = true;
                this.showToast('Inflation wird nun automatisch ber√ºcksichtigt', 'success');
            }
        }

        loadAIOptimizer() {
            this.gaTracker.trackFeatureUsage('ai_optimizer', 'activated');
            this.updatePerformanceIndicator('KI-Modus aktiv');
            this.showToast('KI-Optimierer aktiviert - Erweiterte Berechnungen verf√ºgbar', 'success');
        }

        loadInternationalTax() {
            this.gaTracker.trackFeatureUsage('international_tax', 'activated');
            this.showToast('International Tax Plugin aktiviert - Cross-Border Strukturen verf√ºgbar', 'success');
        }

        // Navigation and Content Loading
        navigateToSection(section) {
            this.saveCurrentSectionData();
            
            this.gaTracker.trackUserJourney('navigation', 'section_changed', {
                from_section: this.getCurrentSection(),
                to_section: section
            });
            
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            const activeLink = document.querySelector(`[data-section="${section}"]`);
            if (activeLink) {
                activeLink.classList.add('active');
            }
            
            this.loadSectionContent(section);
            this.showToast(`Navigation zu ${section}`, 'info');
        }

        saveCurrentSectionData() {
            const currentSection = this.getCurrentSection();
            if (!currentSection) return;
            
            switch(currentSection) {
                case 'verkauf':
                    this.saveVerkaufData();
                    break;
                case 'grundsteuer':
                    this.saveGrundsteuerData();
                    break;
                case 'erbschaft':
                    this.saveErbschaftData();
                    break;
                case 'schenkung':
                    this.saveSchenkungData();
                    break;
                case 'cashflow':
                    this.saveCashflowData();
                    break;
                case 'strategie':
                    this.saveStrategieData();
                    break;
            }
        }

        saveVerkaufData() {
            const currentScenario = this.currentScenario;
            ['scenario1', 'scenario2', 'scenario3'].forEach(scenarioId => {
                this.currentScenario = scenarioId;
                const data = this.collectFormData();
                const scenario = this.scenarios.get(scenarioId);
                if (scenario && Object.keys(data).some(key => data[key] !== '' && data[key] !== 0 && data[key] !== false)) {
                    scenario.data = data;
                }
            });
            this.currentScenario = currentScenario;
        }

        saveGrundsteuerData() {
            if (!this.sectionData) this.sectionData = {};
            this.sectionData.grundsteuer = this.collectGrundsteuerData();
        }

        saveErbschaftData() {
            if (!this.sectionData) this.sectionData = {};
            this.sectionData.erbschaft = this.collectErbschaftData();
        }

        saveSchenkungData() {
            if (!this.sectionData) this.sectionData = {};
            this.sectionData.schenkung = this.collectSchenkungData();
        }

        saveCashflowData() {
            if (!this.sectionData) this.sectionData = {};
            this.sectionData.cashflow = this.collectCashflowData();
        }

        saveStrategieData() {
            if (!this.sectionData) this.sectionData = {};
            this.sectionData.strategie = this.collectStrategyData();
        }

        loadSectionContent(section) {
            const contentArea = document.getElementById('dynamic-content');
            if (!contentArea) return;
            
            this.gaTracker.trackPageView(`Section: ${section}`, 'Tax Calculation');
            
            let content = '';
            
            switch(section) {
                case 'verkauf':
                    content = this.generateVerkaufContent();
                    break;
                case 'grundsteuer':
                    content = this.generateGrundsteuerContent();
                    break;
                case 'erbschaft':
                    content = this.generateErbschaftContent();
                    break;
                case 'schenkung':
                    content = this.generateSchenkungContent();
                    break;
                case 'cashflow':
                    content = this.generateCashflowContent();
                    break;
                case 'strategie':
                    content = this.generateStrategieContent();
                    break;
                default:
                    content = this.generateVerkaufContent();
            }
            
            contentArea.innerHTML = content;
            
            setTimeout(() => {
                this.setupRealtimeValidation();
                this.setupSectionSpecificHandlers(section);
                this.restoreSectionData(section);
            }, 100);
        }

        restoreSectionData(section) {
            switch(section) {
                case 'verkauf':
                    this.restoreVerkaufData();
                    break;
                case 'grundsteuer':
                    this.restoreGrundsteuerData();
                    break;
                case 'erbschaft':
                    this.restoreErbschaftData();
                    break;
                case 'schenkung':
                    this.restoreSchenkungData();
                    break;
                case 'cashflow':
                    this.restoreCashflowData();
                    break;
                case 'strategie':
                    this.restoreStrategieData();
                    break;
            }
        }

        restoreVerkaufData() {
            ['scenario1', 'scenario2', 'scenario3'].forEach(scenarioId => {
                const scenario = this.scenarios.get(scenarioId);
                if (scenario && scenario.data && Object.keys(scenario.data).length > 0) {
                    const currentScenario = this.currentScenario;
                    this.currentScenario = scenarioId;
                    this.populateForm(scenario.data);
                    this.currentScenario = currentScenario;
                }
            });
        }

        restoreGrundsteuerData() {
            if (this.sectionData && this.sectionData.grundsteuer) {
                this.populateGrundsteuerForm(this.sectionData.grundsteuer);
                
                if (this.realtimeEnabled) {
                    setTimeout(() => this.calculateGrundsteuer(), 300);
                }
            }
        }

        restoreErbschaftData() {
            if (this.sectionData && this.sectionData.erbschaft) {
                this.populateErbschaftForm(this.sectionData.erbschaft);
                
                if (this.realtimeEnabled) {
                    setTimeout(() => this.calculateErbschaftsteuer(), 300);
                }
            }
        }

        restoreSchenkungData() {
            if (this.sectionData && this.sectionData.schenkung) {
                this.populateSchenkungForm(this.sectionData.schenkung);
                
                if (this.realtimeEnabled) {
                    setTimeout(() => this.calculateSchenkungssteuer(), 300);
                }
            }
        }

        restoreCashflowData() {
            if (this.sectionData && this.sectionData.cashflow) {
                this.populateCashflowForm(this.sectionData.cashflow);
                
                if (this.realtimeEnabled) {
                    setTimeout(() => this.calculateCashflow(), 300);
                }
            }
        }

        restoreStrategieData() {
            if (this.sectionData && this.sectionData.strategie) {
                this.populateStrategieForm(this.sectionData.strategie);
                
                if (this.realtimeEnabled) {
                    setTimeout(() => this.generateKIStrategy(), 300);
                }
            }
        }

        getCurrentSection() {
            const activeLink = document.querySelector('.nav-link.active');
            return activeLink ? activeLink.getAttribute('data-section') : 'verkauf';
        }

        setupSectionSpecificHandlers(section) {
            switch(section) {
                case 'grundsteuer':
                    this.setupGrundsteuerEventHandlers();
                    break;
                case 'erbschaft':
                    this.setupErbschaftEventHandlers();
                    break;
                case 'schenkung':
                    this.setupSchenkungEventHandlers();
                    break;
                case 'cashflow':
                    this.setupCashflowEventHandlers();
                    break;
                case 'strategie':
                    this.setupStrategieEventHandlers();
                    break;
            }
        }

        setupGrundsteuerEventHandlers() {
            console.log('Setting up Grundsteuer event handlers');
        }

        setupErbschaftEventHandlers() {
            console.log('Setting up Erbschaft event handlers');
        }

        setupSchenkungEventHandlers() {
            console.log('Setting up Schenkung event handlers');
        }

        setupCashflowEventHandlers() {
            console.log('Setting up Cashflow event handlers');
        }

        setupStrategieEventHandlers() {
            console.log('Setting up Strategie event handlers');
        }

        // Content Generation Methods
        generateVerkaufContent() {
            const formFields = this.generateVerkaufFormFields();
            const advancedOptions = this.generateAdvancedOptions();
            const buttonGroup = this.generateVerkaufButtons();

            return `
                <div class="scenario-tabs">
                    <button class="scenario-tab active" data-scenario="scenario1" onclick="app.switchScenario('scenario1')">
                        Szenario 1
                    </button>
                    <button class="scenario-tab" data-scenario="scenario2" onclick="app.switchScenario('scenario2')">
                        Szenario 2
                    </button>
                    <button class="scenario-tab" data-scenario="scenario3" onclick="app.switchScenario('scenario3')">
                        Szenario 3
                    </button>
                    <button class="btn btn-outline" onclick="app.addScenario()" style="margin-left: auto; padding: 0.5rem 1rem; font-size: 0.9rem;">
                        + Szenario hinzuf√ºgen
                    </button>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <span>üí∞</span>
                            <span>KI-Optimierte Verkaufssteuer-Berechnung 2025</span>
                        </div>
                    </div>

                    <div class="alert alert-info">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span>Real-time KI-Berechnung aktiviert - Optimale Strukturen werden automatisch berechnet</span>
                            <label style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="checkbox" id="realtime-calc" checked onchange="app.toggleRealtime()">
                                <span>Real-time</span>
                            </label>
                        </div>
                    </div>

                    <!-- Szenario 1 Content -->
                    <div class="scenario-content active" id="scenario1-content">
                        ${formFields}
                        ${advancedOptions}
                        ${buttonGroup}
                    </div>

                    <!-- Szenario 2 Content -->
                    <div class="scenario-content" id="scenario2-content">
                        ${formFields.replace(/id="/g, 'id="s2_')}
                        ${advancedOptions.replace(/id="/g, 'id="s2_')}
                        ${buttonGroup}
                    </div>

                    <!-- Szenario 3 Content -->
                    <div class="scenario-content" id="scenario3-content">
                        ${formFields.replace(/id="/g, 'id="s3_')}
                        ${advancedOptions.replace(/id="/g, 'id="s3_')}
                        ${buttonGroup}
                    </div>
                </div>

                <div class="results-container" id="results-container">
                    <!-- Results will be dynamically inserted here -->
                </div>
            `;
        }

        generateVerkaufFormFields() {
            return `
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">
                                    Kaufpreis <span class="required">*</span>
                                </label>
                                <div class="input-group">
                                    <input type="number" id="kaufpreis" class="form-input" placeholder="z.B. 400.000" min="0" step="1000" required>
                                    <div class="validation-indicator" id="kaufpreis-indicator"></div>
                                </div>
                                <div class="form-help">Urspr√ºnglicher Kaufpreis der Immobilie</div>
                                <div class="form-error" id="kaufpreis-error"></div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">
                                    Verkaufspreis <span class="required">*</span>
                                </label>
                                <div class="input-group">
                                    <input type="number" id="verkaufspreis" class="form-input" placeholder="z.B. 600.000" min="0" step="1000" required>
                                    <div class="validation-indicator" id="verkaufspreis-indicator"></div>
                                </div>
                                <div class="form-help">Aktueller Verkaufspreis</div>
                                <div class="form-error" id="verkaufspreis-error"></div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">
                                    Nebenkosten Kauf
                                </label>
                                <div class="input-group">
                                    <input type="number" id="nebenkosten_kauf" class="form-input" placeholder="z.B. 40.000" min="0" step="1000">
                                    <div class="validation-indicator" id="nebenkosten_kauf-indicator"></div>
                                </div>
                                <div class="form-help">Notar, Grunderwerbsteuer, Makler beim Kauf</div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">
                                    Nebenkosten Verkauf
                                </label>
                                <div class="input-group">
                                    <input type="number" id="nebenkosten_verkauf" class="form-input" placeholder="z.B. 30.000" min="0" step="1000">
                                    <div class="validation-indicator" id="nebenkosten_verkauf-indicator"></div>
                                </div>
                                <div class="form-help">Makler, Notar, Inserate beim Verkauf</div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">
                                    Modernisierung/Renovierung
                                </label>
                                <div class="input-group">
                                    <input type="number" id="modernisierung" class="form-input" placeholder="z.B. 35.000" min="0" step="1000">
                                    <div class="validation-indicator" id="modernisierung-indicator"></div>
                                </div>
                                <div class="form-help">Steuerlich absetzbare Investitionen</div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">
                                    Haltedauer (Jahre) <span class="required">*</span>
                                </label>
                                <div class="input-group">
                                    <input type="number" id="haltedauer" class="form-input" placeholder="z.B. 8" min="0" max="50" step="0.1" required>
                                    <div class="validation-indicator" id="haltedauer-indicator"></div>
                                </div>
                                <div class="form-help">Zeit zwischen Kauf und Verkauf</div>
                                <div class="form-error" id="haltedauer-error"></div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">
                                    Pers√∂nlicher Steuersatz (%)
                                </label>
                                <select id="steuersatz" class="form-select">
                                    <option value="14">14% (Eingangssteuersatz)</option>
                                    <option value="24">24% (Mittlerer Bereich)</option>
                                    <option value="32">32% (H√∂herer Bereich)</option>
                                    <option value="42" selected>42% (Spitzensteuersatz)</option>
                                    <option value="45">45% (Reichensteuer)</option>
                                </select>
                                <div class="form-help">Ihr aktueller Einkommensteuersatz</div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">
                                    Kirchensteuer (%)
                                </label>
                                <select id="kirchensteuer" class="form-select">
                                    <option value="0">0% (Konfessionslos)</option>
                                    <option value="8" selected>8% (Bayern, BW)</option>
                                    <option value="9">9% (Andere Bundesl√§nder)</option>
                                </select>
                                <div class="form-help">Kirchensteuer je nach Bundesland</div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">
                                    Bundesland
                                </label>
                                <select id="bundesland" class="form-select">
                                    <option value="bw">Baden-W√ºrttemberg</option>
                                    <option value="by">Bayern</option>
                                    <option value="be">Berlin</option>
                                    <option value="bb">Brandenburg</option>
                                    <option value="hb">Bremen</option>
                                    <option value="hh">Hamburg</option>
                                    <option value="he">Hessen</option>
                                    <option value="mv">Mecklenburg-Vorpommern</option>
                                    <option value="ni">Niedersachsen</option>
                                    <option value="nw" selected>Nordrhein-Westfalen</option>
                                    <option value="rp">Rheinland-Pfalz</option>
                                    <option value="sl">Saarland</option>
                                    <option value="sn">Sachsen</option>
                                    <option value="st">Sachsen-Anhalt</option>
                                    <option value="sh">Schleswig-Holstein</option>
                                    <option value="th">Th√ºringen</option>
                                </select>
                                <div class="form-help" id="bundesland-help">F√ºr bundeslandspezifische Steuerberechnung</div>
                            </div>
                        </div>
            `;
        }

        generateAdvancedOptions() {
            return `
                        <div class="advanced-options">
                            <button class="disclosure-toggle" onclick="app.toggleAdvanced()">
                                <span class="disclosure-arrow">‚ñ∂</span>
                                Erweiterte Optionen
                            </button>
                            <div class="disclosure-content" id="advanced-content">
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label class="form-label">
                                            üí∞ Zus√§tzliche Werbungskosten
                                        </label>
                                        <input type="number" id="werbungskosten" class="form-input" placeholder="z.B. 5.000" min="0" step="100" aria-describedby="werbungskosten-help">
                                        <div class="form-help" id="werbungskosten-help">Weitere steuerlich absetzbare Kosten</div>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">
                                            üìä Abschreibungen (AfA)
                                        </label>
                                        <input type="number" id="abschreibungen" class="form-input" placeholder="z.B. 12.000" min="0" step="100" aria-describedby="abschreibungen-help">
                                        <div class="form-help" id="abschreibungen-help">J√§hrliche Abschreibungen bei Vermietung</div>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">
                                            üèóÔ∏è Immobilientyp
                                        </label>
                                        <select id="immobilientyp" class="form-select" aria-describedby="immobilientyp-help">
                                            <option value="eigenheim">Eigenheim/Privatnutzung</option>
                                            <option value="vermietung">Vermietungsimmobilie</option>
                                            <option value="gewerbe">Gewerbeimmobilie</option>
                                            <option value="mischnutzung">Mischnutzung</option>
                                        </select>
                                        <div class="form-help" id="immobilientyp-help">Art der Immobiliennutzung</div>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">
                                            üí± Inflationsbereinigung
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                                            <input type="checkbox" id="inflation-adjustment">
                                            <span>Kaufpreis inflationsbereinigt berechnen</span>
                                        </label>
                                        <div class="form-help">Automatische Anpassung an Inflation seit Kauf</div>
                                    </div>
                                </div>
                            </div>
                        </div>
            `;
        }

        generateVerkaufButtons() {
            return `
                        <div class="btn-group">
                            <button class="btn btn-primary" onclick="app.calculateOptimal()" title="Optimale Berechnung starten (Ctrl+Enter)">
                                üßÆ KI-Optimierung starten
                            </button>
                            <button class="btn btn-success" onclick="app.loadExample()" title="Beispieldaten laden (Ctrl+E)">
                                üí° Beispiel laden
                            </button>
                            <button class="btn btn-warning" onclick="app.exportPDFReport()" title="PDF-Bericht erstellen (Ctrl+P)">
                                üìä PDF-Report
                            </button>
                            <button class="btn btn-secondary" onclick="app.resetForm()" title="Formular zur√ºcksetzen (Ctrl+R)">
                                üîÑ Zur√ºcksetzen
                            </button>
                        </div>
            `;
        }

        generateGrundsteuerContent() {
            return `
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <span>üèõÔ∏è</span>
                            <span>Grundsteuer-Reform 2025</span>
                        </div>
                    </div>

                    <div class="alert alert-info">
                        <h3>üìã Neue Grundsteuer-Berechnung ab 2025</h3>
                        <p>Die Grundsteuer-Reform ist in Kraft! Berechnen Sie Ihre neue Grundsteuerbelastung mit den aktuellen Bewertungsverfahren.</p>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">
                                üè† Grundst√ºcksfl√§che (m¬≤) <span class="required">*</span>
                            </label>
                            <input type="number" id="grundstuecksflaeche" class="form-input" placeholder="z.B. 800" min="0" step="1" required aria-describedby="grundstuecksflaeche-help">
                            <div class="form-help" id="grundstuecksflaeche-help">Gesamte Grundst√ºcksfl√§che in Quadratmetern</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                üèóÔ∏è Wohnfl√§che (m¬≤) <span class="required">*</span>
                            </label>
                            <input type="number" id="wohnflaeche" class="form-input" placeholder="z.B. 150" min="0" step="1" required aria-describedby="wohnflaeche-help">
                            <div class="form-help" id="wohnflaeche-help">Wohnfl√§che des Geb√§udes</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                üìÖ Baujahr
                            </label>
                            <input type="number" id="baujahr" class="form-input" placeholder="z.B. 1995" min="1900" max="2025" aria-describedby="baujahr-help">
                            <div class="form-help" id="baujahr-help">Jahr der Fertigstellung</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                üè† Immobilientyp
                            </label>
                            <select id="grundsteuer_immobilientyp" class="form-select" aria-describedby="grundsteuer_immobilientyp-help">
                                <option value="einfamilienhaus">Einfamilienhaus</option>
                                <option value="zweifamilienhaus">Zweifamilienhaus</option>
                                <option value="mehrfamilienhaus">Mehrfamilienhaus</option>
                                <option value="eigentumswohnung">Eigentumswohnung</option>
                                <option value="gewerbe">Gewerbeimmobilie</option>
                            </select>
                            <div class="form-help" id="grundsteuer_immobilientyp-help">Typ der Immobilie</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                üó∫Ô∏è Bundesland
                            </label>
                            <select id="grundsteuer_bundesland" class="form-select" aria-describedby="grundsteuer_bundesland-help">
                                <option value="bw">Baden-W√ºrttemberg</option>
                                <option value="by">Bayern (Bundesmodell)</option>
                                <option value="by-bayerisch">Bayern (Bayerisches Modell)</option>
                                <option value="be">Berlin</option>
                                <option value="bb">Brandenburg</option>
                                <option value="hb">Bremen</option>
                                <option value="hh">Hamburg</option>
                                <option value="he">Hessen</option>
                                <option value="mv">Mecklenburg-Vorpommern</option>
                                <option value="ni">Niedersachsen</option>
                                <option value="nw" selected>Nordrhein-Westfalen</option>
                                <option value="rp">Rheinland-Pfalz</option>
                                <option value="sl">Saarland</option>
                                <option value="sn">Sachsen</option>
                                <option value="st">Sachsen-Anhalt</option>
                                <option value="sh">Schleswig-Holstein</option>
                                <option value="th">Th√ºringen</option>
                            </select>
                            <div class="form-help" id="grundsteuer_bundesland-help">Wichtig: Verschiedene Bundesl√§nder haben unterschiedliche Modelle</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                üèôÔ∏è Gemeinde-Hebesatz (%)
                            </label>
                            <input type="number" id="hebesatz_grundsteuer" class="form-input" placeholder="z.B. 470" min="0" max="1000" step="10" aria-describedby="hebesatz_grundsteuer-help">
                            <div class="form-help" id="hebesatz_grundsteuer-help">Hebesatz Ihrer Gemeinde (meist 300-600%)</div>
                        </div>
                    </div>

                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="app.calculateGrundsteuer()">
                            üßÆ Grundsteuer 2025 berechnen
                        </button>
                        <button class="btn btn-warning" onclick="app.loadGrundsteuerExample()">
                            üí° Beispiel laden
                        </button>
                        <button class="btn btn-secondary" onclick="app.resetGrundsteuerForm()">
                            üîÑ Zur√ºcksetzen
                        </button>
                    </div>
                </div>

                <div id="grundsteuer-results" class="results-container">
                    <!-- Grundsteuer Results will be displayed here -->
                </div>
            `;
        }

        generateErbschaftContent() {
            return `
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <span>üë®‚Äçüë©‚Äçüëß‚Äçüë¶</span>
                            <span>Erbschaftsteuer-Optimierung 2025</span>
                        </div>
                    </div>

                    <div class="alert alert-info">
                        <h3>‚öñÔ∏è Erbschaftsteuer-Planung mit aktuellen Freibetr√§gen</h3>
                        <p>Optimieren Sie die √úbertragung Ihrer Immobilie durch geschickte Erbschaftsteuer-Planung.</p>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">
                                üè† Immobilienwert <span class="required">*</span>
                            </label>
                            <input type="number" id="erbschaft_immobilienwert" class="form-input" placeholder="z.B. 600.000" min="0" step="1000" required aria-describedby="erbschaft_immobilienwert-help">
                            <div class="form-help" id="erbschaft_immobilienwert-help">Aktueller Verkehrswert der Immobilie</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Verwandtschaftsgrad
                            </label>
                            <select id="verwandtschaftsgrad" class="form-select" aria-describedby="verwandtschaftsgrad-help">
                                <option value="ehepartner">Ehepartner/Lebenspartner</option>
                                <option value="kind">Kind/Stiefkind</option>
                                <option value="enkel">Enkel</option>
                                <option value="eltern">Eltern/Gro√üeltern</option>
                                <option value="geschwister">Geschwister</option>
                                <option value="neffe_nichte">Neffe/Nichte</option>
                                <option value="sonstige">Sonstige Verwandte</option>
                                <option value="fremde">Nicht verwandt</option>
                            </select>
                            <div class="form-help" id="verwandtschaftsgrad-help">Verwandtschaftsgrad bestimmt Steuerklasse und Freibetrag</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                üè† Immobilienart
                            </label>
                            <select id="erbschaft_immobilienart" class="form-select" aria-describedby="erbschaft_immobilienart-help">
                                <option value="eigenheim">Eigenheim (selbst bewohnt)</option>
                                <option value="vermietung">Vermietungsimmobilie</option>
                                <option value="ferienhaus">Ferienhaus</option>
                                <option value="gewerbe">Gewerbeimmobilie</option>
                                <option value="grundstueck">Unbebautes Grundst√ºck</option>
                            </select>
                            <div class="form-help" id="erbschaft_immobilienart-help">Art der zu vererbenden Immobilie</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                üí∞ Sonstiges Verm√∂gen
                            </label>
                            <input type="number" id="sonstiges_vermoegen" class="form-input" placeholder="z.B. 100.000" min="0" step="1000" aria-describedby="sonstiges_vermoegen-help">
                            <div class="form-help" id="sonstiges_vermoegen-help">Weiteres Verm√∂gen (Bargeld, Wertpapiere, etc.)</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                üè† Selbstnutzung durch Erben
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="checkbox" id="selbstnutzung_erbe">
                                <span>Erbe wird Immobilie selbst bewohnen</span>
                            </label>
                            <div class="form-help">Kann zu Steuerbefreiung f√ºhren (Familienheim)</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                ‚è±Ô∏è √úbertragung zu Lebzeiten
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="checkbox" id="lebzeitige_uebertragung">
                                <span>√úbertragung zu Lebzeiten geplant</span>
                            </label>
                            <div class="form-help">Erm√∂glicht Freibetr√§ge alle 10 Jahre</div>
                        </div>
                    </div>

                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="app.calculateErbschaftsteuer()">
                            üßÆ Erbschaftsteuer berechnen
                        </button>
                        <button class="btn btn-warning" onclick="app.loadErbschaftExample()">
                            üí° Beispiel laden
                        </button>
                        <button class="btn btn-secondary" onclick="app.resetErbschaftForm()">
                            üîÑ Zur√ºcksetzen
                        </button>
                    </div>
                </div>

                <div id="erbschaft-results" class="results-container">
                    <!-- Erbschaftsteuer Results will be displayed here -->
                </div>
            `;
        }

        generateSchenkungContent() {
            return `
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <span>üéÅ</span>
                            <span>Schenkungssteuer-Planung 2025</span>
                        </div>
                    </div>

                    <div class="alert alert-info">
                        <h3>üéØ Optimale Schenkungsplanung f√ºr Immobilien</h3>
                        <p>Nutzen Sie Freibetr√§ge optimal und planen Sie die steuereffiziente √úbertragung Ihrer Immobilie.</p>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">
                                üè† Immobilienwert <span class="required">*</span>
                            </label>
                            <input type="number" id="schenkung_immobilienwert" class="form-input" placeholder="z.B. 800.000" min="0" step="1000" required aria-describedby="schenkung_immobilienwert-help">
                            <div class="form-help" id="schenkung_immobilienwert-help">Aktueller Verkehrswert der Immobilie</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Beschenkter
                            </label>
                            <select id="beschenkter" class="form-select" aria-describedby="beschenkter-help">
                                <option value="ehepartner">Ehepartner/Lebenspartner</option>
                                <option value="kind">Kind/Stiefkind</option>
                                <option value="enkel">Enkel</option>
                                <option value="urenkel">Urenkel</option>
                                <option value="eltern">Eltern/Gro√üeltern</option>
                                <option value="geschwister">Geschwister</option>
                                <option value="neffe_nichte">Neffe/Nichte</option>
                                <option value="sonstige">Sonstige Verwandte</option>
                                <option value="fremde">Nicht verwandt</option>
                            </select>
                            <div class="form-help" id="beschenkter-help">Bestimmt Freibetrag und Steuersatz</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                üìÖ Vorherige Schenkungen
                            </label>
                            <input type="number" id="vorherige_schenkungen" class="form-input" placeholder="z.B. 50.000" min="0" step="1000" aria-describedby="vorherige_schenkungen-help">
                            <div class="form-help" id="vorherige_schenkungen-help">Schenkungen der letzten 10 Jahre an dieselbe Person</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                üè† Art der Schenkung
                            </label>
                            <select id="schenkungsart" class="form-select" aria-describedby="schenkungsart-help">
                                <option value="vollschenkung">Vollst√§ndige Schenkung</option>
                                <option value="teilschenkung">Teilschenkung (Anteil)</option>
                                <option value="niesbrauch">Schenkung mit Nie√übrauch</option>
                                <option value="wohnrecht">Schenkung mit Wohnrecht</option>
                            </select>
                            <div class="form-help" id="schenkungsart-help">Art der geplanten Schenkung</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                üìä Anteil bei Teilschenkung (%)
                            </label>
                            <input type="number" id="schenkungsanteil" class="form-input" placeholder="z.B. 50" min="1" max="100" step="1" aria-describedby="schenkungsanteil-help">
                            <div class="form-help" id="schenkungsanteil-help">Nur bei Teilschenkung relevant</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                üí∞ Nie√übrauchswert (j√§hrlich)
                            </label>
                            <input type="number" id="niesbrauchswert" class="form-input" placeholder="z.B. 24.000" min="0" step="1000" aria-describedby="niesbrauchswert-help">
                            <div class="form-help" id="niesbrauchswert-help">J√§hrlicher Nie√übrauchswert (Miete oder Nutzungswert)</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                üë§ Alter des Schenkers
                            </label>
                            <input type="number" id="alter_schenker" class="form-input" placeholder="z.B. 65" min="18" max="100" aria-describedby="alter_schenker-help">
                            <div class="form-help" id="alter_schenker-help">Alter f√ºr Berechnung der Nie√übrauchsdauer</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                üìÖ Geplante Schenkungstermine
                            </label>
                            <select id="schenkungsstrategie" class="form-select" aria-describedby="schenkungsstrategie-help">
                                <option value="einmalig">Einmalige Schenkung</option>
                                <option value="zehn_jahre">Alle 10 Jahre (Freibetrag optimal nutzen)</option>
                                <option value="jaehrlich">J√§hrliche Teilschenkungen</option>
                            </select>
                            <div class="form-help" id="schenkungsstrategie-help">Strategie f√ºr die Schenkung</div>
                        </div>
                    </div>

                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="app.calculateSchenkungssteuer()">
                            üßÆ Schenkungssteuer berechnen
                        </button>
                        <button class="btn btn-warning" onclick="app.loadSchenkungExample()">
                            üí° Beispiel laden
                        </button>
                        <button class="btn btn-secondary" onclick="app.resetSchenkungForm()">
                            üîÑ Zur√ºcksetzen
                        </button>
                    </div>
                </div>

                <div id="schenkung-results" class="results-container">
                    <!-- Schenkungssteuer Results will be displayed here -->
                </div>
            `;
        }

        generateCashflowContent() {
            return `
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <span>üìä</span>
                            <span>Cash-Flow Analyse & Liquidit√§tsplanung</span>
                        </div>
                    </div>

                    <div class="alert alert-info">
                        <h3>üí∞ Intelligente Cash-Flow Optimierung</h3>
                        <p>Analysieren Sie die Liquidit√§tsauswirkungen verschiedener Steuerstrategien und optimieren Sie Ihre Zahlungsstr√∂me.</p>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">
                                üè† Monatliche Mieteinnahmen <span class="required">*</span>
                            </label>
                            <input type="number" id="mieteinnahmen" class="form-input" placeholder="z.B. 3.500" min="0" step="100" required aria-describedby="mieteinnahmen-help">
                            <div class="form-help" id="mieteinnahmen-help">Netto-Mieteinnahmen pro Monat</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                üí∏ Monatliche Betriebskosten
                            </label>
                            <input type="number" id="betriebskosten" class="form-input" placeholder="z.B. 800" min="0" step="50" aria-describedby="betriebskosten-help">
                            <div class="form-help" id="betriebskosten-help">Verwaltung, Instandhaltung, Versicherung</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                üè¶ Finanzierungskosten (monatlich)
                            </label>
                            <input type="number" id="finanzierungskosten" class="form-input" placeholder="z.B. 1.200" min="0" step="50" aria-describedby="finanzierungskosten-help">
                            <div class="form-help" id="finanzierungskosten-help">Zinsen und Tilgung f√ºr Darlehen</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                üìä Abschreibungen (j√§hrlich)
                            </label>
                            <input type="number" id="cashflow_abschreibungen" class="form-input" placeholder="z.B. 8.000" min="0" step="100" aria-describedby="cashflow_abschreibungen-help">
                            <div class="form-help" id="cashflow_abschreibungen-help">J√§hrliche AfA-Abschreibungen</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                üíº Pers√∂nlicher Steuersatz (%)
                            </label>
                            <select id="cashflow_steuersatz" class="form-select" aria-describedby="cashflow_steuersatz-help">
                                <option value="14">14% (Eingangssteuersatz)</option>
                                <option value="24">24% (Mittlerer Bereich)</option>
                                <option value="32">32% (H√∂herer Bereich)</option>
                                <option value="42" selected>42% (Spitzensteuersatz)</option>
                                <option value="45">45% (Reichensteuer)</option>
                            </select>
                            <div class="form-help" id="cashflow_steuersatz-help">Ihr Einkommensteuersatz</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                üìÖ Analysezeitraum
                            </label>
                            <select id="analysezeitraum" class="form-select" aria-describedby="analysezeitraum-help">
                                <option value="1">1 Jahr</option>
                                <option value="3">3 Jahre</option>
                                <option value="5" selected>5 Jahre</option>
                                <option value="10">10 Jahre</option>
                                <option value="15">15 Jahre</option>
                            </select>
                            <div class="form-help" id="analysezeitraum-help">Zeitraum f√ºr die Analyse</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                üìà Mietsteigerung (% p.a.)
                            </label>
                            <input type="number" id="mietsteigerung" class="form-input" placeholder="z.B. 2.5" min="0" max="10" step="0.1" aria-describedby="mietsteigerung-help">
                            <div class="form-help" id="mietsteigerung-help">Erwartete j√§hrliche Mietsteigerung</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                üí∞ Geplante Verkaufserl√∂se
                            </label>
                            <input type="number" id="verkaufserloes" class="form-input" placeholder="z.B. 650.000" min="0" step="1000" aria-describedby="verkaufserloes-help">
                            <div class="form-help" id="verkaufserloes-help">Erwarteter Verkaufserl√∂s am Ende des Zeitraums</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                üîÑ Reinvestitionsstrategie
                            </label>
                            <select id="reinvestition" class="form-select" aria-describedby="reinvestition-help">
                                <option value="keine">Keine Reinvestition</option>
                                <option value="liquiditaet">Cash-Optimierung</option>
                                <option value="portfolio">Portfolio-Erweiterung</option>
                                <option value="upgrade">Property-Upgrade</option>
                            </select>
                            <div class="form-help" id="reinvestition-help">Strategie f√ºr Reinvestitionen</div>
                        </div>
                    </div>

                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="app.calculateCashflow()">
                            üìä Cash-Flow analysieren
                        </button>
                        <button class="btn btn-success" onclick="app.generateCashflowForecast()">
                            üìà Liquidit√§tsprognose
                        </button>
                        <button class="btn btn-warning" onclick="app.loadCashflowExample()">
                            üí° Beispiel laden
                        </button>
                        <button class="btn btn-secondary" onclick="app.resetCashflowForm()">
                            üîÑ Zur√ºcksetzen
                        </button>
                    </div>
                </div>

                <div id="cashflow-results" class="results-container">
                    <!-- Cash-Flow Results will be displayed here -->
                </div>
            `;
        }

        generateStrategieContent() {
            return `
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <span>üéØ</span>
                            <span>KI-Gesamtstrategie & Portfolio-Optimierung</span>
                        </div>
                    </div>

                    <div class="alert alert-success">
                        <h3>ü§ñ Intelligente Gesamtstrategie-Analyse</h3>
                        <p>Unser KI-System analysiert Ihr gesamtes Immobilien-Portfolio und entwickelt eine optimale Langzeitstrategie f√ºr maximale Steuerersparnis.</p>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">
                                üè† Anzahl Immobilien im Portfolio
                            </label>
                            <input type="number" id="portfolio_anzahl" class="form-input" placeholder="z.B. 3" min="1" max="50" aria-describedby="portfolio_anzahl-help">
                            <div class="form-help" id="portfolio_anzahl-help">Gesamtanzahl Ihrer Immobilien</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                üí∞ Gesamtportfolio-Wert
                            </label>
                            <input type="number" id="portfolio_wert" class="form-input" placeholder="z.B. 2.000.000" min="0" step="10000" aria-describedby="portfolio_wert-help">
                            <div class="form-help" id="portfolio_wert-help">Gesch√§tzter Gesamtwert aller Immobilien</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                üéØ Strategisches Ziel
                            </label>
                            <select id="strategisches_ziel" class="form-select" aria-describedby="strategisches_ziel-help">
                                <option value="verkaufsoptimierung">Verkaufsoptimierung</option>
                                <option value="nachfolgeplanung">Nachfolgeplanung</option>
                                <option value="steuerminimierung">Steuerminimierung</option>
                                <option value="liquiditaet">Liquidit√§tssteigerung</option>
                                <option value="reinvestition">Reinvestitionsstrategie</option>
                            </select>
                            <div class="form-help" id="strategisches_ziel-help">Hauptziel der Optimierung</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                ‚è±Ô∏è Planungshorizont
                            </label>
                            <select id="planungshorizont" class="form-select" aria-describedby="planungshorizont-help">
                                <option value="kurzfristig">1-3 Jahre</option>
                                <option value="mittelfristig">3-7 Jahre</option>
                                <option value="langfristig">7-15 Jahre</option>
                                <option value="generational">Generationen√ºbergreifend</option>
                            </select>
                            <div class="form-help" id="planungshorizont-help">Zeitlicher Planungsrahmen</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Familiensituation
                            </label>
                            <select id="familiensituation" class="form-select" aria-describedby="familiensituation-help">
                                <option value="single">Alleinstehend</option>
                                <option value="ehepaar">Ehepaar</option>
                                <option value="familie_kinder">Familie mit Kindern</option>
                                <option value="grossfamilie">Gro√üfamilie (3+ Generationen)</option>
                            </select>
                            <div class="form-help" id="familiensituation-help">Ihre Familienkonstellation</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                üìä J√§hrliches Einkommen
                            </label>
                            <select id="jahreseinkommen" class="form-select" aria-describedby="jahreseinkommen-help">
                                <option value="niedrig">Bis 50.000‚Ç¨</option>
                                <option value="mittel">50.000‚Ç¨ - 100.000‚Ç¨</option>
                                <option value="hoch">100.000‚Ç¨ - 250.000‚Ç¨</option>
                                <option value="sehr_hoch">√úber 250.000‚Ç¨</option>
                            </select>
                            <div class="form-help" id="jahreseinkommen-help">Ihre Einkommenskategorie</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                üåç Internationale Komponente
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="checkbox" id="international">
                                <span>Internationale Strukturen erw√ºnscht</span>
                            </label>
                            <div class="form-help">Cross-Border Optimierung einbeziehen</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                ‚öñÔ∏è Risikobereitschaft
                            </label>
                            <select id="risikobereitschaft" class="form-select" aria-describedby="risikobereitschaft-help">
                                <option value="konservativ">Konservativ</option>
                                <option value="moderat">Moderat</option>
                                <option value="progressiv">Progressiv</option>
                                <option value="aggressiv">Aggressiv</option>
                            </select>
                            <div class="form-help" id="risikobereitschaft-help">Ihre Risikobereitschaft bei Optimierungen</div>
                        </div>
                    </div>

                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="app.generateKIStrategy()">
                            ü§ñ KI-Gesamtstrategie generieren
                        </button>
                        <button class="btn btn-success" onclick="app.analyzePortfolio()">
                            üìä Portfolio-Analyse
                        </button>
                        <button class="btn btn-warning" onclick="app.loadStrategyExample()">
                            üí° Beispiel laden
                        </button>
                        <button class="btn btn-secondary" onclick="app.resetStrategyForm()">
                            üîÑ Zur√ºcksetzen
                        </button>
                    </div>
                </div>

                <div id="strategy-results" class="results-container">
                    <!-- Strategy Results will be displayed here -->
                </div>
            `;
        }

        // Helper methods for form data collection and population
        populateGrundsteuerForm(data) {
            Object.keys(data).forEach(key => {
                const element = document.getElementById(key);
                if (element) {
                    if (element.type === 'checkbox') {
                        element.checked = data[key];
                    } else {
                        element.value = data[key];
                    }
                }
            });
        }

        populateErbschaftForm(data) {
            Object.keys(data).forEach(key => {
                const element = document.getElementById(key);
                if (element) {
                    if (element.type === 'checkbox') {
                        element.checked = data[key];
                    } else {
                        element.value = data[key];
                    }
                    
                    // Trigger validation
                    this.validateField(element);
                }
            });
        }

        populateSchenkungForm(data) {
            Object.keys(data).forEach(key => {
                const element = document.getElementById(key);
                if (element) {
                    if (element.type === 'checkbox') {
                        element.checked = data[key];
                    } else {
                        element.value = data[key];
                    }
                    
                    // Trigger validation
                    this.validateField(element);
                }
            });
        }

        populateCashflowForm(data) {
            Object.keys(data).forEach(key => {
                const element = document.getElementById(key);
                if (element) {
                    if (element.type === 'checkbox') {
                        element.checked = data[key];
                    } else {
                        element.value = data[key];
                    }
                    
                    // Trigger validation
                    this.validateField(element);
                }
            });
        }

        populateStrategieForm(data) {
            Object.keys(data).forEach(key => {
                const element = document.getElementById(key);
                if (element) {
                    if (element.type === 'checkbox') {
                        element.checked = data[key];
                    } else {
                        element.value = data[key];
                    }
                    
                    // Trigger validation
                    this.validateField(element);
                }
            });
        }

        // Enhanced Calculation Methods for Different Modules
        async calculateGrundsteuer() {
    try {
        this.showProgress('Berechne neue Grundsteuer 2025...', 20);
        
        const formData = this.collectGrundsteuerData();
        // Fixed: Remove redundant field mapping
        const data = formData;
        
        const results = await this.calculationEngine.calculate('grundsteuer', data);
        
        this.showProgress('Erstelle Grundsteuer-Ergebnisse...', 80);
        this.displayGrundsteuerResults(results);
        
        setTimeout(() => {
            this.hideProgress();
            this.showToast('Grundsteuer erfolgreich berechnet', 'success');
        }, 500);

    } catch (error) {
        this.hideProgress();
        this.errorHandler.logError(error);
        this.showToast('Grundsteuer-Berechnung fehlgeschlagen: ' + error.message, 'danger');
    }
}

        collectGrundsteuerData() {
            return {
                grundstuecksflaeche: parseFloat(document.getElementById('grundstuecksflaeche')?.value) || 0,
                wohnflaeche: parseFloat(document.getElementById('wohnflaeche')?.value) || 0,
                baujahr: parseInt(document.getElementById('baujahr')?.value) || 2000,
                immobilientyp: document.getElementById('grundsteuer_immobilientyp')?.value || 'einfamilienhaus',
                bundesland: document.getElementById('grundsteuer_bundesland')?.value || 'nw',
                hebesatz: parseFloat(document.getElementById('hebesatz_grundsteuer')?.value) || 470
            };
        }

        collectCashflowData() {
            return {
                mieteinnahmen: parseFloat(document.getElementById('mieteinnahmen')?.value) || 0,
                betriebskosten: parseFloat(document.getElementById('betriebskosten')?.value) || 0,
                finanzierungskosten: parseFloat(document.getElementById('finanzierungskosten')?.value) || 0,
                abschreibungen: parseFloat(document.getElementById('cashflow_abschreibungen')?.value) || 0,
                steuersatz: parseFloat(document.getElementById('cashflow_steuersatz')?.value) || 42,
                analysezeitraum: parseInt(document.getElementById('analysezeitraum')?.value) || 5,
                mietsteigerung: parseFloat(document.getElementById('mietsteigerung')?.value) || 2.5,
                verkaufserloes: parseFloat(document.getElementById('verkaufserloes')?.value) || 0,
                reinvestition: document.getElementById('reinvestition')?.value || 'keine'
            };
        }

        collectStrategyData() {
            return {
                portfolio_anzahl: parseInt(document.getElementById('portfolio_anzahl')?.value) || 1,
                portfolio_wert: parseFloat(document.getElementById('portfolio_wert')?.value) || 0,
                strategisches_ziel: document.getElementById('strategisches_ziel')?.value || 'steuerminimierung',
                planungshorizont: document.getElementById('planungshorizont')?.value || 'mittelfristig',
                familiensituation: document.getElementById('familiensituation')?.value || 'ehepaar',
                jahreseinkommen: document.getElementById('jahreseinkommen')?.value || 'mittel',
                international: document.getElementById('international')?.checked || false,
                risikobereitschaft: document.getElementById('risikobereitschaft')?.value || 'moderat'
            };
        }
        
        displayGrundsteuerResults(results) {
            const container = document.getElementById('grundsteuer-results');
            if (!container) return;
            
            const html = `
                <div class="alert alert-success">
                    <h3>üèõÔ∏è Ihre neue Grundsteuer 2025</h3>
                    <p><strong>J√§hrliche Grundsteuer:</strong> ${this.formatCurrency(results.grundsteuerJaehrlich)}</p>
                    <p><strong>Monatliche Belastung:</strong> ${this.formatCurrency(results.grundsteuerMonatlich)}</p>
                </div>

                <div class="results-grid">
                    <div class="result-card">
                        <div class="result-header">
                            <h3 class="result-title">üìä Berechnung im Detail</h3>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Grundsteuerwert:</span>
                            <span class="result-value">${this.formatCurrency(results.grundsteuerwert)}</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Grundsteuermessbetrag:</span>
                            <span class="result-value">${this.formatCurrency(results.grundsteuermessbetrag)}</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Hebesatz:</span>
                            <span class="result-value">${results.hebesatz}%</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Grundsteuer j√§hrlich:</span>
                            <span class="result-value">${this.formatCurrency(results.grundsteuerJaehrlich)}</span>
                        </div>
                    </div>

                    <div class="result-card">
                        <div class="result-header">
                            <h3 class="result-title">üìà Vergleich zum alten System</h3>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Alte Grundsteuer (gesch√§tzt):</span>
                            <span class="result-value">${this.formatCurrency(results.vergleich.altesSystem)}</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Neue Grundsteuer:</span>
                            <span class="result-value">${this.formatCurrency(results.grundsteuerJaehrlich)}</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Differenz:</span>
                            <span class="result-value ${results.vergleich.differenz > 0 ? 'negative' : ''}">${this.formatCurrency(Math.abs(results.vergleich.differenz))} ${results.vergleich.differenz > 0 ? 'mehr' : 'weniger'}</span>
                        </div>
                    </div>
                </div>
            `;

            container.innerHTML = html;
        }

        async calculateErbschaftsteuer() {
            try {
                this.showProgress('Berechne Erbschaftsteuer...', 20);
                
                const data = this.collectErbschaftData();
                const results = await this.calculationEngine.calculate('erbschaft', data);
                
                this.showProgress('Erstelle Erbschaft-Ergebnisse...', 80);
                this.displayErbschaftResults(results);
                
                setTimeout(() => {
                    this.hideProgress();
                    this.showToast('üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Erbschaftsteuer erfolgreich berechnet', 'success');
                }, 500);

            } catch (error) {
                this.hideProgress();
                this.errorHandler.logError(error);
                this.showToast('‚ùå Erbschaftsteuer-Berechnung fehlgeschlagen: ' + error.message, 'danger');
            }
        }

collectErbschaftData() {
    return {
        immobilienwert: parseFloat(document.getElementById('erbschaft_immobilienwert')?.value) || 0,
        verwandtschaftsgrad: document.getElementById('verwandtschaftsgrad')?.value || 'kind',
        immobilienart: document.getElementById('erbschaft_immobilienart')?.value || 'eigenheim',
        sonstiges_vermoegen: parseFloat(document.getElementById('sonstiges_vermoegen')?.value) || 0,
        selbstnutzung: document.getElementById('selbstnutzung_erbe')?.checked || false,
        lebzeitige_uebertragung: document.getElementById('lebzeitige_uebertragung')?.checked || false
    };
}

        displayErbschaftResults(results) {
            const container = document.getElementById('erbschaft-results');
            if (!container) return;
            
            const html = `
                <div class="alert ${results.erbschaftsteuer === 0 ? 'alert-success' : 'alert-info'}">
                    <h3>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Ihre Erbschaftsteuer-Berechnung</h3>
                    <p><strong>Erbschaftsteuer:</strong> ${this.formatCurrency(results.erbschaftsteuer)}</p>
                    <p><strong>Effektiver Steuersatz:</strong> ${results.effektiver_steuersatz.toFixed(1)}%</p>
                </div>

                <div class="results-grid">
                    <div class="result-card">
                        <div class="result-header">
                            <h3 class="result-title">üìä Berechnung im Detail</h3>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Gesamtverm√∂gen:</span>
                            <span class="result-value">${this.formatCurrency(results.gesamtvermoegen)}</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Freibetrag:</span>
                            <span class="result-value">${this.formatCurrency(results.freibetrag)}</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Steuerpflichtiger Erwerb:</span>
                            <span class="result-value">${this.formatCurrency(results.steuerpflichtiger_erwerb)}</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Erbschaftsteuer:</span>
                            <span class="result-value">${this.formatCurrency(results.erbschaftsteuer)}</span>
                        </div>
                    </div>
                </div>
            `;

            container.innerHTML = html;
        }

        async calculateSchenkungssteuer() {
            try {
                this.showProgress('Berechne Schenkungssteuer...', 20);
                
                const data = this.collectSchenkungData();
                const results = await this.calculationEngine.calculate('schenkung', data);
                
                this.showProgress('Erstelle Schenkung-Ergebnisse...', 80);
                this.displaySchenkungResults(results);
                
                setTimeout(() => {
                    this.hideProgress();
                    this.showToast('üéÅ Schenkungssteuer erfolgreich berechnet', 'success');
                }, 500);

            } catch (error) {
                this.hideProgress();
                this.errorHandler.logError(error);
                this.showToast('‚ùå Schenkungssteuer-Berechnung fehlgeschlagen: ' + error.message, 'danger');
            }
        }

        collectSchenkungData() {
    return {
        immobilienwert: parseFloat(document.getElementById('schenkung_immobilienwert')?.value) || 0,
        beschenkter: document.getElementById('beschenkter')?.value || 'kind',
        vorherige_schenkungen: parseFloat(document.getElementById('vorherige_schenkungen')?.value) || 0,
        schenkungsart: document.getElementById('schenkungsart')?.value || 'vollschenkung',
        anteil: parseFloat(document.getElementById('schenkungsanteil')?.value) || 100,
        niesbrauchswert: parseFloat(document.getElementById('niesbrauchswert')?.value) || 0,
        alter_schenker: parseInt(document.getElementById('alter_schenker')?.value) || 65,
        schenkungsstrategie: document.getElementById('schenkungsstrategie')?.value || 'einmalig'
    };
}

        displaySchenkungResults(results) {
            const container = document.getElementById('schenkung-results');
            if (!container) return;
            
            const html = `
                <div class="alert ${results.schenkungssteuer === 0 ? 'alert-success' : 'alert-info'}">
                    <h3>üéÅ Ihre Schenkungssteuer-Berechnung</h3>
                    <p><strong>Schenkungssteuer:</strong> ${this.formatCurrency(results.schenkungssteuer)}</p>
                    <p><strong>Effektiver Steuersatz:</strong> ${results.effektiver_steuersatz.toFixed(1)}%</p>
                </div>

                <div class="results-grid">
                    <div class="result-card">
                        <div class="result-header">
                            <h3 class="result-title">üìä Berechnung im Detail</h3>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Schenkungswert:</span>
                            <span class="result-value">${this.formatCurrency(results.schenkungswert)}</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Gesamterwerb (inkl. Vorschenkungen):</span>
                            <span class="result-value">${this.formatCurrency(results.gesamterwerb)}</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Freibetrag:</span>
                            <span class="result-value">${this.formatCurrency(results.freibetrag)}</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Steuerpflichtiger Erwerb:</span>
                            <span class="result-value">${this.formatCurrency(results.steuerpflichtiger_erwerb)}</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Schenkungssteuer:</span>
                            <span class="result-value">${this.formatCurrency(results.schenkungssteuer)}</span>
                        </div>
                    </div>
                </div>
            `;

            container.innerHTML = html;
        }

        async calculateCashflow() {
    try {
        this.showProgress('Berechne Cash-Flow Analyse...', 20);
        
        const formData = this.collectCashflowData();
        // Fixed: Remove redundant field mapping
        const data = formData;
        
        const results = await this.calculationEngine.calculate('cashflow', data);
        
        this.showProgress('Erstelle Cash-Flow Ergebnisse...', 80);
        this.displayCashflowResults(results);
        
        setTimeout(() => {
            this.hideProgress();
            this.showToast('Cash-Flow erfolgreich analysiert', 'success');
        }, 500);

    } catch (error) {
        this.hideProgress();
        this.errorHandler.logError(error);
        this.showToast('Cash-Flow Analyse fehlgeschlagen: ' + error.message, 'danger');
    }
}
        
        displayCashflowResults(results) {
            const container = document.getElementById('cashflow-results');
            if (!container) return;
            
            let html = `
                <div class="alert alert-success">
                    <h3>üìä Cash-Flow Analyse abgeschlossen</h3>
                    <p><strong>Gesamter Cash-Flow:</strong> ${this.formatCurrency(results.gesamt_cashflow)}</p>
                    <p><strong>Durchschnittlicher j√§hrlicher Cash-Flow:</strong> ${this.formatCurrency(results.durchschnittlicher_cashflow)}</p>
                    ${results.roi > 0 ? `<p><strong>ROI:</strong> ${results.roi.toFixed(1)}%</p>` : ''}
                </div>

                <div class="results-grid">
                    <div class="result-card">
                        <div class="result-header">
                            <h3 class="result-title">üìà Cash-Flow √úbersicht</h3>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Kumulierter Cash-Flow (${results.jahre.length} Jahre):</span>
                            <span class="result-value">${this.formatCurrency(results.kumulierter_cashflow)}</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Verkaufs-Cash-Flow:</span>
                            <span class="result-value">${this.formatCurrency(results.verkaufs_cashflow)}</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Gesamt-Cash-Flow:</span>
                            <span class="result-value">${this.formatCurrency(results.gesamt_cashflow)}</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">√ò J√§hrlicher Cash-Flow:</span>
                            <span class="result-value">${this.formatCurrency(results.durchschnittlicher_cashflow)}</span>
                        </div>
                    </div>

                    <div class="result-card">
                        <div class="result-header">
                            <h3 class="result-title">üìÖ Jahres√ºbersicht</h3>
                        </div>
                        <div style="overflow-x: auto;">
                            <table class="data-table" style="width: 100%; font-size: 0.8rem;">
                                <thead>
                                    <tr>
                                        <th>Jahr</th>
                                        <th>Mieteinnahmen</th>
                                        <th>Betriebskosten</th>
                                        <th>Cash-Flow</th>
                                        <th>Kumuliert</th>
                                    </tr>
                                </thead>
                                <tbody>
            `;

            results.jahre.forEach(jahr => {
                html += `
                    <tr>
                        <td style="text-align: center;">${jahr.jahr}</td>
                        <td style="text-align: right;">${this.formatCurrency(jahr.mieteinnahmen)}</td>
                        <td style="text-align: right;">${this.formatCurrency(jahr.betriebskosten)}</td>
                        <td style="text-align: right; color: ${jahr.cashflow_nach_steuern >= 0 ? '#11998e' : '#e74c3c'}">${this.formatCurrency(jahr.cashflow_nach_steuern)}</td>
                        <td style="text-align: right;">${this.formatCurrency(jahr.kumulierter_cashflow)}</td>
                    </tr>
                `;
            });

            html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;

            container.innerHTML = html;
        }

        async generateKIStrategy() {
            try {
                this.showProgress('KI analysiert Ihr Portfolio...', 20);
                
                const data = this.collectStrategyData();
                const results = await this.performKIStrategyGeneration(data);
                
                this.showProgress('Erstelle KI-Strategieempfehlungen...', 80);
                this.displayStrategyResults(results);
                
                setTimeout(() => {
                    this.hideProgress();
                    this.showToast('ü§ñ KI-Strategie erfolgreich generiert', 'success');
                }, 500);

            } catch (error) {
                this.hideProgress();
                this.errorHandler.logError(error);
                this.showToast('‚ùå KI-Strategiegenerierung fehlgeschlagen: ' + error.message, 'danger');
            }
        }

        async performKIStrategyGeneration(data) {
            const strategien = [];

            if (data.portfolio_wert > 2000000) {
                strategien.push({
                    name: 'Family Office Struktur',
                    beschreibung: 'Professionelle Verm√∂gensverwaltung mit Steuerfamilienstiftung',
                    prioritaet: 'Hoch',
                    ersparnis: data.portfolio_wert * 0.15,
                    zeitrahmen: '2-3 Jahre',
                    komplexitaet: 'Hoch'
                });
            }

            if (data.strategisches_ziel === 'nachfolgeplanung') {
                strategien.push({
                    name: 'Generationen-√ºbergreifende Planung',
                    beschreibung: 'Stufenweise √úbertragung mit Nie√übrauchsvorbehalten',
                    prioritaet: 'Sehr Hoch',
                    ersparnis: data.portfolio_wert * 0.25,
                    zeitrahmen: '5-10 Jahre',
                    komplexitaet: 'Mittel'
                });
            }

            if (data.international) {
                strategien.push({
                    name: 'Cross-Border Optimierung',
                    beschreibung: 'Internationale Holdingstrukturen f√ºr Steueroptimierung',
                    prioritaet: 'Hoch',
                    ersparnis: data.portfolio_wert * 0.18,
                    zeitrahmen: '1-2 Jahre',
                    komplexitaet: 'Sehr Hoch'
                });
            }

            strategien.push({
                name: 'Portfolio-Diversifikation',
                beschreibung: 'Optimierung der Rechtsformen je Immobilie',
                prioritaet: 'Mittel',
                ersparnis: data.portfolio_wert * 0.08,
                zeitrahmen: '6-12 Monate',
                komplexitaet: 'Niedrig'
            });

            const empfehlungen = this.generateKIRecommendations(data, strategien);

            return {
                strategien,
                empfehlungen,
                portfolio_analyse: {
                    risiko_score: this.calculateRiskScore(data),
                    optimierungspotential: data.portfolio_wert * 0.12,
                    steuerbelastung_aktuell: data.portfolio_wert * 0.28
                }
            };
        }

        generateKIRecommendations(data, strategien) {
            const empfehlungen = [];

            empfehlungen.push({
                kategorie: 'Sofortma√ünahmen',
                items: [
                    'Portfolio-Analyse aller Immobilien durchf√ºhren',
                    'Verkaufsstrategien f√ºr 10+ Jahre gehaltene Immobilien pr√ºfen',
                    'Familienpool-Strukturen f√ºr neue Akquisitionen'
                ]
            });

            empfehlungen.push({
                kategorie: 'Mittelfristige Optimierung',
                items: [
                    'Schrittweise √úbertragung auf nachfolgende Generation',
                    'Nie√übrauch-Strukturen f√ºr laufende Eink√ºnfte',
                    'Cross-Border Strukturen f√ºr internationale Diversifikation'
                ]
            });

            if (data.planungshorizont === 'generational') {
                empfehlungen.push({
                    kategorie: 'Langfrist-Strategie',
                    items: [
                        'Familienstiftung f√ºr Generationenverm√∂gen',
                        'Sukzessionsplanung mit steueroptimalen Zeitpunkten',
                        'Internationale Strukturen f√ºr globale Diversifikation'
                    ]
                });
            }

            return empfehlungen;
        }

        calculateRiskScore(data) {
            let score = 50;

            if (data.risikobereitschaft === 'konservativ') score -= 20;
            if (data.risikobereitschaft === 'aggressiv') score += 30;
            if (data.international) score += 15;
            if (data.portfolio_wert > 5000000) score += 10;

            return Math.max(0, Math.min(100, score));
        }

        displayStrategyResults(results) {
            const container = document.getElementById('strategy-results');
            if (!container) return;
            
            let html = `
                <div class="alert alert-success">
                    <h3>ü§ñ KI-Strategieanalyse abgeschlossen</h3>
                    <p><strong>Optimierungspotential:</strong> ${this.formatCurrency(results.portfolio_analyse.optimierungspotential)}</p>
                    <p><strong>Risiko-Score:</strong> ${results.portfolio_analyse.risiko_score}/100</p>
                </div>

                <div class="results-grid">
            `;

            results.strategien.forEach(strategie => {
                const priorityClass = strategie.prioritaet === 'Sehr Hoch' ? 'best' : 
                                    strategie.prioritaet === 'Hoch' ? 'warning-option' : '';
                
                html += `
                    <div class="result-card ${priorityClass}">
                        <div class="result-header">
                            <h3 class="result-title">${this.escapeHtml(strategie.name)}</h3>
                            <span class="result-badge">${this.escapeHtml(strategie.prioritaet)}</span>
                        </div>
                        <p style="margin-bottom: 1rem;">${this.escapeHtml(strategie.beschreibung)}</p>
                        <div class="result-item">
                            <span class="result-label">Ersparnis-Potential:</span>
                            <span class="result-value">${this.formatCurrency(strategie.ersparnis)}</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Zeitrahmen:</span>
                            <span class="result-value">${this.escapeHtml(strategie.zeitrahmen)}</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Komplexit√§t:</span>
                            <span class="result-value">${this.escapeHtml(strategie.komplexitaet)}</span>
                        </div>
                    </div>
                `;
            });

            html += '</div>';

            html += `
                <div class="card mt-4">
                    <div class="card-header">
                        <h3 class="card-title">üí° KI-Empfehlungen</h3>
                    </div>
            `;

            results.empfehlungen.forEach(empfehlung => {
                html += `
                    <div style="margin-bottom: 2rem;">
                        <h4 style="color: var(--primary-solid); margin-bottom: 1rem;">${this.escapeHtml(empfehlung.kategorie)}</h4>
                        <ul style="margin-left: 1.5rem;">
                            ${empfehlung.items.map(item => `<li style="margin-bottom: 0.5rem;">${this.escapeHtml(item)}</li>`).join('')}
                        </ul>
                    </div>
                `;
            });

            html += '</div>';

            container.innerHTML = html;
        }

        // Example Loading Methods
        loadExample() {
            const exampleData = {
                kaufpreis: 400000,
                verkaufspreis: 600000,
                nebenkosten_kauf: 40000,
                nebenkosten_verkauf: 30000,
                modernisierung: 35000,
                haltedauer: 8,
                steuersatz: 42,
                kirchensteuer: 8,
                bundesland: 'by',
                werbungskosten: 5000,
                immobilientyp: 'eigenheim'
            };

            this.saveCurrentState();
            this.populateForm(exampleData);
            
            // Update current scenario data
            const scenario = this.scenarios.get(this.currentScenario);
            if (scenario) {
                scenario.data = exampleData;
            }
            
            this.showToast('üí° Beispieldaten geladen', 'success');
            
            if (this.realtimeEnabled) {
                setTimeout(() => this.calculateOptimal(), 500);
            }
        }

        loadGrundsteuerExample() {
            const exampleData = {
                grundstuecksflaeche: 800,
                wohnflaeche: 150,
                baujahr: 1995,
                grundsteuer_immobilientyp: 'einfamilienhaus',
                grundsteuer_bundesland: 'nw',
                hebesatz_grundsteuer: 470
            };

            this.populateGrundsteuerForm(exampleData);
            
            // Save to section data
            if (!this.sectionData) this.sectionData = {};
            this.sectionData.grundsteuer = exampleData;

            this.showToast('üí° Grundsteuer-Beispiel geladen', 'success');
            setTimeout(() => this.calculateGrundsteuer(), 500);
        }

        loadErbschaftExample() {
            const exampleData = {
                erbschaft_immobilienwert: 600000,
                verwandtschaftsgrad: 'kind',
                erbschaft_immobilienart: 'eigenheim',
                sonstiges_vermoegen: 100000,
                selbstnutzung_erbe: true,
                lebzeitige_uebertragung: false
            };

            this.populateErbschaftForm(exampleData);
            
            // Save to section data
            if (!this.sectionData) this.sectionData = {};
            this.sectionData.erbschaft = exampleData;

            this.showToast('üí° Erbschaftsteuer-Beispiel geladen', 'success');
            setTimeout(() => this.calculateErbschaftsteuer(), 500);
        }

        loadSchenkungExample() {
            const exampleData = {
                schenkung_immobilienwert: 800000,
                beschenkter: 'kind',
                vorherige_schenkungen: 50000,
                schenkungsart: 'niesbrauch',
                schenkungsanteil: 100,
                niesbrauchswert: 24000,
                alter_schenker: 65,
                schenkungsstrategie: 'zehn_jahre'
            };

            this.populateSchenkungForm(exampleData);
            
            // Save to section data
            if (!this.sectionData) this.sectionData = {};
            this.sectionData.schenkung = exampleData;

            this.showToast('üí° Schenkungssteuer-Beispiel geladen', 'success');
            setTimeout(() => this.calculateSchenkungssteuer(), 500);
        }

        loadCashflowExample() {
            const exampleData = {
                mieteinnahmen: 3500,
                betriebskosten: 800,
                finanzierungskosten: 1200,
                cashflow_abschreibungen: 8000,
                cashflow_steuersatz: 42,
                analysezeitraum: 5,
                mietsteigerung: 2.5,
                verkaufserloes: 650000,
                reinvestition: 'portfolio'
            };

            this.populateCashflowForm(exampleData);
            
            // Save to section data
            if (!this.sectionData) this.sectionData = {};
            this.sectionData.cashflow = exampleData;

            this.showToast('üí° Cash-Flow Beispiel geladen', 'success');
            setTimeout(() => this.calculateCashflow(), 500);
        }

        loadStrategyExample() {
            const exampleData = {
                portfolio_anzahl: 4,
                portfolio_wert: 3200000,
                strategisches_ziel: 'nachfolgeplanung',
                planungshorizont: 'langfristig',
                familiensituation: 'familie_kinder',
                jahreseinkommen: 'sehr_hoch',
                international: true,
                risikobereitschaft: 'moderat'
            };

            this.populateStrategieForm(exampleData);
            
            // Save to section data
            if (!this.sectionData) this.sectionData = {};
            this.sectionData.strategie = exampleData;

            this.showToast('üí° Strategie-Beispiel geladen', 'success');
            setTimeout(() => this.generateKIStrategy(), 500);
        }

        // Reset Methods
        resetForm() {
            this.saveCurrentState();
            
            const contentSelector = `#${this.currentScenario}-content`;
            const inputs = document.querySelectorAll(`${contentSelector} .form-input, ${contentSelector} .form-select`);
            
            inputs.forEach(input => {
                if (input.type === 'number') {
                    input.value = '';
                } else if (input.type === 'checkbox') {
                    input.checked = false;
                } else if (input.tagName === 'SELECT') {
                    input.selectedIndex = 0;
                } else {
                    input.value = '';
                }
                
                input.classList.remove('valid', 'invalid');
                this.updateValidationIndicator(input, true);
                this.clearFieldError(input);
            });

            // Clear current scenario data
            const scenario = this.scenarios.get(this.currentScenario);
            if (scenario) {
                scenario.data = {};
            }

            document.getElementById('results-container').innerHTML = '';
            this.updateAnalytics({ structures: [] }, 0);
            
            this.showToast('üîÑ Formular zur√ºckgesetzt', 'info');
        }

        resetAll() {
            this.resetForm();
            this.cache.clear();
            this.appState.history = [];
            this.appState.historyIndex = -1;
            this.sectionData = {}; // Reset section data
            this.updateHistoryButtons();
            this.analytics = {
                calculations: 0,
                cacheHits: 0,
                errors: 0,
                startTime: Date.now()
            };
            this.errorHandler.clearErrors();
            this.updateSessionMetrics();
            this.showToast('üîÑ Alles zur√ºckgesetzt', 'info');
        }

        // Utility Methods
        collectFormData() {
            const data = {};
            const prefix = this.getScenarioPrefix(this.currentScenario);
            const contentSelector = `#${this.currentScenario}-content`;
            const inputs = document.querySelectorAll(`${contentSelector} .form-input, ${contentSelector} .form-select`);
            
            inputs.forEach(input => {
                // Remove scenario prefix from field name to get the actual field name
                let fieldName = input.id;
                if (prefix && fieldName.startsWith(prefix)) {
                    fieldName = fieldName.substring(prefix.length);
                }
                
                if (input.type === 'number') {
                    data[fieldName] = parseFloat(input.value) || 0;
                } else if (input.type === 'checkbox') {
                    data[fieldName] = input.checked;
                } else {
                    data[fieldName] = input.value || '';
                }
            });

            return data;
        }

        populateForm(data) {
            const prefix = this.getScenarioPrefix(this.currentScenario);
            
            Object.keys(data).forEach(key => {
                const elementId = prefix + key;
                const element = document.getElementById(elementId);
                if (element) {
                    if (element.type === 'checkbox') {
                        element.checked = data[key];
                    } else {
                        element.value = data[key];
                    }
                    
                    if (!this.isRestoringState) {
                        this.validateField(element);
                    }
                }
            });
        }

        formatCurrency(amount) {
            return new Intl.NumberFormat('de-DE', {
                style: 'currency',
                currency: 'EUR',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount || 0);
        }

        toggleRealtime() {
            const checkbox = document.getElementById('realtime-calc');
            this.realtimeEnabled = checkbox?.checked ?? true;
            
            const status = this.realtimeEnabled ? 'aktiviert' : 'deaktiviert';
            this.showToast(`ü§ñ Real-time Berechnung ${status}`, 'info');
        }

        toggleAdvanced() {
            const toggle = document.querySelector('.disclosure-toggle');
            const content = document.getElementById('advanced-content');
            const arrow = document.querySelector('.disclosure-arrow');
            
            if (content && toggle && arrow) {
                if (content.classList.contains('open')) {
                    content.classList.remove('open');
                    content.style.display = 'none';
                    toggle.classList.remove('open');
                } else {
                    content.classList.add('open');
                    content.style.display = 'block';
                    toggle.classList.add('open');
                }
            }
        }

        // Modal Management
        showModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'flex';
                setTimeout(() => modal.classList.add('show'), 10);
                
                // Focus management
                const firstFocusable = modal.querySelector('button, input, select, textarea, [tabindex]:not([tabindex="-1"])');
                if (firstFocusable) {
                    firstFocusable.focus();
                }
            }
        }

        closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('show');
                setTimeout(() => modal.style.display = 'none', 300);
            }
        }

        closeAllModals() {
            document.querySelectorAll('.modal-overlay').forEach(modal => {
                modal.style.display = 'none';
            });
        }

        // Progress Management
        showProgress(message, percentage) {
            const overlay = document.getElementById('progress-overlay');
            const title = document.getElementById('progress-title');
            const text = document.getElementById('progress-text');
            const fill = document.getElementById('progress-fill');

            if (overlay && title && text && fill) {
                overlay.style.display = 'flex';
                title.textContent = 'KI-Berechnung l√§uft...';
                text.textContent = message;
                fill.style.width = percentage + '%';
                fill.setAttribute('aria-valuenow', percentage);
            }
        }

        hideProgress() {
            const overlay = document.getElementById('progress-overlay');
            if (overlay) {
                overlay.style.display = 'none';
            }
        }

        cancelCalculation() {
            if (this.calculationTimeout) {
                clearTimeout(this.calculationTimeout);
            }
            this.hideProgress();
            this.showToast('‚èπÔ∏è Berechnung abgebrochen', 'warning');
        }

        // Toast Notifications
        showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            if (!container) return;

            const toastId = 'toast-' + Date.now();
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.id = toastId;
            
            const icons = {
                'success': '‚úÖ',
                'warning': '‚ö†Ô∏è',
                'danger': '‚ùå',
                'info': '‚ÑπÔ∏è'
            };

            toast.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>${icons[type] || '‚ÑπÔ∏è'} ${message}</span>
                    <button onclick="document.getElementById('${toastId}').remove()" 
                            style="background: none; border: none; font-size: 1.2rem; cursor: pointer;"
                            aria-label="Toast schlie√üen">√ó</button>
                </div>
            `;

            container.appendChild(toast);

            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (document.getElementById(toastId)) {
                    toast.style.animation = 'slideOutToast 0.3s ease forwards';
                    setTimeout(() => toast.remove(), 300);
                }
            }, 5000);
        }

        // Enhanced Analytics and Monitoring
        initializeAnalytics() {
            if (typeof Chart !== 'undefined') {
                Chart.defaults.font.family = "'Segoe UI', system-ui, -apple-system, sans-serif";
                Chart.defaults.color = '#6c757d';
            }

            setInterval(() => {
                this.updateSessionMetrics();
            }, 5000);
        }

        updateSessionMetrics() {
            const uptime = Date.now() - this.analytics.startTime;
            const uptimeMinutes = Math.floor(uptime / 60000);
            
            const sessionStats = document.getElementById('session-stats');
            if (sessionStats) {
                sessionStats.innerHTML = `
                    <div>Berechnungen: <span id="calc-count">${this.analytics.calculations}</span></div>
                    <div>Cache Hits: <span id="cache-hits">${this.analytics.cacheHits}</span></div>
                    <div>Fehlerrate: <span id="error-rate">${this.analytics.calculations > 0 ? (this.analytics.errors / this.analytics.calculations * 100).toFixed(1) : 0}%</span></div>
                    <div>Laufzeit: <span id="uptime">${uptimeMinutes}min</span></div>
                `;
            }
        }

        setupPerformanceMonitoring() {
            // Monitor memory usage
            if (performance.memory) {
                setInterval(() => {
                    const memory = performance.memory;
                    if (memory.usedJSHeapSize > memory.jsHeapSizeLimit * 0.9) {
                        console.warn('High memory usage detected');
                        this.showToast('‚ö†Ô∏è Hohe Speichernutzung erkannt', 'warning');
                    }
                }, 30000);
            }

            // Monitor calculation performance
            const originalCalculate = this.calculateOptimal;
            this.calculateOptimal = async function() {
                const start = performance.now();
                try {
                    await originalCalculate.call(this);
                } finally {
                    const duration = performance.now() - start;
                    if (duration > 5000) {
                        console.warn(`Slow calculation detected: ${duration}ms`);
                    }
                }
            };
        }

        // History Management
        saveCurrentState() {
            this.appState.saveCurrentState();
        }
        
        undo() {
            if (this.appState.undo()) {
                this.updateHistoryButtons();
                this.showToast('‚Ü∂ R√ºckg√§ngig', 'info');
                return true;
            }
            this.showToast('‚ö†Ô∏è Nichts zum R√ºckg√§ngigmachen', 'warning');
            return false;
        }

        redo() {
            if (this.appState.redo()) {
                this.updateHistoryButtons();
                this.showToast('‚Ü∑ Wiederholt', 'info');
                return true;
            }
            this.showToast('‚ö†Ô∏è Nichts zum Wiederholen', 'warning');
            return false;
        }

        updateHistoryButtons() {
            const undoBtn = document.getElementById('undo-btn');
            const redoBtn = document.getElementById('redo-btn');
            
            if (undoBtn && redoBtn) {
                undoBtn.disabled = !this.appState.canUndo();
                redoBtn.disabled = !this.appState.canRedo();
                
                // Update visual feedback
                undoBtn.style.opacity = undoBtn.disabled ? '0.5' : '1';
                redoBtn.style.opacity = redoBtn.disabled ? '0.5' : '1';
                
                // Update tooltips
                undoBtn.title = undoBtn.disabled ? 'Nichts zum R√ºckg√§ngigmachen' : 'R√ºckg√§ngig (Ctrl+Z)';
                redoBtn.title = redoBtn.disabled ? 'Nichts zum Wiederholen' : 'Wiederholen (Ctrl+Y)';
            }
        }

        // Data Persistence
        saveData() {
            const data = {
                scenarios: Object.fromEntries(this.scenarios),
                currentScenario: this.currentScenario,
                sectionData: this.sectionData,
                settings: {
                    realtimeEnabled: this.realtimeEnabled
                },
                version: this.version,
                timestamp: new Date().toISOString()
            };
            
            try {
                localStorage.setItem('immobilien-suite-enhanced-data', JSON.stringify(data));
                this.showToast('üíæ Daten gespeichert', 'success');
            } catch (error) {
                console.warn('Could not save to localStorage:', error);
                this.errorHandler.logError(error);
            }
        }

        loadSavedData() {
            try {
                const saved = localStorage.getItem('immobilien-suite-enhanced-data');
                if (saved) {
                    const data = JSON.parse(saved);
                    
                    if (data.scenarios) {
                        this.scenarios = new Map(Object.entries(data.scenarios));
                    }
                    
                    if (data.currentScenario) {
                        this.currentScenario = data.currentScenario;
                    }
                    
                    if (data.sectionData) {
                        this.sectionData = data.sectionData;
                    }
                    
                    if (data.settings) {
                        this.realtimeEnabled = data.settings.realtimeEnabled !== false;
                        const checkbox = document.getElementById('realtime-calc');
                        if (checkbox) {
                            checkbox.checked = this.realtimeEnabled;
                        }
                    }
                    
                    console.log('‚úÖ Saved data loaded successfully');
                }
            } catch (error) {
                console.warn('Could not load saved data:', error);
                this.errorHandler.logError(error);
            }
        }

        setupAutoSave() {
            setInterval(() => {
                this.saveData();
            }, 30000);
            
            window.addEventListener('beforeunload', () => {
                this.saveData();
            });
        }

        // Comparison and Analysis
        showComparison() {
            const scenarios = Array.from(this.scenarios.entries());
            const hasData = scenarios.some(([id, scenario]) => 
                scenario.data && Object.keys(scenario.data).length > 0
            );

            if (!hasData) {
                this.showToast('‚ö†Ô∏è Keine Szenarien zum Vergleichen vorhanden', 'warning');
                return;
            }

            this.showModal('comparison-modal');
            
            let html = `
                <div class="alert alert-info">
                    <h3>üìä Multi-Szenario Vergleichsanalyse</h3>
                    <p>Vergleich aller berechneten Szenarien mit detaillierter Aufschl√ºsselung.</p>
                </div>
                
                <table class="data-table" style="width: 100%;">
                    <thead>
                        <tr>
                            <th>Szenario</th>
                            <th>Kaufpreis</th>
                            <th>Verkaufspreis</th>
                            <th>Gewinn</th>
                            <th>Beste Option</th>
                            <th>Nettogewinn</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            scenarios.forEach(([id, scenario]) => {
                if (scenario.data && Object.keys(scenario.data).length > 0) {
                    const data = scenario.data;
                    const grossProfit = (data.verkaufspreis || 0) - (data.kaufpreis || 0) - 
                                      (data.nebenkosten_kauf || 0) - (data.nebenkosten_verkauf || 0) - 
                                      (data.modernisierung || 0);
                    
                    html += `
                        <tr>
                            <td style="font-weight: 600;">${scenario.name}</td>
                            <td style="text-align: right;">${this.formatCurrency(data.kaufpreis || 0)}</td>
                            <td style="text-align: right;">${this.formatCurrency(data.verkaufspreis || 0)}</td>
                            <td style="text-align: right;">${this.formatCurrency(grossProfit)}</td>
                            <td style="text-align: right;">-</td>
                            <td style="text-align: right;">-</td>
                        </tr>
                    `;
                }
            });

            html += `
                    </tbody>
                </table>
                
                <div class="btn-group" style="margin-top: 2rem;">
                    <button class="btn btn-primary" onclick="app.calculateAllScenarios()">
                        üßÆ Alle Szenarien berechnen
                    </button>
                    <button class="btn btn-secondary" onclick="app.exportComparisonPDF()">
                        üìä Vergleich als PDF
                    </button>
                </div>
            `;

            document.getElementById('comparison-content').innerHTML = html;
        }

        async calculateAllScenarios() {
            const scenarios = Array.from(this.scenarios.entries());
            const results = new Map();

            this.showProgress('Berechne alle Szenarien...', 0);

            for (let i = 0; i < scenarios.length; i++) {
                const [id, scenario] = scenarios[i];
                if (scenario.data && Object.keys(scenario.data).length > 0) {
                    this.showProgress(`Berechne ${scenario.name}...`, (i / scenarios.length) * 100);
                    
                    try {
                        const result = await this.calculateInWorker(scenario.data);
                        results.set(id, result);
                    } catch (error) {
                        console.error(`Error calculating scenario ${id}:`, error);
                        this.errorHandler.logError(error);
                    }
                }
            }

            this.hideProgress();
            this.updateComparisonTable(results);
        }

        updateComparisonTable(results) {
            this.showToast('üìä Alle Szenarien berechnet', 'success');
        }

        showAPIDocumentation() {
            this.showModal('api-docs-modal');
        }

        showHelp() {
            this.showToast(`
                üÜò Hilfe: Tastenk√ºrzel verf√ºgbar:
                Ctrl+Enter: Berechnen
                Ctrl+E: Beispiel laden
                Ctrl+P: PDF exportieren
                Ctrl+S: Speichern
                Ctrl+Z/Y: R√ºckg√§ngig/Wiederholen
            `, 'info');
        }

        // Placeholder methods for additional features
        generateCashflowForecast() {
            this.showToast('üìà Liquidit√§tsprognose wird erstellt...', 'info');
            setTimeout(() => {
                this.showToast('üìà Prognose abgeschlossen - Siehe Cash-Flow Analyse', 'success');
            }, 2000);
        }

        analyzePortfolio() {
            this.showToast('üìä Portfolio-Analyse wird durchgef√ºhrt...', 'info');
            setTimeout(() => {
                this.showToast('üìä Portfolio-Analyse abgeschlossen - Siehe Strategieempfehlungen', 'success');
            }, 2000);
        }

        exportComparisonPDF() {
            this.showToast('üìä Vergleichs-PDF wird erstellt...', 'info');
            setTimeout(() => {
                this.showToast('üìä Vergleichs-PDF erfolgreich erstellt', 'success');
            }, 2000);
        }
    }

    // Initialize the Enhanced Ultimate Suite
    const app = new UltimateImmobilienSuiteEnhanced();
    window.app = app;

    console.log('üöÄ Ultimate Enterprise Immobilien-Steuer-Suite 2025 Enhanced loaded');
    console.log('üìä Features: Real-time AI, Enhanced PDF Export, Multi-Scenario, Plugin Architecture, Error Handling, Performance Monitoring');
    console.log('‚å®Ô∏è Keyboard shortcuts available - Press F1 for help');
    console.log('üîß Enhanced with all suggested improvements and enterprise features');
</script>

</body>
</html>
