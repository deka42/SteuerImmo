<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Immobilien-Steuer-Suite 2025</title>

<!-- Chart.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<!-- jsPDF fÃ¼r PDF-Export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
  body {
    font-family: 'Segoe UI', system-ui, sans-serif;
    margin: 0; padding: 2rem; background: #f8f9fa; color: #2c3e50;
  }
  .app-container {
    max-width: 900px;
    margin: auto;
    background: white;
    padding: 2rem;
    border-radius: 16px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
  }
  h1 {
    text-align: center;
    margin-bottom: 2rem;
  }
  form {
    display: grid;
    grid-template-columns: repeat(auto-fit,minmax(280px,1fr));
    gap: 1.5rem;
  }
  label {
    font-weight: 600;
    margin-bottom: 0.3rem;
    display: block;
  }
  input[type=number], select {
    width: 100%;
    padding: 0.6rem 1rem;
    border-radius: 8px;
    border: 1px solid #ccc;
    font-size: 1rem;
  }
  .btn-group {
    grid-column: 1 / -1;
    display: flex;
    gap: 1rem;
    margin-top: 1rem;
  }
  button {
    cursor: pointer;
    font-weight: 600;
    padding: 0.9rem 1.5rem;
    border: none;
    border-radius: 12px;
    font-size: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    user-select: none;
  }
  button:disabled {
    opacity: 0.5; cursor: not-allowed;
  }
  .btn-primary { background-color: #667eea; color: white; }
  .btn-primary:hover:not(:disabled) { background-color: #5566cc; }
  .btn-secondary { background-color: #95a5a6; color: white; }
  .results {
    margin-top: 2rem;
  }
  .result-item {
    display: flex;
    justify-content: space-between;
    padding: 0.3rem 0;
    border-bottom: 1px solid #eee;
  }
  canvas {
    margin-top: 2rem;
    max-width: 100%;
  }
  /* Toast Container */
  .toast-container {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 10000;
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }
  .toast {
    background: #333;
    color: white;
    padding: 1rem 1.5rem;
    border-radius: 8px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    min-width: 250px;
    opacity: 0.95;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: 600;
  }
  .toast-close {
    background: none;
    border: none;
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
    line-height: 1;
  }
</style>
</head>
<body>
<div class="app-container">
  <h1>Immobilien-Steuer-Suite 2025</h1>

  <form id="tax-form" autocomplete="off">
    <div>
      <label for="property-value">Immobilienwert (â‚¬) <span style="color:red;">*</span></label>
      <input type="number" id="property-value" min="1" placeholder="500000" required />
    </div>
    <div>
      <label for="location">Lage</label>
      <select id="location">
        <option value="urban">StÃ¤dtisch</option>
        <option value="suburban" selected>VorstÃ¤dtisch</option>
        <option value="rural">LÃ¤ndlich</option>
      </select>
    </div>
    <div>
      <label for="property-type">Objekttyp</label>
      <select id="property-type">
        <option value="residential" selected>Wohnimmobilie</option>
        <option value="commercial">Gewerbeimmobilie</option>
        <option value="industrial">Industrieimmobilie</option>
        <option value="agricultural">Landwirtschaft</option>
      </select>
    </div>
    <div>
      <label for="exemptions">Steuerliche Befreiungen (â‚¬)</label>
      <input type="number" id="exemptions" min="0" placeholder="0" />
    </div>
    <div>
      <label for="improvements">Steuerlich relevante Verbesserungen (â‚¬)</label>
      <input type="number" id="improvements" min="0" placeholder="0" />
    </div>
    <div>
      <label for="building-area">NutzflÃ¤che (qm)</label>
      <input type="number" id="building-area" min="0" placeholder="180" />
    </div>
    <div>
      <label for="plot-size">GrundstÃ¼cksgrÃ¶ÃŸe (qm)</label>
      <input type="number" id="plot-size" min="0" placeholder="640" />
    </div>

    <div class="btn-group">
      <button type="button" id="calculate-tax" class="btn btn-primary">ðŸ§® Steuer berechnen</button>
      <button type="button" id="reset-form" class="btn btn-secondary">ðŸ”„ Formular zurÃ¼cksetzen</button>
      <button type="button" id="export-pdf" class="btn btn-secondary">ðŸ“„ PDF exportieren</button>
    </div>
  </form>

  <div id="results" class="results" aria-live="polite" aria-atomic="true"></div>

  <canvas id="tax-chart" aria-label="Diagramm der Grundsteueraufteilung" role="img"></canvas>
</div>

<!-- Toast Container -->
<div class="toast-container" aria-live="assertive" aria-atomic="true"></div>

<script>
(() => {
  const { jsPDF } = window.jspdf;
  const toastContainer = document.querySelector('.toast-container');
  const resultsDiv = document.getElementById('results');
  const ctx = document.getElementById('tax-chart').getContext('2d');
  let chartInstance = null;
  let lastCalculation = null;

  function showToast(message) {
    const toast = document.createElement('div');
    toast.className = 'toast';
    toast.textContent = message;

    const closeBtn = document.createElement('button');
    closeBtn.className = 'toast-close';
    closeBtn.innerHTML = '&times;';
    closeBtn.addEventListener('click', () => toast.remove());

    toast.appendChild(closeBtn);
    toastContainer.appendChild(toast);

    setTimeout(() => toast.remove(), 5000);
  }

  function formatCurrency(amount) {
    return new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR' }).format(amount);
  }

  function getFormData() {
    return {
      propertyValue: parseFloat(document.getElementById('property-value').value),
      location: document.getElementById('location').value,
      propertyType: document.getElementById('property-type').value,
      exemptions: parseFloat(document.getElementById('exemptions').value) || 0,
      improvements: parseFloat(document.getElementById('improvements').value) || 0,
      buildingArea: parseFloat(document.getElementById('building-area').value) || 0,
      plotSize: parseFloat(document.getElementById('plot-size').value) || 0,
    };
  }

  function validate(data) {
    if (isNaN(data.propertyValue) || data.propertyValue <= 0) {
      showToast('Bitte geben Sie einen gÃ¼ltigen Immobilienwert grÃ¶ÃŸer 0 ein.');
      return false;
    }
    return true;
  }

  function calculateTax(data) {
    const taxRates = {
      residential: 0.0035,
      commercial: 0.0045,
      industrial: 0.0055,
      agricultural: 0.0020,
    };
    const locationMultiplier = {
      urban: 1.2,
      suburban: 1.0,
      rural: 0.8,
    };

    const assessedValue = data.propertyValue * 0.7;
    const taxableValue = assessedValue + data.improvements - data.exemptions;
    const baseTax = taxableValue * (taxRates[data.propertyType] || 0.0035);
    const finalTax = baseTax * (locationMultiplier[data.location] || 1.0);
    const savings = finalTax * 0.1; // Beispielhafte 10%

    return {
      input: data,
      calculations: {
        assessedValue,
        taxableValue,
        baseTax,
        finalTax,
        annualTax: finalTax,
        monthlyTax: finalTax / 12,
        effectiveRate: (finalTax / data.propertyValue) * 100,
      },
      savings,
    };
  }

  function displayResults(result) {
    lastCalculation = result;
    const html = `
      <div class="result-item"><strong>Verkehrswert:</strong> ${formatCurrency(result.input.propertyValue)}</div>
      <div class="result-item"><strong>Steuerwert (70%):</strong> ${formatCurrency(result.calculations.assessedValue)}</div>
      <div class="result-item"><strong>Zu versteuernder Wert:</strong> ${formatCurrency(result.calculations.taxableValue)}</div>
      <div class="result-item"><strong>JÃ¤hrliche Grundsteuer:</strong> ${formatCurrency(result.calculations.annualTax)}</div>
      <div class="result-item"><strong>Monatliche Rate:</strong> ${formatCurrency(result.calculations.monthlyTax)}</div>
      <div class="result-item"><strong>Effektiver Steuersatz:</strong> ${result.calculations.effectiveRate.toFixed(2)}%</div>
      <div class="result-item"><strong>Potenzielle Ersparnis:</strong> ${formatCurrency(result.savings)}</div>
    `;
    resultsDiv.innerHTML = html;
  }

  function createChart(result) {
    if (chartInstance) {
      chartInstance.destroy();
    }
    chartInstance = new Chart(ctx, {
      type: 'doughnut',
       {
        labels: ['Grundsteuer', 'Nettowert', 'Ersparnis'],
        datasets: [{
           [
            result.calculations.annualTax,
            result.input.propertyValue - result.calculations.annualTax,
            result.savings,
          ],
          backgroundColor: ['#ff6b6b', '#4ecdc4', '#45b7d1']
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { position: 'bottom' }
        }
      }
    });
  }

  function resetForm() {
    document.getElementById('tax-form').reset();
    resultsDiv.innerHTML = '';
    if (chartInstance) {
      chartInstance.destroy();
      chartInstance = null;
    }
    lastCalculation = null;
  }

  async function exportToPDF() {
    if (!lastCalculation) {
      showToast('Bitte zuerst eine Berechnung durchfÃ¼hren.');
      return;
    }
    try {
      const doc = new jsPDF();
      doc.setFontSize(16);
      doc.text("Immobilien-Steuer-Berechnung 2025", 14, 20);
      doc.setFontSize(12);
      const lineHeight = 10;
      let y = 30;
      const c = lastCalculation;

      doc.text(`Datum: ${new Date().toLocaleDateString('de-DE')}`, 14, y);
      y += lineHeight;
      doc.text(`Immobilienwert: ${formatCurrency(c.input.propertyValue)}`, 14, y);
      y += lineHeight;
      doc.text(`Steuerwert (70%): ${formatCurrency(c.calculations.assessedValue)}`, 14, y);
      y += lineHeight;
      doc.text(`Zu versteuernder Wert: ${formatCurrency(c.calculations.taxableValue)}`, 14, y);
      y += lineHeight;
      doc.text(`JÃ¤hrliche Grundsteuer: ${formatCurrency(c.calculations.annualTax)}`, 14, y);
      y += lineHeight;
      doc.text(`Monatliche Grundsteuer: ${formatCurrency(c.calculations.monthlyTax)}`, 14, y);
      y += lineHeight;
      doc.text(`Effektiver Steuersatz: ${c.calculations.effectiveRate.toFixed(2)}%`, 14, y);
      y += lineHeight + 10;
      doc.text(`Potenzielle Ersparnis: ${formatCurrency(c.savings)}`, 14, y);

      doc.save("immobilien_steuer_berechnung.pdf");
      showToast('PDF wurde erfolgreich exportiert!');
    } catch (e) {
      showToast('Fehler beim PDF-Export: ' + e.message);
    }
  }

  document.getElementById('calculate-tax').addEventListener('click', () => {
    const data = getFormData();
    if (validate(data)) {
      const result = calculateTax(data);
      displayResults(result);
      createChart(result);
      showToast('Berechnung erfolgreich!');
    }
  });

  document.getElementById('reset-form').addEventListener('click', () => {
    resetForm();
    showToast('Formular wurde zurÃ¼ckgesetzt.');
  });

  document.getElementById('export-pdf').addEventListener('click', () => {
    exportToPDF();
  });

})();
</script>

</body>
</html>
