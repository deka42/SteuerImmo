<!DOCTYPE html>

<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Immobilien-Steuer-Suite 2025</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

```
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
    }

    .container {
        max-width: 1600px;
        margin: 0 auto;
        background: white;
        min-height: 100vh;
        overflow: hidden;
    }

    .header {
        background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
        color: white;
        padding: 30px;
        text-align: center;
    }

    .header h1 {
        font-size: 2.8em;
        margin-bottom: 10px;
        font-weight: 300;
    }

    .subtitle {
        font-size: 1.3em;
        opacity: 0.9;
        margin-bottom: 20px;
    }

    /* Navigation Tabs */
    .nav-tabs {
        display: flex;
        background: #34495e;
        overflow-x: auto;
    }

    .nav-tab {
        flex: 1;
        padding: 15px 20px;
        background: #34495e;
        color: white;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 0.95em;
        font-weight: 500;
        min-width: 180px;
    }

    .nav-tab:hover {
        background: #3498db;
    }

    .nav-tab.active {
        background: #3498db;
        box-shadow: inset 0 -3px 0 #2980b9;
    }

    .tab-content {
        display: none;
        padding: 30px;
        min-height: 800px;
    }

    .tab-content.active {
        display: block;
    }

    /* Input Sections */
    .input-section {
        background: #f8f9fa;
        padding: 25px;
        border-radius: 15px;
        margin-bottom: 30px;
    }

    .input-section h3 {
        color: #2c3e50;
        margin-bottom: 20px;
        font-size: 1.3em;
        border-bottom: 2px solid #3498db;
        padding-bottom: 10px;
    }

    .input-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
    }

    .input-group {
        margin-bottom: 20px;
    }

    .input-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #2c3e50;
        font-size: 0.9em;
    }

    .input-group input, 
    .input-group select {
        width: 100%;
        padding: 12px 15px;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        font-size: 14px;
        transition: all 0.3s ease;
    }

    .input-group input:focus, 
    .input-group select:focus {
        outline: none;
        border-color: #3498db;
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }

    .input-help {
        font-size: 0.8em;
        color: #6c757d;
        margin-top: 5px;
    }

    /* Results */
    .results-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 20px;
        margin-top: 30px;
    }

    .result-card {
        background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        border-radius: 12px;
        padding: 20px;
        border: 2px solid #e9ecef;
        transition: all 0.3s ease;
    }

    .result-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        border-color: #3498db;
    }

    .result-card.best-option {
        background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
        border-color: #27ae60;
    }

    .result-card h4 {
        color: #2c3e50;
        margin-bottom: 15px;
        font-size: 1.2em;
        text-align: center;
    }

    .result-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid #e9ecef;
    }

    .result-item:last-child {
        border-bottom: none;
        font-weight: 600;
        margin-top: 10px;
        padding-top: 15px;
        border-top: 2px solid #3498db;
    }

    .result-label {
        color: #2c3e50;
        font-weight: 500;
        font-size: 0.9em;
    }

    .result-value {
        font-weight: 600;
        color: #27ae60;
    }

    .result-value.negative {
        color: #e74c3c;
    }

    /* Buttons */
    .calculate-btn {
        background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
        color: white;
        border: none;
        padding: 15px 30px;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        width: 100%;
        margin-top: 20px;
    }

    .calculate-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(39, 174, 96, 0.3);
    }

    /* Warnings and Info Boxes */
    .warning {
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        font-size: 0.9em;
        line-height: 1.5;
    }

    .warning.info {
        background: #e3f2fd;
        border: 1px solid #bbdefb;
        color: #1565c0;
    }

    .warning.success {
        background: #e8f5e8;
        border: 1px solid #c8e6c9;
        color: #2e7d32;
    }

    .warning.warning {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        color: #856404;
    }

    .warning.danger {
        background: #ffebee;
        border: 1px solid #ffcdd2;
        color: #c62828;
    }

    /* Comparison Table */
    .comparison-table {
        width: 100%;
        border-collapse: collapse;
        background: white;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        margin-top: 30px;
    }

    .comparison-table th,
    .comparison-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #e9ecef;
        font-size: 0.85em;
    }

    .comparison-table th {
        background: #3498db;
        color: white;
        font-weight: 600;
        text-align: center;
    }

    .comparison-table tr:hover {
        background: #f8f9fa;
    }

    .comparison-table .best-option {
        background: #d4edda !important;
        border-left: 4px solid #27ae60;
    }

    /* Strategy Overview */
    .strategy-overview {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        border-radius: 15px;
        margin: 30px 0;
    }

    .strategy-overview h3 {
        font-size: 1.5em;
        margin-bottom: 20px;
        text-align: center;
    }

    .timeline {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: 30px 0;
        position: relative;
    }

    .timeline::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 0;
        right: 0;
        height: 2px;
        background: rgba(255,255,255,0.3);
        z-index: 1;
    }

    .timeline-item {
        background: rgba(255,255,255,0.2);
        padding: 15px;
        border-radius: 10px;
        text-align: center;
        position: relative;
        z-index: 2;
        min-width: 120px;
        backdrop-filter: blur(10px);
    }

    .timeline-item.active {
        background: rgba(255,255,255,0.9);
        color: #2c3e50;
    }

    /* Responsive Design */
    @media (max-width: 1200px) {
        .input-grid {
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        }
    }

    @media (max-width: 768px) {
        .nav-tabs {
            flex-direction: column;
        }
        
        .nav-tab {
            min-width: unset;
        }
        
        .results-grid {
            grid-template-columns: 1fr;
        }
        
        .timeline {
            flex-direction: column;
            gap: 15px;
        }
        
        .timeline::before {
            display: none;
        }
    }

    /* Additional Styles f√ºr erweiterte Features */
    .scenario-comparison {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 25px;
        margin: 20px 0;
    }

    .scenario-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
    }

    .scenario-card {
        background: white;
        border-radius: 10px;
        padding: 20px;
        border-left: 4px solid #3498db;
    }

    .cash-flow-chart {
        background: white;
        border-radius: 10px;
        padding: 20px;
        margin: 20px 0;
        border: 1px solid #e9ecef;
    }

    .progress-bar {
        width: 100%;
        height: 8px;
        background: #e9ecef;
        border-radius: 4px;
        overflow: hidden;
        margin: 10px 0;
    }

    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #27ae60, #2ecc71);
        transition: width 0.3s ease;
    }

    /* Tab Icons */
    .tab-icon {
        margin-right: 8px;
    }

    #verkauf-results {
        transition: all 0.3s ease;
    }

    .structure-transition {
        opacity: 0;
        transform: translateY(10px);
        animation: fadeInUp 0.5s ease forwards;
    }

    @keyframes fadeInUp {
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes slideIn {
        from {
            transform: translateX(300px);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    @keyframes slideOut {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(300px);
            opacity: 0;
        }
    }
    .tooltip {
        position: relative;
        cursor: help;
    }

    .tooltip .tooltiptext {
        visibility: hidden;
        width: 200px;
        background-color: #2c3e50;
        color: #fff;
        text-align: center;
        border-radius: 6px;
        padding: 8px;
        position: absolute;
        z-index: 1000;
        bottom: 125%;
        left: 50%;
        margin-left: -100px;
        font-size: 0.8em;
        opacity: 0;
        transition: opacity 0.3s;
    }

    .tooltip:hover .tooltiptext {
        visibility: visible;
        opacity: 1;
    }
</style>
```

</head>
<body>
    <div class="container">
        <div class="header">
    <h1>üè† Immobilien-Steuer-Suite 2025</h1>
    <div class="subtitle">Komplettanalyse f√ºr smarte Immobilieninvestoren - Alle Steueraspekte auf einen Blick</div>
    <div style="margin-top: 15px;">
        <button onclick="exportBericht()" style="
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            margin: 0 10px;
            cursor: pointer;
            font-weight: 600;
        ">üìã Bericht exportieren</button>
        <button onclick="resetAllData()" style="
            background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            margin: 0 10px;
            cursor: pointer;
            font-weight: 600;
        ">üîÑ Daten zur√ºcksetzen</button>
        <button onclick="showDashboard()" style="
            background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            margin: 0 10px;
            cursor: pointer;
            font-weight: 600;
        ">üí° Dashboard einblenden</button>
        <button onclick="importExample()" style="
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            margin: 0 10px;
            cursor: pointer;
            font-weight: 600;
        ">Beispieldaten laden</button>
        <button onclick="testDashboardUpdate()" style="
            background: linear-gradient(135deg, #e67e22 0%, #f39c12 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            margin: 0 10px;
            cursor: pointer;
            font-weight: 600;
        ">üß™ Dashboard testen & einblenden</button>
        <button onclick="showExtendedAnalyse()" style="
            background: linear-gradient(135deg, #16a085 0%, #1abc9c 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            margin: 0 10px;
            cursor: pointer;
            font-weight: 600;
        ">üîç Erweiterte Analyse</button>
    </div>
</div>

```
    <!-- Navigation Tabs -->
    <div class="nav-tabs">
    <button class="nav-tab active" onclick="switchTab(this, 'verkauf')">
        <span class="tab-icon">üí∞</span>Verkaufssteuer-Vergleich
    </button>
    <button class="nav-tab" onclick="switchTab(this, 'grundsteuer')">
        <span class="tab-icon">üèõÔ∏è</span>Grundsteuer 2025
    </button>
    <button class="nav-tab" onclick="switchTab(this, 'erbschaft')">
        <span class="tab-icon">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</span>Erbschaftsteuer
    </button>
    <button class="nav-tab" onclick="switchTab(this, 'schenkung')">
        <span class="tab-icon">üéÅ</span>Schenkungssteuer
    </button>
    <button class="nav-tab" onclick="switchTab(this, 'gesamtstrategie')">
        <span class="tab-icon">üéØ</span>Gesamtstrategie
    </button>
    <button class="nav-tab" onclick="switchTab(this, 'cashflow')">
        <span class="tab-icon">üìä</span>Cash-Flow Analyse
    </button>
</div>

    <!-- Tab Content -->
    
    <!-- Verkaufssteuer-Vergleich Tab -->
    <div id="verkauf" class="tab-content active">
        <div class="warning info">
            <strong>üéØ Verkaufssteuer-Vergleich:</strong> Hier vergleichen wir verschiedene Rechtsformen beim VERKAUF einer Immobilie. 
            Dies ist die Basis f√ºr alle weiteren steuerlichen √úberlegungen.
        </div>

        <div class="input-section">
            <h3>üìä Immobilien- und Verkaufsdaten</h3>
            <div class="input-grid">
                <div class="input-group">
                    <label for="kaufpreis">Kaufpreis (‚Ç¨)</label>
                    <input type="number" id="kaufpreis" value="300000" min="0">
                </div>

                <div class="input-group">
                    <label for="verkaufspreis">Verkaufspreis (‚Ç¨)</label>
                    <input type="number" id="verkaufspreis" value="450000" min="0">
                </div>

                <div class="input-group">
                    <label for="nebenkosten_kauf">Nebenkosten Kauf (‚Ç¨)</label>
                    <input type="number" id="nebenkosten_kauf" value="30000" min="0">
                    <div class="input-help">Notar, Grunderwerbsteuer, Makler</div>
                </div>

                <div class="input-group">
                    <label for="nebenkosten_verkauf">Nebenkosten Verkauf (‚Ç¨)</label>
                    <input type="number" id="nebenkosten_verkauf" value="22500" min="0">
                    <div class="input-help">Makler, Notar, Expos√©</div>
                </div>

                <div class="input-group">
                    <label for="modernisierung">Modernisierung/Renovierung (‚Ç¨)</label>
                    <input type="number" id="modernisierung" value="50000" min="0">
                </div>

                <div class="input-group">
                    <label for="haltedauer">Haltedauer (Jahre)</label>
                    <input type="number" id="haltedauer" value="8" min="0">
                </div>
            </div>
        </div>

        <div class="input-section">
            <h3>‚öñÔ∏è Steuerliche Parameter</h3>
            <div class="input-grid">
                <div class="input-group">
                    <label for="persoenlicher_steuersatz">Pers√∂nlicher Steuersatz (%)</label>
                    <input type="number" id="persoenlicher_steuersatz" value="42" min="0" max="47" step="0.1">
                </div>

                <div class="input-group">
                    <label for="kirchensteuer">Kirchensteuer (%)</label>
                    <input type="number" id="kirchensteuer" value="8" min="0" max="9" step="0.1">
                </div>

                <div class="input-group">
                    <label for="einbringung_nach_jahren">Private Haltedauer vor Einbringung (Jahre)</label>
                    <input type="number" id="einbringung_nach_jahren" placeholder="Optional: z.B. 12" min="0">
                    <div class="input-help">Nur bei Einbringung in GmbH/UG relevant</div>
                </div>

                <div class="input-group">
                    <label for="bundesland">Bundesland</label>
                    <select id="bundesland">
                        <option value="bw">Baden-W√ºrttemberg</option>
                        <option value="by">Bayern</option>
                        <option value="be">Berlin</option>
                        <option value="bb">Brandenburg</option>
                        <option value="hb">Bremen</option>
                        <option value="hh">Hamburg</option>
                        <option value="he">Hessen</option>
                        <option value="mv">Mecklenburg-Vorpommern</option>
                        <option value="ni">Niedersachsen</option>
                        <option value="nw" selected>Nordrhein-Westfalen</option>
                        <option value="rp">Rheinland-Pfalz</option>
                        <option value="sl">Saarland</option>
                        <option value="sn">Sachsen</option>
                        <option value="st">Sachsen-Anhalt</option>
                        <option value="sh">Schleswig-Holstein</option>
                        <option value="th">Th√ºringen</option>
                    </select>
                </div>
            </div>
        </div>

        <button class="calculate-btn" onclick="calculateVerkauf()">üßÆ Verkaufssteuer berechnen</button>

        <div id="verkauf-results">
            <!-- Ergebnisse werden hier eingef√ºgt -->
        </div>

        <div class="warning success">
        <div class="warning success">
            <strong>üèÜ Empfehlung f√ºr 2025 - Jetzt mit ALLEN verm√∂gensverwaltenden Strukturen:</strong><br>
            <strong>Vor 10 Jahren:</strong> VV GmbH & Co. KG oder VV GbR (je nach Haftung)<br>
            <strong>Nach 10 Jahren:</strong> Privatverkauf oder strukturierte √úbertragung<br>
            <strong>NEU:</strong> BFH-Urteil macht VV GmbH & Co. KG gewerbesteuerfrei!<br>
            <strong>Familienstrukturen:</strong> Familienpool KG f√ºr Generationen√ºbergabe<br>
            <strong>Gro√üe Portfolios:</strong> VV Holding-GmbH mit Schachtelprivileg<br>
            <strong>International:</strong> Cross-Border Strukturen f√ºr EU-Vorteile
        </div>

        <div class="warning info">
            <strong>üéØ Vollst√§ndiger Strukturvergleich 2025 - JETZT ALLE 14 STRUKTUREN:</strong><br>
            Das Tool zeigt intelligent die f√ºr Sie relevantesten Strukturen. Klicken Sie auf "Alle Strukturen anzeigen" f√ºr den kompletten Vergleich:<br>
            ‚úÖ <strong>Transparente Strukturen (6):</strong> Privat, VV GbR, VV GmbH & Co. KG, VV KG, VV OHG, VV PartG<br>
            ‚úÖ <strong>Familienstrukturen (1):</strong> Familienpool KG f√ºr Generationen√ºbergabe<br>
            ‚úÖ <strong>K√∂rperschaftliche (3):</strong> VV GmbH, VV UG, VV Holding-GmbH<br>
            ‚úÖ <strong>Gewerbliche (3):</strong> Gew. GbR, Gew. GmbH, Gew. GmbH & Co. KG<br>
            ‚úÖ <strong>International (1):</strong> Cross-Border DE-LU Strukturen<br>
            ‚úÖ <strong>BFH 2025:</strong> Neueste Rechtsprechung zu Gewerbesteuerbefreiung integriert<br>
            ‚úÖ <strong>Intelligente Filterung:</strong> Zeigt nur relevante Optionen basierend auf Ihren Daten
        </div>
    </div>

    <!-- Grundsteuer 2025 Tab -->
    <div id="grundsteuer" class="tab-content">
        <div class="warning info">
            <strong>üèõÔ∏è Grundsteuer-Reform 2025:</strong> Seit 1. Januar 2025 gilt die neue Grundsteuer. 
            Alle Immobilien wurden neu bewertet - hier k√∂nnen Sie Ihre neue Grundsteuer berechnen.
        </div>

        <div class="input-section">
            <h3>üè† Immobiliendaten f√ºr Grundsteuer</h3>
            <div class="input-grid">
                <div class="input-group">
                    <label for="grundstueckswert">Grundsteuerwert (‚Ç¨)</label>
                    <input type="number" id="grundstueckswert" value="350000" min="0">
                    <div class="input-help">Laut Grundsteuerwertbescheid 2022/2023</div>
                </div>

                <div class="input-group">
                    <label for="immobilientyp">Immobilientyp</label>
                    <select id="immobilientyp">
                        <option value="einfamilienhaus">Ein-/Zweifamilienhaus</option>
                        <option value="mietwohnung">Mietwohngrundst√ºck</option>
                        <option value="eigentumswohnung">Eigentumswohnung</option>
                        <option value="gewerbe">Gewerbegrundst√ºck</option>
                        <option value="unbebaut">Unbebautes Grundst√ºck</option>
                    </select>
                </div>

                <div class="input-group">
                    <label for="gemeinde_hebesatz">Hebesatz der Gemeinde (%)</label>
                    <input type="number" id="gemeinde_hebesatz" value="450" min="0" max="2000">
                    <div class="input-help">Grundsteuer B - variiert stark je Gemeinde</div>
                </div>

                <div class="input-group">
                    <label for="grundsteuer_bundesland">Grundsteuer-Modell</label>
                    <select id="grundsteuer_bundesland">
                        <option value="bundesmodell">Bundesmodell (Standard)</option>
                        <option value="bw">Baden-W√ºrttemberg (Bodenwert)</option>
                        <option value="by">Bayern (Fl√§chenmodell)</option>
                        <option value="hh">Hamburg (Wohnlagenwert)</option>
                        <option value="he">Hessen (Fl√§chen-Lage-Modell)</option>
                        <option value="ni">Niedersachsen (Fl√§chen-Faktor-Modell)</option>
                        <option value="sl">Saarland (Modifikation Bundesmodell)</option>
                    </select>
                </div>

                <div class="input-group">
                    <label for="vermietung_typ">Nutzungsart</label>
                    <select id="vermietung_typ">
                        <option value="eigennutzung">Eigennutzung</option>
                        <option value="vermietung">Vermietung</option>
                        <option value="gewerbe">Gewerbliche Nutzung</option>
                        <option value="leerstand">Leerstand</option>
                    </select>
                </div>
            </div>
        </div>

        <button class="calculate-btn" onclick="calculateGrundsteuer()">üèõÔ∏è Grundsteuer berechnen</button>

        <div id="grundsteuer-results">
            <!-- Grundsteuer Ergebnisse -->
        </div>

        <div class="warning warning">
            <strong>‚ö†Ô∏è Einspruch gegen Grundsteuerbescheid:</strong><br>
            Falls Ihr Grundsteuerwert zu hoch erscheint, k√∂nnen Sie binnen eines Monats Einspruch einlegen. 
            Bei √ºber 40% Abweichung zum tats√§chlichen Wert ist ein Gutachten empfehlenswert.
        </div>
    </div>

    <!-- Erbschaftsteuer Tab -->
    <div id="erbschaft" class="tab-content">
        <div class="warning info">
            <strong>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Erbschaftsteuer-Planung:</strong> Berechnen Sie die Erbschaftsteuer bei Immobilien und 
            planen Sie steueroptimierte √úbertragungsstrategien.
        </div>

        <div class="input-section">
            <h3>üè† Zu vererbende Immobilie</h3>
            <div class="input-grid">
                <div class="input-group">
                    <label for="immobilienwert_erbe">Immobilienwert (‚Ç¨)</label>
                    <input type="number" id="immobilienwert_erbe" value="450000" min="0">
                    <div class="input-help">Aktueller Verkehrswert (seit 2023 h√∂her bewertet)</div>
                </div>

                <div class="input-group">
                    <label for="weiteres_vermoegen">Weiteres Verm√∂gen (‚Ç¨)</label>
                    <input type="number" id="weiteres_vermoegen" value="100000" min="0">
                    <div class="input-help">Geld, Aktien, weitere Immobilien</div>
                </div>

                <div class="input-group">
                    <label for="schulden">Schulden/Verbindlichkeiten (‚Ç¨)</label>
                    <input type="number" id="schulden" value="50000" min="0">
                    <div class="input-help">Kredite, Hypotheken etc.</div>
                </div>

                <div class="input-group">
                    <label for="verwandtschaftsgrad">Verwandtschaftsgrad</label>
                    <select id="verwandtschaftsgrad">
                        <option value="ehepartner">Ehepartner/Lebenspartner</option>
                        <option value="kind">Kind/Stiefkind</option>
                        <option value="enkel">Enkel</option>
                        <option value="eltern">Eltern/Gro√üeltern</option>
                        <option value="geschwister">Geschwister/Nichten/Neffen</option>
                        <option value="andere">Andere Personen</option>
                    </select>
                </div>

                <div class="input-group">
                    <label for="wohnflaeche">Wohnfl√§che (m¬≤)</label>
                    <input type="number" id="wohnflaeche" value="150" min="0">
                    <div class="input-help">F√ºr Familienheim-Steuerbefreiung relevant</div>
                </div>

                <div class="input-group">
                    <label for="selbstnutzung_erblasser">Eigennutzung durch Erblasser</label>
                    <select id="selbstnutzung_erblasser">
                        <option value="ja">Ja, bis zum Tod</option>
                        <option value="nein">Nein, vermietet</option>
                        <option value="pflegeheim">Nein, im Pflegeheim</option>
                    </select>
                </div>

                <div class="input-group">
                    <label for="selbstnutzung_erbe">Geplante Eigennutzung durch Erben (10 Jahre)</label>
                    <select id="selbstnutzung_erbe">
                        <option value="ja">Ja, mindestens 10 Jahre</option>
                        <option value="nein">Nein</option>
                        <option value="unsicher">Unsicher</option>
                    </select>
                </div>
            </div>
        </div>

        <button class="calculate-btn" onclick="calculateErbschaftsteuer()">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Erbschaftsteuer berechnen</button>

        <div id="erbschaft-results">
            <!-- Erbschaftsteuer Ergebnisse -->
        </div>

        <div class="warning success">
            <strong>üí° Steueroptimierung bei Erbschaften:</strong><br>
            ‚Ä¢ <strong>Familienheim:</strong> 100% steuerfrei f√ºr Ehepartner, f√ºr Kinder bis 200m¬≤<br>
            ‚Ä¢ <strong>Schenkungen:</strong> Freibetr√§ge alle 10 Jahre nutzbar<br>
            ‚Ä¢ <strong>Nie√übrauch:</strong> Kann Schenkungsteuer erheblich reduzieren<br>
            ‚Ä¢ <strong>Bewertung:</strong> Gutachten bei √ºberh√∂hten Werten sinnvoll
        </div>
    </div>

    <!-- Schenkungssteuer Tab -->
    <div id="schenkung" class="tab-content">
        <div class="warning info">
            <strong>üéÅ Schenkungssteuer-Optimierung:</strong> Nutzen Sie Freibetr√§ge optimal und planen Sie 
            steuerfreie √úbertragungen zu Lebzeiten.
        </div>

        <div class="input-section">
            <h3>üéÅ Schenkungsplanung</h3>
            <div class="input-grid">
                <div class="input-group">
                    <label for="schenkung_immobilienwert">Immobilienwert gesamt (‚Ç¨)</label>
                    <input type="number" id="schenkung_immobilienwert" value="600000" min="0">
                </div>

                <div class="input-group">
                    <label for="schenkung_anteil">Zu verschenkender Anteil (%)</label>
                    <input type="number" id="schenkung_anteil" value="50" min="0" max="100">
                    <div class="input-help">Schrittweise √úbertragung m√∂glich</div>
                </div>

                <div class="input-group">
                    <label for="schenkung_verwandtschaft">Beschenkter</label>
                    <select id="schenkung_verwandtschaft">
                        <option value="ehepartner">Ehepartner/Lebenspartner</option>
                        <option value="kind">Kind/Stiefkind</option>
                        <option value="enkel">Enkel</option>
                        <option value="eltern">Eltern/Gro√üeltern</option>
                        <option value="geschwister">Geschwister/Nichten/Neffen</option>
                        <option value="andere">Andere Personen</option>
                    </select>
                </div>

                <div class="input-group">
                    <label for="niessbrauch">Nie√übrauch vorbehalten</label>
                    <select id="niessbrauch">
                        <option value="nein">Nein</option>
                        <option value="ja">Ja, auf Lebenszeit</option>
                        <option value="wohnrecht">Nur Wohnrecht</option>
                    </select>
                </div>

                <div class="input-group">
                    <label for="jahresmiete">Jahresmiete/Mietwert (‚Ç¨)</label>
                    <input type="number" id="jahresmiete" value="18000" min="0">
                    <div class="input-help">F√ºr Nie√übrauchswert-Berechnung</div>
                </div>

                <div class="input-group">
                    <label for="alter_schenker">Alter des Schenkers</label>
                    <input type="number" id="alter_schenker" value="65" min="18" max="100">
                    <div class="input-help">F√ºr Nie√übrauchswert-Berechnung</div>
                </div>

                <div class="input-group">
                    <label for="vorherige_schenkungen">Vorherige Schenkungen (10 Jahre) (‚Ç¨)</label>
                    <input type="number" id="vorherige_schenkungen" value="0" min="0">
                    <div class="input-help">Schenkungen der letzten 10 Jahre an gleiche Person</div>
                </div>

                <div class="input-group">
                    <label for="geplante_schritte">Geplante Schenkungsschritte</label>
                    <input type="number" id="geplante_schritte" value="3" min="1" max="5">
                    <div class="input-help">Anzahl 10-Jahres-Perioden</div>
                </div>
            </div>
        </div>

        <button class="calculate-btn" onclick="calculateSchenkung()">üéÅ Schenkungssteuer berechnen</button>

        <div id="schenkung-results">
            <!-- Schenkungssteuer Ergebnisse -->
        </div>

        <div class="warning success">
            <strong>üéØ Optimale Schenkungsstrategie:</strong><br>
            ‚Ä¢ <strong>Timing:</strong> Freibetr√§ge alle 10 Jahre voll ausnutzen<br>
            ‚Ä¢ <strong>Nie√übrauch:</strong> Reduziert Schenkungswert erheblich<br>
            ‚Ä¢ <strong>Mehrere Objekte:</strong> Wohnungsweise verschenken<br>
            ‚Ä¢ <strong>Fr√ºh starten:</strong> Je fr√ºher, desto mehr Freibetrag-Zyklen m√∂glich
        </div>
    </div>

    <!-- Gesamtstrategie Tab -->
    <div id="gesamtstrategie" class="tab-content">
        <div class="strategy-overview">
            <h3>üéØ Ihre optimale Immobilienstrategie 2025</h3>
            <div class="timeline">
                <div class="timeline-item" id="timeline-kauf">
                    <div><strong>Kauf</strong></div>
                    <div>Strukturwahl</div>
                </div>
                <div class="timeline-item" id="timeline-haltung">
                    <div><strong>Haltung</strong></div>
                    <div>0-10 Jahre</div>
                </div>
                <div class="timeline-item" id="timeline-optimierung">
                    <div><strong>Optimierung</strong></div>
                    <div>Ab 8 Jahren</div>
                </div>
                <div class="timeline-item" id="timeline-exit">
                    <div><strong>Exit</strong></div>
                    <div>Verkauf/√úbergabe</div>
                </div>
            </div>
        </div>

        <div class="scenario-comparison">
            <h3>üìä Szenario-Vergleich: 10, 20 und 30 Jahre</h3>
            <div class="scenario-grid" id="scenario-results">
                <!-- Szenarien werden hier eingef√ºgt -->
            </div>
        </div>

        <div class="input-section">
            <h3>‚öôÔ∏è Strategische Parameter</h3>
            <div class="input-grid">
                <div class="input-group">
                    <label for="strategie_alter">Ihr Alter</label>
                    <input type="number" id="strategie_alter" value="45" min="18" max="90">
                </div>

                <div class="input-group">
                    <label for="strategie_risiko">Risikobereitschaft</label>
                    <select id="strategie_risiko">
                        <option value="niedrig">Sicherheitsorientiert</option>
                        <option value="mittel" selected>Ausgewogen</option>
                        <option value="hoch">Renditeorientiert</option>
                    </select>
                </div>

                <div class="input-group">
                    <label for="strategie_liquiditaet">Liquidit√§tsbedarf</label>
                    <select id="strategie_liquiditaet">
                        <option value="niedrig">Langfristig gebunden</option>
                        <option value="mittel" selected>Flexibel verf√ºgbar</option>
                        <option value="hoch">Schnell liquidierbar</option>
                    </select>
                </div>

                <div class="input-group">
                    <label for="strategie_nachfolge">Nachfolgeplanung</label>
                    <select id="strategie_nachfolge">
                        <option value="keine">Noch nicht relevant</option>
                        <option value="kinder">Vererbung an Kinder</option>
                        <option value="partner">√úbertragung an Partner</option>
                        <option value="verkauf">Verkauf geplant</option>
                    </select>
                </div>

                <div class="input-group">
                    <label for="strategie_weitere_immobilien">Weitere Immobilien geplant</label>
                    <select id="strategie_weitere_immobilien">
                        <option value="nein">Nein</option>
                        <option value="wenige">1-2 weitere</option>
                        <option value="portfolio">Portfolio-Aufbau</option>
                    </select>
                </div>

                <div class="input-group">
                    <label for="strategie_einkommen">J√§hrliches Einkommen (‚Ç¨)</label>
                    <input type="number" id="strategie_einkommen" value="80000" min="0">
                    <div class="input-help">F√ºr Verlustverrechnung relevant</div>
                </div>
            </div>
        </div>

        <button class="calculate-btn" onclick="calculateGesamtstrategie()">üéØ Optimale Strategie ermitteln</button>

        <div id="strategie-results">
            <!-- Strategieergebnisse -->
        </div>
    </div>

    <!-- Cash-Flow Analyse Tab -->
    <div id="cashflow" class="tab-content">
        <div class="warning info">
            <strong>üìä Cash-Flow Analyse:</strong> Vollst√§ndige Betrachtung aller Einnahmen, Ausgaben und 
            steuerlichen Auswirkungen √ºber die gesamte Haltedauer.
        </div>

        <div class="input-section">
            <h3>üí∞ Einnahmen und Ausgaben</h3>
            <div class="input-grid">
                <div class="input-group">
                    <label for="cf_jahresmiete">Jahresmiete (‚Ç¨)</label>
                    <input type="number" id="cf_jahresmiete" value="18000" min="0">
                </div>

                <div class="input-group">
                    <label for="cf_mietsteigerung">J√§hrliche Mietsteigerung (%)</label>
                    <input type="number" id="cf_mietsteigerung" value="2.5" min="0" max="10" step="0.1">
                </div>

                <div class="input-group">
                    <label for="cf_instandhaltung">Instandhaltung p.a. (‚Ç¨)</label>
                    <input type="number" id="cf_instandhaltung" value="2000" min="0">
                </div>

                <div class="input-group">
                    <label for="cf_verwaltung">Verwaltungskosten p.a. (‚Ç¨)</label>
                    <input type="number" id="cf_verwaltung" value="800" min="0">
                </div>

                <div class="input-group">
                    <label for="cf_versicherung">Versicherungen p.a. (‚Ç¨)</label>
                    <input type="number" id="cf_versicherung" value="600" min="0">
                </div>

                <div class="input-group">
                    <label for="cf_leerstand">Leerstandsrisiko (%)</label>
                    <input type="number" id="cf_leerstand" value="2" min="0" max="20" step="0.1">
                </div>

                <div class="input-group">
                    <label for="cf_finanzierung">Kreditzinsen p.a. (‚Ç¨)</label>
                    <input type="number" id="cf_finanzierung" value="8000" min="0">
                    <div class="input-help">J√§hrliche Zinszahlungen</div>
                </div>

                <div class="input-group">
                    <label for="cf_tilgung">Tilgung p.a. (‚Ç¨)</label>
                    <input type="number" id="cf_tilgung" value="6000" min="0">
                    <div class="input-help">Nicht steuerlich absetzbar</div>
                </div>

                <div class="input-group">
                    <label for="cf_wertsteigerung">J√§hrliche Wertsteigerung (%)</label>
                    <input type="number" id="cf_wertsteigerung" value="2" min="-5" max="10" step="0.1">
                </div>

                <div class="input-group">
                    <label for="cf_betrachtungszeitraum">Betrachtungszeitraum (Jahre)</label>
                    <input type="number" id="cf_betrachtungszeitraum" value="15" min="1" max="30">
                </div>
            </div>
        </div>

        <button class="calculate-btn" onclick="calculateCashFlow()">üìä Cash-Flow analysieren</button>

        <div class="cash-flow-chart" id="cashflow-chart">
            <!-- Cash-Flow Chart wird hier eingef√ºgt -->
        </div>

        <div id="cashflow-results">
            <!-- Cash-Flow Ergebnisse -->
        </div>

        <div class="warning info">
            <strong>üìà Cash-Flow Interpretation:</strong><br>
            ‚Ä¢ <strong>Positiver Cash-Flow:</strong> Immobilie erwirtschaftet √úberschuss<br>
            ‚Ä¢ <strong>Negativer Cash-Flow:</strong> Zuzahlung n√∂tig, aber steuerliche Vorteile<br>
            ‚Ä¢ <strong>Break-Even:</strong> Neutraler Cash-Flow bei Wertsteigerung<br>
            ‚Ä¢ <strong>Gesamtrendite:</strong> Ber√ºcksichtigt alle Faktoren inkl. Steuern
        </div>
    </div>
</div>

<script>
    // Globale Variablen f√ºr Berechnungen
    let berechungsdaten = {};

    // Tab-Wechsel Funktionalit√§t
    function switchTab(clickedButton, tabName) {
    // Alle Tab-Inhalte ausblenden
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    // Alle Tab-Buttons deaktivieren
    document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.classList.remove('active');
    });

    // Gew√§hlten Tab-Inhalt anzeigen
    document.getElementById(tabName).classList.add('active');
    
    // Geklickten Button als aktiv markieren
    if (clickedButton) {
        clickedButton.classList.add('active');
    }
}

    // Hilfsfunktionen f√ºr Formatierung
    function formatCurrency(amount) {
        // Sichere Formatierung - behandle NaN, undefined, null
        if (isNaN(amount) || amount === null || amount === undefined) {
            return '0 ‚Ç¨';
        }
        
        const numAmount = parseFloat(amount) || 0;
        
        return new Intl.NumberFormat('de-DE', {
            style: 'currency',
            currency: 'EUR',
            minimumFractionDigits: 0,
            maximumFractionDigits: 0
        }).format(numAmount);
    }

    function formatPercent(rate) {
        // Sichere Formatierung f√ºr Prozente
        if (isNaN(rate) || rate === null || rate === undefined) {
            return '0,0%';
        }
        
        const numRate = parseFloat(rate) || 0;
        return (numRate).toFixed(1) + '%';
    }

    // Verkaufssteuer Berechnung (erweitert)
    function calculateVerkauf() {
        const kaufpreis = parseFloat(document.getElementById('kaufpreis').value) || 0;
        const verkaufspreis = parseFloat(document.getElementById('verkaufspreis').value) || 0;
        const nebenkostenKauf = parseFloat(document.getElementById('nebenkosten_kauf').value) || 0;
        const nebenkostenVerkauf = parseFloat(document.getElementById('nebenkosten_verkauf').value) || 0;
        const modernisierung = parseFloat(document.getElementById('modernisierung').value) || 0;
        const haltedauer = parseFloat(document.getElementById('haltedauer').value) || 0;
        const persSteuersatz = parseFloat(document.getElementById('persoenlicher_steuersatz').value) || 42;
        const kirchensteuer = parseFloat(document.getElementById('kirchensteuer').value) || 8;
        const einbringungNach = parseFloat(document.getElementById('einbringung_nach_jahren').value) || 0;

        // Berechnungsdaten f√ºr andere Module speichern - KORRIGIERT
        berechungsdaten.immobilie = {
            kaufpreis: kaufpreis,
            verkaufspreis: verkaufspreis, 
            nebenkosten_kauf: nebenkostenKauf,
            nebenkosten_verkauf: nebenkostenVerkauf,
            modernisierung: modernisierung, 
            haltedauer: haltedauer, 
            persSteuersatz: persSteuersatz, 
            kirchensteuer: kirchensteuer, 
            einbringung_nach_jahren: einbringungNach
        };

        const gesamtkosten = kaufpreis + nebenkostenKauf + modernisierung;
        const bruttogewinn = verkaufspreis - nebenkostenVerkauf - gesamtkosten;
        const koerperschaftsteuer = 15;
        const soli = 5.5;
        const gesamtsteuersatz = persSteuersatz + (persSteuersatz * kirchensteuer / 100) + (persSteuersatz * soli / 100);
        
        const ergebnisse = [];

        // 1. Privatverkauf
        let steuer = 0;
        let steuerfrei = haltedauer >= 10;
        if (!steuerfrei) {
            steuer = bruttogewinn * gesamtsteuersatz / 100;
        }
        ergebnisse.push({
            typ: 'Privatverkauf',
            bruttogewinn: bruttogewinn,
            steuer: steuer,
            nettogewinn: bruttogewinn - steuer,
            besonderheiten: steuerfrei ? '‚úÖ Steuerfrei nach 10 Jahren (¬ß23 EStG)' : '‚è∞ Spekulationssteuer - noch ' + (10 - haltedauer).toFixed(1) + ' Jahre bis steuerfrei'
        });

        // 2. VV GbR
        ergebnisse.push({
            typ: 'VV GbR',
            bruttogewinn: bruttogewinn,
            steuer: steuer,
            nettogewinn: bruttogewinn - steuer,
            besonderheiten: steuerfrei ? '‚úÖ Steuerfrei nach 10 Jahren (transparente Besteuerung)' : '‚è∞ Transparente Besteuerung, noch ' + (10 - haltedauer).toFixed(1) + ' Jahre bis steuerfrei'
        });

        // 3. VV GmbH & Co. KG - NEU: Gewerbesteuerbefreiung 2025
        if (haltedauer >= 10) {
            ergebnisse.push({
                typ: 'VV GmbH & Co. KG',
                bruttogewinn: bruttogewinn,
                steuer: 0,
                nettogewinn: bruttogewinn,
                besonderheiten: 'üèÜ STEUERFREI nach 10 Jahren + BFH 2025: Gewerbesteuerbefreiung!'
            });
        } else {
            const steuerVVKG = bruttogewinn * gesamtsteuersatz / 100;
            ergebnisse.push({
                typ: 'VV GmbH & Co. KG',
                bruttogewinn: bruttogewinn,
                steuer: steuerVVKG,
                nettogewinn: bruttogewinn - steuerVVKG,
                besonderheiten: '‚≠ê BFH 2025: GEWERBESTEUERFREI + wird nach 10 Jahren komplett steuerfrei!'
            });
        }

        // 4. VV GmbH (mit Doppelbesteuerung)
        const gewerbesteuer = 14;
        const gewerbesteuerFreibetrag = 24500;
        const gstBasis = Math.max(0, bruttogewinn - gewerbesteuerFreibetrag);
        const gstBetrag = gstBasis * gewerbesteuer / 100;
        const kstBasis = bruttogewinn - gstBetrag;
        const kstBetrag = kstBasis * koerperschaftsteuer / 100;
        const soli_gmbh = kstBetrag * 5.5 / 100;
        const gesamtsteuerGmbh = gstBetrag + kstBetrag + soli_gmbh;
        const nettoGmbh = bruttogewinn - gesamtsteuerGmbh;
        const abgeltungsteuer = nettoGmbh * 26.375 / 100;
        
        let besonderheitGmbh = '‚ùå NIEMALS steuerfrei! Doppelbesteuerung: ~30% GmbH + ~26% Aussch√ºttung = ~48-50%';
        if (einbringungNach > 0 && einbringungNach >= 10) {
            besonderheitGmbh = `‚úÖ Einbringung nach ${einbringungNach} Jahren war steuerfrei, ‚ùå aber Verkauf durch GmbH = Doppelbesteuerung`;
        } else if (einbringungNach > 0) {
            besonderheitGmbh = `‚ùå Einbringung nach ${einbringungNach} Jahren war steuerpflichtig, Verkauf auch = Doppelbesteuerung`;
        }
        
        ergebnisse.push({
            typ: 'VV GmbH',
            bruttogewinn: bruttogewinn,
            steuer: gesamtsteuerGmbh + abgeltungsteuer,
            nettogewinn: nettoGmbh - abgeltungsteuer,
            besonderheiten: besonderheitGmbh
        });

        // 5. VV KG (Kommanditgesellschaft)
        ergebnisse.push({
            typ: 'VV KG',
            bruttogewinn: bruttogewinn,
            steuer: steuer,
            nettogewinn: bruttogewinn - steuer,
            besonderheiten: steuerfrei ? '‚úÖ Steuerfrei nach 10 Jahren (transparente Besteuerung wie GbR)' : '‚è∞ Transparente Besteuerung, noch ' + (10 - haltedauer).toFixed(1) + ' Jahre bis steuerfrei'
        });

        // 6. VV OHG (Offene Handelsgesellschaft)
        ergebnisse.push({
            typ: 'VV OHG',
            bruttogewinn: bruttogewinn,
            steuer: steuer,
            nettogewinn: bruttogewinn - steuer,
            besonderheiten: steuerfrei ? '‚úÖ Steuerfrei nach 10 Jahren (transparente Besteuerung)' : '‚ö†Ô∏è OHG = Vollhaftung aller Gesellschafter!'
        });

        // 7. VV PartG (Partnerschaftsgesellschaft)
        ergebnisse.push({
            typ: 'VV PartG',
            bruttogewinn: bruttogewinn,
            steuer: steuer,
            nettogewinn: bruttogewinn - steuer,
            besonderheiten: steuerfrei ? '‚úÖ Steuerfrei nach 10 Jahren (nur f√ºr Freiberufler)' : '‚ö†Ô∏è Nur f√ºr Freiberufler geeignet'
        });

        // 8. Familienpool KG
        const familienRabatt = bruttogewinn * 0.05; // 5% Rabatt durch Familienstrukturen
        ergebnisse.push({
            typ: 'Familienpool KG',
            bruttogewinn: bruttogewinn,
            steuer: Math.max(0, steuer - familienRabatt),
            nettogewinn: bruttogewinn - Math.max(0, steuer - familienRabatt),
            besonderheiten: steuerfrei ? 'üèÜ Steuerfrei + optimale Nachfolgeplanung f√ºr Familien' : 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Optimal f√ºr Generationen√ºbergabe'
        });

        // 9. VV UG (Unternehmergesellschaft)
        const ugSteuer = gesamtsteuerGmbh * 0.8; // Etwas g√ºnstiger als GmbH
        ergebnisse.push({
            typ: 'VV UG',
            bruttogewinn: bruttogewinn,
            steuer: ugSteuer + abgeltungsteuer * 0.8,
            nettogewinn: bruttogewinn - ugSteuer - abgeltungsteuer * 0.8,
            besonderheiten: '‚ùå Doppelbesteuerung wie GmbH, aber g√ºnstiger in der Gr√ºndung'
        });

        // 10. VV Holding-GmbH
        const holdingVorteil = bruttogewinn * 0.1; // 10% Vorteil durch Schachtelprivileg
        ergebnisse.push({
            typ: 'VV Holding-GmbH',
            bruttogewinn: bruttogewinn,
            steuer: Math.max(0, gesamtsteuerGmbh - holdingVorteil),
            nettogewinn: bruttogewinn - Math.max(0, gesamtsteuerGmbh - holdingVorteil),
            besonderheiten: '‚≠ê Schachtelprivileg nutzen, optimal f√ºr gro√üe Portfolios ab 3+ Objekte'
        });

        // 11. Gewerbliche GbR
        const gewerbesteuerGesamt = bruttogewinn * gewerbesteuer / 100;
        const anrechnungsbetrag = gewerbesteuerGesamt * 3.8;
        const einkommensteuerBasis = bruttogewinn - Math.min(anrechnungsbetrag, gewerbesteuerGesamt);
        const einkommensteuer = einkommensteuerBasis * gesamtsteuersatz / 100;
        const gesamtsteuerGewerblich = gewerbesteuerGesamt + einkommensteuer;

        ergebnisse.push({
            typ: 'Gewerbliche GbR',
            bruttogewinn: bruttogewinn,
            steuer: gesamtsteuerGewerblich,
            nettogewinn: bruttogewinn - gesamtsteuerGewerblich,
            besonderheiten: '‚ùå Gewerblich = KEINE 10-Jahres-Frist (¬ß23 EStG gilt nicht), aber Gewerbesteueranrechnung'
        });

        // 12. Gewerbliche GmbH
        const gewGmbhSteuer = gesamtsteuerGmbh * 1.1; // Etwas h√∂her durch Gewerbesteuer
        ergebnisse.push({
            typ: 'Gewerbliche GmbH',
            bruttogewinn: bruttogewinn,
            steuer: gewGmbhSteuer,
            nettogewinn: bruttogewinn - gewGmbhSteuer,
            besonderheiten: '‚ùå Immer gewerblich + Doppelbesteuerung = h√∂chste Steuerbelastung'
        });

        // 13. Gewerbliche GmbH & Co. KG
        const gewKGSteuer = gesamtsteuerGewerblich * 0.9; // Etwas g√ºnstiger als reine GmbH
        ergebnisse.push({
            typ: 'Gewerbliche GmbH & Co. KG',
            bruttogewinn: bruttogewinn,
            steuer: gewKGSteuer,
            nettogewinn: bruttogewinn - gewKGSteuer,
            besonderheiten: '‚ùå Gewerblich = keine 10-Jahres-Frist, aber flexibler als reine GmbH'
        });

        // 14. Cross-Border DE-LU Struktur
        if (bruttogewinn > 500000) { // Nur bei gr√∂√üeren Gewinnen sinnvoll
            const crossBorderVorteil = bruttogewinn * 0.15; // 15% Steuerersparnis
            ergebnisse.push({
                typ: 'Cross-Border DE-LU',
                bruttogewinn: bruttogewinn,
                steuer: Math.max(0, steuer - crossBorderVorteil),
                nettogewinn: bruttogewinn - Math.max(0, steuer - crossBorderVorteil),
                besonderheiten: 'üåç EU-Strukturen nur bei gro√üen Portfolios (>500k), komplexe Beratung n√∂tig'
            });
        }

        // Intelligente Filterung: Nur relevante Strukturen anzeigen
        const relevanteErgebnisse = filterRelevanteStrukturen(ergebnisse, bruttogewinn, haltedauer);
        displayVerkaufResults(relevanteErgebnisse, ergebnisse.length);
    }

    // Intelligente Filterung f√ºr relevante Strukturen
    function filterRelevanteStrukturen(alleErgebnisse, bruttogewinn, haltedauer) {
        let relevante = [];
        
        // Immer anzeigen: Die wichtigsten 3-4 Strukturen
        const wichtigeStrukturen = ['Privatverkauf', 'VV GbR', 'VV GmbH & Co. KG', 'VV GmbH'];
        relevante = alleErgebnisse.filter(e => wichtigeStrukturen.includes(e.typ));
        
        // Bei gro√üen Gewinnen (>300k): Weitere Strukturen hinzuf√ºgen
        if (bruttogewinn > 300000) {
            const zusaetzliche = ['Familienpool KG', 'VV Holding-GmbH'];
            relevante.push(...alleErgebnisse.filter(e => zusaetzliche.includes(e.typ)));
        }
        
        // Bei sehr gro√üen Gewinnen (>500k): Cross-Border zeigen
        if (bruttogewinn > 500000) {
            const crossBorder = alleErgebnisse.find(e => e.typ === 'Cross-Border DE-LU');
            if (crossBorder) relevante.push(crossBorder);
        }
        
        // Bei fr√ºhem Verkauf (< 8 Jahre): Gewerbliche Alternativen zeigen
        if (haltedauer < 8) {
            relevante.push(alleErgebnisse.find(e => e.typ === 'Gewerbliche GbR'));
        }
        
        return relevante;
    }

    function displayVerkaufResults(ergebnisse, gesamtAnzahl) {
        const besteOption = ergebnisse.reduce((beste, aktuelle) => 
            aktuelle.nettogewinn > beste.nettogewinn ? aktuelle : beste
        );

        let html = `
            <h3 style="text-align: center; color: #2c3e50; margin: 30px 0;">üìä Verkaufssteuer-Vergleich Ergebnisse</h3>
            <div style="text-align: center; margin-bottom: 20px;">
                <span style="background: #e3f2fd; padding: 8px 15px; border-radius: 15px; font-size: 0.9em; color: #1565c0;">
                    Zeige ${ergebnisse.length} von ${gesamtAnzahl} verf√ºgbaren Strukturen
                </span>
                <button onclick="showAllStructures()" style="
                    background: #3498db;
                    color: white;
                    border: none;
                    padding: 8px 15px;
                    border-radius: 5px;
                    margin-left: 10px;
                    cursor: pointer;
                    font-size: 0.9em;
                ">üìã Alle ${gesamtAnzahl} Strukturen anzeigen</button>
            </div>
            <div class="results-grid">
        `;

        ergebnisse.forEach(option => {
            const isBest = option.typ === besteOption.typ;
            html += `
                <div class="result-card ${isBest ? 'best-option' : ''}">
                    <h4>${option.typ} ${isBest ? 'üèÜ' : ''}</h4>
                    <div class="result-item">
                        <span class="result-label">Bruttogewinn:</span>
                        <span class="result-value">${formatCurrency(option.bruttogewinn)}</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Steuern gesamt:</span>
                        <span class="result-value negative">${formatCurrency(option.steuer)}</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Nettogewinn:</span>
                        <span class="result-value">${formatCurrency(option.nettogewinn)}</span>
                    </div>
                    <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 8px; font-size: 0.85em; color: #6c757d;">
                        ${option.besonderheiten}
                    </div>
                </div>
            `;
        });

        html += `</div>`;

        // Vergleichstabelle
        html += `
            <table class="comparison-table">
                <thead>
                    <tr>
                        <th>Struktur</th>
                        <th>Nettogewinn</th>
                        <th>Steuern</th>
                        <th>Steuerquote</th>
                        <th>Besonderheiten</th>
                    </tr>
                </thead>
                <tbody>
        `;

        ergebnisse.forEach(option => {
            const isBest = option.typ === besteOption.typ;
            html += `
                <tr ${isBest ? 'class="best-option"' : ''}>
                    <td><strong>${option.typ}</strong></td>
                    <td>${formatCurrency(option.nettogewinn)}</td>
                    <td>${formatCurrency(option.steuer)}</td>
                    <td>${formatPercent(option.bruttogewinn > 0 ? option.steuer / option.bruttogewinn * 100 : 0)}</td>
                    <td style="font-size: 0.8em;">${option.besonderheiten}</td>
                </tr>
            `;
        });

        html += `</tbody></table>`;

        document.getElementById('verkauf-results').innerHTML = html;
        
        // Animation hinzuf√ºgen
        setTimeout(() => {
            document.getElementById('verkauf-results').classList.add('structure-transition');
        }, 50);
        
        // Animation hinzuf√ºgen
        setTimeout(() => {
            document.getElementById('verkauf-results').classList.add('structure-transition');
        }, 50);
    }

    // Grundsteuer Berechnung
    function calculateGrundsteuer() {
        const grundstueckswert = parseFloat(document.getElementById('grundstueckswert').value) || 0;
        const immobilientyp = document.getElementById('immobilientyp').value;
        const hebesatz = parseFloat(document.getElementById('gemeinde_hebesatz').value) || 0;
        const bundeslandModell = document.getElementById('grundsteuer_bundesland').value;
        const nutzungsart = document.getElementById('vermietung_typ').value;

        // Grundsteuermesszahl je nach Immobilientyp
        let messzahl = 0.34; // Standard f√ºr bebaute Grundst√ºcke
        if (immobilientyp === 'einfamilienhaus' || immobilientyp === 'mietwohnung' || immobilientyp === 'eigentumswohnung') {
            messzahl = 0.31;
        }

        // Bundesland-spezifische Anpassungen
        if (bundeslandModell === 'hh') {
            messzahl = 0.70; // Hamburg Sonderregelung
        } else if (bundeslandModell === 'sl') {
            messzahl = 0.38; // Saarland Anpassung
        }

        const messbetrag = grundstueckswert * messzahl / 1000;
        const grundsteuerBetrag = messbetrag * hebesatz / 100;

        // Steuerliche Behandlung
        let steuerlicheBehandlung = '';
        let ersparnis = 0;
        
        if (nutzungsart === 'vermietung') {
            ersparnis = grundsteuerBetrag * (berechungsdaten.immobilie?.persSteuersatz || 42) / 100;
            steuerlicheBehandlung = `Als Werbungskosten absetzbar. J√§hrliche Steuerersparnis: ${formatCurrency(ersparnis)}`;
        } else if (nutzungsart === 'gewerbe') {
            ersparnis = grundsteuerBetrag * (berechungsdaten.immobilie?.persSteuersatz || 42) / 100;
            steuerlicheBehandlung = `Als Betriebsausgabe absetzbar. J√§hrliche Steuerersparnis: ${formatCurrency(ersparnis)}`;
        } else if (nutzungsart === 'eigennutzung') {
            steuerlicheBehandlung = 'Nicht steuerlich absetzbar bei Eigennutzung';
        } else if (nutzungsart === 'leerstand') {
            steuerlicheBehandlung = 'Erlass bei unverschuldetem Leerstand m√∂glich';
        }

        let html = `
            <h3 style="text-align: center; color: #2c3e50; margin: 30px 0;">üèõÔ∏è Grundsteuer-Berechnung 2025</h3>
            <div class="results-grid">
                <div class="result-card">
                    <h4>üìä Grundsteuer-Berechnung</h4>
                    <div class="result-item">
                        <span class="result-label">Grundsteuerwert:</span>
                        <span class="result-value">${formatCurrency(grundstueckswert)}</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Grundsteuermesszahl:</span>
                        <span class="result-value">${messzahl}‚Ä∞</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Grundsteuermessbetrag:</span>
                        <span class="result-value">${formatCurrency(messbetrag)}</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Hebesatz Gemeinde:</span>
                        <span class="result-value">${hebesatz}%</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Grundsteuer pro Jahr:</span>
                        <span class="result-value negative">${formatCurrency(grundsteuerBetrag)}</span>
                    </div>
                </div>

                <div class="result-card">
                    <h4>üí° Steuerliche Auswirkungen</h4>
                    <div class="result-item">
                        <span class="result-label">Nutzungsart:</span>
                        <span class="result-value">${nutzungsart}</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Steuerliche Behandlung:</span>
                        <span class="result-value">Siehe unten</span>
                    </div>
                    ${ersparnis > 0 ? `
                    <div class="result-item">
                        <span class="result-label">Steuerersparnis p.a.:</span>
                        <span class="result-value">${formatCurrency(ersparnis)}</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Nettobelastung p.a.:</span>
                        <span class="result-value negative">${formatCurrency(grundsteuerBetrag - ersparnis)}</span>
                    </div>
                    ` : ''}
                    <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 8px; font-size: 0.85em; color: #6c757d;">
                        ${steuerlicheBehandlung}
                    </div>
                </div>

                <div class="result-card">
                    <h4>üìà Vergleich zur alten Grundsteuer</h4>
                    <div style="padding: 15px; background: #fff3cd; border-radius: 8px; margin: 10px 0; font-size: 0.9em; color: #856404;">
                        <strong>‚ö†Ô∏è Hinweis:</strong> Die neue Grundsteuer kann erheblich von der bisherigen abweichen. 
                        In vielen Kommunen sind Steigerungen von 100-300% m√∂glich, besonders in begehrten Lagen.
                    </div>
                    <div style="padding: 15px; background: #e3f2fd; border-radius: 8px; margin: 10px 0; font-size: 0.9em; color: #1565c0;">
                        <strong>üí° Einspruch m√∂glich:</strong> Bei √ºber 40% Abweichung zum tats√§chlichen Marktwert 
                        k√∂nnen Sie binnen eines Monats Einspruch gegen den Grundsteuerwertbescheid einlegen.
                    </div>
                </div>
            </div>
        `;

        document.getElementById('grundsteuer-results').innerHTML = html;
    }

    // Erbschaftsteuer Berechnung
    function calculateErbschaftsteuer() {
        const immobilienwert = parseFloat(document.getElementById('immobilienwert_erbe').value) || 0;
        const weiteresVermoegen = parseFloat(document.getElementById('weiteres_vermoegen').value) || 0;
        const schulden = parseFloat(document.getElementById('schulden').value) || 0;
        const verwandtschaftsgrad = document.getElementById('verwandtschaftsgrad').value;
        const wohnflaeche = parseFloat(document.getElementById('wohnflaeche').value) || 0;
        const selbstnutzungErblasser = document.getElementById('selbstnutzung_erblasser').value;
        const selbstnutzungErbe = document.getElementById('selbstnutzung_erbe').value;

        // Erbfallkostenpauschale (2025: 15.000‚Ç¨)
        const erbfallkosten = 15000;
        
        // Freibetr√§ge und Steuerklassen
        const freibetraege = {
            'ehepartner': 500000,
            'kind': 400000,
            'enkel': 200000,
            'eltern': 100000,
            'geschwister': 20000,
            'andere': 20000
        };

        const steuerklassen = {
            'ehepartner': 1,
            'kind': 1,
            'enkel': 1,
            'eltern': 2,
            'geschwister': 2,
            'andere': 3
        };

        const steuersaetze = {
            1: [7, 11, 15, 19, 23, 27, 30],
            2: [15, 20, 25, 30, 35, 40, 43],
            3: [30, 35, 40, 45, 50]
        };

        const grenzen = [75000, 300000, 600000, 6000000, 13000000, 26000000];

        const freibetrag = freibetraege[verwandtschaftsgrad];
        const steuerklasse = steuerklassen[verwandtschaftsgrad];

        // Familienheim-Steuerbefreiung pr√ºfen
        let familienheimBefreiung = false;
        let familienheimWert = 0;

        if ((verwandtschaftsgrad === 'ehepartner' || verwandtschaftsgrad === 'kind') && 
            selbstnutzungErblasser === 'ja' && selbstnutzungErbe === 'ja') {
            
            if (verwandtschaftsgrad === 'ehepartner') {
                familienheimBefreiung = true;
                familienheimWert = immobilienwert;
            } else if (verwandtschaftsgrad === 'kind' && wohnflaeche <= 200) {
                familienheimBefreiung = true;
                familienheimWert = immobilienwert;
            }
        }

        // Steuerpflichtiges Verm√∂gen berechnen
        const gesamtvermoegen = immobilienwert + weiteresVermoegen - schulden - erbfallkosten;
        const steuerpflichtigerWert = familienheimBefreiung ? 
            Math.max(0, gesamtvermoegen - familienheimWert - freibetrag) :
            Math.max(0, gesamtvermoegen - freibetrag);

        // Steuersatz ermitteln
        let steuersatz = 0;
        if (steuerpflichtigerWert > 0) {
            const satzTabelle = steuersaetze[steuerklasse];
            for (let i = 0; i < grenzen.length; i++) {
                if (steuerpflichtigerWert <= grenzen[i]) {
                    steuersatz = satzTabelle[i];
                    break;
                }
            }
            if (steuersatz === 0) {
                steuersatz = satzTabelle[satzTabelle.length - 1];
            }
        }

        const erbschaftsteuer = steuerpflichtigerWert * steuersatz / 100;

        let html = `
            <h3 style="text-align: center; color: #2c3e50; margin: 30px 0;">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Erbschaftsteuer-Berechnung</h3>
            <div class="results-grid">
                <div class="result-card">
                    <h4>üí∞ Verm√∂gensaufstellung</h4>
                    <div class="result-item">
                        <span class="result-label">Immobilienwert:</span>
                        <span class="result-value">${formatCurrency(immobilienwert)}</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Weiteres Verm√∂gen:</span>
                        <span class="result-value">${formatCurrency(weiteresVermoegen)}</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Schulden:</span>
                        <span class="result-value negative">-${formatCurrency(schulden)}</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Erbfallkosten:</span>
                        <span class="result-value negative">-${formatCurrency(erbfallkosten)}</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Gesamtverm√∂gen:</span>
                        <span class="result-value">${formatCurrency(gesamtvermoegen)}</span>
                    </div>
                </div>

                <div class="result-card ${familienheimBefreiung ? 'best-option' : ''}">
                    <h4>üè† Familienheim-Befreiung</h4>
                    <div class="result-item">
                        <span class="result-label">Berechtigt:</span>
                        <span class="result-value">${familienheimBefreiung ? 'Ja ‚úÖ' : 'Nein ‚ùå'}</span>
                    </div>
                    ${familienheimBefreiung ? `
                    <div class="result-item">
                        <span class="result-label">Steuerfreier Wert:</span>
                        <span class="result-value">${formatCurrency(familienheimWert)}</span>
                    </div>
                    ` : ''}
                    <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 8px; font-size: 0.85em; color: #6c757d;">
                        ${familienheimBefreiung ? 
                            '‚úÖ Familienheim ist steuerfrei! Bedingung: 10 Jahre Eigennutzung' :
                            'Voraussetzungen f√ºr Familienheim-Befreiung nicht erf√ºllt'
                        }
                    </div>
                </div>

                <div class="result-card">
                    <h4>‚öñÔ∏è Steuerberechnung</h4>
                    <div class="result-item">
                        <span class="result-label">Verwandtschaftsgrad:</span>
                        <span class="result-value">${verwandtschaftsgrad}</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Freibetrag:</span>
                        <span class="result-value">${formatCurrency(freibetrag)}</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Steuerklasse:</span>
                        <span class="result-value">${steuerklasse}</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Steuerpflichtiger Wert:</span>
                        <span class="result-value">${formatCurrency(steuerpflichtigerWert)}</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Steuersatz:</span>
                        <span class="result-value">${steuersatz}%</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Erbschaftsteuer:</span>
                        <span class="result-value ${erbschaftsteuer > 0 ? 'negative' : ''}">${formatCurrency(erbschaftsteuer)}</span>
                    </div>
                </div>
            </div>

            ${erbschaftsteuer > 0 ? `
            <div class="warning danger">
                <strong>üí∏ Steuerbelastung: ${formatCurrency(erbschaftsteuer)}</strong><br>
                Das entspricht ${formatPercent(erbschaftsteuer / gesamtvermoegen * 100)} des Gesamtverm√∂gens. 
                Bei Liquidit√§tsproblemen k√∂nnte ein Verkauf der Immobilie n√∂tig werden.
            </div>
            ` : `
            <div class="warning success">
                <strong>üéâ Keine Erbschaftsteuer!</strong><br>
                ${familienheimBefreiung ? 'Dank Familienheim-Befreiung und ' : ''}Freibetrag reicht aus.
            </div>
            `}
        `;

        document.getElementById('erbschaft-results').innerHTML = html;
    }

    // Schenkungssteuer Berechnung
    function calculateSchenkung() {
        const immobilienwert = parseFloat(document.getElementById('schenkung_immobilienwert').value) || 0;
        const schenkungsanteil = parseFloat(document.getElementById('schenkung_anteil').value) || 0;
        const verwandtschaft = document.getElementById('schenkung_verwandtschaft').value;
        const niessbrauch = document.getElementById('niessbrauch').value;
        const jahresmiete = parseFloat(document.getElementById('jahresmiete').value) || 0;
        const alterSchenker = parseFloat(document.getElementById('alter_schenker').value) || 0;
        const vorherigeSchenkungen = parseFloat(document.getElementById('vorherige_schenkungen').value) || 0;
        const geplantePerioden = parseFloat(document.getElementById('geplante_schritte').value) || 1;

        const schenkungswert = immobilienwert * schenkungsanteil / 100;

        // Freibetr√§ge (gleich wie Erbschaftsteuer)
        const freibetraege = {
            'ehepartner': 500000,
            'kind': 400000,
            'enkel': 200000,
            'eltern': 100000,
            'geschwister': 20000,
            'andere': 20000
        };

        const freibetrag = freibetraege[verwandtschaft];

        // Nie√übrauchswert berechnen
        let niessbrauchswert = 0;
        if (niessbrauch === 'ja' && jahresmiete > 0) {
            // Vereinfachte Berechnung: Jahresmiete √ó Kapitalisierungsfaktor
            const kapitalisierungsfaktor = Math.max(1, 18.6 - (alterSchenker - 50) * 0.5);
            niessbrauchswert = jahresmiete * kapitalisierungsfaktor;
        } else if (niessbrauch === 'wohnrecht' && jahresmiete > 0) {
            const kapitalisierungsfaktor = Math.max(1, 18.6 - (alterSchenker - 50) * 0.5);
            niessbrauchswert = jahresmiete * 0.6 * kapitalisierungsfaktor; // Wohnrecht = 60% des Nie√übrauchs
        }

        const bereinigterschenkungswert = Math.max(0, schenkungswert - niessbrauchswert);
        
        // Mehrperioden-Strategie
        const schenkungProPeriode = bereinigterschenkungswert / geplantePerioden;
        const gesamteFreibetraege = freibetrag * geplantePerioden;
        const gesamteSchenkungsteuer = Math.max(0, bereinigterschenkungswert - gesamteFreibetraege) * 0.15; // Vereinfachter Steuersatz

        // Aktuelle Periode
        const aktuellerSchenkungswert = vorherigeSchenkungen + schenkungProPeriode;
        const aktuelleSchenkungsteuer = Math.max(0, aktuellerSchenkungswert - freibetrag) * 0.15;

        let html = `
            <h3 style="text-align: center; color: #2c3e50; margin: 30px 0;">üéÅ Schenkungssteuer-Optimierung</h3>
            <div class="results-grid">
                <div class="result-card">
                    <h4>üè† Schenkungsgegenstand</h4>
                    <div class="result-item">
                        <span class="result-label">Gesamtimmobilienwert:</span>
                        <span class="result-value">${formatCurrency(immobilienwert)}</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Schenkungsanteil:</span>
                        <span class="result-value">${schenkungsanteil}%</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Schenkungswert brutto:</span>
                        <span class="result-value">${formatCurrency(schenkungswert)}</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Nie√übrauchswert:</span>
                        <span class="result-value negative">-${formatCurrency(niessbrauchswert)}</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Schenkungswert netto:</span>
                        <span class="result-value">${formatCurrency(bereinigterschenkungswert)}</span>
                    </div>
                </div>

                <div class="result-card">
                    <h4>üìä Einperioden-Strategie</h4>
                    <div class="result-item">
                        <span class="result-label">Freibetrag:</span>
                        <span class="result-value">${formatCurrency(freibetrag)}</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Steuerpflichtiger Wert:</span>
                        <span class="result-value">${formatCurrency(Math.max(0, bereinigterschenkungswert - freibetrag))}</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Schenkungsteuer:</span>
                        <span class="result-value negative">${formatCurrency(Math.max(0, bereinigterschenkungswert - freibetrag) * 0.15)}</span>
                    </div>
                </div>

                <div class="result-card best-option">
                    <h4>üéØ Mehrperioden-Strategie (${geplantePerioden} √ó 10 Jahre)</h4>
                    <div class="result-item">
                        <span class="result-label">Schenkung pro Periode:</span>
                        <span class="result-value">${formatCurrency(schenkungProPeriode)}</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Gesamte Freibetr√§ge:</span>
                        <span class="result-value">${formatCurrency(gesamteFreibetraege)}</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Gesamte Steuerersparnis:</span>
                        <span class="result-value">${formatCurrency(Math.max(0, bereinigterschenkungswert - freibetrag) * 0.15 - gesamteSchenkungsteuer)}</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Optimierte Schenkungsteuer:</span>
                        <span class="result-value negative">${formatCurrency(gesamteSchenkungsteuer)}</span>
                    </div>
                </div>
            </div>

            <div class="scenario-comparison">
                <h3>üìà Schenkungsstrategie-Vergleich</h3>
                <div class="scenario-grid">
                    <div class="scenario-card">
                        <h4>üí∏ Ohne Optimierung</h4>
                        <p><strong>Sofortige Schenkung:</strong> ${formatCurrency(Math.max(0, bereinigterschenkungswert - freibetrag) * 0.15)} Steuern</p>
                        <p><strong>Netto√ºbertragung:</strong> ${formatCurrency(bereinigterschenkungswert - Math.max(0, bereinigterschenkungswert - freibetrag) * 0.15)}</p>
                    </div>
                    <div class="scenario-card" style="border-left-color: #27ae60;">
                        <h4>üéØ Mit Optimierung</h4>
                        <p><strong>Optimierte Steuern:</strong> ${formatCurrency(gesamteSchenkungsteuer)}</p>
                        <p><strong>Netto√ºbertragung:</strong> ${formatCurrency(bereinigterschenkungswert - gesamteSchenkungsteuer)}</p>
                        <p><strong>Ersparnis:</strong> ${formatCurrency(Math.max(0, bereinigterschenkungswert - freibetrag) * 0.15 - gesamteSchenkungsteuer)}</p>
                    </div>
                    ${niessbrauchswert > 0 ? `
                    <div class="scenario-card" style="border-left-color: #3498db;">
                        <h4>üè† Nie√übrauch-Vorteil</h4>
                        <p><strong>J√§hrliche Einnahmen:</strong> ${formatCurrency(jahresmiete)}</p>
                        <p><strong>Steuerersparnis durch Nie√übrauch:</strong> ${formatCurrency(niessbrauchswert * 0.15)}</p>
                        <p><strong>Verbleiben beim Schenker:</strong> Nutzung + Einnahmen</p>
                    </div>
                    ` : ''}
                </div>
            </div>
        `;

        document.getElementById('schenkung-results').innerHTML = html;
    }

    // Gesamtstrategie Berechnung
    function calculateGesamtstrategie() {
        // Hier w√ºrde eine komplexe Gesamtanalyse erfolgen
        const alter = parseFloat(document.getElementById('strategie_alter').value) || 45;
        const risiko = document.getElementById('strategie_risiko').value;
        const liquiditaet = document.getElementById('strategie_liquiditaet').value;
        const nachfolge = document.getElementById('strategie_nachfolge').value;
        const weitereImmobilien = document.getElementById('strategie_weitere_immobilien').value;
        const einkommen = parseFloat(document.getElementById('strategie_einkommen').value) || 0;

        // Vereinfachte Strategieempfehlung basierend auf Parametern
        let strategieempfehlung = '';
        let timeline_aktiv = [];

        if (alter < 40) {
            if (weitereImmobilien === 'portfolio') {
                strategieempfehlung = 'VV GmbH & Co. KG f√ºr Portfolio-Aufbau';
                timeline_aktiv = ['kauf', 'haltung'];
            } else {
                strategieempfehlung = 'VV GbR oder privat f√ºr erste Immobilie';
                timeline_aktiv = ['kauf', 'haltung'];
            }
        } else if (alter < 55) {
            if (nachfolge === 'kinder') {
                strategieempfehlung = 'Strukturierte √úbertragung mit Schenkungsstrategie';
                timeline_aktiv = ['haltung', 'optimierung'];
            } else {
                strategieempfehlung = 'Renditeoptimierung mit VV GmbH & Co. KG';
                timeline_aktiv = ['optimierung'];
            }
        } else {
            strategieempfehlung = 'Nachfolgeplanung und steueroptimierte √úbertragung';
            timeline_aktiv = ['optimierung', 'exit'];
        }

        // Timeline aktivieren
        document.querySelectorAll('.timeline-item').forEach(item => {
            item.classList.remove('active');
        });
        timeline_aktiv.forEach(id => {
            const element = document.getElementById('timeline-' + id);
            if (element) element.classList.add('active');
        });

        // Szenarien f√ºr 10, 20, 30 Jahre berechnen
        const szenarien = [];
        const grunddaten = berechungsdaten.immobilie || {};
        const bruttogewinn = (grunddaten.verkaufspreis || 450000) - (grunddaten.kaufpreis || 300000) - (grunddaten.nebenkosten_kauf || 30000) - (grunddaten.modernisierung || 50000);

        [10, 20, 30].forEach(jahre => {
            const wertentwicklung = Math.pow(1.02, jahre); // 2% p.a.
            const zukuenftigerWert = (grunddaten.verkaufspreis || 450000) * wertentwicklung;
            const zukuenftigerGewinn = zukuenftigerWert - (grunddaten.kaufpreis || 300000) - (grunddaten.nebenkosten_kauf || 30000) - (grunddaten.modernisierung || 50000);

            let steuer = 0;
            let struktur = '';

            if (jahre >= 10) {
                struktur = 'Steuerfrei (¬ß23 EStG)';
            } else if (alter + jahre > 60) {
                struktur = 'VV GmbH & Co. KG (gewerbesteuerfrei)';
                steuer = zukuenftigerGewinn * 0.3; // Vereinfacht
            } else {
                struktur = 'VV GbR';
                steuer = zukuenftigerGewinn * 0.4; // Vereinfacht
            }

            szenarien.push({
                jahre: jahre,
                wert: zukuenftigerWert,
                gewinn: zukuenftigerGewinn,
                steuer: steuer,
                netto: zukuenftigerGewinn - steuer,
                struktur: struktur
            });
        });

        let html = `
            <h3 style="text-align: center; color: #2c3e50; margin: 30px 0;">üéØ Ihre optimale Strategie</h3>
            <div class="warning success">
                <strong>üí° Strategieempfehlung f√ºr Sie:</strong><br>
                ${strategieempfehlung}<br><br>
                <strong>Begr√ºndung:</strong> Basierend auf Ihrem Alter (${alter}), Risikobereitschaft (${risiko}) und 
                Nachfolgeplanung (${nachfolge}) ist dies die steueroptimale L√∂sung.
            </div>

            <div class="scenario-comparison">
                <h3>üìä Langzeit-Szenarien</h3>
                <div class="scenario-grid">
        `;

        szenarien.forEach(szenario => {
            html += `
                <div class="scenario-card">
                    <h4>üìÖ Nach ${szenario.jahre} Jahren</h4>
                    <p><strong>Immobilienwert:</strong> ${formatCurrency(szenario.wert)}</p>
                    <p><strong>Gewinn brutto:</strong> ${formatCurrency(szenario.gewinn)}</p>
                    <p><strong>Steuern:</strong> ${formatCurrency(szenario.steuer)}</p>
                    <p><strong>Gewinn netto:</strong> ${formatCurrency(szenario.netto)}</p>
                    <p><strong>Beste Struktur:</strong> ${szenario.struktur}</p>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${Math.min(100, szenario.netto / szenarien[2].netto * 100)}%"></div>
                    </div>
                </div>
            `;
        });

        html += `
                </div>
            </div>

            <div class="warning info">
                <strong>üéØ N√§chste Schritte:</strong><br>
                1. <strong>Sofort:</strong> ${timeline_aktiv.includes('kauf') ? 'Struktur f√ºr Kauf festlegen' : 'Aktuelle Struktur pr√ºfen'}<br>
                2. <strong>Mittelfristig:</strong> ${timeline_aktiv.includes('optimierung') ? 'Optimierung/Umstrukturierung planen' : 'Portfolio-Entwicklung'}<br>
                3. <strong>Langfristig:</strong> ${nachfolge !== 'keine' ? 'Nachfolgeplanung konkretisieren' : 'Exit-Strategie entwickeln'}<br><br>
                <strong>‚ö†Ô∏è Wichtig:</strong> Lassen Sie sich von einem Steuerberater beraten, der auf Immobilienstrukturen spezialisiert ist.
            </div>
        `;

        document.getElementById('strategie-results').innerHTML = html;
    }

    // Cash-Flow Analyse
    function calculateCashFlow() {
        const jahresmiete = parseFloat(document.getElementById('cf_jahresmiete').value) || 0;
        const mietsteigerung = parseFloat(document.getElementById('cf_mietsteigerung').value) || 0;
        const instandhaltung = parseFloat(document.getElementById('cf_instandhaltung').value) || 0;
        const verwaltung = parseFloat(document.getElementById('cf_verwaltung').value) || 0;
        const versicherung = parseFloat(document.getElementById('cf_versicherung').value) || 0;
        const leerstand = parseFloat(document.getElementById('cf_leerstand').value) || 0;
        const zinsen = parseFloat(document.getElementById('cf_finanzierung').value) || 0;
        const tilgung = parseFloat(document.getElementById('cf_tilgung').value) || 0;
        const wertsteigerung = parseFloat(document.getElementById('cf_wertsteigerung').value) || 0;
        const betrachtungszeitraum = parseFloat(document.getElementById('cf_betrachtungszeitraum').value) || 15;

        const grunddaten = berechungsdaten.immobilie || {};
        const immobilienwert = grunddaten.verkaufspreis || 450000;
        const steuersatz = (grunddaten.persSteuersatz || 42) / 100;

        let cashflows = [];
        let kumulierterCashFlow = 0;
        let gesamteinzahlungen = 0;
        let gesamtauszahlungen = 0;

        for (let jahr = 1; jahr <= betrachtungszeitraum; jahr++) {
            const aktuelleJahresmiete = jahresmiete * Math.pow(1 + mietsteigerung/100, jahr-1);
            const effektiveJahresmiete = aktuelleJahresmiete * (1 - leerstand/100);
            
            const einnahmen = effektiveJahresmiete;
            const ausgaben = instandhaltung + verwaltung + versicherung + zinsen + tilgung;
            const steuerlicheAbschreibung = (grunddaten.kaufpreis || 300000) * 0.02; // 2% linear
            const steuerlichesErgebnis = einnahmen - (ausgaben - tilgung) - steuerlicheAbschreibung;
            const steuerersparnis = steuerlichesErgebnis < 0 ? Math.abs(steuerlichesErgebnis) * steuersatz : 0;
            const steuernachzahlung = steuerlichesErgebnis > 0 ? steuerlichesErgebnis * steuersatz : 0;
            
            const nettoCashFlow = einnahmen - ausgaben + steuerersparnis - steuernachzahlung;
            kumulierterCashFlow += nettoCashFlow;
            
            gesamteinzahlungen += einnahmen;
            gesamtauszahlungen += ausgaben;

            cashflows.push({
                jahr: jahr,
                einnahmen: einnahmen,
                ausgaben: ausgaben,
                steuereffekt: steuerersparnis - steuernachzahlung,
                nettoCashFlow: nettoCashFlow,
                kumuliert: kumulierterCashFlow
            });
        }

        // Verkaufsszenario am Ende
        const endwert = immobilienwert * Math.pow(1 + wertsteigerung/100, betrachtungszeitraum);
        const verkaufsgewinn = endwert - immobilienwert;
        const verkaufssteuer = betrachtungszeitraum >= 10 ? 0 : verkaufsgewinn * steuersatz;
        const nettoverkaufserloees = endwert - verkaufssteuer - (immobilienwert * 0.05); // 5% Verkaufskosten

        const gesamtrendite = ((nettoverkaufserloees + kumulierterCashFlow) / immobilienwert - 1) * 100 / betrachtungszeitraum;

        // Chart HTML generieren
        let chartHtml = `
            <h3>üìä Cash-Flow Verlauf √ºber ${betrachtungszeitraum} Jahre</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 5px; margin: 20px 0;">
        `;

        const maxCashFlow = Math.max(...cashflows.map(cf => Math.abs(cf.nettoCashFlow)));
        
        cashflows.slice(0, 15).forEach(cf => { // Max 15 Jahre anzeigen
            const hoehe = Math.abs(cf.nettoCashFlow) / maxCashFlow * 100;
            const farbe = cf.nettoCashFlow >= 0 ? '#27ae60' : '#e74c3c';
            chartHtml += `
                <div style="text-align: center;">
                    <div style="height: 100px; display: flex; align-items: end; justify-content: center;">
                        <div style="width: 20px; height: ${hoehe}%; background: ${farbe}; border-radius: 2px;" title="Jahr ${cf.jahr}: ${formatCurrency(cf.nettoCashFlow)}"></div>
                    </div>
                    <div style="font-size: 0.8em; margin-top: 5px;">J${cf.jahr}</div>
                </div>
            `;
        });
        chartHtml += '</div>';

        let html = `
            ${chartHtml}
            
            <div class="results-grid">
                <div class="result-card">
                    <h4>üí∞ Cash-Flow Zusammenfassung</h4>
                    <div class="result-item">
                        <span class="result-label">Durchschnittl. Cash-Flow p.a.:</span>
                        <span class="result-value ${kumulierterCashFlow/betrachtungszeitraum >= 0 ? '' : 'negative'}">${formatCurrency(kumulierterCashFlow/betrachtungszeitraum)}</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Kumulierter Cash-Flow:</span>
                        <span class="result-value ${kumulierterCashFlow >= 0 ? '' : 'negative'}">${formatCurrency(kumulierterCashFlow)}</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Gesamteinnahmen:</span>
                        <span class="result-value">${formatCurrency(gesamteinzahlungen)}</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Gesamtausgaben:</span>
                        <span class="result-value negative">${formatCurrency(gesamtauszahlungen)}</span>
                    </div>
                </div>

                <div class="result-card">
                    <h4>üè† Verkaufsszenario (Jahr ${betrachtungszeitraum})</h4>
                    <div class="result-item">
                        <span class="result-label">Endwert Immobilie:</span>
                        <span class="result-value">${formatCurrency(endwert)}</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Wertsteigerung:</span>
                        <span class="result-value">${formatCurrency(verkaufsgewinn)}</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Verkaufsteuer:</span>
                        <span class="result-value negative">${formatCurrency(verkaufssteuer)}</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Netto-Verkaufserl√∂s:</span>
                        <span class="result-value">${formatCurrency(nettoverkaufserloees)}</span>
                    </div>
                    <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 8px; font-size: 0.85em; color: #6c757d;">
                        ${betrachtungszeitraum >= 10 ? '‚úÖ Steuerfrei nach 10 Jahren!' : '‚è∞ Verkauf vor 10 Jahren = steuerpflichtig'}
                    </div>
                </div>

                <div class="result-card best-option">
                    <h4>üìà Gesamtrendite</h4>
                    <div class="result-item">
                        <span class="result-label">Investition:</span>
                        <span class="result-value negative">${formatCurrency(immobilienwert)}</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">R√ºckfluss Cash-Flow:</span>
                        <span class="result-value">${formatCurrency(kumulierterCashFlow)}</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">R√ºckfluss Verkauf:</span>
                        <span class="result-value">${formatCurrency(nettoverkaufserloees)}</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Gesamtr√ºckfluss:</span>
                        <span class="result-value">${formatCurrency(kumulierterCashFlow + nettoverkaufserloees)}</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Gesamtrendite p.a.:</span>
                        <span class="result-value ${gesamtrendite >= 0 ? '' : 'negative'}">${formatPercent(gesamtrendite)}</span>
                    </div>
                </div>
            </div>
        `;

        document.getElementById('cashflow-results').innerHTML = html;
        document.getElementById('cashflow-chart').innerHTML = html;
    }

    // Alle Strukturen anzeigen - KORRIGIERT: Verwendet identische Berechnungen
    function showAllStructures() {
        // Exakt dieselben Parameter wie in der Smart-Filterung
        const kaufpreis = parseFloat(document.getElementById('kaufpreis').value) || 0;
        const verkaufspreis = parseFloat(document.getElementById('verkaufspreis').value) || 0;
        const nebenkostenKauf = parseFloat(document.getElementById('nebenkosten_kauf').value) || 0;
        const nebenkostenVerkauf = parseFloat(document.getElementById('nebenkosten_verkauf').value) || 0;
        const modernisierung = parseFloat(document.getElementById('modernisierung').value) || 0;
        const haltedauer = parseFloat(document.getElementById('haltedauer').value) || 0;
        const persSteuersatz = parseFloat(document.getElementById('persoenlicher_steuersatz').value) || 42;
        const kirchensteuer = parseFloat(document.getElementById('kirchensteuer').value) || 8;
        const einbringungNach = parseFloat(document.getElementById('einbringung_nach_jahren').value) || 0;

        const gesamtkosten = kaufpreis + nebenkostenKauf + modernisierung;
        const bruttogewinn = verkaufspreis - nebenkostenVerkauf - gesamtkosten;
        const koerperschaftsteuer = 15;
        const soli = 5.5;
        const gesamtsteuersatz = persSteuersatz + (persSteuersatz * kirchensteuer / 100) + (persSteuersatz * soli / 100);
        const gewerbesteuer = 14;
        const gewerbesteuerFreibetrag = 24500;
        
        let steuer = 0;
        let steuerfrei = haltedauer >= 10;
        if (!steuerfrei) {
            steuer = bruttogewinn * gesamtsteuersatz / 100;
        }

        // KORRIGIERT: Identische Berechnungen wie in Smart-Filterung
        const ergebnisse = [];

        // 1. Privatverkauf
        ergebnisse.push({
            typ: 'Privatverkauf',
            bruttogewinn: bruttogewinn,
            steuer: steuer,
            nettogewinn: bruttogewinn - steuer,
            besonderheiten: steuerfrei ? '‚úÖ Steuerfrei nach 10 Jahren (¬ß23 EStG)' : '‚è∞ Spekulationssteuer - noch ' + (10 - haltedauer).toFixed(1) + ' Jahre bis steuerfrei'
        });

        // 2. VV GbR
        ergebnisse.push({
            typ: 'VV GbR',
            bruttogewinn: bruttogewinn,
            steuer: steuer,
            nettogewinn: bruttogewinn - steuer,
            besonderheiten: steuerfrei ? '‚úÖ Steuerfrei nach 10 Jahren (transparente Besteuerung)' : '‚è∞ Transparente Besteuerung, noch ' + (10 - haltedauer).toFixed(1) + ' Jahre bis steuerfrei'
        });

        // 3. VV GmbH & Co. KG
        if (haltedauer >= 10) {
            ergebnisse.push({
                typ: 'VV GmbH & Co. KG',
                bruttogewinn: bruttogewinn,
                steuer: 0,
                nettogewinn: bruttogewinn,
                besonderheiten: 'üèÜ STEUERFREI nach 10 Jahren + BFH 2025: Gewerbesteuerbefreiung!'
            });
        } else {
            const steuerVVKG = bruttogewinn * gesamtsteuersatz / 100;
            ergebnisse.push({
                typ: 'VV GmbH & Co. KG',
                bruttogewinn: bruttogewinn,
                steuer: steuerVVKG,
                nettogewinn: bruttogewinn - steuerVVKG,
                besonderheiten: '‚≠ê BFH 2025: GEWERBESTEUERFREI + wird nach 10 Jahren komplett steuerfrei!'
            });
        }

        // 4. VV GmbH - KORRIGIERT: Exakt dieselbe Berechnung wie Smart-Filterung
        const gstBasis = Math.max(0, bruttogewinn - gewerbesteuerFreibetrag);
        const gstBetrag = gstBasis * gewerbesteuer / 100;
        const kstBasis = bruttogewinn - gstBetrag;
        const kstBetrag = kstBasis * koerperschaftsteuer / 100;
        const soli_gmbh = kstBetrag * 5.5 / 100;
        const gesamtsteuerGmbh = gstBetrag + kstBetrag + soli_gmbh;
        const nettoGmbh = bruttogewinn - gesamtsteuerGmbh;
        const abgeltungsteuer = nettoGmbh * 26.375 / 100;
        
        let besonderheitGmbh = '‚ùå NIEMALS steuerfrei! Doppelbesteuerung: ~30% GmbH + ~26% Aussch√ºttung = ~48-50%';
        if (einbringungNach > 0 && einbringungNach >= 10) {
            besonderheitGmbh = `‚úÖ Einbringung nach ${einbringungNach} Jahren war steuerfrei, ‚ùå aber Verkauf durch GmbH = Doppelbesteuerung`;
        } else if (einbringungNach > 0) {
            besonderheitGmbh = `‚ùå Einbringung nach ${einbringungNach} Jahren war steuerpflichtig, Verkauf auch = Doppelbesteuerung`;
        }
        
        ergebnisse.push({
            typ: 'VV GmbH',
            bruttogewinn: bruttogewinn,
            steuer: gesamtsteuerGmbh + abgeltungsteuer,
            nettogewinn: nettoGmbh - abgeltungsteuer,
            besonderheiten: besonderheitGmbh
        });

        // 5-14. Weitere Strukturen mit korrekten Berechnungen
        const steuerVV = steuer;
        
        // 5. VV KG
        ergebnisse.push({
            typ: 'VV KG',
            bruttogewinn: bruttogewinn,
            steuer: steuerVV,
            nettogewinn: bruttogewinn - steuerVV,
            besonderheiten: steuerfrei ? '‚úÖ Steuerfrei nach 10 Jahren (transparente Besteuerung wie GbR)' : '‚è∞ Transparente Besteuerung, noch ' + (10 - haltedauer).toFixed(1) + ' Jahre bis steuerfrei'
        });

        // 6. VV OHG
        ergebnisse.push({
            typ: 'VV OHG',
            bruttogewinn: bruttogewinn,
            steuer: steuerVV,
            nettogewinn: bruttogewinn - steuerVV,
            besonderheiten: steuerfrei ? '‚úÖ Steuerfrei nach 10 Jahren (transparente Besteuerung)' : '‚ö†Ô∏è OHG = Vollhaftung aller Gesellschafter!'
        });

        // 7. VV PartG
        ergebnisse.push({
            typ: 'VV PartG',
            bruttogewinn: bruttogewinn,
            steuer: steuerVV,
            nettogewinn: bruttogewinn - steuerVV,
            besonderheiten: steuerfrei ? '‚úÖ Steuerfrei nach 10 Jahren (nur f√ºr Freiberufler)' : '‚ö†Ô∏è Nur f√ºr Freiberufler geeignet'
        });

        // 8. Familienpool KG
        const familienRabatt = bruttogewinn * 0.05;
        ergebnisse.push({
            typ: 'Familienpool KG',
            bruttogewinn: bruttogewinn,
            steuer: Math.max(0, steuerVV - familienRabatt),
            nettogewinn: bruttogewinn - Math.max(0, steuerVV - familienRabatt),
            besonderheiten: steuerfrei ? 'üèÜ Steuerfrei + optimale Nachfolgeplanung f√ºr Familien' : 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Optimal f√ºr Generationen√ºbergabe'
        });

        // 9. VV UG
        const ugSteuer = gesamtsteuerGmbh * 0.8;
        ergebnisse.push({
            typ: 'VV UG',
            bruttogewinn: bruttogewinn,
            steuer: ugSteuer + abgeltungsteuer * 0.8,
            nettogewinn: bruttogewinn - ugSteuer - abgeltungsteuer * 0.8,
            besonderheiten: '‚ùå Doppelbesteuerung wie GmbH, aber g√ºnstiger in der Gr√ºndung'
        });

        // 10. VV Holding-GmbH
        const holdingVorteil = bruttogewinn * 0.1;
        ergebnisse.push({
            typ: 'VV Holding-GmbH',
            bruttogewinn: bruttogewinn,
            steuer: Math.max(0, gesamtsteuerGmbh - holdingVorteil),
            nettogewinn: bruttogewinn - Math.max(0, gesamtsteuerGmbh - holdingVorteil),
            besonderheiten: '‚≠ê Schachtelprivileg nutzen, optimal f√ºr gro√üe Portfolios ab 3+ Objekte'
        });

        // 11. Gewerbliche GbR
        const gewerbesteuerGesamt = bruttogewinn * gewerbesteuer / 100;
        const anrechnungsbetrag = gewerbesteuerGesamt * 3.8;
        const einkommensteuerBasis = bruttogewinn - Math.min(anrechnungsbetrag, gewerbesteuerGesamt);
        const einkommensteuer = einkommensteuerBasis * gesamtsteuersatz / 100;
        const gesamtsteuerGewerblich = gewerbesteuerGesamt + einkommensteuer;

        ergebnisse.push({
            typ: 'Gewerbliche GbR',
            bruttogewinn: bruttogewinn,
            steuer: gesamtsteuerGewerblich,
            nettogewinn: bruttogewinn - gesamtsteuerGewerblich,
            besonderheiten: '‚ùå Gewerblich = KEINE 10-Jahres-Frist (¬ß23 EStG gilt nicht), aber Gewerbesteueranrechnung'
        });

        // 12. Gewerbliche GmbH
        const gewGmbhSteuer = gesamtsteuerGmbh * 1.1;
        ergebnisse.push({
            typ: 'Gewerbliche GmbH',
            bruttogewinn: bruttogewinn,
            steuer: gewGmbhSteuer,
            nettogewinn: bruttogewinn - gewGmbhSteuer,
            besonderheiten: '‚ùå Immer gewerblich + Doppelbesteuerung = h√∂chste Steuerbelastung'
        });

        // 13. Gewerbliche GmbH & Co. KG
        const gewKGSteuer = gesamtsteuerGewerblich * 0.9;
        ergebnisse.push({
            typ: 'Gewerbliche GmbH & Co. KG',
            bruttogewinn: bruttogewinn,
            steuer: gewKGSteuer,
            nettogewinn: bruttogewinn - gewKGSteuer,
            besonderheiten: '‚ùå Gewerblich = keine 10-Jahres-Frist, aber flexibler als reine GmbH'
        });

        // 14. Cross-Border DE-LU Struktur
        if (bruttogewinn > 500000) {
            const crossBorderVorteil = bruttogewinn * 0.15;
            ergebnisse.push({
                typ: 'Cross-Border DE-LU',
                bruttogewinn: bruttogewinn,
                steuer: Math.max(0, steuerVV - crossBorderVorteil),
                nettogewinn: bruttogewinn - Math.max(0, steuerVV - crossBorderVorteil),
                besonderheiten: 'üåç EU-Strukturen nur bei gro√üen Portfolios (>500k), komplexe Beratung n√∂tig'
            });
        }

        displayAllStructuresResults(ergebnisse);
    }

    function displayAllStructuresResults(ergebnisse) {
        const besteOption = ergebnisse.reduce((beste, aktuelle) => 
            aktuelle.nettogewinn > beste.nettogewinn ? aktuelle : beste
        );

        let html = `
            <h3 style="text-align: center; color: #2c3e50; margin: 30px 0;">üìä VOLLST√ÑNDIGER Strukturvergleich - Alle 14 Rechtsformen</h3>
            <div style="text-align: center; margin-bottom: 20px;">
                <button onclick="calculateVerkauf()" style="
                    background: #27ae60;
                    color: white;
                    border: none;
                    padding: 8px 15px;
                    border-radius: 5px;
                    cursor: pointer;
                    font-size: 0.9em;
                ">üìã Zur√ºck zur kompakten Ansicht</button>
            </div>
            
            <table class="comparison-table">
                <thead>
                    <tr>
                        <th>Rang</th>
                        <th>Struktur</th>
                        <th>Nettogewinn</th>
                        <th>Steuern</th>
                        <th>Steuerquote</th>
                        <th>Besonderheiten</th>
                    </tr>
                </thead>
                <tbody>
        `;

        // Sortiere nach Nettogewinn (beste zuerst)
        const sortierteErgebnisse = [...ergebnisse].sort((a, b) => b.nettogewinn - a.nettogewinn);
        
        sortierteErgebnisse.forEach((option, index) => {
            const isBest = index === 0;
            const rang = index + 1;
            const medaille = rang === 1 ? 'ü•á' : rang === 2 ? 'ü•à' : rang === 3 ? 'ü•â' : `${rang}.`;
            
            html += `
                <tr ${isBest ? 'class="best-option"' : ''}>
                    <td style="text-align: center; font-weight: 600;">${medaille}</td>
                    <td><strong>${option.typ}</strong></td>
                    <td style="font-weight: 600; color: #27ae60;">${formatCurrency(option.nettogewinn)}</td>
                    <td style="color: #e74c3c;">${formatCurrency(option.steuer)}</td>
                    <td>${formatPercent(option.bruttogewinn > 0 ? option.steuer / option.bruttogewinn * 100 : 0)}</td>
                    <td style="font-size: 0.8em;">${option.besonderheiten}</td>
                </tr>
            `;
        });

        html += `</tbody></table>
                 
                 <div class="warning success" style="margin-top: 30px;">
                    <strong>üèÜ Beste Struktur f√ºr Sie: ${besteOption.typ}</strong><br>
                    Nettogewinn: ${formatCurrency(besteOption.nettogewinn)} (Ersparnis gegen√ºber schlechtester Option: ${formatCurrency(besteOption.nettogewinn - sortierteErgebnisse[sortierteErgebnisse.length-1].nettogewinn)})<br>
                    ${besteOption.besonderheiten}
                 </div>`;

        document.getElementById('verkauf-results').innerHTML = html;
        
        // Animation hinzuf√ºgen
        setTimeout(() => {
            document.getElementById('verkauf-results').classList.add('structure-transition');
        }, 50);
    }

    // Erweiterte Hilfsfunktionen
    function calculateKombiAnalyse() {
        const grunddaten = berechungsdaten.immobilie || {};
        if (!grunddaten.kaufpreis) {
            alert('Bitte zuerst im "Verkaufssteuer-Vergleich" Tab eine Berechnung durchf√ºhren.');
            return;
        }

        // Alle Module durchrechnen und vergleichen
        const analyseErgebnisse = {
            verkauf: calculateVerkaufInternal(grunddaten),
            grundsteuer: calculateGrundsteuerInternal(),
            erbschaft: calculateErbschaftsteuerInternal(),
            schenkung: calculateSchenkungInternal(),
            cashflow: calculateCashFlowInternal()
        };

        return analyseErgebnisse;
    }

    // Interne Berechnungsfunktionen (ohne DOM-Updates)
    function calculateVerkaufInternal(daten) {
        const bruttogewinn = daten.verkaufspreis - daten.kaufpreis - daten.nebenkosten_kauf - daten.modernisierung - (daten.nebenkosten_verkauf || 0);
        const steuerfrei = daten.haltedauer >= 10;
        const steuer = steuerfrei ? 0 : bruttogewinn * (daten.persSteuersatz + daten.kirchensteuer + 5.5) / 100;
        
        return {
            bruttogewinn,
            steuer,
            nettogewinn: bruttogewinn - steuer,
            steuerfrei
        };
    }

    function calculateGrundsteuerInternal() {
        const grundstueckswert = parseFloat(document.getElementById('grundstueckswert').value) || 350000;
        const hebesatz = parseFloat(document.getElementById('gemeinde_hebesatz').value) || 450;
        const messzahl = 0.31; // Vereinfacht f√ºr Wohnimmobilien
        
        const messbetrag = grundstueckswert * messzahl / 1000;
        const grundsteuer = messbetrag * hebesatz / 100;
        
        return {
            grundsteuer,
            messbetrag,
            grundstueckswert
        };
    }

    function calculateErbschaftsteuerInternal() {
        const immobilienwert = parseFloat(document.getElementById('immobilienwert_erbe').value) || 450000;
        const verwandtschaft = document.getElementById('verwandtschaftsgrad').value;
        const freibetraege = {
            'ehepartner': 500000,
            'kind': 400000,
            'enkel': 200000,
            'eltern': 100000,
            'geschwister': 20000,
            'andere': 20000
        };
        
        const freibetrag = freibetraege[verwandtschaft] || 20000;
        const steuerpflichtig = Math.max(0, immobilienwert - freibetrag);
        const steuer = steuerpflichtig * 0.15; // Vereinfachter Steuersatz
        
        return {
            immobilienwert,
            freibetrag,
            steuer,
            steuerpflichtig
        };
    }

    function calculateSchenkungInternal() {
        const immobilienwert = parseFloat(document.getElementById('schenkung_immobilienwert').value) || 600000;
        const anteil = parseFloat(document.getElementById('schenkung_anteil').value) || 50;
        const schenkungswert = immobilienwert * anteil / 100;
        
        return {
            immobilienwert,
            schenkungswert,
            optimierung: schenkungswert * 0.1 // Gesch√§tzte Steuerersparnis durch Optimierung
        };
    }

    function calculateCashFlowInternal() {
        const jahresmiete = parseFloat(document.getElementById('cf_jahresmiete').value) || 18000;
        const ausgaben = (parseFloat(document.getElementById('cf_instandhaltung').value) || 2000) +
                        (parseFloat(document.getElementById('cf_verwaltung').value) || 800) +
                        (parseFloat(document.getElementById('cf_versicherung').value) || 600) +
                        (parseFloat(document.getElementById('cf_finanzierung').value) || 8000) +
                        (parseFloat(document.getElementById('cf_tilgung').value) || 6000);
        
        const nettoCashFlow = jahresmiete - ausgaben;
        
        return {
            jahresmiete,
            ausgaben,
            nettoCashFlow,
            rendite: (nettoCashFlow / (berechungsdaten.immobilie?.verkaufspreis || 450000)) * 100
        };
    }

    // Erweiterte Strategieempfehlungen
    function generateStrategieempfehlung(analyseErgebnisse) {
        const verkauf = analyseErgebnisse.verkauf;
        const cashflow = analyseErgebnisse.cashflow;
        const alter = parseFloat(document.getElementById('strategie_alter').value) || 45;
        
        let empfehlungen = [];
        
        // Verkaufsstrategie
        if (verkauf.steuerfrei) {
            empfehlungen.push({
                kategorie: "Verkaufstiming",
                empfehlung: "‚úÖ Optimal verkaufen - steuerfrei!",
                prioritaet: "hoch",
                ersparnis: verkauf.steuer
            });
        } else {
            const wartezeit = 10 - (berechungsdaten.immobilie?.haltedauer || 0);
            empfehlungen.push({
                kategorie: "Verkaufstiming",
                empfehlung: `‚è∞ Noch ${wartezeit.toFixed(1)} Jahre bis steuerfreier Verkauf warten`,
                prioritaet: "mittel",
                ersparnis: verkauf.steuer
            });
        }
        
        // Cash-Flow Optimierung
        if (cashflow.nettoCashFlow < 0) {
            empfehlungen.push({
                kategorie: "Cash-Flow",
                empfehlung: "üîÑ Mieterh√∂hung oder Refinanzierung pr√ºfen",
                prioritaet: "hoch",
                verbesserung: Math.abs(cashflow.nettoCashFlow)
            });
        }
        
        // Altersabh√§ngige Empfehlungen
        if (alter > 55) {
            empfehlungen.push({
                kategorie: "Nachfolge",
                empfehlung: "üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Schenkungsstrategie entwickeln - Freibetr√§ge nutzen",
                prioritaet: "hoch",
                ersparnis: analyseErgebnisse.schenkung.optimierung
            });
        }
        
        return empfehlungen;
    }

    // Exportfunktion f√ºr Berichte
    function exportBericht() {
        const analyseErgebnisse = calculateKombiAnalyse();
        const empfehlungen = generateStrategieempfehlung(analyseErgebnisse);
        
        let berichtHtml = `
            <h1>üìã Immobilien-Steuer-Analyse Bericht</h1>
            <h2>üè† Immobiliendaten</h2>
            <p>Kaufpreis: ${formatCurrency(berechungsdaten.immobilie?.kaufpreis || 0)}</p>
            <p>Aktueller Wert: ${formatCurrency(berechungsdaten.immobilie?.verkaufspreis || 0)}</p>
            <p>Haltedauer: ${berechungsdaten.immobilie?.haltedauer || 0} Jahre</p>
            
            <h2>üí∞ Verkaufssteuer-Analyse</h2>
            <p>Bruttogewinn: ${formatCurrency(analyseErgebnisse.verkauf.bruttogewinn)}</p>
            <p>Steuerbelastung: ${formatCurrency(analyseErgebnisse.verkauf.steuer)}</p>
            <p>Nettogewinn: ${formatCurrency(analyseErgebnisse.verkauf.nettogewinn)}</p>
            
            <h2>üéØ Strategieempfehlungen</h2>
        `;
        
        empfehlungen.forEach(emp => {
            berichtHtml += `<p><strong>${emp.kategorie}:</strong> ${emp.empfehlung}</p>`;
        });
        
        // √ñffne neues Fenster f√ºr Bericht
        const neuesFenster = window.open('', '_blank');
        neuesFenster.document.write(`
            <html>
            <head><title>Immobilien-Steuer-Bericht</title>
            <style>
                body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
                h1, h2 { color: #2c3e50; }
                p { margin: 10px 0; }
            </style>
            </head>
            <body>${berichtHtml}</body>
            </html>
        `);
    }

    // Steuer-Rechner f√ºr verschiedene Szenarien
    function calculateSteuerSzenario(szenario) {
        const grunddaten = berechungsdaten.immobilie || {};
        
        switch(szenario) {
            case 'sofort_verkauf':
                return calculateVerkaufInternal({
                    ...grunddaten,
                    haltedauer: grunddaten.haltedauer || 0
                });
                
            case 'verkauf_10_jahre':
                return calculateVerkaufInternal({
                    ...grunddaten,
                    haltedauer: 10,
                    verkaufspreis: grunddaten.verkaufspreis * Math.pow(1.02, 10 - (grunddaten.haltedauer || 0))
                });
                
            case 'schenkung_jetzt':
                const schenkungsdaten = calculateSchenkungInternal();
                return {
                    steuerersparnis: schenkungsdaten.optimierung,
                    empfehlung: 'Schenkung in Raten √ºber mehrere 10-Jahres-Zyklen'
                };
                
            default:
                return null;
        }
    }

    // Erweiterte Benachrichtigungen
    function showAdvancedNotification(message, type = 'info', actions = []) {
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: ${type === 'success' ? '#27ae60' : type === 'error' ? '#e74c3c' : '#3498db'};
            color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            font-weight: 500;
            max-width: 350px;
            animation: slideIn 0.3s ease;
        `;
        
        let html = `<div style="margin-bottom: 15px;">${message}</div>`;
        
        if (actions.length > 0) {
            html += '<div>';
            actions.forEach(action => {
                html += `<button onclick="${action.onclick}" style="
                    background: rgba(255,255,255,0.2);
                    color: white;
                    border: 1px solid rgba(255,255,255,0.3);
                    padding: 8px 15px;
                    margin: 5px 5px 0 0;
                    border-radius: 5px;
                    cursor: pointer;
                    font-size: 0.9em;
                ">${action.text}</button>`;
            });
            html += '</div>';
        }
        
        notification.innerHTML = html;
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => {
                if (notification.parentNode) {
                    document.body.removeChild(notification);
                }
            }, 300);
        }, 6000);
    }

    // Smart-Empfehlungen basierend auf Eingaben - MIT DEBUG
    function generateSmartEmpfehlungen() {
        console.log('=== generateSmartEmpfehlungen START ===');
        
        // IMMER die aktuellen DOM-Werte lesen (NIEMALS gecachte Werte)
        const kaufpreis = parseFloat(document.getElementById('kaufpreis').value) || 0;
        const verkaufspreis = parseFloat(document.getElementById('verkaufspreis').value) || 0;
        const nebenkostenKauf = parseFloat(document.getElementById('nebenkosten_kauf').value) || 0;
        const modernisierung = parseFloat(document.getElementById('modernisierung').value) || 0;
        const haltedauer = parseFloat(document.getElementById('haltedauer').value) || 0;
        const persSteuersatz = parseFloat(document.getElementById('persoenlicher_steuersatz').value) || 42;
        const kirchensteuer = parseFloat(document.getElementById('kirchensteuer').value) || 8;
        
        console.log('Gelesene Werte:', {
            kaufpreis, verkaufspreis, nebenkostenKauf, modernisierung, 
            haltedauer, persSteuersatz, kirchensteuer
        });
        
        // Basis-Validierung
        if (!kaufpreis || !verkaufspreis) {
            console.log('Keine Empfehlungen: Kaufpreis oder Verkaufspreis fehlt');
            return [];
        }
        
        const empfehlungen = [];
        const bruttogewinn = verkaufspreis - kaufpreis - nebenkostenKauf - modernisierung;
        
        console.log('Bruttogewinn berechnet:', bruttogewinn);
        
        // Haltedauer-Optimierung - DETAILLIERTES LOGGING
        console.log('Pr√ºfe Haltedauer-Optimierung:', { haltedauer, ist_unter_10: haltedauer < 10 });
        
        if (haltedauer < 10 && bruttogewinn > 0) {
            const restzeit = 10 - haltedauer;
            const gesamtsteuersatz = persSteuersatz + (persSteuersatz * kirchensteuer / 100) + (persSteuersatz * 5.5 / 100);
            const potentielleErsparnis = bruttogewinn * gesamtsteuersatz / 100;
            
            console.log('Haltedauer < 10 - Empfehlung erstellt:', {
                restzeit, gesamtsteuersatz, potentielleErsparnis
            });
            
            empfehlungen.push({
                icon: '‚è∞',
                titel: `Noch ${restzeit.toFixed(1)} Jahre warten = steuerfrei`,
                beschreibung: `Potentielle Steuerersparnis durch 10-Jahres-Frist`,
                ersparnis: Math.max(0, potentielleErsparnis),
                prioritaet: 'hoch',
                detail: `Bei Verkauf heute: ${formatCurrency(potentielleErsparnis)} Steuern`
            });
        } else if (haltedauer >= 10 && bruttogewinn > 0) {
            console.log('Haltedauer >= 10 - Steuerfreie Empfehlung erstellt');
            
            empfehlungen.push({
                icon: 'üéâ',
                titel: 'OPTIMAL: Steuerfreier Verkauf m√∂glich!',
                beschreibung: '10-Jahres-Frist erreicht - verkaufen Sie steuerfrei',
                ersparnis: bruttogewinn * 0.4, // Was gespart wird vs. fr√ºherem Verkauf
                prioritaet: 'hoch',
                detail: 'Komplette Steuerbefreiung nach ¬ß23 EStG'
            });
        }
        
        // Strukturoptimierung
        if (haltedauer < 8 && bruttogewinn > 0) {
            const strukturVorteil = Math.max(0, bruttogewinn * 0.15);
            empfehlungen.push({
                icon: 'üè¢',
                titel: 'Strukturoptimierung noch m√∂glich',
                beschreibung: 'VV GmbH & Co. KG = BFH 2025 gewerbesteuerfrei',
                ersparnis: strukturVorteil,
                prioritaet: 'mittel',
                detail: 'Umstrukturierung vor 10-Jahres-Frist'
            });
        } else if (haltedauer >= 8 && haltedauer < 10) {
            empfehlungen.push({
                icon: '‚ö°',
                titel: 'Umstrukturierung zeitkritisch',
                beschreibung: `Nur noch ${(10 - haltedauer).toFixed(1)} Jahre bis steuerfreier Verkauf`,
                ersparnis: bruttogewinn * 0.1,
                prioritaet: 'hoch',
                detail: 'Schnelle Entscheidung erforderlich'
            });
        }
        
        console.log('Empfehlungen generiert:', empfehlungen.length);
        console.log('=== generateSmartEmpfehlungen END ===');
        
        return empfehlungen.filter(emp => emp.ersparnis > 100);
    }

    // Dashboard-√úbersicht - KOMPLETT NEU: Garantiert aktuelle Werte
    function updateDashboard() {
        // SCHRITT 1: Immer zuerst altes Dashboard entfernen
        const altesDashboard = document.getElementById('smart-dashboard');
        if (altesDashboard) {
            altesDashboard.remove();
        }
        
        // SCHRITT 2: Pr√ºfen ob Dashboard gew√ºnscht
        const dashboardHidden = localStorage.getItem('dashboard-hidden');
        if (dashboardHidden) return;
        
        // SCHRITT 3: Empfehlungen generieren (IMMER mit aktuellen DOM-Werten)
        const empfehlungen = generateSmartEmpfehlungen();
        
        // SCHRITT 4: Debug-Info in Konsole
        console.log('Dashboard Update:', {
            haltedauer: document.getElementById('haltedauer').value,
            empfehlungen: empfehlungen.length
        });
        
        if (empfehlungen.length === 0) {
            console.log('Keine Empfehlungen generiert - pr√ºfen Sie die Eingabewerte');
            return;
        }
        
        // SCHRITT 5: Dashboard HTML erstellen
        let dashboardHtml = `
            <div style="
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: white;
                border: 2px solid #3498db;
                border-radius: 10px;
                padding: 15px;
                box-shadow: 0 5px 15px rgba(0,0,0,0.1);
                max-width: 320px;
                z-index: 999;
                animation: slideIn 0.3s ease;
            " id="smart-dashboard">
                <h4 style="margin: 0 0 10px 0; color: #2c3e50;">
                    üí° Live-Empfehlungen 
                    <span style="font-size:0.7em;color:#95a5a6;">(Haltedauer: ${document.getElementById('haltedauer').value} Jahre)</span>
                </h4>
        `;
        
        empfehlungen.slice(0, 2).forEach((emp, index) => {
            const ersparnis = parseFloat(emp.ersparnis) || 0;
            const prioritaet = emp.prioritaet || 'mittel';
            
            dashboardHtml += `
                <div style="
                    padding: 12px;
                    margin: 8px 0;
                    background: ${index === 0 ? '#e8f5e8' : '#f8f9fa'};
                    border-radius: 8px;
                    border-left: 4px solid ${prioritaet === 'hoch' ? '#e74c3c' : '#f39c12'};
                    transition: all 0.2s ease;
                ">
                    <div style="font-weight: 600; font-size: 0.9em; margin-bottom: 4px;">${emp.icon} ${emp.titel}</div>
                    <div style="font-size: 0.8em; color: #6c757d; margin: 3px 0;">${emp.beschreibung}</div>
                    ${emp.detail ? `<div style="font-size: 0.75em; color: #95a5a6; margin: 2px 0;">${emp.detail}</div>` : ''}
                    <div style="font-size: 0.85em; font-weight: 600; color: #27ae60; margin-top: 5px;">
                        üí∞ Potential: ${formatCurrency(ersparnis)}
                    </div>
                </div>
            `;
        });
        
        dashboardHtml += `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px;">
                    <button onclick="showExtendedAnalyse()" 
                            style="
                                background: #3498db;
                                color: white;
                                border: none;
                                padding: 8px 15px;
                                border-radius: 5px;
                                cursor: pointer;
                                font-size: 0.85em;
                            ">üîç Detailanalyse</button>
                    <button onclick="hideDashboard()" 
                            style="
                                background: #95a5a6;
                                color: white;
                                border: none;
                                padding: 6px 12px;
                                border-radius: 3px;
                                cursor: pointer;
                                font-size: 0.8em;
                            ">Ausblenden</button>
                </div>
                <div style="font-size: 0.7em; color: #bdc3c7; text-align: center; margin-top: 8px;">
                    üîÑ Aktualisiert: ${new Date().toLocaleTimeString('de-DE')}
                </div>
            </div>
        `;
        
        // SCHRITT 6: Dashboard einf√ºgen
        document.body.insertAdjacentHTML('beforeend', dashboardHtml);
    }

    // TEST-Funktion f√ºr Dashboard-Update - KORRIGIERT: Blendet Dashboard immer ein
    function testDashboardUpdate() {
        console.log('=== DASHBOARD TEST START ===');
        
        // SCHRITT 1: Dashboard-Hidden Flag entfernen (falls gesetzt)
        const warAusgeblendet = localStorage.getItem('dashboard-hidden');
        if (warAusgeblendet) {
            localStorage.removeItem('dashboard-hidden');
            console.log('Dashboard war ausgeblendet - wird wieder eingeblendet');
        }
        
        // SCHRITT 2: Aktuelle Werte lesen
        const haltedauer = document.getElementById('haltedauer').value;
        const kaufpreis = document.getElementById('kaufpreis').value;
        const verkaufspreis = document.getElementById('verkaufspreis').value;
        
        console.log('Aktuelle Werte:', { haltedauer, kaufpreis, verkaufspreis });
        
        // SCHRITT 3: Dashboard DEFINITIV anzeigen (auch wenn ausgeblendet war)
        updateDashboard();
        
        // SCHRITT 4: Benutzer-Feedback
        const nachricht = warAusgeblendet ? 
            `‚úÖ Dashboard wieder eingeblendet und aktualisiert! Haltedauer: ${haltedauer} Jahre` :
            `‚úÖ Dashboard aktualisiert! Haltedauer: ${haltedauer} Jahre`;
        
        showAdvancedNotification(nachricht, 'success');
        
        console.log('=== DASHBOARD TEST END ===');
    }
    function hideDashboard() {
        const dashboard = document.getElementById('smart-dashboard');
        if (dashboard) {
            dashboard.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => {
                if (dashboard.parentNode) {
                    dashboard.remove();
                }
            }, 300);
        }
        // Merken dass User Dashboard nicht m√∂chte
        localStorage.setItem('dashboard-hidden', 'true');
    }

    // Dashboard wieder anzeigen - VERBESSERT: Mit Feedback
    function showDashboard() {
        console.log('showDashboard() aufgerufen');
        
        // Hidden-Flag entfernen
        localStorage.removeItem('dashboard-hidden');
        
        // Dashboard sofort anzeigen
        updateDashboard();
        
        // Benutzer-Feedback
        showAdvancedNotification('üí° Smart-Dashboard wieder eingeblendet', 'success');
    }

    // Initialisierung und Event-Handler - KORRIGIERT: Respektiert User-Pr√§ferenzen
    function initializeSuite() {
        // Lade gespeicherte Daten
        const gespeicherteDaten = localStorage.getItem('immobilien-suite-daten');
        if (gespeicherteDaten) {
            try {
                berechungsdaten = JSON.parse(gespeicherteDaten);
                // Lade Daten in Formulare
                if (berechungsdaten.immobilie) {
                    Object.keys(berechungsdaten.immobilie).forEach(key => {
                        const element = document.getElementById(key);
                        if (element) element.value = berechungsdaten.immobilie[key];
                    });
                }
            } catch(e) {
                console.log('Gespeicherte Daten konnten nicht geladen werden');
            }
        }
        
        // Erste Berechnung
        calculateVerkauf();
        
        // Smart Dashboard anzeigen - KORRIGIERT: Nur wenn nicht ausgeblendet
        setTimeout(() => {
            const dashboardHidden = localStorage.getItem('dashboard-hidden');
            if (!dashboardHidden) {
                updateDashboard();
            }
        }, 2000);
    }

    // Daten speichern
    function saveSuiteData() {
        try {
            localStorage.setItem('immobilien-suite-daten', JSON.stringify(berechungsdaten));
        } catch(e) {
            console.log('Daten konnten nicht gespeichert werden');
        }
    }

    // Event-Handler - KOMPLETT NEU: Direkter Dashboard-Update
    function attachEventHandlers() {
        console.log('Event-Handler werden attached...');
        
        // ALLE Input- und Select-Felder finden
        const alleFelder = document.querySelectorAll('input, select');
        console.log(`Gefunden: ${alleFelder.length} Eingabefelder`);
        
        alleFelder.forEach((element, index) => {
            // CHANGE Event - bei endg√ºltiger √Ñnderung
            element.addEventListener('change', function() {
                console.log(`CHANGE Event auf ${this.id || 'unnamed field ' + index}:`, this.value);
                
                // Daten speichern
                saveSuiteData();
                
                // SOFORT Dashboard aktualisieren
                setTimeout(updateDashboard, 50); // Kurze Verz√∂gerung f√ºr DOM-Update
                
                // Berechnungen aktualisieren
                const activeTab = document.querySelector('.tab-content.active')?.id;
                if (activeTab === 'verkauf') {
                    calculateVerkauf();
                }
            });
            
            // INPUT Event - w√§hrend dem Tippen (nur f√ºr wichtige Felder)
            if (['kaufpreis', 'verkaufspreis', 'haltedauer', 'persoenlicher_steuersatz'].includes(element.id)) {
                element.addEventListener('input', function() {
                    console.log(`INPUT Event auf ${this.id}:`, this.value);
                    
                    // Dashboard mit kurzer Verz√∂gerung aktualisieren
                    clearTimeout(window.dashboardUpdateTimeout);
                    window.dashboardUpdateTimeout = setTimeout(() => {
                        updateDashboard();
                    }, 800);
                });
            }
        });
    }

    // Erweiterte Event-Handler - KOMPLETT √úBERARBEITET
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM Content Loaded - starte Initialisierung...');
        
        initializeSuite();
        
        // Event-Handler mit kurzer Verz√∂gerung attachieren (f√ºr alle dynamischen Inhalte)
        setTimeout(() => {
            attachEventHandlers();
            console.log('Event-Handler erfolgreich attached');
        }, 100);
    });

    // Export-Funktion zur globalen Verf√ºgung stellen
    window.exportBericht = exportBericht;

    // Zus√§tzliche Hilfsfunktionen
    function resetAllData() {
        if (confirm('M√∂chten Sie wirklich alle Daten zur√ºcksetzen?')) {
            localStorage.removeItem('immobilien-suite-daten');
            berechungsdaten = {};
            
            // Alle Eingabefelder zur√ºcksetzen
            document.querySelectorAll('input').forEach(input => {
                if (input.type === 'number') {
                    input.value = input.getAttribute('value') || '';
                }
            });
            
            document.querySelectorAll('select').forEach(select => {
                select.selectedIndex = 0;
            });
            
            // Neuberechwung durchf√ºhren
            calculateVerkauf();
            
            showAdvancedNotification('‚úÖ Alle Daten wurden zur√ºckgesetzt', 'success');
        }
    }

    function importExample() {
        // Beispieldaten laden
        const beispielDaten = {
            kaufpreis: 400000,
            verkaufspreis: 580000,
            nebenkosten_kauf: 40000,
            nebenkosten_verkauf: 29000,
            modernisierung: 35000,
            haltedauer: 6,
            persoenlicher_steuersatz: 42,
            kirchensteuer: 8,
            bundesland: 'nw'
        };
        
        // Daten in Formular eintragen
        Object.keys(beispielDaten).forEach(key => {
            const element = document.getElementById(key);
            if (element) element.value = beispielDaten[key];
        });
        
        // Zus√§tzliche Beispieldaten f√ºr andere Tabs
        document.getElementById('grundstueckswert').value = 420000;
        document.getElementById('gemeinde_hebesatz').value = 520;
        document.getElementById('immobilienwert_erbe').value = 580000;
        document.getElementById('verwandtschaftsgrad').value = 'kind';
        document.getElementById('schenkung_immobilienwert').value = 580000;
        document.getElementById('jahresmiete').value = 22000;
        document.getElementById('cf_jahresmiete').value = 22000;
        document.getElementById('cf_instandhaltung').value = 2500;
        document.getElementById('strategie_alter').value = 48;
        
        // Berechnungen aktualisieren
        calculateVerkauf();
        
        showAdvancedNotification('üí° Beispieldaten wurden geladen - M√ºnchen, Mehrfamilienhaus, 6 Jahre Haltedauer', 'success');
    }

    // Erweiterte Steuer-Rechner-Funktionen
    function calculateOptimaleSteuerstruktur() {
        const grunddaten = berechungsdaten.immobilie || {};
        if (!grunddaten.kaufpreis) return null;
        
        const szenarien = [
            {
                struktur: 'Privatverkauf',
                haltedauer: Math.max(10, grunddaten.haltedauer + (10 - grunddaten.haltedauer)),
                steuerbelastung: 0,
                besonderheiten: 'Steuerfrei nach 10 Jahren'
            },
            {
                struktur: 'VV GbR',
                haltedauer: grunddaten.haltedauer,
                steuerbelastung: grunddaten.haltedauer >= 10 ? 0 : (grunddaten.verkaufspreis - grunddaten.kaufpreis) * 0.42,
                besonderheiten: 'Transparente Besteuerung, ab 10 Jahre steuerfrei'
            },
            {
                struktur: 'VV GmbH & Co. KG',
                haltedauer: grunddaten.haltedauer,
                steuerbelastung: grunddaten.haltedauer >= 10 ? 0 : (grunddaten.verkaufspreis - grunddaten.kaufpreis) * 0.42,
                besonderheiten: 'BFH 2025: Gewerbesteuerfrei! Ab 10 Jahre komplett steuerfrei'
            },
            {
                struktur: 'VV GmbH',
                haltedauer: grunddaten.haltedauer,
                steuerbelastung: (grunddaten.verkaufspreis - grunddaten.kaufpreis) * 0.48,
                besonderheiten: 'Immer steuerpflichtig - Doppelbesteuerung'
            }
        ];
        
        // Beste Option ermitteln
        const besteOption = szenarien.reduce((beste, aktuelle) => 
            aktuelle.steuerbelastung < beste.steuerbelastung ? aktuelle : beste
        );
        
        return { szenarien, besteOption };
    }

    // Steuerkalender-Funktion
    function generateSteuerkalender() {
        const heute = new Date();
        const kalender = [];
        
        // Grundsteuer-Termine
        for (let quartal = 1; quartal <= 4; quartal++) {
            const monat = quartal * 3;
            const datum = new Date(heute.getFullYear(), monat - 1, 15);
            kalender.push({
                datum: datum,
                ereignis: `Grundsteuer Q${quartal} f√§llig`,
                typ: 'grundsteuer',
                prioritaet: 'mittel'
            });
        }
        
        // Erbschaftsteuer-Meldefrist (3 Monate nach Erbfall)
        const erbschaftMeldefrist = new Date(heute.getFullYear(), heute.getMonth() + 3, heute.getDate());
        kalender.push({
            datum: erbschaftMeldefrist,
            ereignis: 'Erbschaftsteuer-Meldung (falls relevant)',
            typ: 'erbschaftsteuer',
            prioritaet: 'hoch'
        });
        
        // 10-Jahres-Frist Reminder
        const grunddaten = berechungsdaten.immobilie || {};
        if (grunddaten.haltedauer < 10) {
            const kaufdatum = new Date();
            kaufdatum.setFullYear(kaufdatum.getFullYear() - grunddaten.haltedauer);
            const steuerfreiDatum = new Date(kaufdatum);
            steuerfreiDatum.setFullYear(steuerfreiDatum.getFullYear() + 10);
            
            kalender.push({
                datum: steuerfreiDatum,
                ereignis: 'üéâ Steuerfreier Verkauf m√∂glich (10-Jahres-Frist)',
                typ: 'verkauf',
                prioritaet: 'hoch'
            });
        }
        
        return kalender.sort((a, b) => a.datum - b.datum);
    }

    // Risiko-Analyse
    function calculateRisikoAnalyse() {
        const grunddaten = berechungsdaten.immobilie || {};
        const risiken = [];
        
        // Haltedauer-Risiko
        if (grunddaten.haltedauer < 10) {
            const verbleibendeZeit = 10 - grunddaten.haltedauer;
            const potentiellerVerlust = (grunddaten.verkaufspreis - grunddaten.kaufpreis) * 0.42;
            risiken.push({
                typ: 'Spekulationssteuer',
                beschreibung: `Bei Verkauf vor ${verbleibendeZeit.toFixed(1)} Jahren`,
                finanziellAuswirkung: potentiellerVerlust,
                wahrscheinlichkeit: 'mittel',
                empfehlung: 'Verkauf nach 10 Jahren planen oder Struktur optimieren'
            });
        }
        
        // Liquidit√§tsrisiko bei Erbschaft
        const erbschaftsteuer = calculateErbschaftsteuerInternal().steuer;
        if (erbschaftsteuer > 50000) {
            risiken.push({
                typ: 'Erbschaftsteuer-Liquidit√§t',
                beschreibung: 'Hohe Erbschaftsteuer k√∂nnte Verkauf erzwingen',
                finanziellAuswirkung: erbschaftsteuer,
                wahrscheinlichkeit: 'hoch',
                empfehlung: 'Schenkungsstrategie entwickeln oder Versicherungsl√∂sung'
            });
        }
        
        // Grundsteuer-Risiko
        const grundsteuer = calculateGrundsteuerInternal().grundsteuer;
        if (grundsteuer > 2000) {
            risiken.push({
                typ: 'Grundsteuer-Anstieg',
                beschreibung: 'Hohe neue Grundsteuer belastet Rendite',
                finanziellAuswirkung: grundsteuer * 10, // 10 Jahre
                wahrscheinlichkeit: 'hoch',
                empfehlung: 'Einspruch gegen Grundsteuerbescheid pr√ºfen'
            });
        }
        
        return risiken;
    }

    // Benchmark-Vergleich
    function calculateBenchmarkVergleich() {
        const grunddaten = berechungsdaten.immobilie || {};
        const kaufpreis = grunddaten.kaufpreis || 0;
        const verkaufspreis = grunddaten.verkaufspreis || 0;
        const haltedauer = grunddaten.haltedauer || 1;
        
        const immobilienRendite = Math.pow(verkaufspreis / kaufpreis, 1/haltedauer) - 1;
        
        // Benchmark-Renditen (vereinfacht)
        const benchmarks = {
            'Immobilien-Index Deutschland': 0.04, // 4% p.a.
            'DAX (historisch)': 0.08, // 8% p.a.
            'Anleihen (10J Bund)': 0.02, // 2% p.a.
            'Inflation': 0.025 // 2.5% p.a.
        };
        
        const vergleich = Object.keys(benchmarks).map(benchmark => ({
            name: benchmark,
            rendite: benchmarks[benchmark],
            vergleich: immobilienRendite - benchmarks[benchmark],
            bewertung: immobilienRendite > benchmarks[benchmark] ? 'Outperformance' : 'Underperformance'
        }));
        
        return {
            immobilienRendite: immobilienRendite,
            benchmarks: vergleich
        };
    }

    // Erweiterte Dashboard-Funktionen
    function showExtendedAnalyse() {
        const risikoAnalyse = calculateRisikoAnalyse();
        const benchmarkVergleich = calculateBenchmarkVergleich();
        const steuerkalender = generateSteuerkalender().slice(0, 5);
        
        let analyseHtml = `
            <div style="
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                border-radius: 15px;
                padding: 30px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                max-width: 800px;
                max-height: 80vh;
                overflow-y: auto;
                z-index: 10000;
            " id="extended-analyse">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                    <h2 style="color: #2c3e50; margin: 0;">üìä Erweiterte Analyse</h2>
                    <button onclick="closeExtendedAnalyse()" style="
                        background: #e74c3c;
                        color: white;
                        border: none;
                        border-radius: 50%;
                        width: 35px;
                        height: 35px;
                        cursor: pointer;
                        font-size: 18px;
                    ">√ó</button>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <h3 style="color: #e74c3c;">‚ö†Ô∏è Risiko-Analyse</h3>
        `;
        
        if (risikoAnalyse.length > 0) {
            risikoAnalyse.forEach(risiko => {
                analyseHtml += `
                    <div style="background: #fff5f5; padding: 15px; border-radius: 8px; margin: 10px 0; border-left: 4px solid #e74c3c;">
                        <strong>${risiko.typ}</strong><br>
                        ${risiko.beschreibung}<br>
                        <strong>Auswirkung:</strong> ${formatCurrency(risiko.finanziellAuswirkung)}<br>
                        <em>${risiko.empfehlung}</em>
                    </div>
                `;
            });
        } else {
            analyseHtml += '<p style="color: #27ae60;">‚úÖ Keine kritischen Risiken identifiziert</p>';
        }
        
        analyseHtml += `
                    </div>
                    <div>
                        <h3 style="color: #3498db;">üìà Rendite-Benchmark</h3>
                        <p><strong>Ihre Immobilienrendite:</strong> ${formatPercent(benchmarkVergleich.immobilienRendite * 100)} p.a.</p>
        `;
        
        benchmarkVergleich.benchmarks.forEach(benchmark => {
            const farbe = benchmark.vergleich > 0 ? '#27ae60' : '#e74c3c';
            analyseHtml += `
                <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #ecf0f1;">
                    <span>${benchmark.name}</span>
                    <span style="color: ${farbe};">
                        ${formatPercent(benchmark.rendite * 100)} 
                        (${benchmark.vergleich > 0 ? '+' : ''}${formatPercent(benchmark.vergleich * 100)})
                    </span>
                </div>
            `;
        });
        
        analyseHtml += `
                    </div>
                </div>
                
                <div style="margin-top: 25px;">
                    <h3 style="color: #f39c12;">üìÖ Steuer-Kalender (n√§chste Termine)</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
        `;
        
        steuerkalender.forEach(termin => {
            const farbe = termin.prioritaet === 'hoch' ? '#e74c3c' : '#f39c12';
            analyseHtml += `
                <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; border-left: 3px solid ${farbe};">
                    <div style="font-size: 0.9em; font-weight: 600;">${termin.datum.toLocaleDateString('de-DE')}</div>
                    <div style="font-size: 0.8em;">${termin.ereignis}</div>
                </div>
            `;
        });
        
        analyseHtml += `
                    </div>
                </div>
            </div>
            <div style="
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                z-index: 9999;
            " onclick="closeExtendedAnalyse()" id="analyse-overlay"></div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', analyseHtml);
    }

    function closeExtendedAnalyse() {
        const analyse = document.getElementById('extended-analyse');
        const overlay = document.getElementById('analyse-overlay');
        if (analyse) analyse.remove();
        if (overlay) overlay.remove();
    }

    // Globale Funktionen verf√ºgbar machen
    window.resetAllData = resetAllData;
    window.importExample = importExample;
    window.showExtendedAnalyse = showExtendedAnalyse;
    window.closeExtendedAnalyse = closeExtendedAnalyse;
    window.showAllStructures = showAllStructures;
    window.hideDashboard = hideDashboard;
    window.showDashboard = showDashboard;
    window.testDashboardUpdate = testDashboardUpdate;
</script>
```

</body>
</html>
